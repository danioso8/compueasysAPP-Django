{% load static %} {% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if current_category %}{{ current_category.nombre }} - {% endif %}Tienda CompuEasys</title>
    
    <!-- Bootstrap CSS (Para modales y componentes) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/store.css' %}?v=8.2">
    <link rel="stylesheet" href="{% static 'css/detail_modern.css' %}?v=1.3">
    
    <!-- CSS Personalizado -->
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
    
    <!-- Preload cr칤tico -->
    <link rel="preload" href="{% static 'js/store.js' %}" as="script">
    
    <!-- Meta tags para SEO -->
    <meta name="description" content="Tienda online CompuEasys - Encuentra los mejores productos tecnol칩gicos al mejor precio">
    <meta name="keywords" content="tecnolog칤a, computadoras, accesorios, CompuEasys">
    
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        #refresh-cart-btn {
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        #refresh-cart-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05) !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5) !important;
            filter: brightness(1.1) !important;
        }
        
        #refresh-cart-btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98) !important;
        }
        
        #refresh-cart-btn:disabled {
            opacity: 0.7 !important;
            cursor: not-allowed !important;
        }
        
        #refresh-cart-btn.spinning i {
            animation: spin 0.6s linear infinite !important;
        }
    </style>
</head>

<body>
    <!-- WhatsApp Floating Button - Modern (abajo a la derecha) -->
    <a href="#" id="whatsapp-chat-float" class="whatsapp-float-modern" title="Chatea por WhatsApp" target="_blank" style="position: fixed !important; right: 30px !important; bottom: 30px !important; z-index: 9998 !important; width: 60px !important; height: 60px !important; display: flex !important; align-items: center !important; justify-content: center !important; border-radius: 50% !important; background: linear-gradient(135deg, #25d366 0%, #128c7e 100%) !important; color: white !important; font-size: 28px !important; box-shadow: 0 8px 32px rgba(0,0,0,0.16) !important;">
         <i class="fab fa-whatsapp"></i>
    </a>
    
    <!-- Floating Cart Button - Modern (arriba a la derecha) -->
    <button class="cart-float-modern cart-float-top" title="Ver carrito" onclick="toggleCartSidebar()" style="position: fixed !important; right: 30px !important; top: 20px !important; z-index: 9998 !important; width: 65px !important; height: 65px !important; display: flex !important; align-items: center !important; justify-content: center !important; border-radius: 50% !important; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; color: white !important; font-size: 30px !important; border: none !important; cursor: pointer !important; box-shadow: 0 8px 32px rgba(0,0,0,0.16) !important; transition: all 0.3s ease !important;">
        <i class="bi bi-cart-plus-fill"></i>
        <span id="cart-badge-float" class="badge rounded-pill bg-danger pulse-animation" style="position: absolute !important; top: -5px !important; right: -5px !important; z-index: 9999 !important; font-size: 13px !important; font-weight: 700 !important; padding: 5px 8px !important; min-width: 24px !important; display: {% if cart_count > 0 %}block{% else %}none{% endif %} !important;">
            {{ cart_count|default:0 }}
        </span>
    </button>
    
    <!-- Mini Cart Flotante Mobile - Solo visible en m칩vil cuando hay productos -->
    <div id="mini-cart-mobile" class="lg:hidden fixed bottom-20 right-4 z-[9999] hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-4 w-72 relative" id="mini-cart-content">
            <!-- Header -->
            <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-200">
                <div class="flex items-center gap-2">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-full w-8 h-8 flex items-center justify-center">
                        <i class="bi bi-cart3 text-sm"></i>
                    </div>
                    <span class="font-bold text-gray-800">Mi Carrito</span>
                    <span id="mini-cart-count" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-semibold">0</span>
                </div>
                <button onclick="closeMiniCart()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
            </div>
            
            <!-- Items Preview -->
            <div class="space-y-2 mb-3 max-h-40 overflow-y-auto" id="mini-cart-items">
                <!-- Se llenar치 din치micamente -->
            </div>
            
            <!-- Total -->
            <div class="border-t border-gray-200 pt-3 mb-3">
                <div class="flex items-center justify-between text-sm mb-1">
                    <span class="text-gray-600">Subtotal:</span>
                    <span class="font-bold text-gray-800" id="mini-cart-subtotal">$0</span>
                </div>
            </div>
            
            <!-- Botones de Acci칩n -->
            <div class="space-y-2">
                <a href="{% url 'checkout' %}" class="block w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-xl font-semibold text-center hover:shadow-lg transition-all">
                    <i class="bi bi-credit-card me-2"></i>Ir a Checkout
                </a>
                <button onclick="viewFullCart()" class="block w-full bg-gray-100 text-gray-700 py-2.5 rounded-xl font-medium text-center hover:bg-gray-200 transition-all text-sm">
                    Ver carrito completo
                </button>
            </div>
            
            <!-- Drag Handle -->
            <div class="absolute -left-3 top-1/2 -translate-y-1/2 bg-gray-200 rounded-l-lg px-1 py-3 cursor-move" id="drag-handle">
                <i class="bi bi-grip-vertical text-gray-400"></i>
            </div>
        </div>
    </div>
    
    <!-- Cart Sidebar Modern -->
    <div id="cart-sidebar-modern" class="cart-sidebar-modern">
        <div class="cart-sidebar-header">
            <h3>
                <i class="bi bi-cart3 me-2"></i>
                Mi Carrito
                <span id="cart-count-sidebar" class="cart-count-badge">{{ cart_count }}</span>
            </h3>
            <div style="display: flex; gap: 0.75rem; align-items: center;">
                <button class="btn btn-primary" onclick="refreshCartSidebar()" id="refresh-cart-btn" title="Actualizar carrito" style="padding: 0.5rem 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; border-radius: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                    <i class="bi bi-arrow-clockwise" style="font-size: 1.1rem;"></i>
                    <span style="font-weight: 600;">Actualizar</span>
                </button>
                <button class="cart-close-btn" onclick="toggleCartSidebar()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        
        <!-- Wrapper para actualizaci칩n din치mica completa -->
        <div id="cart-sidebar-dynamic-content">
            <div class="cart-sidebar-content">
                {% if cart_count > 0 %}
                    <!-- Items del carrito con productos reales -->
                    <div id="cart-items-container" class="cart-items-list">
                    {% for item in cart_items %}
                    <div class="cart-item-card" data-product-id="{{ item.product.id }}">
                        <div class="cart-item-image">
                            {% if item.variant and item.variant.imagen %}
                                <img src="{{ item.variant.imagen.url }}" alt="{{ item.product.name }}">
                            {% elif item.product.imagen %}
                                <img src="{{ item.product.imagen.url }}" alt="{{ item.product.name }}">
                            {% else %}
                                <div class="cart-item-no-image">
                                    <i class="bi bi-image"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="cart-item-details">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h4 class="cart-item-name mb-0">{{ item.product.name|truncatechars:35 }}</h4>
                                <button class="btn btn-sm btn-danger btn-remove-item" 
                                        onclick="removeFromCartSidebar({{ item.product.id }})" 
                                        title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            {% if item.variant %}
                            <p class="cart-item-variant">
                                <i class="bi bi-palette me-1"></i>{{ item.variant.color }}
                            </p>
                            {% endif %}
                            <div class="cart-item-quantity">
                                <span class="quantity-label">Cantidad:</span>
                                <span class="quantity-value">{{ item.quantity }}</span>
                            </div>
                            <div class="cart-item-price">
                                <span class="price-label">Precio:</span>
                                <span class="price-value">${{ item.price|floatformat:0|intcomma }}</span>
                            </div>
                            <div class="cart-item-subtotal">
                                <span class="subtotal-label">Subtotal:</span>
                                <span class="subtotal-value">${{ item.subtotal|floatformat:0|intcomma }} COP</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="cart-empty-state">
                    <i class="bi bi-cart-x"></i>
                    <h4>Tu carrito est치 vac칤o</h4>
                    <p>Agrega productos para empezar a comprar</p>
                    <a href="/store" class="btn-continue-shopping">
                        <i class="bi bi-shop me-2"></i>Ir a la tienda
                    </a>
                    </div>
                {% endif %}
            </div>
            
            {% if cart_count > 0 %}
            <div class="cart-sidebar-footer">
                <div class="cart-total-section">
                    <span class="cart-total-label">Total:</span>
                    <span id="cart-total-amount" class="cart-total-amount">${{ cart_total|floatformat:0|intcomma }} COP</span>
                </div>
                <div class="cart-actions">
                    <a href="/cart" class="btn-view-cart">
                        <i class="bi bi-eye me-2"></i>Ver carrito completo
                    </a>
                    <a href="/checkout" class="btn-checkout-now">
                        <i class="bi bi-lightning-charge-fill me-2"></i>Finalizar compra
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Overlay para cerrar el sidebar -->
    <div id="cart-sidebar-overlay" class="cart-sidebar-overlay" onclick="toggleCartSidebar()"></div>

    <!-- Header Moderno -->
    <header class="modern-header">
        <nav class="main-navbar">
            <div class="container-fluid">
                <div class="navbar-content">
                    <!-- Logo -->
                    <a href="{% url 'home' %}" class="brand-logo">
                        <i class="bi bi-cpu"></i>
                        <span>CompuEasys</span>
                    </a>
                    
                    <!-- B칰squeda Central -->
                    <div class="search-container">
                        <form class="search-form" method="GET" action="{% url 'store' %}">
                            <div class="search-input-group">
                                <i class="bi bi-search search-icon"></i>
                                <input 
                                    type="text" 
                                    name="q" 
                                    class="search-input" 
                                    placeholder="Buscar productos..."
                                    value="{{ query }}"
                                    autocomplete="off"
                                    id="search-input"
                                >
                                <button type="button" class="search-clear" id="search-clear" style="display: none;">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                            <button type="submit" class="search-submit">
                                <i class="bi bi-search"></i>
                                <span>Buscar</span>
                            </button>
                        </form>
                        
                        <!-- Sugerencias de b칰squeda -->
                        <div class="search-suggestions" id="search-suggestions"></div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="header-actions">
                        <!-- Cart -->
                        <a href="{% url 'cart' %}" class="action-btn cart-btn">
                            <i class="bi bi-cart3"></i>
                            <span class="cart-count">{{ cart_count }}</span>
                        </a>
                        
                        <!-- User Menu -->
                        {% if is_logged_in %}
                        <div class="user-menu" style="position: relative;">
                            <button class="action-btn user-btn" id="user-menu-btn" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="bi bi-person-circle"></i>
                                <span>{{ user.name|default:user.email|truncatechars:15 }}</span>
                                <i class="bi bi-chevron-down" style="font-size: 0.8rem;"></i>
                            </button>
                            <div class="user-dropdown" id="user-dropdown" style="display: none; position: absolute; top: 100%; right: 0; background: white; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; margin-top: 0.5rem; z-index: 1000;">
                                <a href="{% url 'mis_pedidos' %}" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #333; text-decoration: none; transition: background 0.2s ease;">
                                    <i class="bi bi-box-seam"></i> Mis Pedidos
                                </a>
                                <a href="{% url 'logout_view' %}" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #333; text-decoration: none; border-top: 1px solid #e9ecef; transition: background 0.2s ease;">
                                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesi칩n
                                </a>
                            </div>
                        </div>
                        {% else %}
                        <a href="{% url 'login_user' %}" class="action-btn login-btn">
                            <i class="bi bi-person"></i>
                            <span>Ingresar</span>
                        </a>
                        {% endif %}
                        
                        <!-- Mobile Menu Toggle -->
                        <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Navigation Links -->
        <nav class="secondary-navbar">
            <div class="container-fluid">
                <ul class="nav-links">
                    <li><a href="{% url 'home' %}"><i class="bi bi-house"></i> Inicio</a></li>
                    <li><a href="{% url 'store' %}" class="active"><i class="bi bi-shop"></i> Tienda</a></li>
                    <li><a href="{% url 'aboutUs' %}"><i class="bi bi-info-circle"></i> Nosotros</a></li>
                    <li><a href="{% url 'services' %}"><i class="bi bi-gear"></i> Servicios</a></li>
                    <li><a href="{% url 'contactUs' %}"><i class="bi bi-envelope"></i> Contacto</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>

    <!-- Main Content con Sidebar Lateral -->
    <main class="bg-gray-50 min-h-screen">
        <div class="flex max-w-[95%] mx-auto gap-6 py-6">
            
            <!-- Sidebar de Categor칤as - Desktop Sticky -->
            <aside class="hidden lg:block w-64 flex-shrink-0">
                <div class="sticky top-20">
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="bi bi-funnel-fill text-blue-600"></i>
                            Categor칤as
                        </h2>
                        
                        <div class="space-y-1">
                            <a href="{% url 'store' %}" 
                               class="flex items-center justify-between px-3 py-2.5 rounded-lg transition-all group {% if not request.GET.category %}bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-md{% else %}hover:bg-gray-50 text-gray-700{% endif %}">
                                <div class="flex items-center gap-2">
                                    <i class="bi bi-grid {% if not request.GET.category %}text-white{% else %}text-blue-600 group-hover:text-blue-700{% endif %}"></i>
                                    <span class="font-medium text-sm">Todos los productos</span>
                                </div>
                                <span class="{% if not request.GET.category %}bg-white/20 text-white{% else %}bg-gray-100 text-gray-600{% endif %} px-2 py-0.5 rounded-full text-xs font-semibold">
                                    {{ products.count }}
                                </span>
                            </a>
                            
                            {% for category in categories %}
                            <a href="?category={{ category.id }}" 
                               class="flex items-center justify-between px-3 py-2.5 rounded-lg transition-all group {% if request.GET.category == category.id|stringformat:'s' %}bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-md{% else %}hover:bg-gray-50 text-gray-700{% endif %}">
                                <div class="flex items-center gap-2">
                                    <i class="bi bi-tag {% if request.GET.category == category.id|stringformat:'s' %}text-white{% else %}text-blue-600 group-hover:text-blue-700{% endif %}"></i>
                                    <span class="font-medium text-sm truncate">{{ category.nombre }}</span>
                                </div>
                                <span class="{% if request.GET.category == category.id|stringformat:'s' %}bg-white/20 text-white{% else %}bg-gray-100 text-gray-600{% endif %} px-2 py-0.5 rounded-full text-xs font-semibold flex-shrink-0">
                                    {{ category.productstore_set.count }}
                                </span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </aside>
            
            <!-- Bot칩n Filtros Mobile -->
            <div class="lg:hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-50">
                <button id="mobile-filter-btn" 
                        class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 font-semibold hover:shadow-xl transition-all">
                    <i class="bi bi-funnel-fill"></i>
                    <span>Filtrar por categor칤a</span>
                    <span class="bg-white/20 px-2 py-0.5 rounded-full text-xs">{{ categories.count }}</span>
                </button>
            </div>
            
            <!-- Modal Filtros Mobile -->
            <div id="mobile-filter-modal" class="lg:hidden fixed inset-0 bg-black/50 z-50 hidden">
                <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[80vh] overflow-hidden flex flex-col">
                    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i class="bi bi-funnel-fill text-blue-600"></i>
                            Filtrar por categor칤a
                        </h3>
                        <button id="close-filter-modal" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                            <i class="bi bi-x-lg text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="overflow-y-auto p-4 space-y-2">
                        <a href="{% url 'store' %}" 
                           class="flex items-center justify-between px-4 py-3 rounded-lg transition-all {% if not request.GET.category %}bg-gradient-to-r from-blue-600 to-purple-600 text-white{% else %}hover:bg-gray-50 text-gray-700{% endif %}">
                            <div class="flex items-center gap-3">
                                <i class="bi bi-grid text-xl"></i>
                                <span class="font-medium">Todos los productos</span>
                            </div>
                            <span class="{% if not request.GET.category %}bg-white/20{% else %}bg-gray-100{% endif %} px-3 py-1 rounded-full text-xs font-semibold">
                                {{ products.count }}
                            </span>
                        </a>
                        
                        {% for category in categories %}
                        <a href="?category={{ category.id }}" 
                           class="flex items-center justify-between px-4 py-3 rounded-lg transition-all {% if request.GET.category == category.id|stringformat:'s' %}bg-gradient-to-r from-blue-600 to-purple-600 text-white{% else %}hover:bg-gray-50 text-gray-700{% endif %}">
                            <div class="flex items-center gap-3">
                                <i class="bi bi-tag text-xl"></i>
                                <span class="font-medium">{{ category.nombre }}</span>
                            </div>
                            <span class="{% if request.GET.category == category.id|stringformat:'s' %}bg-white/20{% else %}bg-gray-100{% endif %} px-3 py-1 rounded-full text-xs font-semibold">
                                {{ category.productstore_set.count }}
                            </span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- 츼rea de Productos -->
            <section class="flex-1 min-w-0">
                <!-- Header con resultados y ordenamiento -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            {% if query %}
                            <p class="text-sm text-gray-600 mb-1">
                                Resultados para <span class="font-semibold text-gray-800">"{{ query }}"</span>
                            </p>
                            {% endif %}
                            <p class="text-lg font-bold text-gray-800">
                                {{ products.count }} producto{{ products.count|pluralize }}
                                {% if current_category %}<span class="text-blue-600"> en {{ current_category.nombre }}</span>{% endif %}
                            </p>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <select class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" id="sort-select">
                                <option value="name">Ordenar por nombre</option>
                                <option value="price_low">Precio: menor a mayor</option>
                                <option value="price_high">Precio: mayor a menor</option>
                                <option value="newest">M치s recientes</option>
                            </select>
                        </div>
                    </div>
                </div>
                    
                    <!-- Products Grid -->
                    <div id="products-container">
                        {% if products %}
                        <!-- Productos agrupados por categor칤a -->
                        {% for category_name, category_products in products_by_category.items %}
                        <div class="mb-8" data-category-id="{{ forloop.counter }}">
                            <div class="mb-6">
                                <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                                    <i class="bi bi-tag-fill text-blue-600"></i>
                                    {{ category_name }}
                                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-semibold">
                                        {{ category_products|length }}
                                    </span>
                                </h2>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6" id="products-grid-{{ forloop.counter }}">
                            {% for product in category_products %}
                            <!-- Product Card Moderno con Tailwind -->
                            <article class="group bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 flex flex-col" 
                                     data-product-id="{{ product.id }}"
                                     data-gallery-images='[{% if product.imagen and product.imagen.name %}"{{ product.imagen.url }}"{% endif %}{% for img in product.galeria.all %}{% if img.galeria and img.galeria.name %}, "{{ img.galeria.url }}"{% endif %}{% endfor %}]'>
                                
                                <!-- Imagen del Producto - Limpia sin badges -->
                                <div class="relative aspect-square overflow-hidden bg-gray-50">
                                    <a href="{% url 'product_detail' product.id %}" class="block h-full">
                                        {% if product.imagen and product.imagen.name %}
                                        <img 
                                            src="{{ product.imagen.url }}" 
                                            alt="{{ product.name }}"
                                            class="w-full h-full object-contain p-4 group-hover:scale-105 transition-transform duration-300"
                                            loading="lazy"
                                        >
                                        {% else %}
                                        <div class="w-full h-full flex flex-col items-center justify-center text-gray-300">
                                            <i class="bi bi-image text-5xl"></i>
                                            <span class="text-sm mt-2">Sin imagen</span>
                                        </div>
                                        {% endif %}
                                    </a>
                                </div>
                                
                                <!-- Contenido del Card -->
                                <div class="p-3 md:p-4 flex flex-col flex-grow">
                                    <!-- Categor칤a -->
                                    {% if product.category %}
                                    <span class="text-xs text-gray-500 mb-1 truncate">{{ product.category.nombre }}</span>
                                    {% endif %}
                                    
                                    <!-- T칤tulo -->
                                    <h3 class="text-sm md:text-base font-semibold text-gray-800 mb-2 line-clamp-2 hover:text-blue-600 transition-colors min-h-[2.5rem] md:min-h-[3rem]">
                                        <a href="{% url 'product_detail' product.id %}">
                                            {{ product.name }}
                                        </a>
                                    </h3>
                                    
                                    <!-- Spacer para empujar precio y stock al fondo -->
                                    <div class="flex-grow"></div>
                                    
                                    <!-- Precio -->
                                    <div class="mb-3">
                                        <div class="flex items-baseline gap-1">
                                            <span class="text-xl md:text-2xl font-bold text-gray-900">${{ product.price|intcomma }}</span>
                                            <span class="text-xs text-gray-500">COP</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Stock Info - Abajo y limpio -->
                                    <div class="mb-3">
                                        {% if product.stock > 0 %}
                                        <div class="flex items-center gap-2 text-xs">
                                            <span class="flex items-center gap-1 text-green-600 font-medium">
                                                <i class="bi bi-check-circle-fill"></i>
                                                Disponible
                                            </span>
                                            <span class="text-gray-500">{{ product.stock }} unidades</span>
                                        </div>
                                        {% else %}
                                        <div class="flex items-center gap-1 text-xs text-red-600 font-medium">
                                            <i class="bi bi-x-circle-fill"></i>
                                            Agotado
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Bot칩n de Acci칩n -->
                                    {% if product.stock > 0 %}
                                    <form class="add-to-cart-form w-full" data-product="{{ product.id }}">
                                        {% csrf_token %}
                                        <input type="hidden" name="quantity" value="1">
                                        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-2.5 px-4 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2 text-sm md:text-base">
                                            <i class="bi bi-cart-plus text-lg"></i>
                                            <span>Agregar</span>
                                        </button>
                                    </form>
                                    {% else %}
                                    <button class="btn-notify-stock w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2 text-sm md:text-base" data-product="{{ product.id }}">
                                        <i class="bi bi-bell"></i>
                                        <span>Notificar</span>
                                    </button>
                                    {% endif %}
                                </div>
                            </article>
                            {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <!-- Empty State -->
                        <div class="text-center py-16">
                            <i class="bi bi-search text-6xl text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">No se encontraron productos</h3>
                            <p class="text-gray-600 mb-6">
                                {% if query %}
                                No hay resultados para "{{ query }}"
                                {% else %}
                                No hay productos disponibles en esta categor칤a
                                {% endif %}
                            </p>
                            {% if query %}
                            <a href="{% url 'store' %}" class="inline-flex items-center gap-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                                Ver todos los productos
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </section>
            </div>
        </div>
    </main>
   
   
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Informaci칩n del usuario para notificaciones
        window.userData = {
            isAuthenticated: {{ is_logged_in|yesno:"true,false" }},
            email: {% if user and user.email %}'{{ user.email|escapejs }}'{% else %}null{% endif %},
            name: {% if user and user.name %}'{{ user.name|escapejs }}'{% else %}{% if user and user.username %}'{{ user.username|escapejs }}'{% else %}null{% endif %}{% endif %}
        };
        console.log('游댏 User Data:', window.userData); // Debug
        console.log('游댏 isAuthenticated:', window.userData.isAuthenticated);
        console.log('游댏 email:', window.userData.email);
        console.log('游댏 name:', window.userData.name);
    </script>
    <script src="{% static 'js/store.js' %}?v=1.5"></script>

    <!-- Cart Sidebar Scripts -->
    <script>
    // ===== WHATSAPP INTEGRATION =====
    const whatsappBtn = document.getElementById('whatsapp-chat-float');
    if (whatsappBtn) {
        whatsappBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const numero = "573007915262";
            const mensaje = encodeURIComponent('춰Hola! 游녦\nEstoy interesado en conocer m치s sobre sus productos.\n\n쯇ueden ayudarme?');
            const url = `https://wa.me/${numero}?text=${mensaje}`;
            window.open(url, "_blank");
        });
    }

    // ===== MINI CART MOBILE FLOTANTE =====
    const miniCartMobile = document.getElementById('mini-cart-mobile');
    const miniCartContent = document.getElementById('mini-cart-content');
    const dragHandle = document.getElementById('drag-handle');
    let isDragging = false;
    let currentX, currentY, initialX, initialY;
    
    // Funci칩n para mostrar el mini cart
    function showMiniCart() {
        if (window.innerWidth < 1024 && miniCartMobile) { // Solo en m칩vil
            miniCartMobile.classList.remove('hidden');
            updateMiniCart();
            
            // Auto-ocultar despu칠s de 5 segundos
            setTimeout(() => {
                if (!isDragging) {
                    miniCartMobile.classList.add('opacity-50');
                }
            }, 5000);
        }
    }
    
    // Funci칩n para cerrar el mini cart
    function closeMiniCart() {
        if (miniCartMobile) {
            miniCartMobile.classList.add('hidden');
        }
    }
    window.closeMiniCart = closeMiniCart;
    
    // Funci칩n para ver el carrito completo
    function viewFullCart() {
        toggleCartSidebar();
        closeMiniCart();
    }
    window.viewFullCart = viewFullCart;
    
    // Actualizar contenido del mini cart
    async function updateMiniCart() {
        try {
            const response = await fetch('/cart-preview/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Actualizar contador
                const miniCartCount = document.getElementById('mini-cart-count');
                if (miniCartCount) {
                    miniCartCount.textContent = data.cart_count || 0;
                }
                
                // Actualizar subtotal
                const miniCartSubtotal = document.getElementById('mini-cart-subtotal');
                if (miniCartSubtotal) {
                    miniCartSubtotal.textContent = data.cart_total || '$0';
                }
                
                // Actualizar items
                const miniCartItems = document.getElementById('mini-cart-items');
                if (miniCartItems && data.cart_items) {
                    miniCartItems.innerHTML = data.cart_items.map(item => `
                        <div class="flex items-center gap-2 bg-gray-50 rounded-lg p-2">
                            <div class="w-12 h-12 bg-white rounded flex-shrink-0 overflow-hidden">
                                ${item.image ? 
                                    `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-contain">` : 
                                    '<i class="bi bi-image text-2xl text-gray-300"></i>'
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-semibold text-gray-800 truncate">${item.name}</p>
                                <p class="text-xs text-gray-600">${item.quantity} x ${item.price}</p>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Si no hay items, ocultar el mini cart
                if (data.cart_count === 0) {
                    closeMiniCart();
                }
            }
        } catch (error) {
            console.error('Error actualizando mini cart:', error);
        }
    }
    
    // Drag functionality
    if (dragHandle && miniCartContent) {
        dragHandle.addEventListener('touchstart', dragStart);
        dragHandle.addEventListener('mousedown', dragStart);
        
        function dragStart(e) {
            if (e.type === 'touchstart') {
                initialX = e.touches[0].clientX - miniCartMobile.offsetLeft;
                initialY = e.touches[0].clientY - miniCartMobile.offsetTop;
            } else {
                initialX = e.clientX - miniCartMobile.offsetLeft;
                initialY = e.clientY - miniCartMobile.offsetTop;
            }
            
            isDragging = true;
            miniCartMobile.classList.remove('opacity-50');
            
            document.addEventListener('touchmove', drag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchend', dragEnd);
            document.addEventListener('mouseup', dragEnd);
        }
        
        function drag(e) {
            if (!isDragging) return;
            
            e.preventDefault();
            
            if (e.type === 'touchmove') {
                currentX = e.touches[0].clientX - initialX;
                currentY = e.touches[0].clientY - initialY;
            } else {
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
            }
            
            // Limitar el movimiento dentro de la pantalla
            const maxX = window.innerWidth - miniCartMobile.offsetWidth;
            const maxY = window.innerHeight - miniCartMobile.offsetHeight;
            
            currentX = Math.max(0, Math.min(currentX, maxX));
            currentY = Math.max(0, Math.min(currentY, maxY));
            
            miniCartMobile.style.left = currentX + 'px';
            miniCartMobile.style.top = currentY + 'px';
            miniCartMobile.style.right = 'auto';
            miniCartMobile.style.bottom = 'auto';
        }
        
        function dragEnd() {
            isDragging = false;
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchend', dragEnd);
            document.removeEventListener('mouseup', dragEnd);
        }
    }
    
    // Interceptar los formularios de agregar al carrito
    document.addEventListener('submit', function(e) {
        if (e.target.classList.contains('add-to-cart-form')) {
            // Esperar un momento para que se agregue el producto
            setTimeout(() => {
                showMiniCart();
            }, 500);
        }
    });

    // ===== MODAL FILTROS MOBILE =====
    const mobileFilterBtn = document.getElementById('mobile-filter-btn');
    const mobileFilterModal = document.getElementById('mobile-filter-modal');
    const closeFilterModal = document.getElementById('close-filter-modal');
    
    if (mobileFilterBtn && mobileFilterModal) {
        mobileFilterBtn.addEventListener('click', () => {
            mobileFilterModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });
        
        const closeModal = () => {
            mobileFilterModal.classList.add('hidden');
            document.body.style.overflow = '';
        };
        
        if (closeFilterModal) {
            closeFilterModal.addEventListener('click', closeModal);
        }
        
        // Cerrar al hacer clic fuera del modal
        mobileFilterModal.addEventListener('click', (e) => {
            if (e.target === mobileFilterModal) {
                closeModal();
            }
        });
        
        // Cerrar al seleccionar una categor칤a
        const categoryLinks = mobileFilterModal.querySelectorAll('a');
        categoryLinks.forEach(link => {
            link.addEventListener('click', closeModal);
        });
    }

    // ===== CART FLOAT BUTTON SCROLL EFFECT =====
    window.addEventListener('scroll', function() {
        const cartBtn = document.querySelector('.cart-float-modern');
        if (cartBtn) {
            if (window.scrollY > 100) {
                cartBtn.classList.add('scrolled');
            } else {
                cartBtn.classList.remove('scrolled');
            }
        }
    });

    // ===== MOBILE MENU TOGGLE =====
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const secondaryNavbar = document.querySelector('.secondary-navbar');
    
    // Crear overlay para men칰 m칩vil
    let menuOverlay = document.getElementById('menu-overlay');
    if (!menuOverlay) {
        menuOverlay = document.createElement('div');
        menuOverlay.id = 'menu-overlay';
        menuOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            transition: opacity 0.3s ease;
        `;
        document.body.appendChild(menuOverlay);
    }
    
    if (mobileMenuToggle && secondaryNavbar) {
        mobileMenuToggle.addEventListener('click', function() {
            const isActive = secondaryNavbar.classList.toggle('active');
            mobileMenuToggle.classList.toggle('active');
            
            if (isActive) {
                menuOverlay.style.display = 'block';
                setTimeout(() => menuOverlay.style.opacity = '1', 10);
                document.body.style.overflow = 'hidden';
            } else {
                menuOverlay.style.opacity = '0';
                setTimeout(() => menuOverlay.style.display = 'none', 300);
                document.body.style.overflow = '';
            }
        });
        
        // Cerrar men칰 al hacer click en el overlay
        menuOverlay.addEventListener('click', function() {
            secondaryNavbar.classList.remove('active');
            mobileMenuToggle.classList.remove('active');
            menuOverlay.style.opacity = '0';
            setTimeout(() => menuOverlay.style.display = 'none', 300);
            document.body.style.overflow = '';
        });
        
        // Cerrar men칰 al hacer click en un enlace
        const navLinks = secondaryNavbar.querySelectorAll('.nav-links a');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                secondaryNavbar.classList.remove('active');
                mobileMenuToggle.classList.remove('active');
                menuOverlay.style.opacity = '0';
                setTimeout(() => menuOverlay.style.display = 'none', 300);
                document.body.style.overflow = '';
            });
        });
    }

    // ===== USER MENU DROPDOWN =====
    const userMenuBtn = document.getElementById('user-menu-btn');
    const userDropdown = document.getElementById('user-dropdown');
    
    if (userMenuBtn && userDropdown) {
        userMenuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            userDropdown.style.display = userDropdown.style.display === 'none' ? 'block' : 'none';
        });
        
        // Cerrar al hacer click fuera
        document.addEventListener('click', function(e) {
            if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.style.display = 'none';
            }
        });
        
        // Hover effects
        const dropdownItems = userDropdown.querySelectorAll('a');
        dropdownItems.forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.background = '#f8f9fa';
            });
            item.addEventListener('mouseleave', function() {
                this.style.background = 'transparent';
            });
        });
    }

    // ===== CART SIDEBAR FUNCTIONALITY =====
    function toggleCartSidebar() {
        const sidebar = document.getElementById('cart-sidebar-modern');
        const overlay = document.getElementById('cart-sidebar-overlay');
        
        if (sidebar && overlay) {
            const isActive = sidebar.classList.contains('active');
            
            if (isActive) {
                // Cerrar
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            } else {
                // Abrir y recargar contenido del carrito
                sidebar.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Recargar productos del carrito cuando se abre
                if (window.StoreManagers && window.StoreManagers.Cart) {
                    window.StoreManagers.Cart.loadCartPreview();
                }
            }
        }
    }

    // Cerrar sidebar con tecla ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const sidebar = document.getElementById('cart-sidebar-modern');
            if (sidebar && sidebar.classList.contains('active')) {
                toggleCartSidebar();
            }
        }
    });

    // ===== ACTUALIZAR CARRITO MANUALMENTE =====
    async function refreshCartSidebar() {
        console.log('游댃 [RefreshCart] Bot칩n clickeado');
        const refreshBtn = document.getElementById('refresh-cart-btn');
        
        if (!refreshBtn) {
            console.error('仇 Bot칩n de actualizar no encontrado');
            return;
        }
        
        try {
            // Deshabilitar y animar
            refreshBtn.disabled = true;
            refreshBtn.classList.add('spinning');
            console.log('游댃 [RefreshCart] Iniciando actualizaci칩n...');
            
            // SIEMPRE usar fetch directo para asegurar datos actualizados
            console.log('游닍 [RefreshCart] Usando fetch directo');
            const response = await fetch('/cart-preview/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                },
                cache: 'no-store'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('游닍 [RefreshCart] Respuesta completa:', data);
            console.log('游닍 [RefreshCart] Items en carrito:', data.debug?.items_in_cart || 'N/A');
            console.log('游닍 [RefreshCart] Total cantidad:', data.debug?.total_quantity || 'N/A');
            console.log('游닍 [RefreshCart] HTML length:', data.cart_items_html?.length || 0);
            
            if (data.success) {
                // Actualizar TODO el contenido din치mico del sidebar (content + footer)
                const dynamicContent = document.getElementById('cart-sidebar-dynamic-content');
                if (dynamicContent) {
                    console.log('游닍 [RefreshCart] Dynamic content encontrado, actualizando...');
                    console.log('游닍 [RefreshCart] HTML antes:', dynamicContent.innerHTML.length);
                    dynamicContent.innerHTML = data.cart_content_html;
                    console.log('游닍 [RefreshCart] HTML despu칠s:', dynamicContent.innerHTML.length);
                    console.log('九 [RefreshCart] Dynamic content actualizado completamente (items + footer)');
                } else {
                    console.error('仇 [RefreshCart] Dynamic content NO encontrado');
                }
                
                // Actualizar todos los badges
                const badges = [
                    document.getElementById('cart-count-sidebar'),
                    ...document.querySelectorAll('.cart-count')
                ];
                
                badges.forEach((badge, index) => {
                    if (badge) {
                        badge.textContent = data.cart_count;
                        console.log(`九 [RefreshCart] Badge ${index} actualizado a ${data.cart_count}`);
                    }
                });
                
                // Actualizar total en el footer si existe
                const totalAmount = document.getElementById('cart-total-amount');
                if (totalAmount) {
                    totalAmount.textContent = data.cart_total;
                    console.log(`九 [RefreshCart] Total actualizado a ${data.cart_total}`);
                }
            } else {
                console.error('仇 [RefreshCart] Respuesta sin success=true');
            }
            
            console.log('九 [RefreshCart] Carrito actualizado exitosamente');
            
            // Mostrar feedback visual
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: '춰Carrito actualizado!',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true
                });
            }
        } catch (error) {
            console.error('仇 [RefreshCart] Error:', error);
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error al actualizar',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        } finally {
            if (refreshBtn) {
                setTimeout(() => {
                    refreshBtn.disabled = false;
                    refreshBtn.classList.remove('spinning');
                    console.log('游댃 [RefreshCart] Bot칩n restaurado');
                }, 500);
            }
        }
    }
    
    // Hacer la funci칩n global
    window.refreshCartSidebar = refreshCartSidebar;

    // ===== ELIMINAR PRODUCTO DEL CARRITO FLOTANTE =====
    async function removeFromCartSidebar(productId) {
        console.log('游딈勇 [RemoveFromCart] Eliminando producto:', productId);

        try {
            const response = await fetch(`/remove_from_cart/${productId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (response.ok) {
                console.log('九 [RemoveFromCart] Producto eliminado');
                
                // Recargar el carrito usando fetch directo (igual que refreshCartSidebar)
                const cartResponse = await fetch('/cart-preview/', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    cache: 'no-store'
                });
                
                const cartData = await cartResponse.json();
                console.log('游닍 [RemoveFromCart] Datos actualizados:', cartData);
                
                if (cartData.success) {
                    // Actualizar TODO el contenido din치mico del sidebar
                    const dynamicContent = document.getElementById('cart-sidebar-dynamic-content');
                    if (dynamicContent) {
                        dynamicContent.innerHTML = cartData.cart_content_html;
                        console.log('九 [RemoveFromCart] Dynamic content actualizado (items + footer)');
                    }
                    
                    // Actualizar badges
                    const badge = document.getElementById('cart-count-sidebar');
                    if (badge) badge.textContent = cartData.cart_count;
                    
                    const badges = document.querySelectorAll('.cart-count');
                    badges.forEach(b => b.textContent = cartData.cart_count);
                    
                    // Actualizar total
                    const totalAmount = document.getElementById('cart-total-amount');
                    if (totalAmount) totalAmount.textContent = cartData.cart_total;
                    
                    console.log('九 [RemoveFromCart] Todo actualizado correctamente');
                }
            } else {
                throw new Error('Error al eliminar');
            }
        } catch (error) {
            console.error('Error eliminando producto:', error);
            alert('Error al eliminar el producto. Intenta nuevamente.');
        }
    }

    // Funci칩n auxiliar para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>

    <!-- WebSocket para registrar visitas en tiempo real -->
    <!-- NOTA: WebSocket deshabilitado temporalmente para evitar errores en consola -->
    <!-- Para habilitar: descomentar el bloque y asegurarse de que Redis/Channel Layers est칠 configurado -->
    <!--
    <script>
    (function() {
        // Detectar si es local o producci칩n
        var ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        var ws_path = ws_scheme + '://' + window.location.host + '/ws/store/';
        
        try {
            var storeSocket = new WebSocket(ws_path);

            storeSocket.onopen = function(e) {
                console.log('[WebSocket] Conectado para visitas en tienda');
            };
            storeSocket.onmessage = function(e) {
                var data = JSON.parse(e.data);
                if (data.message === 'visit_registered') {
                    console.log('[WebSocket] Visita registrada:', data.timestamp);
                }
            };
            storeSocket.onerror = function(e) {
                console.warn('[WebSocket] Error de conexi칩n (normal en desarrollo sin Redis)');
            };
            storeSocket.onclose = function(e) {
                console.log('[WebSocket] Desconectado');
            };
        } catch (error) {
            console.warn('[WebSocket] No disponible:', error.message);
        }
    })();
    </script>
    -->
    
    <script>
    // ===== COMPARTIR CATEGOR칈A =====
    function shareCategoryLink(categoryName, buttonElement) {
        // Obtener el ID de categor칤a desde el elemento padre
        const categorySection = buttonElement.closest('[data-category-id]');
        
        // Si no hay data-category-id, buscar en el filtro lateral
        let categoryId = null;
        const currentUrl = new URL(window.location.href);
        categoryId = currentUrl.searchParams.get('category');
        
        // Si a칰n no hay ID, tratar de obtenerlo del nombre
        if (!categoryId) {
            // Buscar en el filtro lateral por el nombre de categor칤a
            const categoryInputs = document.querySelectorAll('input[name="category"]');
            categoryInputs.forEach(input => {
                const label = input.closest('label');
                if (label && label.textContent.includes(categoryName)) {
                    categoryId = input.value;
                }
            });
        }
        
        // Construir URL completa
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = categoryId ? `${baseUrl}?category=${categoryId}` : window.location.href;
        
        // Intentar usar Web Share API
        if (navigator.share) {
            navigator.share({
                title: `${categoryName} - CompuEasys`,
                text: `Mira nuestros productos en ${categoryName}`,
                url: shareUrl
            }).then(() => {
                showShareToast('춰Enlace compartido!', 'success');
            }).catch((error) => {
                if (error.name !== 'AbortError') {
                    copyToClipboard(shareUrl, categoryName);
                }
            });
        } else {
            copyToClipboard(shareUrl, categoryName);
        }
    }
    
    function copyToClipboard(url, categoryName) {
        navigator.clipboard.writeText(url).then(() => {
            showShareToast(`Enlace de ${categoryName} copiado al portapapeles`, 'success');
        }).catch(() => {
            // Fallback para navegadores antiguos
            const tempInput = document.createElement('input');
            tempInput.value = url;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showShareToast(`Enlace de ${categoryName} copiado`, 'success');
        });
    }
    
    function showShareToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
        toast.style.cssText = 'z-index: 9999; animation: slideDown 0.3s ease;';
        toast.innerHTML = `
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'}-fill me-2"></i>
            ${message}
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 2500);
    }
    
    // Estilos de animaci칩n
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, -100%); opacity: 0; }
        }
        .share-category-btn {
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        .share-category-btn:hover {
            transform: scale(1.05);
        }
    `;
    document.head.appendChild(style);
    </script>
</body>
</html>