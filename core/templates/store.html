{% load static %} {% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if current_category %}{{ current_category.nombre }} - {% endif %}Tienda CompuEasys</title>
    
    <!-- CSS Ultra Moderno -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/store.css' %}?v=8.2">
    <link rel="stylesheet" href="{% static 'css/detail_modern.css' %}?v=1.3">
    
    <!-- Preload cr√≠tico -->
    <link rel="preload" href="{% static 'js/store.js' %}" as="script">
    
    <!-- Meta tags para SEO -->
    <meta name="description" content="Tienda online CompuEasys - Encuentra los mejores productos tecnol√≥gicos al mejor precio">
    <meta name="keywords" content="tecnolog√≠a, computadoras, accesorios, CompuEasys">
    
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        #refresh-cart-btn {
            transition: all 0.3s ease !important;
            cursor: pointer !important;
        }
        
        #refresh-cart-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05) !important;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5) !important;
            filter: brightness(1.1) !important;
        }
        
        #refresh-cart-btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98) !important;
        }
        
        #refresh-cart-btn:disabled {
            opacity: 0.7 !important;
            cursor: not-allowed !important;
        }
        
        #refresh-cart-btn.spinning i {
            animation: spin 0.6s linear infinite !important;
        }
    </style>
</head>

<body>
    <!-- WhatsApp Floating Button - Modern (abajo a la derecha) -->
    <a href="#" id="whatsapp-chat-float" class="whatsapp-float-modern" title="Chatea por WhatsApp" target="_blank" style="position: fixed !important; right: 30px !important; bottom: 30px !important; z-index: 9998 !important; width: 60px !important; height: 60px !important; display: flex !important; align-items: center !important; justify-content: center !important; border-radius: 50% !important; background: linear-gradient(135deg, #25d366 0%, #128c7e 100%) !important; color: white !important; font-size: 28px !important; box-shadow: 0 8px 32px rgba(0,0,0,0.16) !important;">
         <i class="fab fa-whatsapp"></i>
    </a>
    
    <!-- Floating Cart Button - Modern (arriba a la derecha) -->
    <button class="cart-float-modern cart-float-top" title="Ver carrito" onclick="toggleCartSidebar()" style="position: fixed !important; right: 30px !important; top: 20px !important; z-index: 9998 !important; width: 65px !important; height: 65px !important; display: flex !important; align-items: center !important; justify-content: center !important; border-radius: 50% !important; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; color: white !important; font-size: 30px !important; border: none !important; cursor: pointer !important; box-shadow: 0 8px 32px rgba(0,0,0,0.16) !important; transition: all 0.3s ease !important;">
        <i class="bi bi-cart-plus-fill"></i>
        <span id="cart-badge-float" class="badge rounded-pill bg-danger pulse-animation" style="position: absolute !important; top: -5px !important; right: -5px !important; z-index: 9999 !important; font-size: 13px !important; font-weight: 700 !important; padding: 5px 8px !important; min-width: 24px !important; display: {% if cart_count > 0 %}block{% else %}none{% endif %} !important;">
            {{ cart_count|default:0 }}
        </span>
    </button>
    
    <!-- Cart Sidebar Modern -->
    <div id="cart-sidebar-modern" class="cart-sidebar-modern">
        <div class="cart-sidebar-header">
            <h3>
                <i class="bi bi-cart3 me-2"></i>
                Mi Carrito
                <span id="cart-count-sidebar" class="cart-count-badge">{{ cart_count }}</span>
            </h3>
            <div style="display: flex; gap: 0.75rem; align-items: center;">
                <button class="btn btn-primary" onclick="refreshCartSidebar()" id="refresh-cart-btn" title="Actualizar carrito" style="padding: 0.5rem 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; border-radius: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                    <i class="bi bi-arrow-clockwise" style="font-size: 1.1rem;"></i>
                    <span style="font-weight: 600;">Actualizar</span>
                </button>
                <button class="cart-close-btn" onclick="toggleCartSidebar()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        
        <!-- Wrapper para actualizaci√≥n din√°mica completa -->
        <div id="cart-sidebar-dynamic-content">
            <div class="cart-sidebar-content">
                {% if cart_count > 0 %}
                    <!-- Items del carrito con productos reales -->
                    <div id="cart-items-container" class="cart-items-list">
                    {% for item in cart_items %}
                    <div class="cart-item-card" data-product-id="{{ item.product.id }}">
                        <div class="cart-item-image">
                            {% if item.variant and item.variant.imagen %}
                                <img src="{{ item.variant.imagen.url }}" alt="{{ item.product.name }}">
                            {% elif item.product.imagen %}
                                <img src="{{ item.product.imagen.url }}" alt="{{ item.product.name }}">
                            {% else %}
                                <div class="cart-item-no-image">
                                    <i class="bi bi-image"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="cart-item-details">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h4 class="cart-item-name mb-0">{{ item.product.name|truncatechars:35 }}</h4>
                                <button class="btn btn-sm btn-danger btn-remove-item" 
                                        onclick="removeFromCartSidebar({{ item.product.id }})" 
                                        title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            {% if item.variant %}
                            <p class="cart-item-variant">
                                <i class="bi bi-palette me-1"></i>{{ item.variant.color }}
                            </p>
                            {% endif %}
                            <div class="cart-item-quantity">
                                <span class="quantity-label">Cantidad:</span>
                                <span class="quantity-value">{{ item.quantity }}</span>
                            </div>
                            <div class="cart-item-price">
                                <span class="price-label">Precio:</span>
                                <span class="price-value">${{ item.price|floatformat:0|intcomma }}</span>
                            </div>
                            <div class="cart-item-subtotal">
                                <span class="subtotal-label">Subtotal:</span>
                                <span class="subtotal-value">${{ item.subtotal|floatformat:0|intcomma }} COP</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="cart-empty-state">
                    <i class="bi bi-cart-x"></i>
                    <h4>Tu carrito est√° vac√≠o</h4>
                    <p>Agrega productos para empezar a comprar</p>
                    <a href="/store" class="btn-continue-shopping">
                        <i class="bi bi-shop me-2"></i>Ir a la tienda
                    </a>
                    </div>
                {% endif %}
            </div>
            
            {% if cart_count > 0 %}
            <div class="cart-sidebar-footer">
                <div class="cart-total-section">
                    <span class="cart-total-label">Total:</span>
                    <span id="cart-total-amount" class="cart-total-amount">${{ cart_total|floatformat:0|intcomma }} COP</span>
                </div>
                <div class="cart-actions">
                    <a href="/cart" class="btn-view-cart">
                        <i class="bi bi-eye me-2"></i>Ver carrito completo
                    </a>
                    <a href="/checkout" class="btn-checkout-now">
                        <i class="bi bi-lightning-charge-fill me-2"></i>Finalizar compra
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Overlay para cerrar el sidebar -->
    <div id="cart-sidebar-overlay" class="cart-sidebar-overlay" onclick="toggleCartSidebar()"></div>

    <!-- Header Moderno -->
    <header class="modern-header">
        <nav class="main-navbar">
            <div class="container-fluid">
                <div class="navbar-content">
                    <!-- Logo -->
                    <a href="{% url 'home' %}" class="brand-logo">
                        <i class="bi bi-cpu"></i>
                        <span>CompuEasys</span>
                    </a>
                    
                    <!-- B√∫squeda Central -->
                    <div class="search-container">
                        <form class="search-form" method="GET" action="{% url 'store' %}">
                            <div class="search-input-group">
                                <i class="bi bi-search search-icon"></i>
                                <input 
                                    type="text" 
                                    name="q" 
                                    class="search-input" 
                                    placeholder="Buscar productos..."
                                    value="{{ query }}"
                                    autocomplete="off"
                                    id="search-input"
                                >
                                <button type="button" class="search-clear" id="search-clear" style="display: none;">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                            <button type="submit" class="search-submit">
                                <i class="bi bi-search"></i>
                                <span>Buscar</span>
                            </button>
                        </form>
                        
                        <!-- Sugerencias de b√∫squeda -->
                        <div class="search-suggestions" id="search-suggestions"></div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="header-actions">
                        <!-- Cart -->
                        <a href="{% url 'cart' %}" class="action-btn cart-btn">
                            <i class="bi bi-cart3"></i>
                            <span class="cart-count">{{ cart_count }}</span>
                        </a>
                        
                        <!-- User Menu -->
                        {% if is_logged_in %}
                        <div class="user-menu" style="position: relative;">
                            <button class="action-btn user-btn" id="user-menu-btn" style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="bi bi-person-circle"></i>
                                <span>{{ user.name|default:user.email|truncatechars:15 }}</span>
                                <i class="bi bi-chevron-down" style="font-size: 0.8rem;"></i>
                            </button>
                            <div class="user-dropdown" id="user-dropdown" style="display: none; position: absolute; top: 100%; right: 0; background: white; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; margin-top: 0.5rem; z-index: 1000;">
                                <a href="{% url 'mis_pedidos' %}" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #333; text-decoration: none; transition: background 0.2s ease;">
                                    <i class="bi bi-box-seam"></i> Mis Pedidos
                                </a>
                                <a href="{% url 'logout_view' %}" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #333; text-decoration: none; border-top: 1px solid #e9ecef; transition: background 0.2s ease;">
                                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
                                </a>
                            </div>
                        </div>
                        {% else %}
                        <a href="{% url 'login_user' %}" class="action-btn login-btn">
                            <i class="bi bi-person"></i>
                            <span>Ingresar</span>
                        </a>
                        {% endif %}
                        
                        <!-- Mobile Menu Toggle -->
                        <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Navigation Links -->
        <nav class="secondary-navbar">
            <div class="container-fluid">
                <ul class="nav-links">
                    <li><a href="{% url 'home' %}"><i class="bi bi-house"></i> Inicio</a></li>
                    <li><a href="{% url 'store' %}" class="active"><i class="bi bi-shop"></i> Tienda</a></li>
                    <li><a href="{% url 'aboutUs' %}"><i class="bi bi-info-circle"></i> Nosotros</a></li>
                    <li><a href="{% url 'services' %}"><i class="bi bi-gear"></i> Servicios</a></li>
                    <li><a href="{% url 'contactUs' %}"><i class="bi bi-envelope"></i> Contacto</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>

    <!-- Categories Bar - Horizontal -->
    <div class="categories-bar">
        <div class="container-fluid">
            <div class="categories-scroll">
                <a href="{% url 'store' %}" class="category-chip {% if not request.GET.category %}active{% endif %}">
                    <i class="bi bi-grid"></i>
                    <span>Todos</span>
                    <span class="chip-count">{{ products.count }}</span>
                </a>
                {% for category in categories %}
                <a href="?category={{ category.id }}" class="category-chip {% if request.GET.category == category.id|stringformat:'s' %}active{% endif %}">
                    <i class="bi bi-tag"></i>
                    <span>{{ category.nombre }}</span>
                    <span class="chip-count">{{ category.productstore_set.count }}</span>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="store-main">
        <div class="container-fluid">
            <div class="store-layout-full">
                <!-- Products Area -->
                <section class="products-area-full">
                    <!-- Toolbar -->
                    <div class="products-toolbar">
                        <div class="toolbar-left">
                            <div class="results-info">
                                {% if query %}
                                <span class="search-query">
                                    Resultados para "<strong>{{ query }}</strong>"
                                </span>
                                {% endif %}
                                <span class="results-count">
                                    {{ products.count }} producto{{ products.count|pluralize }}
                                    {% if current_category %} en {{ current_category.nombre }}{% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <div class="toolbar-right">
                            <!-- Sort -->
                            <div class="sort-dropdown">
                                <select class="sort-select" id="sort-select">
                                    <option value="name">Ordenar por nombre</option>
                                    <option value="price_low">Precio: menor a mayor</option>
                                    <option value="price_high">Precio: mayor a menor</option>
                                    <option value="newest">M√°s recientes</option>
                                </select>
                            </div>
                            
                            <!-- View Mode -->
                            <div class="view-mode-toggle">
                                <button type="button" class="view-btn active" data-view="grid">
                                    <i class="bi bi-grid"></i>
                                </button>
                                <button type="button" class="view-btn" data-view="list">
                                    <i class="bi bi-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Products Grid -->
                    <div class="products-container" id="products-container">
                        {% if products %}
                        <!-- Productos agrupados por categor√≠a -->
                        {% for category_name, category_products in products_by_category.items %}
                        <div class="category-section mb-5" data-category-id="{{ forloop.counter }}">
                            <div class="category-header mb-4 d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-3">
                                    <h2 class="category-title mb-0">
                                        <i class="bi bi-tag-fill"></i> {{ category_name }}
                                    </h2>
                                    <span class="category-count badge bg-primary">
                                        {{ category_products|length }} producto{{ category_products|length|pluralize }}
                                    </span>
                                </div>
                                <button class="btn btn-outline-primary btn-sm share-category-btn" 
                                        onclick="shareCategoryLink('{{ category_name|escapejs }}', this)"
                                        title="Compartir categor√≠a">
                                    <i class="bi bi-share-fill me-1"></i> Compartir
                                </button>
                            </div>
                            
                            <div class="products-grid" id="products-grid-{{ forloop.counter }}">
                            {% for product in category_products %}
                            <article class="product-card" data-product-id="{{ product.id }}">
                                <div class="card-image-container">
                                    <a href="{% url 'product_detail' product.id %}" class="card-image-link">
                                        {% if product.imagen and product.imagen.name %}
                                        <img 
                                            src="{{ product.imagen.url }}" 
                                            alt="{{ product.name }}"
                                            class="card-image primary-image"
                                            loading="lazy"
                                            data-product-id="{{ product.id }}"
                                        >
                                        {% else %}
                                        <div class="card-image-placeholder">
                                            <i class="bi bi-image"></i>
                                            <span>Sin imagen</span>
                                        </div>
                                        {% endif %}
                                    </a>
                                    
                                    <!-- Discount Badge (Simulado - puedes agregar campo de descuento al modelo) -->
                                    {% if product.stock > 0 %}
                                    <div class="discount-badge">
                                        <i class="bi bi-percent"></i> OFERTA
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Stock Badge -->
                                    {% if product.stock > 0 %}
                                    <div class="stock-badge in-stock bg-primary text-white">
                                        <i class="bi bi-check-circle"></i>
                                       Disponible
                                    </div>
                                    {% else %}
                                    <div class="stock-badge out-of-stock">
                                        <i class="bi bi-x-circle"></i>
                                        Agotado
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Free Shipping Badge (Simulado - puedes agregar l√≥gica seg√∫n precio) -->
                                    {% if product.price >= 100000 and product.stock > 0 %}
                                    <div class="free-shipping-badge">
                                        <i class="bi bi-truck"></i>
                                        Env√≠o Gratis
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="card-content">
                                    <div class="card-header">
                                        <!-- Provider Badge -->
                                        {% if product.proveedor %}
                                        
                                        {% endif %}
                                        
                                        <h3 class="card-title">
                                            <a href="{% url 'product_detail' product.id %}">
                                                {{ product.name }}
                                            </a>
                                        </h3>
                                        {% if product.category %}
                                        <span class="card-category">{{ product.category.nombre }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <p class="card-description" hidden>
                                        {{ product.description|truncatechars:80 }}
                                    </p>
                                    
                                    <div class="card-footer">
                                        <div class="price-section">
                                            <!-- Precio original tachado (simulado - puedes agregar campo al modelo) -->
                                            <!-- <span class="price-original">$XXX</span> -->
                                            <span class="price-current">${{ product.price|intcomma }}</span>
                                            <span class="price-currency">COP</span>
                                            <!-- Badge de ahorro (simulado) -->
                                            <!-- <span class="price-savings">Ahorras $XXX</span> -->
                                        </div>
                                        
                                        <div class="card-actions-footer">
                                            {% if product.stock > 0 %}
                                            <form class="add-to-cart-form" data-product="{{ product.id }}">
                                                {% csrf_token %}
                                                <input type="hidden" name="quantity" value="1">
                                                <button type="submit" class="btn-add-cart btn btn-success">
                                                    <i class="bi bi-cart-plus"></i>
                                                    <span>Agregar</span>
                                                </button>
                                            </form>
                                            {% else %}
                                            <button class="btn-notify-stock" data-product="{{ product.id }}">
                                                <i class="bi bi-bell"></i>
                                                <span>Notificar</span>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </article>
                            {% endfor %}
                            </div><!-- Cierre products-grid para esta categor√≠a -->
                        </div><!-- Cierre category-section -->
                        {% endfor %}
                        {% else %}
                        <!-- Empty State -->
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="bi bi-search"></i>
                            </div>
                            <h3 class="empty-title">No se encontraron productos</h3>
                            <p class="empty-subtitle">
                                {% if query %}
                                No hay resultados para "{{ query }}"
                                {% else %}
                                No hay productos disponibles en esta categor√≠a
                                {% endif %}
                            </p>
                            <div class="empty-actions">
                                {% if query %}
                                <a href="{% url 'store' %}" class="btn-primary">Ver todos los productos</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Loading State -->
                    <div class="loading-state" id="loading-state" style="display: none;">
                        <div class="loading-spinner">
                            <i class="bi bi-arrow-clockwise spin"></i>
                        </div>
                        <p>Cargando productos...</p>
                    </div>
                </section>
            </div>
        </div>
    </main>
   
   
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/store.js' %}"></script>

    <!-- Cart Sidebar Scripts -->
    <script>
    // ===== WHATSAPP INTEGRATION =====
    const whatsappBtn = document.getElementById('whatsapp-chat-float');
    if (whatsappBtn) {
        whatsappBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const numero = "573007915262";
            const mensaje = encodeURIComponent('¬°Hola! üëã\nEstoy interesado en conocer m√°s sobre sus productos.\n\n¬øPueden ayudarme?');
            const url = `https://wa.me/${numero}?text=${mensaje}`;
            window.open(url, "_blank");
        });
    }

    // ===== CART FLOAT BUTTON SCROLL EFFECT =====
    window.addEventListener('scroll', function() {
        const cartBtn = document.querySelector('.cart-float-modern');
        if (cartBtn) {
            if (window.scrollY > 100) {
                cartBtn.classList.add('scrolled');
            } else {
                cartBtn.classList.remove('scrolled');
            }
        }
    });

    // ===== MOBILE MENU TOGGLE =====
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const secondaryNavbar = document.querySelector('.secondary-navbar');
    
    // Crear overlay para men√∫ m√≥vil
    let menuOverlay = document.getElementById('menu-overlay');
    if (!menuOverlay) {
        menuOverlay = document.createElement('div');
        menuOverlay.id = 'menu-overlay';
        menuOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            transition: opacity 0.3s ease;
        `;
        document.body.appendChild(menuOverlay);
    }
    
    if (mobileMenuToggle && secondaryNavbar) {
        mobileMenuToggle.addEventListener('click', function() {
            const isActive = secondaryNavbar.classList.toggle('active');
            mobileMenuToggle.classList.toggle('active');
            
            if (isActive) {
                menuOverlay.style.display = 'block';
                setTimeout(() => menuOverlay.style.opacity = '1', 10);
                document.body.style.overflow = 'hidden';
            } else {
                menuOverlay.style.opacity = '0';
                setTimeout(() => menuOverlay.style.display = 'none', 300);
                document.body.style.overflow = '';
            }
        });
        
        // Cerrar men√∫ al hacer click en el overlay
        menuOverlay.addEventListener('click', function() {
            secondaryNavbar.classList.remove('active');
            mobileMenuToggle.classList.remove('active');
            menuOverlay.style.opacity = '0';
            setTimeout(() => menuOverlay.style.display = 'none', 300);
            document.body.style.overflow = '';
        });
        
        // Cerrar men√∫ al hacer click en un enlace
        const navLinks = secondaryNavbar.querySelectorAll('.nav-links a');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                secondaryNavbar.classList.remove('active');
                mobileMenuToggle.classList.remove('active');
                menuOverlay.style.opacity = '0';
                setTimeout(() => menuOverlay.style.display = 'none', 300);
                document.body.style.overflow = '';
            });
        });
    }

    // ===== USER MENU DROPDOWN =====
    const userMenuBtn = document.getElementById('user-menu-btn');
    const userDropdown = document.getElementById('user-dropdown');
    
    if (userMenuBtn && userDropdown) {
        userMenuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            userDropdown.style.display = userDropdown.style.display === 'none' ? 'block' : 'none';
        });
        
        // Cerrar al hacer click fuera
        document.addEventListener('click', function(e) {
            if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                userDropdown.style.display = 'none';
            }
        });
        
        // Hover effects
        const dropdownItems = userDropdown.querySelectorAll('a');
        dropdownItems.forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.style.background = '#f8f9fa';
            });
            item.addEventListener('mouseleave', function() {
                this.style.background = 'transparent';
            });
        });
    }

    // ===== CART SIDEBAR FUNCTIONALITY =====
    function toggleCartSidebar() {
        const sidebar = document.getElementById('cart-sidebar-modern');
        const overlay = document.getElementById('cart-sidebar-overlay');
        
        if (sidebar && overlay) {
            const isActive = sidebar.classList.contains('active');
            
            if (isActive) {
                // Cerrar
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            } else {
                // Abrir y recargar contenido del carrito
                sidebar.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Recargar productos del carrito cuando se abre
                if (window.StoreManagers && window.StoreManagers.Cart) {
                    window.StoreManagers.Cart.loadCartPreview();
                }
            }
        }
    }

    // Cerrar sidebar con tecla ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const sidebar = document.getElementById('cart-sidebar-modern');
            if (sidebar && sidebar.classList.contains('active')) {
                toggleCartSidebar();
            }
        }
    });

    // ===== ACTUALIZAR CARRITO MANUALMENTE =====
    async function refreshCartSidebar() {
        console.log('üîÑ [RefreshCart] Bot√≥n clickeado');
        const refreshBtn = document.getElementById('refresh-cart-btn');
        
        if (!refreshBtn) {
            console.error('‚ùå Bot√≥n de actualizar no encontrado');
            return;
        }
        
        try {
            // Deshabilitar y animar
            refreshBtn.disabled = true;
            refreshBtn.classList.add('spinning');
            console.log('üîÑ [RefreshCart] Iniciando actualizaci√≥n...');
            
            // SIEMPRE usar fetch directo para asegurar datos actualizados
            console.log('üì¶ [RefreshCart] Usando fetch directo');
            const response = await fetch('/cart-preview/', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                },
                cache: 'no-store'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üì¶ [RefreshCart] Respuesta completa:', data);
            console.log('üì¶ [RefreshCart] Items en carrito:', data.debug?.items_in_cart || 'N/A');
            console.log('üì¶ [RefreshCart] Total cantidad:', data.debug?.total_quantity || 'N/A');
            console.log('üì¶ [RefreshCart] HTML length:', data.cart_items_html?.length || 0);
            
            if (data.success) {
                // Actualizar TODO el contenido din√°mico del sidebar (content + footer)
                const dynamicContent = document.getElementById('cart-sidebar-dynamic-content');
                if (dynamicContent) {
                    console.log('üì¶ [RefreshCart] Dynamic content encontrado, actualizando...');
                    console.log('üì¶ [RefreshCart] HTML antes:', dynamicContent.innerHTML.length);
                    dynamicContent.innerHTML = data.cart_content_html;
                    console.log('üì¶ [RefreshCart] HTML despu√©s:', dynamicContent.innerHTML.length);
                    console.log('‚úÖ [RefreshCart] Dynamic content actualizado completamente (items + footer)');
                } else {
                    console.error('‚ùå [RefreshCart] Dynamic content NO encontrado');
                }
                
                // Actualizar todos los badges
                const badges = [
                    document.getElementById('cart-count-sidebar'),
                    ...document.querySelectorAll('.cart-count')
                ];
                
                badges.forEach((badge, index) => {
                    if (badge) {
                        badge.textContent = data.cart_count;
                        console.log(`‚úÖ [RefreshCart] Badge ${index} actualizado a ${data.cart_count}`);
                    }
                });
                
                // Actualizar total en el footer si existe
                const totalAmount = document.getElementById('cart-total-amount');
                if (totalAmount) {
                    totalAmount.textContent = data.cart_total;
                    console.log(`‚úÖ [RefreshCart] Total actualizado a ${data.cart_total}`);
                }
            } else {
                console.error('‚ùå [RefreshCart] Respuesta sin success=true');
            }
            
            console.log('‚úÖ [RefreshCart] Carrito actualizado exitosamente');
            
            // Mostrar feedback visual
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: '¬°Carrito actualizado!',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true
                });
            }
        } catch (error) {
            console.error('‚ùå [RefreshCart] Error:', error);
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error al actualizar',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        } finally {
            if (refreshBtn) {
                setTimeout(() => {
                    refreshBtn.disabled = false;
                    refreshBtn.classList.remove('spinning');
                    console.log('üîÑ [RefreshCart] Bot√≥n restaurado');
                }, 500);
            }
        }
    }
    
    // Hacer la funci√≥n global
    window.refreshCartSidebar = refreshCartSidebar;

    // ===== ELIMINAR PRODUCTO DEL CARRITO FLOTANTE =====
    async function removeFromCartSidebar(productId) {
        console.log('üóëÔ∏è [RemoveFromCart] Eliminando producto:', productId);

        try {
            const response = await fetch(`/remove_from_cart/${productId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            if (response.ok) {
                console.log('‚úÖ [RemoveFromCart] Producto eliminado');
                
                // Recargar el carrito usando fetch directo (igual que refreshCartSidebar)
                const cartResponse = await fetch('/cart-preview/', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    cache: 'no-store'
                });
                
                const cartData = await cartResponse.json();
                console.log('üì¶ [RemoveFromCart] Datos actualizados:', cartData);
                
                if (cartData.success) {
                    // Actualizar TODO el contenido din√°mico del sidebar
                    const dynamicContent = document.getElementById('cart-sidebar-dynamic-content');
                    if (dynamicContent) {
                        dynamicContent.innerHTML = cartData.cart_content_html;
                        console.log('‚úÖ [RemoveFromCart] Dynamic content actualizado (items + footer)');
                    }
                    
                    // Actualizar badges
                    const badge = document.getElementById('cart-count-sidebar');
                    if (badge) badge.textContent = cartData.cart_count;
                    
                    const badges = document.querySelectorAll('.cart-count');
                    badges.forEach(b => b.textContent = cartData.cart_count);
                    
                    // Actualizar total
                    const totalAmount = document.getElementById('cart-total-amount');
                    if (totalAmount) totalAmount.textContent = cartData.cart_total;
                    
                    console.log('‚úÖ [RemoveFromCart] Todo actualizado correctamente');
                }
            } else {
                throw new Error('Error al eliminar');
            }
        } catch (error) {
            console.error('Error eliminando producto:', error);
            alert('Error al eliminar el producto. Intenta nuevamente.');
        }
    }

    // Funci√≥n auxiliar para obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>

    <!-- WebSocket para registrar visitas en tiempo real -->
    <!-- NOTA: WebSocket deshabilitado temporalmente para evitar errores en consola -->
    <!-- Para habilitar: descomentar el bloque y asegurarse de que Redis/Channel Layers est√© configurado -->
    <!--
    <script>
    (function() {
        // Detectar si es local o producci√≥n
        var ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        var ws_path = ws_scheme + '://' + window.location.host + '/ws/store/';
        
        try {
            var storeSocket = new WebSocket(ws_path);

            storeSocket.onopen = function(e) {
                console.log('[WebSocket] Conectado para visitas en tienda');
            };
            storeSocket.onmessage = function(e) {
                var data = JSON.parse(e.data);
                if (data.message === 'visit_registered') {
                    console.log('[WebSocket] Visita registrada:', data.timestamp);
                }
            };
            storeSocket.onerror = function(e) {
                console.warn('[WebSocket] Error de conexi√≥n (normal en desarrollo sin Redis)');
            };
            storeSocket.onclose = function(e) {
                console.log('[WebSocket] Desconectado');
            };
        } catch (error) {
            console.warn('[WebSocket] No disponible:', error.message);
        }
    })();
    </script>
    -->
    
    <script>
    // ===== COMPARTIR CATEGOR√çA =====
    function shareCategoryLink(categoryName, buttonElement) {
        // Obtener el ID de categor√≠a desde el elemento padre
        const categorySection = buttonElement.closest('[data-category-id]');
        
        // Si no hay data-category-id, buscar en el filtro lateral
        let categoryId = null;
        const currentUrl = new URL(window.location.href);
        categoryId = currentUrl.searchParams.get('category');
        
        // Si a√∫n no hay ID, tratar de obtenerlo del nombre
        if (!categoryId) {
            // Buscar en el filtro lateral por el nombre de categor√≠a
            const categoryInputs = document.querySelectorAll('input[name="category"]');
            categoryInputs.forEach(input => {
                const label = input.closest('label');
                if (label && label.textContent.includes(categoryName)) {
                    categoryId = input.value;
                }
            });
        }
        
        // Construir URL completa
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = categoryId ? `${baseUrl}?category=${categoryId}` : window.location.href;
        
        // Intentar usar Web Share API
        if (navigator.share) {
            navigator.share({
                title: `${categoryName} - CompuEasys`,
                text: `Mira nuestros productos en ${categoryName}`,
                url: shareUrl
            }).then(() => {
                showShareToast('¬°Enlace compartido!', 'success');
            }).catch((error) => {
                if (error.name !== 'AbortError') {
                    copyToClipboard(shareUrl, categoryName);
                }
            });
        } else {
            copyToClipboard(shareUrl, categoryName);
        }
    }
    
    function copyToClipboard(url, categoryName) {
        navigator.clipboard.writeText(url).then(() => {
            showShareToast(`Enlace de ${categoryName} copiado al portapapeles`, 'success');
        }).catch(() => {
            // Fallback para navegadores antiguos
            const tempInput = document.createElement('input');
            tempInput.value = url;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showShareToast(`Enlace de ${categoryName} copiado`, 'success');
        });
    }
    
    function showShareToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
        toast.style.cssText = 'z-index: 9999; animation: slideDown 0.3s ease;';
        toast.innerHTML = `
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'}-fill me-2"></i>
            ${message}
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 2500);
    }
    
    // Estilos de animaci√≥n
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translate(-50%, 0); opacity: 1; }
            to { transform: translate(-50%, -100%); opacity: 0; }
        }
        .share-category-btn {
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        .share-category-btn:hover {
            transform: scale(1.05);
        }
    `;
    document.head.appendChild(style);
    </script>
</body>
</html>