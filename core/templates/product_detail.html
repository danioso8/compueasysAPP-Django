{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=3.0">
    <title>{{ product.name }} - Tienda Online</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/detail.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Precargar im√°genes importantes -->
    <link rel="preload" href="{% if product.imagen %}{{ product.imagen.url }}{% endif %}" as="image">
    
    <!-- Meta tags para redes sociales -->
    <meta property="og:title" content="{{ product.name }}">
    <meta property="og:description" content="{{ product.description|truncatechars:150 }}">
    <meta property="og:image" content="{% if product.imagen %}{{ product.imagen.url }}{% endif %}">
    <meta name="description" content="{{ product.description|truncatechars:150 }}">
</head>
<body>
    <a href="#" id="whatsapp-chat-float" class="whatsapp-float" title="Chatea por WhatsApp" target="_blank">
         <img src="{% static 'img/whatsapp-icon.png' %}" alt="WhatsApp" style="width:60px; height:60px; border-radius:50%;">
    </a>
    <header>
        {% include 'navbarr.html' %}
    </header>
    <main>
        <div class="container-product-all mt-5">
            <div class="container_product">
                <!-- Carrito flotante mejorado -->
                <div class="car-buy">
                    <a href="/cart" class="cart-toggle-btn position-relative" title="Ver carrito">
                        <i class="bi bi-cart-plus-fill"></i>
                        {% if cart_count > 0 %}
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                            {{ cart_count }}
                        </span>
                        {% endif %}
                    </a>
                </div>
                
                <div class="product-Galery">
                    <!-- Secci√≥n de imagen principal y galer√≠a mejorada -->
                    <div class="product-image">
                        <h1>{{ product.name }}</h1>
                        
                        <!-- Slider de imagen principal con controles mejorados -->
                        <div class="image-slider">
                            <img id="main-product-image"
                                 src="{% if Galeria_images %}{{ Galeria_images.0.galeria.url }}{% else %}{{ product.imagen.url }}{% endif %}"
                                 alt="{{ product.name }}"
                                 loading="lazy"
                                 title="Haz clic para ver en pantalla completa">
                            
                            {% if Galeria_images|length > 1 %}
                            <button id="prev-img" class="slider-arrow prev" aria-label="Imagen anterior">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <button id="next-img" class="slider-arrow next" aria-label="Imagen siguiente">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            {% endif %}
                        </div>

                        <!-- Galer√≠a de thumbnails mejorada -->
                        {% if Galeria_images %}
                        <div class="Gallery">
                            {% for imagen in Galeria_images %}
                                <img src="{{ imagen.galeria.url }}" 
                                     alt="Vista {{ forloop.counter }} de {{ product.name }}" 
                                     class="thumbnail"
                                     loading="lazy"
                                     data-index="{{ forloop.counter0 }}">
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Caracter√≠sticas del producto mejoradas -->
                        <div class="product-details">
                            <div class="cart-left">
                                <h2>Caracter√≠sticas del Producto</h2>
                                <div class="product-specs">
                                    <div class="spec-item">
                                        <span class="spec-label">Producto:</span>
                                        <span class="spec-value text-success">{{ product.name }}</span>
                                    </div>
                                    <div class="spec-item">
                                        <span class="spec-label">Descripci√≥n:</span>
                                        <span class="spec-value">{{ product.description|default:"Sin descripci√≥n disponible" }}</span>
                                    </div>
                                    {% if product.category %}
                                    <div class="spec-item">
                                        <span class="spec-label">Categor√≠a:</span>
                                        <span class="spec-value text-primary">{{ product.category.nombre }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Rese√±as de clientes mejoradas -->
                        <div class="product-reviews">
                            <h2>Rese√±as de Clientes</h2>
                            <div class="reviews-container">
                                <div class="review">
                                    <div class="review-header">
                                        <strong class="reviewer-name">Juan P√©rez</strong>
                                        <div class="rating">
                                            <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                                            <span class="rating-text">5.0</span>
                                        </div>
                                    </div>
                                    <p class="review-text">Excelente producto, muy satisfecho con la compra. La calidad supera mis expectativas.</p>
                                    <div class="review-date">Hace 2 d√≠as</div>
                                </div>
                                <div class="review">
                                    <div class="review-header">
                                        <strong class="reviewer-name">Mar√≠a G√≥mez</strong>
                                        <div class="rating">
                                            <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                                            <span class="rating-text">4.0</span>
                                        </div>
                                    </div>
                                    <p class="review-text">Buena calidad, aunque el env√≠o tard√≥ un poco m√°s de lo esperado. En general, recomendable.</p>
                                    <div class="review-date">Hace 1 semana</div>
                                </div>
                                <div class="review">
                                    <div class="review-header">
                                        <strong class="reviewer-name">Carlos Rodr√≠guez</strong>
                                        <div class="rating">
                                            <span class="stars">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span>
                                            <span class="rating-text">3.0</span>
                                        </div>
                                    </div>
                                    <p class="review-text">El producto es aceptable, pero esperaba m√°s por el precio. Podr√≠a mejorar algunos aspectos.</p>
                                    <div class="review-date">Hace 2 semanas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Informaci√≥n y acciones de compra mejoradas -->
                    <div class="product-info">
                        <div class="description-section">
                            <h1>{{ product.name }}</h1>
                            <p class="description">{{ product.description|default:"Descripci√≥n no disponible"|safe }}</p>
                        </div>
                        
                        <!-- Precio destacado -->
                        <div class="price">
                            <span id="main-product-price" class="amount">${{ product.price|intcomma }} COP</span>
                            <span class="price-discount">Antes: ${{ product.price|add:"30000"|intcomma }} COP</span>
                        </div>
                        
                        <!-- Secci√≥n de compra moderna -->
                        <div class="car">
                            <div class="stock-indicator">
                                <i class="bi bi-box-seam"></i>
                                <span class="ui-pdp-buybox__quantity__selected" id="available-stock">
                                    {{ product.stock }} disponibles
                                </span>
                            </div>
                            
                            <form class="purchase-form" method="post" action="{% url 'add_to_cart_detail' product.id %}">
                                {% csrf_token %}
                                
                                <!-- Selector de variantes mejorado -->
                                {% if product.variants.all %}
                                <div class="variant-selection">
                                    <label class="variant-label"><strong>Elige una variante:</strong></label>
                                    <div id="variant-swatches" class="variant-swatches">
                                        {% for variant in product.variants.all %}
                                            <div class="variant-option" 
                                                 data-variant-id="{{ variant.id }}"
                                                 data-color="{{ variant.color }}"
                                                 data-price="{{ variant.precio }}"
                                                 data-stock="{{ variant.stock }}"
                                                 {% if variant.imagen %}data-img="{{ variant.imagen.url }}"{% endif %}
                                                 title="{{ variant.color|default:'Variante' }} - Stock: {{ variant.stock }}">
                                                
                                                {% if variant.imagen %}
                                                    <!-- Variante con imagen -->
                                                    <div class="variant-image-container">
                                                        <img src="{{ variant.imagen.url }}" 
                                                             alt="{{ variant.color }}" 
                                                             class="variant-image"
                                                             loading="lazy">
                                                        <div class="variant-overlay">
                                                            <span class="variant-color-indicator" style="background-color: {{ variant.color|default:'#ccc' }}"></span>
                                                        </div>
                                                    </div>
                                                    <div class="variant-info">
                                                        <span class="variant-color-name">{{ variant.color|default:'Color' }}</span>
                                                        <span class="variant-stock">Stock: {{ variant.stock }}</span>
                                                        {% if variant.precio %}
                                                            <span class="variant-price">${{ variant.precio|floatformat:0 }}</span>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <!-- Variante solo color -->
                                                    <div class="variant-color-only" style="background-color: {{ variant.color|default:'#ccc' }}">
                                                        <div class="variant-color-check">
                                                            <i class="bi bi-check"></i>
                                                        </div>
                                                    </div>
                                                    <div class="variant-info">
                                                        <span class="variant-color-name">{{ variant.color|default:'Color' }}</span>
                                                        <span class="variant-stock">{{ variant.stock }}</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" name="variant_id" id="variant_id" required>
                                    
                                    <!-- Vista previa de la variante seleccionada -->
                                    <div id="selected-variant-preview" class="selected-variant-preview" style="display: none;">
                                        <div class="preview-content">
                                            <img id="variant-preview-image" src="" alt="Variante seleccionada" class="preview-image">
                                            <div class="preview-info">
                                                <span id="variant-preview-color" class="preview-color"></span>
                                                <span id="variant-preview-stock" class="preview-stock"></span>
                                                <span id="variant-preview-price" class="preview-price"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Controles de cantidad modernos -->
                                {% if product.stock > 0 %}
                                <div class="quantity-controls">
                                    <label class="quantity-label">
                                        <strong>Cantidad:</strong>
                                    </label>
                                    <div class="quantity-wrapper">
                                        <button type="button" class="quantity-btn quantity-decrease" aria-label="Disminuir cantidad">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <input type="number" 
                                               name="quantity" 
                                               min="1" 
                                               value="1" 
                                               max="{{ product.stock }}" 
                                               class="quantity-input"
                                               aria-label="Cantidad">
                                        <button type="button" class="quantity-btn quantity-increase" aria-label="Aumentar cantidad">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Botones de acci√≥n modernos -->
                                <div class="action-buttons">
                                    <button type="submit" id="add_to_cart" class="btn btn-primary">
                                        <i class="bi bi-cart-plus"></i>
                                        Agregar al Carrito
                                    </button>
                                    <button type="submit" id="go_to_cart" name="go_to_cart" class="btn btn-success">
                                        <i class="bi bi-lightning"></i>
                                        Comprar Ahora
                                    </button>
                                </div>
                                
                                {% else %}
                                <div class="out-of-stock">
                                    <div class="stock-alert">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <strong>Producto Agotado</strong>
                                    </div>
                                    <p>Este producto no est√° disponible en este momento. Te notificaremos cuando vuelva a estar en stock.</p>
                                    <button type="button" class="btn btn-outline" disabled>
                                        <i class="bi bi-bell"></i>
                                        Notificarme
                                    </button>
                                </div>
                                {% endif %}
                            </form>
                            
                            <!-- Pol√≠ticas de compra mejoradas -->
                            <div class="cart-right-polices">
                                <h2>Informaci√≥n de Compra</h2>
                                <div class="policies-grid">
                                    <div class="policy-item">
                                        <i class="bi bi-truck"></i>
                                        <div>
                                            <strong>Env√≠o Gratis</strong>
                                            <p>En compras superiores a $200,000 COP. Entrega en 3-5 d√≠as h√°biles.</p>
                                        </div>
                                    </div>
                                    <div class="policy-item">
                                        <i class="bi bi-shield-check"></i>
                                        <div>
                                            <strong>Garant√≠a</strong>
                                            <p>Garant√≠a de 30 d√≠as por defectos de f√°brica.</p>
                                        </div>
                                    </div>
                                    <div class="policy-item">
                                        <i class="bi bi-arrow-left-right"></i>
                                        <div>
                                            <strong>Devoluciones</strong>
                                            <p>Devoluciones gratuitas dentro de los primeros 15 d√≠as.</p>
                                        </div>
                                    </div>
                                    <div class="policy-item">
                                        <i class="bi bi-credit-card"></i>
                                        <div>
                                            <strong>Pago Seguro</strong>
                                            <p>M√∫ltiples m√©todos de pago seguros disponibles.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                                <li><strong>Devoluciones:</strong> Aceptamos devoluciones dentro de los 30 d√≠as posteriores a la compra. El producto debe estar en su estado original.</li>
                                <li><strong>Garant√≠a:</strong> Todos nuestros productos cuentan con una garant√≠a de 3 meses contra defectos de fabricaci√≥n.</li>
                                <li><strong>Soporte:</strong> Nuestro equipo de soporte est√° disponible para ayudarte con cualquier consulta o problema relacionado con tu compra.</li>
                            </ul>
                        </div>
                    </div>
                </div>
              
            </div>
            <!-- Publicidad o im√°genes adicionales -->
            <div class="cart-all-img">
                <div class="img-publicity">
                    <img src="{{ product.imagen.url }}" alt="Publicidad" style="width:100%; height:100%;">
                </div >
                {% for imagen in Galeria_images %}
                    <div class="img-publicity mt-4">
                        <img src="{{ imagen.galeria.url }}" alt="Publicidad" style="width:100%; height:100%; margin-bottom:50px;">
                    </div>
                {% endfor %}
            </div>
             
        </div>
    </main>
    <footer>
        {% include 'footer.html' %}
    </footer>
   
   
   
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/detail_product.js' %}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
    // Galer√≠a de im√°genes
    const galleryImages = [
        {% for imagen in Galeria_images %}
            "{{ imagen.galeria.url }}",
        {% endfor %}
    ];
    {% if not Galeria_images %}
        galleryImages.push("{{ product.imagen.url }}");
    {% endif %}

    let currentIndex = 0;
    const mainImg = document.getElementById('main-product-image');
    const prevBtn = document.getElementById('prev-img');
    const nextBtn = document.getElementById('next-img');

    function showImage(index) {
        if (galleryImages.length === 0) return;
        mainImg.src = galleryImages[index];
    }

    prevBtn.addEventListener('click', function() {
        currentIndex = (currentIndex - 1 + galleryImages.length) % galleryImages.length;
        showImage(currentIndex);
    });

    nextBtn.addEventListener('click', function() {
        currentIndex = (currentIndex + 1) % galleryImages.length;
        showImage(currentIndex);
    });

    // Cambia la imagen principal al hacer clic en una miniatura
    document.querySelectorAll('.thumbnail').forEach(function(thumb, idx) {
        thumb.addEventListener('click', function() {
            currentIndex = idx;
            showImage(currentIndex);
        });
    });

    // --- Swatches de variantes ---
    document.querySelectorAll('.variant-swatch').forEach(function(btn) {
        btn.addEventListener('click', function() {
            // Quitar selecci√≥n previa
            document.querySelectorAll('.variant-swatch').forEach(function(b) {
                b.style.border = "2px solid #ccc";
            });
            // Marcar seleccionada
            btn.style.border = "2px solid #405cdb";
            // Actualizar input oculto
            document.getElementById('variant_id').value = btn.getAttribute('data-variant-id');
            // Cambiar imagen principal
            var imgUrl = btn.getAttribute('data-img');
            if (imgUrl) {
                mainImg.src = imgUrl;
            } else {
                mainImg.src = "{{ product.imagen.url }}";
            }
            // Cambiar precio
            var precio = btn.getAttribute('data-precio');
            var mainPrice = document.getElementById('main-product-price');
            if (precio) {
                mainPrice.textContent = "$" + Number(precio).toLocaleString('es-CO') + " COP";
            } else {
                mainPrice.textContent = "${{ product.price|intcomma }} COP";
            }
            // Actualizar stock disponible
            var stock = btn.getAttribute('data-stock');
            var stockDisplay = document.getElementById('available-stock');
            if (stockDisplay) {
                stockDisplay.textContent = "Disponibles " + (stock || 0);
            }
            // Actualizar cantidad m√°xima
            var quantityInput = document.querySelector('.quantity-input');
            if (quantityInput) {
                quantityInput.max = stock || 0;
            }
        });
    });
});

// WhatsApp Integration
document.getElementById('whatsapp-chat-float').addEventListener('click', function(e) {
    e.preventDefault();
    var numero = "573007915262"; // Cambia por tu n√∫mero real
    var nombre = "{{ product.name }}";
   
    var mensaje = "Hola, quiero m√°s informaci√≥n sobre el producto: " + nombre ;
    var url = "https://wa.me/" + numero + "?text=" + mensaje;
    window.open(url, "_blank");
});

// Cart Integration
document.addEventListener('DOMContentLoaded', function () {
    const cart = document.querySelector('.cart-sidebar, #cart, .cart-widget');
    const toggleBtn = document.querySelector('.cart-toggle-btn, .open-cart-btn, .btn-cart');
    
    if (cart && toggleBtn) {
        toggleBtn.addEventListener('click', function (e) {
            e.preventDefault();
            if (cart.classList.contains('cart-sidebar')) {
                cart.classList.toggle('open');
            } else {
                cart.style.display = (cart.style.display === 'block' ? 'none' : 'block');
            }
        });

        // Cerrar al tocar fuera (m√≥vil)
        document.addEventListener('click', function (e) {
            if (!cart.contains(e.target) && !toggleBtn.contains(e.target)) {
                if (cart.classList.contains('open')) cart.classList.remove('open');
            }
        });
    }
});
    </script>
    
    <!-- Enhanced Variant Selection Script -->
    <script>
    // Script adicional para las variantes con im√°genes
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üé® Inicializando sistema de variantes mejorado...');
        
        // Verificar si hay variantes disponibles
        const variantOptions = document.querySelectorAll('.variant-option');
        const variantIdInput = document.getElementById('variant_id');
        
        if (variantOptions.length > 0) {
            console.log(`‚úÖ ${variantOptions.length} variantes encontradas`);
            
            // Manejar stock de variantes
            variantOptions.forEach(variant => {
                const stock = parseInt(variant.dataset.stock || '0');
                
                if (stock <= 0) {
                    variant.classList.add('out-of-stock');
                    variant.title += ' - AGOTADO';
                }
                
                // Debugging
                console.log('Variante:', {
                    id: variant.dataset.variantId,
                    color: variant.dataset.color,
                    stock: variant.dataset.stock,
                    price: variant.dataset.price,
                    hasImage: !!variant.dataset.img
                });
            });
            
            // Auto-seleccionar primera variante disponible
            const firstAvailable = Array.from(variantOptions).find(v => !v.classList.contains('out-of-stock'));
            if (firstAvailable) {
                setTimeout(() => {
                    firstAvailable.click();
                    console.log('‚úÖ Primera variante disponible seleccionada autom√°ticamente');
                }, 300);
            }
        } else {
            console.log('‚ÑπÔ∏è No hay variantes para este producto');
            // Si no hay variantes, asegurar que el formulario funcione sin variant_id
            if (variantIdInput) {
                variantIdInput.removeAttribute('required');
            }
        }
        
        // Mejorar experiencia visual
        const variantImages = document.querySelectorAll('.variant-image');
        variantImages.forEach(img => {
            img.addEventListener('load', function() {
                this.style.opacity = '1';
            });
            
            img.addEventListener('error', function() {
                console.warn('‚ö†Ô∏è Error cargando imagen de variante:', this.src);
                this.style.display = 'none';
                // Mostrar el indicador de color en su lugar
                const colorIndicator = this.parentElement.querySelector('.variant-color-indicator');
                if (colorIndicator) {
                    colorIndicator.style.width = '40px';
                    colorIndicator.style.height = '40px';
                }
            });
        });
        
        // A√±adir efectos de carga
        variantOptions.forEach(variant => {
            variant.addEventListener('click', function() {
                this.classList.add('loading');
                setTimeout(() => {
                    this.classList.remove('loading');
                }, 300);
            });
        });
    });
    </script>
    
    <!-- Modern Product Detail JavaScript -->
    <script src="{% static 'js/product_detail.js' %}"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>