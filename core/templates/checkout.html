{% load humanize %} {% load static %}

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Checkout</title>
    <link rel="stylesheet" href="{% static 'css/checkout.css' %}?v=2" />
  </head>
  <body>
      <div class="header">
         <h1>COMPUEASYS</h1>
        </div>
    <div class="container-checkout">
         <h2>Informacion del pedido</h2>
        <form class="form-payment" method="post" action="{% url 'pago_exitoso' %}">
            {% csrf_token %}
           
               <!-- ...otros campos... -->
             <input type="hidden" name="note" value="{{ nota|default_if_none:'' }}">
            <div class="form-group1">
                <h4>ENTREGA:</h4>
               <input type="email" id="email" name="email" required placeholder="Correo electrónico" value="{{ saved.email|default_if_none:'' }}" />
               <div class="form-check-entrega">
                   <div class="form-check-direccion">
                      <input type="radio" id="entrega_direccion" name="entrega_opcion" value="{{ saved.direccion|default_if_none:'' }}" checked/>
                     <label for="entrega_direccion">Entregar en esta dirección</label>
                   </div>
                   <div class="form-check-pickup">
                       <input type="radio" id="recoger_tienda" name="entrega_opcion" value="recoger_tienda"/>
                       <label for="recoger_tienda">Recoger en tienda</label>
                  </div>   
                      <input type="text" id="nombre" name="nombre" required placeholder="Nombre completo" value="{{ saved.nombre|default_if_none:'' }}" />
                      <input type="text" id="cedula" name="cedula" required placeholder="Cédula" value="{{ saved.cedula|default_if_none:'' }}" />
                      <input type="text" id="direccion" name="direccion" required placeholder="Dirección de envío" value="{{ saved.direccion|default_if_none:'' }}" />
                    <div class="form-group-destination">
                    
                             <select name="departament" id="departament" required>
                                 <option value="">Departamento</option>
                                  {% for dep in departamentos.keys %}
                                  <option value="{{ dep }}" {% if dep == departament_selected %}selected{% endif %}>{{ dep }}</option>
                                  {% endfor %}
                              </select>

                             
                             <select name="ciudad" id="ciudad" required>
    <option value="">Ciudad</option>
    {% for ciudad in ciudades %}
        <option value="{{ ciudad }}" {% if ciudad == city_selected %}selected{% endif %}>{{ ciudad }}</option>
    {% endfor %}
</select>
                              <input type="text" id="codigo_postal" name="codigo_postal" required placeholder="Código postal" value="{{ saved.codigo_postal|default_if_none:'' }}" />
                      </div>
                       <input type="tel" id="telefono" name="telefono" required placeholder="Teléfono" value="{{ saved.telefono|default_if_none:'' }}" />
                       <div class="form-check-save">
                          <input type="checkbox" id="save_info" name="save_info" checked />
                           <label for="save_info">Guardar esta información para la próxima vez</label> 
            
                       </div>
                         <div class="form-group-entrega">
                      <h4>PAGO:</h4>
                        <div class="form-check-entrega">
                            <div class="form-check-direccion">
                               <input type="radio" id="entrega_direccion" name="entrega_opcion" checked />  
                               <label for="entrega_direccion">Pago contra entrega</label>
                             </div>
                        </div>

                        <div class="form-check-pickup">
                               <input type="radio" id="recoger_tienda" name="entrega_opcion" />
                               <label for="recoger_tienda">Recoger en tienda</label>
                       </div>
                      </div>
               </div>

                
            </div>
             
            <div class="divider">
                  <div class="form-group2">
                    <div><h2>Detalles del pedido</h2></div>
                      <div class="table-scroll">
                        <table class="table-cart">          
                         <tbody>
                            {% for item in cart_items %}
                                <tr>
                                   <td><img src="{{ item.product.imagen.url }}"  width="50" /></td>
                                     <td>{{ item.product.name }}</td>
                                     <td>{{ item.quantity }}</td>                                     
                                     <td>${{ item.subtotal|intcomma }}</td>
                                </tr>
                            {% endfor %}
                         </tbody>
                      </table>                 
                      </div>
                           
                  </div>
                  <div class="total-amount">
                     <div class="form-group-codigo-descuento">
                     
                        <input type="text" id="discount_code" name="discount_code" placeholder="Código de descuento" />
                        <button type="button">Aplicar</button>
                     </div>
                    <div class="form-group-total">
                       <span>Subtotal</span>
                        <h3> ${{ cart_total|intcomma }}</h3>              
                         <!-- Aquí puedes pedir datos de envío, pago, etc. -->
                        
                    </div>
                       <button type="submit">Confirmar y pedir</button>
                         <a href="{% url 'cart' %}">Volver al carrito</a>
                  </div>          
            </div>
            
        </form>
    </div>
  </body>
  <script src="{% static 'js/checkout.js' %}?v=2"></script>
  <script>const departamentosCiudades = {{ departamentos|safe }};
const depSelect = document.getElementById('departament');
const ciudadSelect = document.getElementById('ciudad');
const ciudadSeleccionada = "{{ city_selected|escapejs }}";

function actualizarCiudades() {
    const dep = depSelect.value;
    ciudadSelect.innerHTML = '<option value="">Seleccione una ciudad</option>';
    if (departamentosCiudades[dep]) {
        departamentosCiudades[dep].forEach(function(ciudad) {
            const selected = ciudad === ciudadSeleccionada ? 'selected' : '';
            ciudadSelect.innerHTML += `<option value="${ciudad}" ${selected}>${ciudad}</option>`;
        });
    }
}

// Inicializa ciudades si ya hay un departamento seleccionado
if(depSelect.value) {
    actualizarCiudades();
}

depSelect.addEventListener('change', function() {
    actualizarCiudades();
});
</script>
</html>
