<!-- filepath: d:\ESCRITORIO\CompueasysApp\dashboard\templates\dashboard\dashboard_home.html -->
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Tienda</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Estilos Base del Dashboard -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />
    
    <!-- M√≥dulos CSS Especializados -->
    <link rel="stylesheet" href="{% static 'css/dashboard-realtime.css' %}" />
    <link rel="stylesheet" href="{% static 'css/dashboard-messages.css' %}" />
    <link rel="stylesheet" href="{% static 'css/dashboard-pedidos.css' %}" />

</head>
<body>
    <!-- Barra superior para m√≥viles -->
    <div class="mobile-header d-md-none">
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        <div class="mobile-logo">
            <i class="fas fa-desktop"></i>
            <span>CompuEasys</span>
        </div>
        <div class="mobile-user">
            <i class="fas fa-user-circle"></i>
        </div>
    </div>
    
    <!-- Overlay para cerrar men√∫ en m√≥vil -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    
    <div class="dashboard-container">
        <aside class="sidebar modern-sidebar" id="sidebar">
            <!-- Header Corporativo Mejorado -->
            <div class="sidebar-brand">
                <div class="brand-logo">
                    <div class="logo-icon">
                        <i class="fas fa-desktop"></i>
                    </div>
                    <div class="brand-identity">
                        <span class="brand-name">CompuEasys</span>
                        <span class="brand-tagline">Dashboard Pro</span>
                    </div>
                </div>
                <button class="sidebar-collapse-btn" id="sidebarToggle" title="Contraer/Expandir">
                    <i class="fas fa-angles-left"></i>
                </button>
            </div>

         
            
            <!-- Navegaci√≥n Moderna con Grupos -->
            <nav class="sidebar-navigation">
                <!-- GRUPO: PANEL DE CONTROL -->
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-grip-horizontal"></i>
                        <span class="sidebar-text">Panel de Control</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item">
                            <a href="/dashboard/dashboard_home/" class="nav-menu-link {% if not request.GET.view %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-home"></i>
                                </span>
                                <span class="nav-menu-text">Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=ventas" class="nav-menu-link {% if request.GET.view == 'ventas' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-chart-line"></i>
                                </span>
                                <span class="nav-menu-text">An√°lisis de Ventas</span>
                            </a>
                        </li>
                        {% if is_superuser or is_staff %}
                        <li class="nav-menu-item">
                            <a href="?view=visitas" class="nav-menu-link {% if request.GET.view == 'visitas' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-chart-area"></i>
                                </span>
                                <span class="nav-menu-text">An√°lisis de Visitas</span>
                                <span class="nav-menu-badge live">
                                    <i class="fas fa-circle"></i> Live
                                </span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <!-- GRUPO: GESTI√ìN COMERCIAL -->
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-shopping-bag"></i>
                        <span class="sidebar-text">Gesti√≥n Comercial</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item">
                            <a href="?view=pedidos" class="nav-menu-link {% if request.GET.view == 'pedidos' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-shopping-cart"></i>
                                </span>
                                <span class="nav-menu-text">Pedidos</span>
                                <span class="nav-menu-badge primary">{{ estadisticas_diarias.pedidos_hoy|default:"0" }}</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=productos" class="nav-menu-link {% if request.GET.view == 'productos' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-box-open"></i>
                                </span>
                                <span class="nav-menu-text">Productos</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=inventario" class="nav-menu-link {% if request.GET.view == 'inventario' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-warehouse"></i>
                                </span>
                                <span class="nav-menu-text">Inventario</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=bonos" class="nav-menu-link {% if request.GET.view == 'bonos' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-gift"></i>
                                </span>
                                <span class="nav-menu-text">Promociones</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- GRUPO: ORGANIZACI√ìN -->
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-layer-group"></i>
                        <span class="sidebar-text">Organizaci√≥n</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item">
                            <a href="?view=categoria" class="nav-menu-link {% if request.GET.view == 'categoria' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-folder-tree"></i>
                                </span>
                                <span class="nav-menu-text">Categor√≠as</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=tipos" class="nav-menu-link {% if request.GET.view == 'tipos' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-tag"></i>
                                </span>
                                <span class="nav-menu-text">Tipos</span>
                            </a>
                        </li>
                        {% if is_superuser %}
                        <li class="nav-menu-item">
                            <a href="?view=proveedores" class="nav-menu-link {% if request.GET.view == 'proveedores' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-truck-loading"></i>
                                </span>
                                <span class="nav-menu-text">Proveedores</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <!-- GRUPO: COMUNICACI√ìN -->
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-comments"></i>
                        <span class="sidebar-text">Comunicaci√≥n</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item">
                            <a href="?view=mensajes" class="nav-menu-link {% if request.GET.view == 'mensajes' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-envelope"></i>
                                </span>
                                <span class="nav-menu-text">Mensajes</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- GRUPO: CONFIGURACI√ìN - Solo Superuser -->
                {% if is_superuser %}
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-sliders-h"></i>
                        <span class="sidebar-text">Configuraci√≥n</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item has-submenu">
                            <a href="#" class="nav-menu-link" data-bs-toggle="collapse" data-bs-target="#configSubmenu">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-cog"></i>
                                </span>
                                <span class="nav-menu-text">Sistema</span>
                                <span class="nav-menu-arrow">
                                    <i class="fas fa-chevron-down"></i>
                                </span>
                            </a>
                            <ul class="nav-submenu collapse" id="configSubmenu">
                                <li class="nav-submenu-item">
                                    <a href="?view=wompi_config" class="nav-submenu-link">
                                        <i class="fas fa-credit-card"></i>
                                        <span>Pagos (Wompi)</span>
                                    </a>
                                </li>
                                <li class="nav-submenu-item">
                                    <a href="?view=whatsapp_config" class="nav-submenu-link">
                                        <i class="fab fa-whatsapp"></i>
                                        <span>WhatsApp</span>
                                    </a>
                                </li>
                                <li class="nav-submenu-item">
                                    <a href="?view=datos_tienda" class="nav-submenu-link">
                                        <i class="fas fa-store-alt"></i>
                                        <span>Datos de Tienda</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=usuarios" class="nav-menu-link {% if request.GET.view == 'usuarios' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-users-cog"></i>
                                </span>
                                <span class="nav-menu-text">Usuarios</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=proyectos" class="nav-menu-link {% if request.GET.view == 'proyectos' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-project-diagram"></i>
                                </span>
                                <span class="nav-menu-text">Proyectos</span>
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </nav>
            
            <!-- Footer Corporativo Mejorado -->
            <div class="sidebar-footer">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <a href="/" target="_blank" class="quick-action-btn" title="Ver Tienda">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                    <a href="#" class="quick-action-btn" title="Soporte" onclick="alert('Contacto: soporte@compueasys.com')">
                        <i class="fas fa-life-ring"></i>
                    </a>
                    <a href="#" class="quick-action-btn" title="Notificaciones">
                        <i class="fas fa-bell"></i>
                    </a>
                </div>
                 <!-- Perfil de Usuario Corporativo -->
            <div class="sidebar-user-profile">
                <div class="user-profile-card">
                    <div class="user-avatar-wrapper">
                        <div class="user-avatar-img">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="user-status-indicator"></div>
                    </div>
                    <div class="user-profile-info">
                        <h6 class="user-profile-name">{{ current_user.username|default:"Administrador" }}</h6>
                        <div class="user-profile-role">
                            {% if is_superuser %}
                                <span class="role-badge superuser">
                                    <i class="fas fa-crown"></i> Super Admin
                                </span>
                            {% elif is_staff %}
                                <span class="role-badge staff">
                                    <i class="fas fa-user-tie"></i> Staff
                                </span>
                            {% else %}
                                <span class="role-badge user">
                                    <i class="fas fa-user"></i> Usuario
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

                <!-- Logout Button Corporativo -->
                <form method="post" action="{% url 'logout_view' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn-modern">
                        <span class="logout-icon">
                            <i class="fas fa-sign-out-alt"></i>
                        </span>
                          
                        <span class="logout-text">Cerrar Sesi√≥n</span>
                    </button>
                </form>

                <!-- Version Info -->
                <div class="sidebar-version">
                    <small>v2.0.0 Pro</small>
                </div>
            </div>
        </aside>
        <main class="main-content">
            {% if not request.GET.view %}
            <!-- HOME DASHBOARD - Vista por defecto -->
            <div class="home-dashboard-modern">
                <div class="mb-4">
                    <h2 class="mb-1">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        Panel de Control
                    </h2>
                    <p class="text-muted">Resumen general de ventas y rendimiento de tu tienda</p>
                </div>
                
                <!-- KPIs Cards Modernos -->
                <div class="row g-3 mb-4">
                    <!-- Ventas Totales -->
                    <div class="col-md-3">
                        <div class="modern-stat-card gradient-primary">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">
                                    ${{ total_ventas_general|floatformat:0 }}
                                </div>
                                <div class="stat-label">Ventas Totales</div>
                                <div class="stat-trend">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    <span>Todas las ventas</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Productos Vendidos -->
                    <div class="col-md-3">
                        <div class="modern-stat-card gradient-success">
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">
                                    {{ estadisticas_ventas.productos_vendidos }}
                                </div>
                                <div class="stat-label">Productos Vendidos</div>
                                <div class="stat-trend">
                                    <i class="fas fa-shopping-cart me-1"></i>
                                    <span>Total unidades</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Promedio por Pedido -->
                    <div class="col-md-3">
                        <div class="modern-stat-card gradient-warning">
                            <div class="stat-icon">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">
                                    ${{ estadisticas_ventas.promedio_por_pedido|floatformat:0 }}
                                </div>
                                <div class="stat-label">Promedio por Pedido</div>
                                <div class="stat-trend">
                                    <i class="fas fa-calculator me-1"></i>
                                    <span>Ticket promedio</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Pedidos -->
                    <div class="col-md-3">
                        <div class="modern-stat-card gradient-info">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">
                                    {{ estadisticas_ventas.pedidos_totales }}
                                </div>
                                <div class="stat-label">Total Pedidos</div>
                                <div class="stat-trend">
                                    <i class="fas fa-chart-bar me-1"></i>
                                    <span>Pedidos confirmados</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actividad en Tiempo Real -->
                <div class="alert alert-info mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-calendar-day me-2"></i>Actividad de Hoy
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-sync-alt fa-spin"></i> Tiempo Real
                        </span>
                    </h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-primary">
                                    <i class="fas fa-shopping-cart me-2"></i>
                                    <span data-stat="pedidos-hoy">{{ estadisticas_diarias.pedidos_hoy }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Pedidos de Hoy</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-success">
                                    <i class="fas fa-dollar-sign me-2"></i>
                                    <span data-stat="ventas-hoy">${{ estadisticas_diarias.ventas_hoy|default:"0"|floatformat:0 }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Ventas de Hoy</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-info">
                                    <i class="fas fa-box-open me-2"></i>
                                    <span data-stat="productos-vendidos-hoy">{{ estadisticas_diarias.productos_vendidos_hoy }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Productos Vendidos Hoy</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-warning">
                                    <i class="fas fa-users me-2"></i>
                                    <span data-stat="total-usuarios">{{ usuarios|length }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Total Usuarios</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico y Top 5 Categor√≠as -->
                <div class="row g-3 mb-4">
                    <!-- Gr√°fico Principal -->
                    <div class="col-lg-8">
                        <div class="card modern-card shadow-sm">
                            <div class="card-header bg-white border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-pie me-2 text-primary"></i>
                                        Ventas por Categor√≠a
                                    </h5>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary active" data-chart-type="bar">
                                            <i class="fas fa-chart-bar"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" data-chart-type="pie">
                                            <i class="fas fa-chart-pie"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" data-chart-type="doughnut">
                                            <i class="fas fa-circle-notch"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 350px;">
                                    <canvas id="homeVentasChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Categor√≠as -->
                    <div class="col-lg-4">
                        <div class="card modern-card shadow-sm h-100">
                            <div class="card-header bg-white border-bottom">
                                <h5 class="mb-0">
                                    <i class="fas fa-trophy me-2 text-warning"></i>
                                    Top 5 Categor√≠as
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="top-5-list" id="home-top-5">
                                    {% for categoria in ventas_por_categoria|slice:":5" %}
                                    <div class="top-category-item mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <span class="fw-bold">{{ forloop.counter }}. {{ categoria.nombre }}</span>
                                                <small class="text-muted d-block">{{ categoria.cantidad_productos }} productos</small>
                                            </div>
                                            <span class="badge bg-success">${{ categoria.total_ingresos|floatformat:0 }}</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            {% widthratio categoria.total_ingresos ventas_por_categoria.0.total_ingresos 100 as percentage %}
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ percentage }}%; background: {% cycle 'linear-gradient(90deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8))' 'linear-gradient(90deg, rgba(79, 172, 254, 0.8), rgba(0, 242, 254, 0.8))' 'linear-gradient(90deg, rgba(67, 233, 123, 0.8), rgba(79, 172, 254, 0.8))' 'linear-gradient(90deg, rgba(245, 87, 108, 0.8), rgba(255, 159, 64, 0.8))' 'linear-gradient(90deg, rgba(255, 205, 86, 0.8), rgba(153, 102, 255, 0.8))' %};"
                                                 aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                        <p>No hay datos de ventas</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla Detallada de Ventas -->
                <div class="card modern-card shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2 text-info"></i>
                                Detalle por Categor√≠a
                            </h5>
                            <button type="button" class="btn btn-sm btn-success" onclick="exportToExcelHome()">
                                <i class="fas fa-file-excel me-1"></i>
                                Exportar a Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-center" style="width: 60px;">#</th>
                                        <th>Categor√≠a</th>
                                        <th class="text-end">Ingresos Totales</th>
                                        <th class="text-center">Productos Vendidos</th>
                                        <th class="text-center">Pedidos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for categoria in ventas_por_categoria %}
                                    <tr>
                                        <td class="fw-bold text-muted">{{ forloop.counter }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="category-color-indicator me-2" 
                                                     style="width: 8px; height: 8px; border-radius: 50%; background: {% cycle 'rgba(102, 126, 234, 0.8)' 'rgba(118, 75, 162, 0.8)' 'rgba(79, 172, 254, 0.8)' 'rgba(0, 242, 254, 0.8)' 'rgba(67, 233, 123, 0.8)' 'rgba(245, 87, 108, 0.8)' 'rgba(255, 159, 64, 0.8)' 'rgba(255, 205, 86, 0.8)' 'rgba(153, 102, 255, 0.8)' 'rgba(201, 203, 207, 0.8)' %};"></div>
                                                <strong class="text-dark">{{ categoria.nombre }}</strong>
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-success-subtle text-success px-3 py-2">
                                                ${{ categoria.total_ingresos|floatformat:0 }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-info-subtle text-info">
                                                {{ categoria.cantidad_productos }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary-subtle text-primary">
                                                {{ categoria.cantidad_pedidos }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-2x mb-2"></i>
                                            <p class="mb-0">No hay datos de ventas disponibles</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            {% elif request.GET.view == 'visitas' %}
            <!-- Secci√≥n Visitas Recientes responsive y moderna -->
             <section class="mb-4">
                <div class="card modern-card shadow-sm">
                    <div class="card-header modern-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
                            <div class="text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    An√°lisis de Visitas
                                    <span class="badge bg-white text-primary ms-2 pulse-animation">
                                        <i class="fas fa-circle" style="font-size: 8px;"></i> En vivo
                                    </span>
                                </h5>
                                <small class="opacity-75">Monitoreo en tiempo real de tu tienda</small>
                            </div>
                            <form method="get" class="d-flex flex-wrap gap-2 align-items-center mb-0 w-100 w-md-auto" id="visitas-filter-form">
                                <input type="hidden" name="view" value="visitas">
                                <select name="visitas_filter" class="form-select form-select-sm flex-fill flex-md-grow-0 shadow-sm" id="visitas_filter" onchange="this.form.submit()" style="min-width: 100px;">
                                    <option value="all" {% if request.GET.visitas_filter == 'all' or not request.GET.visitas_filter %}selected{% endif %}>üìÖ Todas</option>
                                    <option value="today" {% if request.GET.visitas_filter == 'today' %}selected{% endif %}>üåü Hoy</option>
                                    <option value="week" {% if request.GET.visitas_filter == 'week' %}selected{% endif %}>üìä Semana</option>
                                    <option value="month" {% if request.GET.visitas_filter == 'month' %}selected{% endif %}>üìà Mes</option>
                                </select>
                                <select name="visitas_user" class="form-select form-select-sm flex-fill flex-md-grow-0 shadow-sm" id="visitas_user" onchange="this.form.submit()" style="min-width: 100px;">
                                    <option value="all" {% if request.GET.visitas_user == 'all' or not request.GET.visitas_user %}selected{% endif %}>üë• Todos</option>
                                    <option value="auth" {% if request.GET.visitas_user == 'auth' %}selected{% endif %}>‚úÖ Autenticados</option>
                                    <option value="anon" {% if request.GET.visitas_user == 'anon' %}selected{% endif %}>üîí An√≥nimos</option>
                                </select>
                                <select name="visitas_type" class="form-select form-select-sm flex-fill flex-md-grow-0 shadow-sm" id="visitas_type" onchange="this.form.submit()" style="min-width: 100px;">
                                    <option value="all" {% if request.GET.visitas_type == 'all' or not request.GET.visitas_type %}selected{% endif %}>üåê Todos</option>
                                    <option value="home" {% if request.GET.visitas_type == 'home' %}selected{% endif %}>üè† Home</option>
                                    <option value="store" {% if request.GET.visitas_type == 'store' %}selected{% endif %}>üè™ Tienda</option>
                                    <option value="product_detail" {% if request.GET.visitas_type == 'product_detail' %}selected{% endif %}>üì¶ Productos</option>
                                    <option value="cart" {% if request.GET.visitas_type == 'cart' %}selected{% endif %}>üõí Carrito</option>
                                    <option value="checkout" {% if request.GET.visitas_type == 'checkout' %}selected{% endif %}>üí≥ Checkout</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-light shadow-sm" id="refresh-visitas" title="Refrescar ahora">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Estad√≠sticas en cards responsive modernos (solo m√≥vil) -->
                        <div class="d-lg-none p-3 bg-light">
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <div class="card text-center h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <div class="card-body p-3 text-white">
                                            <h5 class="mb-1 fw-bold">{{ visitas_count }}</h5>
                                            <small class="opacity-75">üìä Total Filtrado</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card text-center h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                        <div class="card-body p-3 text-white">
                                            <h5 class="mb-1 fw-bold">{{ visitas_count_today }}</h5>
                                            <small class="opacity-75">üåü Hoy</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card text-center h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                        <div class="card-body p-3 text-white">
                                            <h5 class="mb-1 fw-bold">{{ visitas_count_auth }}</h5>
                                            <small class="opacity-75">‚úÖ Autenticados</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card text-center h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                        <div class="card-body p-3 text-white">
                                            <h5 class="mb-1 fw-bold">{{ visitas_count_anon }}</h5>
                                            <small class="opacity-75">üîí An√≥nimos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-0">
                            <!-- Sidebar de estad√≠sticas modernizado (solo desktop) -->
                            <div class="col-lg-3 d-none d-lg-block border-end bg-light">
                                <div class="p-3">
                                    <!-- Total filtrado destacado -->
                                    <div class="card border-0 shadow-sm mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <div class="card-body text-center text-white p-3">
                                            <h4 class="mb-1 fw-bold">{{ visitas_count }}</h4>
                                            <small class="opacity-75">üìä Total Filtrado</small>
                                        </div>
                                    </div>
                                    
                                    <!-- Por Per√≠odo -->
                                    <div class="mb-3">
                                        <h6 class="mb-2 text-primary fw-bold"><i class="fas fa-calendar-alt me-1"></i> Por Per√≠odo</h6>
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm">
                                            <span class="small">üåü Hoy:</span>
                                            <span class="badge" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">{{ visitas_count_today }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm">
                                            <span class="small">üìä Semana:</span>
                                            <span class="badge" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">{{ visitas_count_week }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm">
                                            <span class="small">üìà Mes:</span>
                                            <span class="badge" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">{{ visitas_count_month }}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Por Usuario -->
                                    <div class="mb-3">
                                        <h6 class="mb-2 text-success fw-bold"><i class="fas fa-users me-1"></i> Por Usuario</h6>
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm">
                                            <span class="small">‚úÖ Autenticados:</span>
                                            <span class="badge bg-success">{{ visitas_count_auth }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm">
                                            <span class="small">üîí An√≥nimos:</span>
                                            <span class="badge bg-secondary">{{ visitas_count_anon }}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Por Tipo -->
                                    <div>
                                        <h6 class="mb-2 text-info fw-bold"><i class="fas fa-map-signs me-1"></i> Por Tipo</h6>
                                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-white rounded shadow-sm">
                                            <span class="small">üè† Home:</span>
                                            <span class="badge bg-primary">{{ visitas_count_home }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-white rounded shadow-sm">
                                            <span class="small">üè™ Tienda:</span>
                                            <span class="badge bg-info">{{ visitas_count_store }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-white rounded shadow-sm">
                                            <span class="small">üì¶ Productos:</span>
                                            <span class="badge bg-success">{{ visitas_count_product }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-white rounded shadow-sm">
                                            <span class="small">üõí Carrito:</span>
                                            <span class="badge" style="background: #6f42c1;">{{ visitas_count_cart }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-white rounded shadow-sm">
                                            <span class="small">üí≥ Checkout:</span>
                                            <span class="badge bg-warning text-dark">{{ visitas_count_checkout }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contenedor de visitas con scroll moderno (desktop) -->
                            <div class="col-lg-9 d-none d-lg-block">
                                <!-- Header con contador -->
                                <div class="p-3 border-bottom bg-white sticky-top">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="text-muted">Mostrando</span>
                                            <span class="badge bg-primary">{{ visitas_count }}</span>
                                            <span class="text-muted">visitas</span>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-arrow-down me-1"></i>Despl√°zate para ver m√°s
                                        </small>
                                    </div>
                                </div>
                                
                                <!-- Contenedor con scroll -->
                                <div style="max-height: 600px; overflow-y: auto; overflow-x: hidden;" class="custom-scrollbar">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                                            <tr>
                                                <th style="min-width: 140px;">
                                                    <i class="fas fa-clock text-primary"></i> Fecha/Hora
                                                </th>
                                                <th style="min-width: 120px;">
                                                    <i class="fas fa-tag text-success"></i> Tipo
                                                </th>
                                                <th style="min-width: 150px;">
                                                    <i class="fas fa-user text-info"></i> Usuario
                                                </th>
                                                <th style="min-width: 180px;">
                                                    <i class="fas fa-map-marker-alt text-danger"></i> Ubicaci√≥n
                                                </th>
                                                <th style="min-width: 120px;">
                                                    <i class="fas fa-network-wired text-secondary"></i> IP
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="visitas-tbody">
                                            {% for visita in visitas_recientes %}
                                            <tr class="visita-row" style="transition: all 0.3s ease;">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="visit-time-badge">
                                                            <div class="fw-bold">{{ visita.timestamp|date:"H:i" }}</div>
                                                            <small class="text-muted">{{ visita.timestamp|date:"d/m/Y" }}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if visita.visit_type == 'home' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-home"></i> Home</span>
                                                    {% elif visita.visit_type == 'store' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><i class="fas fa-store"></i> Tienda</span>
                                                    {% elif visita.visit_type == 'product_detail' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                                            <i class="fas fa-box"></i> 
                                                            {% if visita.product %}
                                                                {{ visita.product.name|truncatewords:3 }}
                                                            {% elif visita.product_id %}
                                                                Producto #{{ visita.product_id }}
                                                            {% else %}
                                                                Producto
                                                            {% endif %}
                                                        </span>
                                                    {% elif visita.visit_type == 'cart' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="fas fa-shopping-basket"></i> Carrito</span>
                                                    {% elif visita.visit_type == 'checkout' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);"><i class="fas fa-shopping-cart"></i> Checkout</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary rounded-pill">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if visita.user %}
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                                                {{ visita.user.name|default:visita.user.email|first|upper }}
                                                            </div>
                                                            <div>
                                                                <div class="fw-semibold">{{ visita.user.name|default:visita.user.email|truncatewords:2 }}</div>
                                                                <small class="text-muted">‚úÖ Autenticado</small>
                                                            </div>
                                                        </div>
                                                    {% else %}
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2" style="width: 32px; height: 32px; border-radius: 50%; background: #6c757d; display: flex; align-items: center; justify-content: center; color: white;">
                                                                <i class="fas fa-user-secret"></i>
                                                            </div>
                                                            <div>
                                                                <div class="text-secondary">An√≥nimo</div>
                                                                <small class="text-muted">üîí No identificado</small>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if visita.city or visita.country %}
                                                        <div class="d-flex align-items-center">
                                                            <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                            <div>
                                                                <div class="fw-semibold">{{ visita.city|default:'Desconocida' }}</div>
                                                                <small class="text-muted">{{ visita.country|default:'-' }}</small>
                                                            </div>
                                                        </div>
                                                    {% else %}
                                                        <div class="text-muted">
                                                            <i class="fas fa-question-circle me-1"></i>No disponible
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <code class="px-2 py-1 bg-light rounded">{{ visita.ip_address|default:'-' }}</code>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center py-5">
                                                    <i class="fas fa-eye-slash fa-3x text-muted mb-3 d-block"></i>
                                                    <p class="text-muted">No hay visitas con los filtros seleccionados</p>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tarjetas m√≥viles con scroll moderno -->
                            <div class="col-12 d-lg-none">
                                <!-- Header contador m√≥vil -->
                                <div class="p-3 border-bottom bg-white sticky-top">
                                    <div class="text-center">
                                        <span class="badge bg-primary">{{ visitas_count }}</span>
                                        <span class="text-muted small">visitas totales</span>
                                        <div class="mt-1">
                                            <small class="text-muted">
                                                <i class="fas fa-arrow-down me-1"></i>Desliza para ver m√°s
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contenedor con scroll -->
                                <div style="max-height: 500px; overflow-y: auto; overflow-x: hidden;" class="custom-scrollbar p-3">
                                    {% for visita in visitas_recientes %}
                                    <div class="card mb-3 shadow-sm border-0" style="border-left: 4px solid {% if visita.visit_type == 'home' %}#667eea{% elif visita.visit_type == 'store' %}#4facfe{% elif visita.visit_type == 'product_detail' %}#43e97b{% elif visita.visit_type == 'cart' %}#fa709a{% elif visita.visit_type == 'checkout' %}#ffd89b{% else %}#6c757d{% endif %} !important;">
                                        <div class="card-body p-3">
                                            <!-- Header de la card -->
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div>
                                                    {% if visita.visit_type == 'home' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-home"></i> Home</span>
                                                    {% elif visita.visit_type == 'store' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><i class="fas fa-store"></i> Tienda</span>
                                                    {% elif visita.visit_type == 'product_detail' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                                            <i class="fas fa-box"></i> 
                                                            {% if visita.product %}
                                                                {{ visita.product.name|truncatewords:3 }}
                                                            {% elif visita.product_id %}
                                                                Producto #{{ visita.product_id }}
                                                            {% else %}
                                                                Producto
                                                            {% endif %}
                                                        </span>
                                                    {% elif visita.visit_type == 'cart' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="fas fa-shopping-basket"></i> Carrito</span>
                                                    {% elif visita.visit_type == 'checkout' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);"><i class="fas fa-shopping-cart"></i> Checkout</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary rounded-pill">-</span>
                                                    {% endif %}
                                                </div>
                                                <div class="text-end">
                                                    <div class="fw-bold">{{ visita.timestamp|date:"H:i" }}</div>
                                                    <small class="text-muted">{{ visita.timestamp|date:"d/m/Y" }}</small>
                                                </div>
                                            </div>
                                            
                                            <!-- Usuario -->
                                            <div class="mb-2">
                                                {% if visita.user %}
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                                            {{ visita.user.name|default:visita.user.email|first|upper }}
                                                        </div>
                                                        <div>
                                                            <div class="fw-semibold">{{ visita.user.name|default:visita.user.email|truncatewords:2 }}</div>
                                                            <small class="text-muted">‚úÖ Autenticado</small>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2" style="width: 40px; height: 40px; border-radius: 50%; background: #6c757d; display: flex; align-items: center; justify-content: center; color: white;">
                                                            <i class="fas fa-user-secret"></i>
                                                        </div>
                                                        <div>
                                                            <div class="text-secondary">An√≥nimo</div>
                                                            <small class="text-muted">üîí No identificado</small>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Footer con ubicaci√≥n e IP -->
                                            <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                                                <div>
                                                    {% if visita.city or visita.country %}
                                                        <small class="text-muted">
                                                            <i class="fas fa-map-marker-alt text-danger"></i> 
                                                            {{ visita.city|default:'Desconocida' }}{% if visita.country %}, {{ visita.country }}{% endif %}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">
                                                            <i class="fas fa-question-circle"></i> No disponible
                                                        </small>
                                                    {% endif %}
                                                </div>
                                                <code class="small bg-light px-2 py-1 rounded">{{ visita.ip_address|default:'-' }}</code>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-eye-slash fa-3x mb-3 d-block"></i>
                                        <p class="mb-0">No hay visitas con los filtros seleccionados</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Productos M√°s Visitados responsive -->
            <section class="mb-4">
                <div class="card modern-card">
                    <div class="card-header modern-header">
                        <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-3">
                            <div>
                                <i class="fas fa-fire me-2 text-danger"></i>
                                <strong>Productos M√°s Visitados</strong>
                                {% if productos_visitados_page %}
                                <span class="badge bg-info ms-2">{{ productos_visitados_page.paginator.count }} productos</span>
                                {% endif %}
                            </div>
                            <div class="d-flex gap-2 align-items-center w-100 w-sm-auto">
                                <select class="form-select form-select-sm flex-fill flex-sm-grow-0" id="periodo-productos" style="min-width: 120px;">
                                    <option value="all" {% if request.GET.periodo_productos == 'all' or not request.GET.periodo_productos %}selected{% endif %}>Todo</option>
                                    <option value="today" {% if request.GET.periodo_productos == 'today' %}selected{% endif %}>Hoy</option>
                                    <option value="week" {% if request.GET.periodo_productos == 'week' %}selected{% endif %}>Semana</option>
                                    <option value="month" {% if request.GET.periodo_productos == 'month' %}selected{% endif %}>Mes</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-success" id="refresh-productos" title="Refrescar productos">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if productos_visitados_page %}
                        <!-- Informaci√≥n de paginaci√≥n -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <small class="text-muted">
                                Mostrando {{ productos_visitados_page.start_index }} - {{ productos_visitados_page.end_index }} 
                                de {{ productos_visitados_page.paginator.count }} productos
                            </small>
                            <small class="text-muted">
                                P√°gina {{ productos_visitados_page.number }} de {{ productos_visitados_page.paginator.num_pages }}
                            </small>
                        </div>
                        
                        <div class="row g-3" id="productos-visitados-container">
                            {% for item in productos_visitados_page %}
                            <div class="col-12 col-sm-6 col-lg-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                {% if item.product.imagen %}
                                                    <img src="{{ item.product.imagen.url }}" alt="{{ item.product.name }}" 
                                                         class="rounded" width="60" height="60" style="object-fit: cover;">
                                                {% else %}
                                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                        <i class="fas fa-image text-muted"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-1">{{ item.product.name|truncatewords:5 }}</h6>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-eye"></i> {{ item.total_visitas }} visita{{ item.total_visitas|pluralize }}
                                                    </span>
                                                    <span class="text-muted small">
                                                        ${{ item.product.price|floatformat:0 }}
                                                    </span>
                                                </div>
                                                <div class="mt-1">
                                                    <span class="badge bg-secondary small">Stock: {{ item.product.stock }}</span>
                                                    {% if item.product.category %}
                                                        <span class="badge bg-info small">{{ item.product.category.nombre }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No hay datos de productos visitados en este per√≠odo
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Paginaci√≥n de productos visitados -->
                        {% if productos_visitados_page.paginator.num_pages > 1 %}
                        <nav aria-label="Paginaci√≥n de productos visitados" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <!-- Primera p√°gina -->
                                {% if productos_visitados_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?view=visitas&productos_page=1{% if request.GET.visitas_filter %}&visitas_filter={{ request.GET.visitas_filter }}{% endif %}{% if request.GET.visitas_user %}&visitas_user={{ request.GET.visitas_user }}{% endif %}{% if request.GET.visitas_type %}&visitas_type={{ request.GET.visitas_type }}{% endif %}{% if request.GET.periodo_productos %}&periodo_productos={{ request.GET.periodo_productos }}{% endif %}">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?view=visitas&productos_page={{ productos_visitados_page.previous_page_number }}{% if request.GET.visitas_filter %}&visitas_filter={{ request.GET.visitas_filter }}{% endif %}{% if request.GET.visitas_user %}&visitas_user={{ request.GET.visitas_user }}{% endif %}{% if request.GET.visitas_type %}&visitas_type={{ request.GET.visitas_type }}{% endif %}{% if request.GET.periodo_productos %}&periodo_productos={{ request.GET.periodo_productos }}{% endif %}">
                                        <i class="fas fa-angle-left"></i> Anterior
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-left"></i> Anterior</span>
                                </li>
                                {% endif %}

                                <!-- P√°ginas numeradas -->
                                {% for num in productos_visitados_page.paginator.page_range %}
                                    {% if productos_visitados_page.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                    {% elif num > productos_visitados_page.number|add:'-3' and num < productos_visitados_page.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?view=visitas&productos_page={{ num }}{% if request.GET.visitas_filter %}&visitas_filter={{ request.GET.visitas_filter }}{% endif %}{% if request.GET.visitas_user %}&visitas_user={{ request.GET.visitas_user }}{% endif %}{% if request.GET.visitas_type %}&visitas_type={{ request.GET.visitas_type }}{% endif %}{% if request.GET.periodo_productos %}&periodo_productos={{ request.GET.periodo_productos }}{% endif %}">{{ num }}</a>
                                    </li>
                                    {% endif %}
                                {% endfor %}

                                <!-- √öltima p√°gina -->
                                {% if productos_visitados_page.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?view=visitas&productos_page={{ productos_visitados_page.next_page_number }}{% if request.GET.visitas_filter %}&visitas_filter={{ request.GET.visitas_filter }}{% endif %}{% if request.GET.visitas_user %}&visitas_user={{ request.GET.visitas_user }}{% endif %}{% if request.GET.visitas_type %}&visitas_type={{ request.GET.visitas_type }}{% endif %}{% if request.GET.periodo_productos %}&periodo_productos={{ request.GET.periodo_productos }}{% endif %}">
                                        Siguiente <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?view=visitas&productos_page={{ productos_visitados_page.paginator.num_pages }}{% if request.GET.visitas_filter %}&visitas_filter={{ request.GET.visitas_filter }}{% endif %}{% if request.GET.visitas_user %}&visitas_user={{ request.GET.visitas_user }}{% endif %}{% if request.GET.visitas_type %}&visitas_type={{ request.GET.visitas_type }}{% endif %}{% if request.GET.periodo_productos %}&periodo_productos={{ request.GET.periodo_productos }}{% endif %}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Siguiente <i class="fas fa-angle-right"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No hay datos de productos visitados
                        </div>
                        {% endif %}
                    </div>
                </div>
            </section>
            {% endif %}
           






            {% if request.GET.view == "usuarios" %}
                <div class="usuarios-dashboard">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-users me-2"></i>Gesti√≥n de Usuarios</h2>
                        <div class="d-flex gap-2">
                            <span class="badge bg-primary">Total: {{ usuarios|length }}</span>
                            <span class="badge bg-success">Simples: {{ usuarios|length|add:"-"|add:"0" }}</span>
                            <span class="badge bg-warning">Admins: {{ usuarios|length|add:"-"|add:"0" }}</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre</th>
                                            <th>Email</th>
                                            <th>Tel√©fono</th>
                                            <th>Ciudad</th>
                                            <th>Username</th>
                                            <th>Tipo de Usuario</th>
                                            <th>Fecha de Registro</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for usuario in usuarios %}
                                        <tr>
                                            <td>{{ usuario.id }}</td>
                                            <td>
                                                <strong>{{ usuario.name|default:"Sin nombre" }}</strong>
                                            </td>
                                            <td>
                                                <a href="mailto:{{ usuario.email }}">{{ usuario.email }}</a>
                                            </td>
                                            <td>
                                                {{ usuario.phone|default:"Sin tel√©fono" }}
                                            </td>
                                            <td>
                                                {{ usuario.city|default:"Sin ciudad" }}
                                            </td>
                                            <td>
                                                {{ usuario.username|default:"Sin username" }}
                                            </td>
                                            <td class="text-center">
                                                {% if usuario.is_admin %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-crown me-1"></i>Administrador
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-user me-1"></i>Usuario Simple
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    {{ usuario.date_joined|date:"d/m/Y H:i"|default:"Sin fecha" }}
                                                </small>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group" role="group">
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-primary edit-user-btn" 
                                                            data-user-id="{{ usuario.id }}"
                                                            data-model-type="{{ usuario.model_type }}"
                                                            title="Editar usuario">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    {% if not usuario.is_admin %}
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-danger delete-user-btn" 
                                                            data-user-id="{{ usuario.id }}"
                                                            data-model-type="{{ usuario.model_type }}"
                                                            data-user-name="{{ usuario.name }}"
                                                            title="Eliminar usuario">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% else %}
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-secondary" 
                                                            disabled
                                                            title="No se pueden eliminar administradores">
                                                        <i class="fas fa-shield-alt"></i>
                                                    </button>
                                                    {% endif %}
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-info view-user-btn" 
                                                            data-user-id="{{ usuario.id }}"
                                                            data-model-type="{{ usuario.model_type }}"
                                                            title="Ver detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="9" class="text-center">
                                                <div class="py-4">
                                                    <i class="fas fa-users text-muted fa-3x mb-3"></i>
                                                    <h5 class="text-muted">No hay usuarios registrados</h5>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal para editar usuario -->
                <div class="modal fade" id="editUserModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-edit me-2"></i>Editar Usuario
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editUserForm">
                                    <input type="hidden" id="editUserId" name="user_id">
                                    <input type="hidden" id="editUserModelType" name="model_type">
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserName" class="form-label">Nombre</label>
                                                <input type="text" class="form-control" id="editUserName" name="name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserEmail" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="editUserEmail" name="email" required>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserPhone" class="form-label">Tel√©fono</label>
                                                <input type="text" class="form-control" id="editUserPhone" name="phone">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserUsername" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="editUserUsername" name="username">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserAddress" class="form-label">Direcci√≥n</label>
                                                <input type="text" class="form-control" id="editUserAddress" name="address">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserCity" class="form-label">Ciudad</label>
                                                <input type="text" class="form-control" id="editUserCity" name="city">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Secci√≥n de Seguridad -->
                                    <hr>
                                    <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Seguridad y Permisos</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserPassword" class="form-label">
                                                    <i class="fas fa-key me-1"></i>Nueva Contrase√±a
                                                </label>
                                                <input type="password" class="form-control" id="editUserPassword" name="password" 
                                                       placeholder="Dejar vac√≠o para mantener actual">
                                                <div class="form-text">Solo completar si desea cambiar la contrase√±a</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserConfirmPassword" class="form-label">
                                                    <i class="fas fa-key me-1"></i>Confirmar Contrase√±a
                                                </label>
                                                <input type="password" class="form-control" id="editUserConfirmPassword" name="confirm_password" 
                                                       placeholder="Confirmar nueva contrase√±a">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Permisos (solo para register_superuser) -->
                                    <div id="permissionsSection" class="permissions-section" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <label class="form-label">
                                                    <i class="fas fa-user-cog me-1"></i>Permisos de Usuario
                                                </label>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-check form-switch mb-2">
                                                    <input class="form-check-input" type="checkbox" id="editUserIsActive" name="is_active">
                                                    <label class="form-check-label" for="editUserIsActive">
                                                        <i class="fas fa-user-check me-1"></i>Usuario Activo
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check form-switch mb-2">
                                                    <input class="form-check-input" type="checkbox" id="editUserIsStaff" name="is_staff">
                                                    <label class="form-check-label" for="editUserIsStaff">
                                                        <i class="fas fa-user-tie me-1"></i>Es Staff
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check form-switch mb-2">
                                                    <input class="form-check-input" type="checkbox" id="editUserIsSuperuser" name="is_superuser">
                                                    <label class="form-check-label" for="editUserIsSuperuser">
                                                        <i class="fas fa-crown me-1"></i>Super Usuario
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Estado del Usuario Simple -->
                                    <div id="simpleUserSection" class="simple-user-section" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check form-switch mb-2">
                                                    <input class="form-check-input" type="checkbox" id="editSimpleUserIsActive" name="simple_is_active">
                                                    <label class="form-check-label" for="editSimpleUserIsActive">
                                                        <i class="fas fa-user-check me-1"></i>Usuario Activo
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="alert alert-info alert-sm">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    <small>Los usuarios simples tienen permisos limitados por defecto</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="saveUserChanges">
                                    <i class="fas fa-save me-2"></i>Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal para ver detalles del usuario -->
                <div class="modal fade" id="viewUserModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-circle me-2"></i>Detalles del Usuario
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="userDetailsContent">
                                <!-- El contenido se carga din√°micamente -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Script espec√≠fico para gesti√≥n de usuarios -->
                <script>
                    // Asegurar que la gesti√≥n de usuarios se inicialice
                    document.addEventListener('DOMContentLoaded', function() {
                        console.log('Inicializando gesti√≥n de usuarios inline...');
                        
                        // Event listeners para botones de usuarios
                        document.addEventListener('click', function(e) {
                            if (e.target.matches('.edit-user-btn') || e.target.closest('.edit-user-btn')) {
                                e.preventDefault();
                                const btn = e.target.matches('.edit-user-btn') ? e.target : e.target.closest('.edit-user-btn');
                                const userId = btn.dataset.userId;
                                const modelType = btn.dataset.modelType;
                                
                                console.log('Edit user clicked:', { userId, modelType });
                                loadUserForEditInline(userId, modelType);
                            }
                            
                            if (e.target.matches('.view-user-btn') || e.target.closest('.view-user-btn')) {
                                e.preventDefault();
                                const btn = e.target.matches('.view-user-btn') ? e.target : e.target.closest('.view-user-btn');
                                const userId = btn.dataset.userId;
                                const modelType = btn.dataset.modelType;
                                
                                console.log('View user clicked:', { userId, modelType });
                                viewUserDetailsInline(userId, modelType);
                            }
                            
                            if (e.target.matches('.delete-user-btn') || e.target.closest('.delete-user-btn')) {
                                e.preventDefault();
                                const btn = e.target.matches('.delete-user-btn') ? e.target : e.target.closest('.delete-user-btn');
                                const userId = btn.dataset.userId;
                                const modelType = btn.dataset.modelType;
                                const userName = btn.dataset.userName;
                                
                                console.log('Delete user clicked:', { userId, modelType, userName });
                                confirmDeleteUserInline(userId, modelType, userName);
                            }
                        });
                        
                        // Listener para guardar cambios
                        const saveBtn = document.getElementById('saveUserChanges');
                        if (saveBtn) {
                            saveBtn.addEventListener('click', saveUserChangesInline);
                        }
                    });
                    
                    // Funci√≥n para cargar usuario para edici√≥n
                    async function loadUserForEditInline(userId, modelType) {
                        console.log('loadUserForEditInline called with:', userId, modelType);
                        try {
                            const response = await fetch(`/dashboard/usuario/${userId}/${modelType}/detalles/`);
                            console.log('Response received:', response);
                            const data = await response.json();
                            console.log('Data parsed:', data);
                            
                            if (data.success) {
                                const user = data.user;
                                
                                // Llenar campos b√°sicos
                                document.getElementById('editUserId').value = user.id;
                                document.getElementById('editUserModelType').value = user.model_type;
                                document.getElementById('editUserName').value = user.name || '';
                                document.getElementById('editUserEmail').value = user.email || '';
                                document.getElementById('editUserPhone').value = user.phone || '';
                                document.getElementById('editUserAddress').value = user.address || '';
                                document.getElementById('editUserCity').value = user.city || '';
                                document.getElementById('editUserUsername').value = user.username || '';
                                
                                // Limpiar campos de contrase√±a
                                document.getElementById('editUserPassword').value = '';
                                document.getElementById('editUserConfirmPassword').value = '';
                                
                                // Mostrar/ocultar secciones seg√∫n el tipo de usuario
                                const permissionsSection = document.getElementById('permissionsSection');
                                const simpleUserSection = document.getElementById('simpleUserSection');
                                
                                if (modelType === 'register_superuser') {
                                    // Mostrar secci√≥n de permisos completa para administradores
                                    permissionsSection.style.display = 'block';
                                    simpleUserSection.style.display = 'none';
                                    
                                    // Llenar campos de permisos usando los nuevos datos
                                    document.getElementById('editUserIsActive').checked = user.is_active !== false;
                                    document.getElementById('editUserIsStaff').checked = user.is_staff || false;
                                    document.getElementById('editUserIsSuperuser').checked = user.is_superuser || false;
                                } else {
                                    // Mostrar secci√≥n simple para usuarios normales
                                    permissionsSection.style.display = 'none';
                                    simpleUserSection.style.display = 'block';
                                    
                                    // Llenar campo de estado activo para usuario simple
                                    document.getElementById('editSimpleUserIsActive').checked = user.is_active !== false;
                                }
                                
                                console.log('About to show modal...');
                                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                                modal.show();
                                console.log('Modal show() called');
                            } else {
                                console.error('API error:', data.error);
                                alert('Error al cargar usuario: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error de conexi√≥n');
                        }
                    }
                    
                    // Funci√≥n para ver detalles
                    async function viewUserDetailsInline(userId, modelType) {
                        try {
                            const response = await fetch(`/dashboard/usuario/${userId}/${modelType}/detalles/`);
                            const data = await response.json();
                            
                            if (data.success) {
                                const user = data.user;
                                
                                const detailsContent = `
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-user me-2"></i>Informaci√≥n Personal</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>ID:</strong></td><td>${user.id}</td></tr>
                                                <tr><td><strong>Nombre:</strong></td><td>${user.name || 'Sin nombre'}</td></tr>
                                                <tr><td><strong>Email:</strong></td><td>${user.email}</td></tr>
                                                <tr><td><strong>Tel√©fono:</strong></td><td>${user.phone || 'Sin tel√©fono'}</td></tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-info-circle me-2"></i>Informaci√≥n Adicional</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>Username:</strong></td><td>${user.username || 'Sin username'}</td></tr>
                                                <tr><td><strong>Ciudad:</strong></td><td>${user.city || 'Sin ciudad'}</td></tr>
                                                <tr><td><strong>Direcci√≥n:</strong></td><td>${user.address || 'Sin direcci√≥n'}</td></tr>
                                                <tr><td><strong>Fecha:</strong></td><td>${user.date_joined || 'Sin fecha'}</td></tr>
                                            </table>
                                        </div>
                                    </div>
                                `;
                                
                                document.getElementById('userDetailsContent').innerHTML = detailsContent;
                                const modal = new bootstrap.Modal(document.getElementById('viewUserModal'));
                                modal.show();
                            } else {
                                alert('Error al cargar detalles: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error de conexi√≥n');
                        }
                    }
                    
                    // Funci√≥n para confirmar eliminaci√≥n
                    function confirmDeleteUserInline(userId, modelType, userName) {
                        if (modelType === 'register_superuser') {
                            alert('No se pueden eliminar usuarios administradores por seguridad.');
                            return;
                        }
                        
                        if (confirm(`¬øEst√°s seguro de que quieres eliminar el usuario "${userName}"?`)) {
                            deleteUserInline(userId, modelType);
                        }
                    }
                    
                    // Funci√≥n para eliminar usuario
                    async function deleteUserInline(userId, modelType) {
                        try {
                            const response = await fetch('/dashboard/usuario/eliminar/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify({
                                    user_id: userId,
                                    model_type: modelType
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                alert(data.message);
                                location.reload();
                            } else {
                                alert('Error: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error de conexi√≥n');
                        }
                    }
                    
                    // Funci√≥n para guardar cambios
                    async function saveUserChangesInline() {
                        const form = document.getElementById('editUserForm');
                        const formData = new FormData(form);
                        
                        // Validar contrase√±as
                        const password = document.getElementById('editUserPassword').value;
                        const confirmPassword = document.getElementById('editUserConfirmPassword').value;
                        
                        if (password && password !== confirmPassword) {
                            alert('Las contrase√±as no coinciden');
                            return;
                        }
                        
                        if (password && password.length < 6) {
                            alert('La contrase√±a debe tener al menos 6 caracteres');
                            return;
                        }
                        
                        const modelType = formData.get('model_type');
                        
                        const userData = {
                            user_id: formData.get('user_id'),
                            model_type: modelType,
                            name: formData.get('name'),
                            email: formData.get('email'),
                            phone: formData.get('phone'),
                            address: formData.get('address'),
                            city: formData.get('city'),
                            username: formData.get('username')
                        };
                        
                        // Agregar contrase√±a si se proporcion√≥
                        if (password) {
                            userData.password = password;
                        }
                        
                        // Agregar permisos seg√∫n el tipo de usuario
                        if (modelType === 'register_superuser') {
                            userData.is_active = document.getElementById('editUserIsActive').checked;
                            userData.is_staff = document.getElementById('editUserIsStaff').checked;
                            userData.is_superuser = document.getElementById('editUserIsSuperuser').checked;
                        } else {
                            userData.is_active = document.getElementById('editSimpleUserIsActive').checked;
                        }
                        
                        try {
                            const response = await fetch('/dashboard/usuario/editar/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify(userData)
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                alert(data.message);
                                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                                location.reload();
                            } else {
                                alert('Error: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error de conexi√≥n');
                        }
                    }
                    
                    // Funci√≥n para obtener cookie CSRF
                    function getCookie(name) {
                        const match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
                        return match ? match.pop() : '';
                    }
                </script>

            {% elif request.GET.view == "productos" %}
                <div class="productos-dashboard">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-boxes me-2"></i>Gesti√≥n de Productos</h2>
                        <a href="?view=productos&crear=1" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Crear Producto
                        </a>
                    </div>

                    <!-- Filtros responsive -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
                            <button class="btn btn-sm btn-outline-secondary d-md-none" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#filtrosCollapse" 
                                    aria-expanded="true" aria-controls="filtrosCollapse">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="collapse show" id="filtrosCollapse">
                                <form method="GET" class="row g-3">
                                    <input type="hidden" name="view" value="productos">
                                    
                                    <div class="col-12 col-md-5">
                                        <label for="categoria_filter" class="form-label">Categor√≠a</label>
                                        <select name="categoria_filter" id="categoria_filter" class="form-select">
                                            <option value="">Todas las categor√≠as</option>
                                            {% for categoria in categorias %}
                                                <option value="{{ categoria.id }}" {% if categoria_filter == categoria.id|stringformat:"s" %}selected{% endif %}>
                                                    {{ categoria.nombre }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="col-12 col-md-5">
                                        <label for="search" class="form-label">Buscar</label>
                                        <input type="text" name="search" id="search" class="form-control" 
                                               value="{{ search_query }}" placeholder="Nombre o descripci√≥n" style="font-size: 16px;">
                                    </div>
                                    
                                    <div class="col-12 col-md-2 d-flex align-items-end gap-2">
                                        <button type="submit" class="btn btn-primary flex-grow-1">
                                            <i class="fas fa-search"></i><span class="d-none d-sm-inline ms-2">Buscar</span>
                                        </button>
                                        <a href="?view=productos" class="btn btn-outline-secondary flex-grow-1">
                                            <i class="fas fa-times"></i><span class="d-none d-sm-inline ms-2">Limpiar</span>
                                        </a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de resultados -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
                        <div class="results-info">
                            <span class="badge bg-info">
                                Total: {{ productos_page.paginator.count }} producto(s)
                            </span>
                            {% if categoria_filter %}
                                <span class="badge bg-success ms-2">
                                    Filtrado por categor√≠a
                                </span>
                            {% endif %}
                            {% if search_query %}
                                <span class="badge bg-warning ms-2">
                                    B√∫squeda: "{{ search_query }}"
                                </span>
                            {% endif %}
                        </div>
                        
                        <div class="pagination-info">
                            <small class="text-muted">P√°gina {{ productos_page.number }} de {{ productos_page.paginator.num_pages }}</small>
                        </div>
                    </div>

                    <!-- Vista Desktop - Tabla de productos -->
                    <div class="card d-none d-lg-block">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col" style="width: 80px;">Imagen</th>
                                            <th scope="col">Nombre</th>
                                            <th scope="col">Categor√≠a</th>
                                            <th scope="col">Stock</th>
                                            <th scope="col">Precio Compra</th>
                                            <th scope="col">Precio Venta</th>
                                            <th scope="col">Proveedor</th>
                                            <th scope="col" style="width: 180px;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for producto in productos %}
                                        <tr data-producto-id="{{ producto.id }}">
                                            <td class="text-center">
                                                {% if producto.imagen %}
                                                    <img src="{{ producto.imagen.url }}" alt="{{ producto.name }}" 
                                                         class="product-thumbnail rounded" width="50" height="50" 
                                                         style="object-fit: cover;"/>
                                                {% else %}
                                                    <div class="no-image-placeholder d-flex align-items-center justify-content-center" 
                                                         style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 4px;">
                                                        <i class="fas fa-image text-muted"></i>
                                                    </div>
                                                {% endif %} 
                                            </td>
                                            <td class="align-middle">
                                                <strong>{{ producto.name }}</strong>
                                                {% if producto.description %}
                                                    <br><small class="text-muted">{{ producto.description|truncatechars:50 }}</small>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                {% if producto.category %}
                                                    <span class="badge bg-primary">{{ producto.category.nombre }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Sin categor√≠a</span>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                {% if producto.stock > 10 %}
                                                    <span class="badge bg-success">{{ producto.stock }}</span>
                                                {% elif producto.stock > 0 %}
                                                    <span class="badge bg-warning text-dark">{{ producto.stock }}</span>
                                                {% else %}
                                                    <span class="badge bg-danger">{{ producto.stock }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                <span class="text-muted">${{ producto.price_buy|floatformat:0 }}</span>
                                            </td>
                                            <td class="align-middle">
                                                <strong class="text-success">${{ producto.price|floatformat:0 }}</strong>
                                            </td>
                                            <td class="align-middle">
                                                {% if producto.proveedor %}
                                                    <small>{{ producto.proveedor.nombre }}</small>
                                                {% else %}
                                                    <small class="text-muted">Sin proveedor</small>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="?view=productos&editar={{ producto.id }}" 
                                                       class="btn btn-outline-primary btn-sm" title="Editar">
                                                        <i class="fas fa-edit"></i> Editar
                                                    </a>
                                                    <button type="button" 
                                                            class="btn btn-outline-danger btn-sm delete-product-btn" 
                                                            data-product-id="{{ producto.id }}" title="Eliminar">
                                                        <i class="fas fa-trash"></i> Eliminar
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center py-4">
                                                <div class="no-products">
                                                    <i class="fas fa-box-open text-muted" style="font-size: 3rem;"></i>
                                                    <h5 class="mt-3 text-muted">No hay productos</h5>
                                                    <p class="text-muted">
                                                        {% if categoria_filter or search_query %}
                                                            No se encontraron productos con los filtros aplicados.
                                                        {% else %}
                                                            A√∫n no has agregado productos a tu inventario.
                                                        {% endif %}
                                                    </p>
                                                    {% if not categoria_filter and not search_query %}
                                                        <a href="?view=productos&crear=1" class="btn btn-primary">
                                                            <i class="fas fa-plus me-2"></i>Crear primer producto
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Vista M√≥vil - Tarjetas de productos -->
                    <div class="d-lg-none">
                        {% for producto in productos %}
                        <div class="card producto-card-mobile mb-3" data-producto-id="{{ producto.id }}">
                            <div class="card-body">
                                <!-- Header con imagen y nombre -->
                                <div class="row g-3">
                                    <div class="col-4">
                                        {% if producto.imagen %}
                                            <img src="{{ producto.imagen.url }}" alt="{{ producto.name }}" 
                                                 class="img-fluid rounded" style="width: 100%; aspect-ratio: 1; object-fit: cover;"/>
                                        {% else %}
                                            <div class="no-image-placeholder d-flex align-items-center justify-content-center rounded" 
                                                 style="width: 100%; aspect-ratio: 1; background: #f0f0f0;">
                                                <i class="fas fa-image fa-2x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-8">
                                        <h6 class="mb-2">{{ producto.name }}</h6>
                                        {% if producto.category %}
                                            <span class="badge bg-primary mb-2">{{ producto.category.nombre }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary mb-2">Sin categor√≠a</span>
                                        {% endif %}
                                        <br>
                                        {% if producto.stock > 10 %}
                                            <span class="badge bg-success">Stock: {{ producto.stock }}</span>
                                        {% elif producto.stock > 0 %}
                                            <span class="badge bg-warning text-dark">Stock: {{ producto.stock }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">Sin stock</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Descripci√≥n -->
                                {% if producto.description %}
                                <div class="mt-3">
                                    <small class="text-muted">{{ producto.description|truncatechars:80 }}</small>
                                </div>
                                {% endif %}

                                <!-- Informaci√≥n de precios y proveedor -->
                                <div class="row g-2 mt-3">
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded">
                                            <small class="text-muted d-block">Precio Compra</small>
                                            <strong>${{ producto.price_buy|floatformat:0 }}</strong>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-success bg-opacity-10 rounded">
                                            <small class="text-muted d-block">Precio Venta</small>
                                            <strong class="text-success">${{ producto.price|floatformat:0 }}</strong>
                                        </div>
                                    </div>
                                    {% if producto.proveedor %}
                                    <div class="col-12">
                                        <div class="p-2 bg-light rounded">
                                            <small class="text-muted d-block">
                                                <i class="fas fa-truck me-1"></i>Proveedor
                                            </small>
                                            <small>{{ producto.proveedor.nombre }}</small>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Botones de acci√≥n -->
                                <div class="row g-2 mt-3">
                                    <div class="col-6">
                                        <a href="?view=productos&editar={{ producto.id }}" 
                                           class="btn btn-outline-primary btn-sm w-100">
                                            <i class="fas fa-edit"></i> Editar
                                        </a>
                                    </div>
                                    <div class="col-6">
                                        <button type="button" 
                                                class="btn btn-outline-danger btn-sm w-100 delete-product-btn" 
                                                data-product-id="{{ producto.id }}">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="card">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-box-open text-muted" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-muted">No hay productos</h5>
                                <p class="text-muted">
                                    {% if categoria_filter or search_query %}
                                        No se encontraron productos con los filtros aplicados.
                                    {% else %}
                                        A√∫n no has agregado productos a tu inventario.
                                    {% endif %}
                                </p>
                                {% if not categoria_filter and not search_query %}
                                    <a href="?view=productos&crear=1" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>Crear primer producto
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Paginaci√≥n -->
                    {% if productos_page.paginator.num_pages > 1 %}
                    <nav aria-label="Paginaci√≥n de productos" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <!-- Primera p√°gina -->
                            {% if productos_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page=1">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <!-- P√°gina anterior -->
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ productos_page.previous_page_number }}">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-left"></i></span>
                                </li>
                            {% endif %}

                            <!-- P√°ginas numeradas -->
                            {% for num in productos_page.paginator.page_range %}
                                {% if num == productos_page.number %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > productos_page.number|add:'-3' and num < productos_page.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ num }}">
                                            {{ num }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            <!-- P√°gina siguiente -->
                            {% if productos_page.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ productos_page.next_page_number }}">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <!-- √öltima p√°gina -->
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ productos_page.paginator.num_pages }}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-right"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                                </li>
                            {% endif %}
                            <!-- Link Visitas en el sidebar principal -->
                            <li class="nav-item">
                                <a href="?view=visitas" class="nav-link {% if request.GET.view == 'visitas' %}active{% endif %}" title="Visitas a la tienda">
                                    <i class="fas fa-eye nav-icon"></i>
                                    <span class="sidebar-text">Visitas</span>
                                </a>
                            </li>
                        </ul>
                    </nav>

                    <!-- Informaci√≥n de la paginaci√≥n -->
                    <div class="text-center text-muted">
                        <small>
                            Mostrando 
                            <strong>{{ productos_page.start_index }}</strong> - <strong>{{ productos_page.end_index }}</strong> 
                            de <strong>{{ productos_page.paginator.count }}</strong> productos
                        </small>
                    </div>
                    {% endif %}
                </div>
                </table>
               
            <!-- ...existing code... -->
            {% if show_create_product_form or show_edit_product_form %}
               <h2 id="form-title">{% if producto_to_edit %}Editar Producto{% else %}Crear Producto{% endif %}</h2>
               <form id="form-crear-producto" method="post" enctype="multipart/form-data" class="form-crear-producto" action="{% url 'dashboard_home' %}?view=productos{% if producto_to_edit %}&editar={{ producto_to_edit.id }}{% else %}&crear=1{% endif %}" data-create-action="{% url 'dashboard_home' %}?view=productos&crear=1">
               {% csrf_token %}
              <input type="hidden" name="product_id" id="producto_id" value="{% if producto_to_edit %}{{ producto_to_edit.id }}{% endif %}" />

             <label>Nombre:</label>
             <input type="text" name="name" id="producto_name" value="{% if producto_to_edit %}{{ producto_to_edit.name }}{% endif %}" required />

             <label>Descripci√≥n:</label>
            <textarea name="description" id="producto_description">{% if producto_to_edit %}{{ producto_to_edit.description }}{% endif %}</textarea>
 
             <div class="row g-3 mt-2">
              <div class="col-12 col-md-6">
                <label>Precio de compra:</label>
                <input type="number" name="price_buy" id="producto_price_buy" step="0.01" value="{% if producto_to_edit %}{{ producto_to_edit.price_buy }}{% endif %}" class="form-control" required />
             </div>
            <div class="col-12 col-md-6">
                <label>Precio de venta:</label>
                <input type="number" name="price" id="producto_price" step="0.01" value="{% if producto_to_edit %}{{ producto_to_edit.price }}{% endif %}" class="form-control" required />
            </div>
            <div class="col-12 col-md-4">
                <label>Stock:</label>
                <input type="number" name="stock" id="producto_stock" value="{% if producto_to_edit %}{{ producto_to_edit.stock }}{% endif %}" class="form-control" required />
            </div>
            <div class="col-12 col-md-4">
                <label>Descuento:</label>
                <input type="number" name="descuento" id="producto_descuento" step="0.01" value="{% if producto_to_edit %}{{ producto_to_edit.descuento|default:0 }}{% endif %}" class="form-control" />
            </div>
            <div class="col-12 col-md-4">
                <label>IVA:</label>
                <input type="number" name="iva" id="producto_iva" step="0.01" value="{% if producto_to_edit %}{{ producto_to_edit.iva|default:0 }}{% endif %}" class="form-control" />
            </div>
        </div>        <div class="row g-3 mt-2">
            <div class="col-12 col-md-4">
                <label>Proveedor:</label>
                <select name="proveedor" id="producto_proveedor" class="form-select">
                    <option value="">Seleccione un proveedor</option>
                    {% for prov in proveedores %}
                        <option value="{{ prov.id }}" {% if producto_to_edit and producto_to_edit.proveedor.id == prov.id %}selected{% endif %}>{{ prov.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-4">
                <label>Categor√≠as:</label>
                <select name="categoria" id="producto_categoria" class="form-select">
                    <option value="">Seleccione una categor√≠a</option>
                    {% for categoria in categorias %}
                        <option value="{{ categoria.id }}" {% if producto_to_edit and producto_to_edit.category.id == categoria.id %}selected{% endif %}>{{ categoria.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-4">
                <label>Tipo de producto:</label>
                <select name="type" id="producto_type" class="form-select">
                    <option value="">Seleccione un tipo</option>
                    {% for tipo in tipos %}
                        <option value="{{ tipo.id }}" {% if producto_to_edit and producto_to_edit.type.id == tipo.id %}selected{% endif %}>{{ tipo.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <label>Imagen principal:</label>
        <input type="file" name="images" id="producto_images" />
        <div id="preview-main" style="margin-top:8px;">
            {% if producto_to_edit and producto_to_edit.imagen %}
                <div class="position-relative d-inline-block">
                    <img src="{{ producto_to_edit.imagen.url }}" alt="{{ producto_to_edit.name }}" style="max-width:150px; border-radius:6px; border:2px solid #ddd;" />
                    <small class="d-block text-muted mt-1">Imagen actual (selecciona un archivo para reemplazar)</small>
                </div>
            {% endif %}
            <img id="preview-main-img" src="" alt="Nueva imagen" style="max-width:150px; display:none; margin-top:8px; border-radius:6px;" />
        </div>

        <label>Galer√≠a:</label>
        <small class="text-muted d-block mb-2">{% if producto_to_edit %}A√±ade m√°s im√°genes o elimina las existentes{% else %}Selecciona m√∫ltiples im√°genes{% endif %}</small>
<input type="file" name="galeria" id="producto_galeria" multiple accept="image/*" />
<div id="preview-gallery" style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;">
  {# im√°genes existentes (solo si existe producto_to_edit) #}
  {% if producto_to_edit %}
    {% for img in producto_to_edit.galeria.all %}
      <div class="gallery-item position-relative" data-gallery-id="{{ img.id }}" style="position:relative; border:2px solid #28a745; border-radius:8px; padding:4px; background:#f8f9fa;">
        {% if img.galeria and img.galeria.name %}
          <img src="{{ img.galeria.url }}" style="max-width:120px; max-height:120px; object-fit:cover; border-radius:6px; display:block;" />
        {% elif img.imagen and img.imagen.name %}
          <img src="{{ img.imagen.url }}" style="max-width:120px; max-height:120px; object-fit:cover; border-radius:6px; display:block;" />
        {% elif img.image and img.image.name %}
          <img src="{{ img.image.url }}" style="max-width:120px; max-height:120px; object-fit:cover; border-radius:6px; display:block;" />
        {% endif %}
        <button type="button" class="btn btn-sm btn-danger gallery-remove-btn" data-gallery-id="{{ img.id }}" title="Eliminar imagen" style="position:absolute; top:0px; right:0px; width:24px; height:24px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; line-height:1;">√ó</button>
        <input type="hidden" class="gallery-keep" name="galeria_keep[]" value="{{ img.id }}">
      </div>
    {% endfor %}
  {% endif %}
  {# previews de archivos nuevos ser√°n a√±adidos por JS aqu√≠ #}
</div>

<!-- Variantes -->
<label>Variantes:</label>
<small class="text-muted d-block mb-2">{% if producto_to_edit %}Modifica, elimina o agrega nuevas variantes{% else %}Agrega variantes del producto (colores, tallas, etc.){% endif %}</small>
<div id="variantes-container">
  {# variantes existentes (editar) #}
  {% if producto_to_edit %}
    {% for v in producto_to_edit.variants.all %}
      <div class="variante-row-mobile mb-3 p-3 border rounded position-relative" data-variant-id="{{ v.id }}" style="background:#f8f9fa;">
        <button type="button" class="btn btn-sm btn-danger variant-remove-btn" data-variant-id="{{ v.id }}" title="Eliminar variante" style="position:absolute; top:8px; right:8px; width:28px; height:28px; padding:0; border-radius:50%; z-index:10;">√ó</button>
        <input type="hidden" class="variant-keep" name="variante_id[]" value="{{ v.id }}">
        
        <div class="row g-2">
          <!-- Imagen primero en m√≥vil -->
          <div class="col-12 col-md-auto text-center mb-2">
            {% if v.imagen and v.imagen.name %}
              <img src="{{ v.imagen.url }}" class="img-thumbnail" style="max-width:100px; max-height:100px; object-fit:cover;" />
              <small class="d-block text-muted" style="font-size:10px;">Actual</small>
            {% else %}
              <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width:100px; height:100px; margin:0 auto;">
                <i class="fas fa-image text-muted"></i>
              </div>
            {% endif %}
            
            <div class="image-preview-container mt-2 mb-2" id="preview_{{ forloop.counter0 }}" style="display:none;">
              <img src="" alt="Nueva" class="img-thumbnail" style="max-width:100px; max-height:100px; object-fit:cover;" />
              <button type="button" class="btn btn-sm btn-danger ms-1" onclick="clearImagePreview({{ forloop.counter0 }})">
                <i class="fas fa-times"></i>
              </button>
              <small class="d-block text-success" style="font-size:10px;">Nueva imagen</small>
            </div>
            
            <input type="file" name="variante_imagen_{{ forloop.counter0 }}" class="form-control form-control-sm mt-2 variant-image-input" accept="image/*" data-variant-index="{{ forloop.counter0 }}" data-preview-id="preview_{{ forloop.counter0 }}" />
            <small class="text-muted" style="font-size:10px;">Cambiar imagen</small>
          </div>
          
          <!-- Campos en grid responsive -->
          <div class="col-12 col-md">
            <div class="row g-2">
              <div class="col-12 col-sm-6">
                <label class="small">Nombre</label>
                <input type="text" name="variante_nombre[]" value="{{ v.nombre }}" placeholder="Nombre" class="form-control form-control-sm" />
              </div>
              <div class="col-6 col-sm-3">
                <label class="small">Precio</label>
                <input type="number" name="variante_precio[]" value="{{ v.precio }}" placeholder="Precio" step="0.01" class="form-control form-control-sm" />
              </div>
              <div class="col-6 col-sm-3">
                <label class="small">Stock</label>
                <input type="number" name="variante_stock[]" value="{{ v.stock }}" placeholder="Stock" class="form-control form-control-sm" />
              </div>
              <div class="col-6 col-sm-6">
                <label class="small">Color</label>
                <input type="text" name="variante_color[]" value="{{ v.color|default:'' }}" placeholder="Color" class="form-control form-control-sm" />
              </div>
              <div class="col-6 col-sm-6">
                <label class="small">Talla</label>
                <input type="text" name="variante_talla[]" value="{{ v.talla|default:'' }}" placeholder="Talla" class="form-control form-control-sm" />
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    {# fila vac√≠a por defecto para crear #}
    <div class="variante-row-mobile mb-3 p-3 border rounded position-relative" style="background:#f8f9fa;">
      <button type="button" class="btn btn-sm btn-danger variant-remove-btn-new" style="display:none; position:absolute; top:8px; right:8px; width:28px; height:28px; padding:0; border-radius:50%; z-index:10;">√ó</button>
      <div class="row g-2">
        <div class="col-12 col-sm-6">
          <label class="small">Nombre</label>
          <input type="text" name="variante_nombre[]" placeholder="Nombre de la variante" class="form-control form-control-sm" />
        </div>
        <div class="col-6 col-sm-3">
          <label class="small">Precio</label>
          <input type="number" name="variante_precio[]" placeholder="0.00" step="0.01" class="form-control form-control-sm" />
        </div>
        <div class="col-6 col-sm-3">
          <label class="small">Stock</label>
          <input type="number" name="variante_stock[]" placeholder="0" class="form-control form-control-sm" />
        </div>
        <div class="col-6 col-sm-6">
          <label class="small">Color</label>
          <input type="text" name="variante_color[]" placeholder="Ej: Rojo" class="form-control form-control-sm" />
        </div>
        <div class="col-6 col-sm-6">
          <label class="small">Talla</label>
          <input type="text" name="variante_talla[]" placeholder="Ej: M" class="form-control form-control-sm" />
        </div>
        <div class="col-12">
          <label class="small">Imagen</label>
          <div class="image-preview-container mb-2" id="preview_0" style="display:none;">
            <img src="" alt="Preview" class="img-thumbnail" style="max-width:120px; max-height:120px; object-fit:cover;" />
            <button type="button" class="btn btn-sm btn-danger ms-2" onclick="clearImagePreview(0)">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <input type="file" name="variante_imagen_0" class="form-control form-control-sm variant-image-input" accept="image/*" data-variant-index="0" data-preview-id="preview_0" />
        </div>
      </div>
    </div>
  {% endif %}
</div>
        <button type="button" class="btn btn-secondary btn-sm mt-3 w-100 w-md-auto" onclick="agregarVariante()"><i class="fas fa-plus me-1"></i>Agregar variante</button>
        <div class="d-grid gap-2 d-md-flex mt-3">
          <button type="submit" id="form-submit-btn" class="btn btn-success"><i class="fas fa-save me-1"></i>{% if producto_to_edit %}Actualizar{% else %}Guardar{% endif %}</button>
          <button type="button" id="form-clear-btn" class="btn btn-outline-secondary"><i class="fas fa-plus me-1"></i>Nuevo Producto</button>
          {% if producto_to_edit %}
            <a href="?view=productos" class="btn btn-outline-danger"><i class="fas fa-times me-1"></i>Cancelar</a>
          {% endif %}
        </div>
    </form>
{% endif %}


<!-- ...existing code... -->
            {% elif request.GET.view == "pedidos" %}
                <!-- Header de Pedidos -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-shopping-cart me-2"></i>Gesti√≥n de Pedidos</h2>
                        <p class="text-muted mb-0">Administra y da seguimiento a todos los pedidos</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                </div>

                <!-- Estad√≠sticas Diarias - TIEMPO REAL -->
                <div class="alert alert-info mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-calendar-day me-2"></i>Actividad de Hoy
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-sync-alt fa-spin"></i> Tiempo Real
                        </span>
                    </h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-primary">
                                    <i class="fas fa-shopping-cart me-2"></i>
                                    <span data-stat="pedidos-hoy">{{ estadisticas_diarias.pedidos_hoy }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Pedidos de Hoy</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-success">
                                    <i class="fas fa-dollar-sign me-2"></i>
                                    <span data-stat="ventas-hoy">${{ estadisticas_diarias.ventas_hoy|default:"0"|floatformat:0 }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Ventas de Hoy</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-info">
                                    <i class="fas fa-box-open me-2"></i>
                                    <span data-stat="productos-vendidos-hoy">{{ estadisticas_diarias.productos_vendidos_hoy }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Productos Vendidos Hoy</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-warning">
                                    <i class="fas fa-users me-2"></i>
                                    <span data-stat="total-usuarios">{{ usuarios|length }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Total Usuarios</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas r√°pidas responsive -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center p-3">
                                <h4 class="text-primary mb-1">{{ pedidos|length }}</h4>
                                <small class="text-muted">Total Pedidos</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center p-3">
                                <h4 class="text-warning mb-1">{{ pedidos_pendientes_count|default:0 }}</h4>
                                <small class="text-muted">Pendientes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-info h-100">
                            <div class="card-body text-center p-3">
                                <h4 class="text-info mb-1">{{ pedidos_enviados_count|default:0 }}</h4>
                                <small class="text-muted">En camino</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-success h-100">
                            <div class="card-body text-center p-3">
                                <h4 class="text-success mb-1">{{ pedidos_entregados_count|default:0 }}</h4>
                                <small class="text-muted">Entregados</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros Responsive -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="get" class="row g-3">
                            <input type="hidden" name="view" value="pedidos">
                            <div class="col-12 col-md-6 col-lg-3">
                                <label class="form-label small fw-bold">Estado:</label>
                                <select name="estado_filter" class="form-select form-select-sm">
                                    <option value="">Todos los estados</option>
                                    <option value="pendiente" {% if request.GET.estado_filter == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                    <option value="confirmado" {% if request.GET.estado_filter == 'confirmado' %}selected{% endif %}>Confirmado</option>
                                    <option value="enviado" {% if request.GET.estado_filter == 'enviado' %}selected{% endif %}>Enviado</option>
                                    <option value="llegando" {% if request.GET.estado_filter == 'llegando' %}selected{% endif %}>En camino</option>
                                    <option value="entregado" {% if request.GET.estado_filter == 'entregado' %}selected{% endif %}>Entregado</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6 col-lg-3">
                                <label class="form-label small fw-bold">M√©todo de pago:</label>
                                <select name="metodo_filter" class="form-select form-select-sm">
                                    <option value="">Todos los m√©todos</option>
                                    <option value="contraentrega" {% if request.GET.metodo_filter == 'contraentrega' %}selected{% endif %}>Contra entrega</option>
                                    <option value="recoger_tienda" {% if request.GET.metodo_filter == 'recoger_tienda' %}selected{% endif %}>Recoger en tienda</option>
                                    <option value="tarjeta" {% if request.GET.metodo_filter == 'tarjeta' %}selected{% endif %}>Tarjeta</option>
                                </select>
                            </div>
                            <div class="col-12 col-lg-4">
                                <label class="form-label small fw-bold">Buscar:</label>
                                <input type="text" name="search" class="form-control form-control-sm" 
                                       placeholder="Buscar por nombre, email, ID..." 
                                       value="{{ request.GET.search }}"
                                       style="font-size: 16px;">
                            </div>
                            <div class="col-12 col-lg-2 d-flex align-items-end gap-2">
                                <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                                    <i class="fas fa-search"></i><span class="d-none d-sm-inline ms-1">Filtrar</span>
                                </button>
                                <a href="?view=pedidos" class="btn btn-outline-secondary btn-sm flex-grow-1">
                                    <i class="fas fa-times"></i><span class="d-none d-sm-inline ms-1">Limpiar</span>
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista/Tabla de Pedidos Responsive -->
                {% if pedidos %}
                    <!-- Vista Desktop: Tabla -->
                    <div class="d-none d-lg-block">
                        <div class="card shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-striped mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Cliente</th>
                                                <th>Contacto</th>
                                                <th>Total</th>
                                                <th>M√©todo Pago</th>
                                                <th>Estado</th>
                                                <th>Estado Pago</th>
                                                <th>Fecha</th>
                                                <th class="text-center">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for pedido in pedidos %}
                                            <tr>
                                                <td>
                                                    <strong class="text-primary">#{{ pedido.id }}</strong>
                                                    {% if pedido.transaction_id %}
                                                        <br><small class="text-muted">{{ pedido.transaction_id|slice:":8" }}...</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div>
                                                        <strong>{{ pedido.nombre }}</strong><br>
                                                        <small class="text-muted">{{ pedido.user.email }}</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if pedido.telefono %}
                                                        <small><i class="fas fa-phone"></i> {{ pedido.telefono }}</small><br>
                                                    {% endif %}
                                                    <small class="text-muted">
                                                        <i class="fas fa-map-marker-alt"></i> {{ pedido.ciudad }}, {{ pedido.departamento }}
                                                    </small>
                                                </td>
                                                <td>
                                                    <strong class="text-success">${{ pedido.total|floatformat:0 }}</strong>
                                                    {% if pedido.subtotal and pedido.envio %}
                                                        <br>
                                                        <small class="text-muted">
                                                            Sub: ${{ pedido.subtotal|floatformat:0 }}
                                                            {% if pedido.envio > 0 %} + Env√≠o: ${{ pedido.envio|floatformat:0 }}{% endif %}
                                                        </small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if pedido.metodo_pago == 'contraentrega' %}
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-money-bill"></i> Contra entrega
                                                        </span>
                                                    {% elif pedido.metodo_pago == 'recoger_tienda' %}
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-store"></i> Recoger en tienda
                                                        </span>
                                                    {% elif pedido.metodo_pago == 'wompi_tarjeta' or pedido.metodo_pago == 'wompi' %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-credit-card"></i> Wompi
                                                        </span>
                                                        {% if pedido.transaction_id %}
                                                            <br><small class="text-success" title="ID de transacci√≥n Wompi">
                                                                <i class="fas fa-check-circle"></i> {{ pedido.transaction_id|slice:":12" }}...
                                                            </small>
                                                        {% endif %}
                                                    {% elif pedido.metodo_pago == 'tarjeta' %}
                                                        <span class="badge bg-primary">
                                                            <i class="fas fa-credit-card"></i> Tarjeta
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ pedido.get_metodo_pago_display }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ pedido.get_estado_badge_class|slice:"6:" }}">
                                                        {% if pedido.estado == 'pendiente' %}
                                                            <i class="fas fa-clock"></i>
                                                        {% elif pedido.estado == 'confirmado' %}
                                                            <i class="fas fa-check"></i>
                                                        {% elif pedido.estado == 'enviado' %}
                                                            <i class="fas fa-shipping-fast"></i>
                                                        {% elif pedido.estado == 'llegando' %}
                                                            <i class="fas fa-truck"></i>
                                                        {% elif pedido.estado == 'entregado' %}
                                                            <i class="fas fa-check-circle"></i>
                                                        {% endif %}
                                                        {{ pedido.get_estado_display }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ pedido.get_pago_badge_class|slice:"6:" }}">
                                                        {% if pedido.estado_pago == 'completado' %}
                                                            <i class="fas fa-check-circle"></i>
                                                        {% elif pedido.estado_pago == 'fallido' %}
                                                            <i class="fas fa-times-circle"></i>
                                                        {% elif pedido.estado_pago == 'procesando' %}
                                                            <i class="fas fa-spinner"></i>
                                                        {% else %}
                                                            <i class="fas fa-clock"></i>
                                                        {% endif %}
                                                        {{ pedido.get_estado_pago_display }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <small>{{ pedido.fecha|date:"d/m/Y H:i" }}</small>
                                                    {% if pedido.fecha_entregado %}
                                                        <br><small class="text-success">Entregado: {{ pedido.fecha_entregado|date:"d/m" }}</small>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    <div class="d-flex flex-column gap-1">
                                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                                onclick="event.preventDefault(); loadPedidoDetails({{ pedido.id }})"
                                                                title="Ver detalles del pedido">
                                                            <i class="fas fa-eye me-1"></i> Ver
                                                        </button>
                                                        {% if pedido.estado_pago != 'completado' %}
                                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                                onclick="confirmarPago({{ pedido.id }})"
                                                                title="Confirmar pago del pedido">
                                                            <i class="fas fa-dollar-sign me-1"></i> Pago
                                                        </button>
                                                        {% endif %}
                                                        <div class="dropdown">
                                                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" 
                                                                    type="button" 
                                                                    id="dropdownEstado{{ pedido.id }}"
                                                                    data-bs-toggle="dropdown"
                                                                    aria-expanded="false"
                                                                    title="Cambiar estado del pedido">
                                                                <i class="fas fa-edit me-1"></i> Estado
                                                            </button>
                                                            <ul class="dropdown-menu" aria-labelledby="dropdownEstado{{ pedido.id }}">
                                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'pendiente')">
                                                                    <i class="fas fa-clock me-2 text-warning"></i>Pendiente
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'confirmado')">
                                                                    <i class="fas fa-check me-2 text-info"></i>Confirmar
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'enviado')">
                                                                    <i class="fas fa-shipping-fast me-2 text-primary"></i>Enviar
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'llegando')">
                                                                    <i class="fas fa-truck me-2 text-info"></i>En camino
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'entregado')">
                                                                    <i class="fas fa-check-circle me-2 text-success"></i>Entregado
                                                                </a></li>
                                                                <li><hr class="dropdown-divider"></li>
                                                                <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'cancelado')">
                                                                    <i class="fas fa-times-circle me-2"></i>Cancelar
                                                                </a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vista M√≥vil: Cards -->
                    <div class="d-lg-none">
                        {% for pedido in pedidos %}
                        <div class="card shadow-sm mb-3 pedido-card-mobile">
                            <div class="card-body p-3">
                                <!-- Header con ID y Total -->
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">
                                            <strong class="text-primary">#{{ pedido.id }}</strong>
                                        </h6>
                                        {% if pedido.transaction_id %}
                                            <small class="text-muted">{{ pedido.transaction_id|slice:":8" }}...</small>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <h5 class="mb-0 text-success">${{ pedido.total|floatformat:0 }}</h5>
                                        <small class="text-muted">{{ pedido.fecha|date:"d/m/Y" }}</small>
                                    </div>
                                </div>

                                <!-- Cliente y Contacto -->
                                <div class="border-top pt-2 mb-2">
                                    <strong class="d-block">{{ pedido.nombre }}</strong>
                                    <small class="text-muted d-block"><i class="fas fa-envelope"></i> {{ pedido.user.email }}</small>
                                    {% if pedido.telefono %}
                                        <small class="text-muted d-block"><i class="fas fa-phone"></i> {{ pedido.telefono }}</small>
                                    {% endif %}
                                    <small class="text-muted d-block"><i class="fas fa-map-marker-alt"></i> {{ pedido.ciudad }}, {{ pedido.departamento }}</small>
                                </div>

                                <!-- Badges de Estado -->
                                <div class="border-top pt-2 mb-2">
                                    <div class="d-flex flex-wrap gap-2">
                                        <!-- M√©todo de Pago -->
                                        {% if pedido.metodo_pago == 'contraentrega' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-money-bill"></i> Contra entrega
                                            </span>
                                        {% elif pedido.metodo_pago == 'recoger_tienda' %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-store"></i> Recoger
                                            </span>
                                        {% elif pedido.metodo_pago == 'wompi_tarjeta' or pedido.metodo_pago == 'wompi' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-credit-card"></i> Wompi
                                            </span>
                                            {% if pedido.transaction_id %}
                                                <br><small class="text-success" title="ID de transacci√≥n Wompi">
                                                    <i class="fas fa-check-circle"></i> {{ pedido.transaction_id|slice:":12" }}...
                                                </small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">{{ pedido.get_metodo_pago_display }}</span>
                                        {% endif %}

                                        <!-- Estado del Pedido -->
                                        <span class="badge bg-{{ pedido.get_estado_badge_class|slice:"6:" }}">
                                            {% if pedido.estado == 'pendiente' %}
                                                <i class="fas fa-clock"></i>
                                            {% elif pedido.estado == 'confirmado' %}
                                                <i class="fas fa-check"></i>
                                            {% elif pedido.estado == 'enviado' %}
                                                <i class="fas fa-shipping-fast"></i>
                                            {% elif pedido.estado == 'llegando' %}
                                                <i class="fas fa-truck"></i>
                                            {% elif pedido.estado == 'entregado' %}
                                                <i class="fas fa-check-circle"></i>
                                            {% endif %}
                                            {{ pedido.get_estado_display }}
                                        </span>

                                        <!-- Estado de Pago -->
                                        <span class="badge bg-{{ pedido.get_pago_badge_class|slice:"6:" }}">
                                            {% if pedido.estado_pago == 'completado' %}
                                                <i class="fas fa-check-circle"></i>
                                            {% elif pedido.estado_pago == 'fallido' %}
                                                <i class="fas fa-times-circle"></i>
                                            {% elif pedido.estado_pago == 'procesando' %}
                                                <i class="fas fa-spinner"></i>
                                            {% else %}
                                                <i class="fas fa-clock"></i>
                                            {% endif %}
                                            {{ pedido.get_estado_pago_display }}
                                        </span>
                                    </div>
                                </div>

                                <!-- Botones de Acci√≥n -->
                                <div class="border-top pt-2 d-grid gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" 
                                            onclick="event.preventDefault(); loadPedidoDetails({{ pedido.id }})">
                                        <i class="fas fa-eye me-1"></i> Ver Detalles
                                    </button>
                                    <div class="row g-2">
                                        {% if pedido.estado_pago != 'completado' %}
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-success btn-sm w-100" 
                                                    onclick="confirmarPago({{ pedido.id }})">
                                                <i class="fas fa-dollar-sign"></i> Confirmar Pago
                                            </button>
                                        </div>
                                        {% endif %}
                                        <div class="{% if pedido.estado_pago != 'completado' %}col-6{% else %}col-12{% endif %}">
                                            <div class="dropdown w-100">
                                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" 
                                                        type="button" 
                                                        id="dropdownEstadoMobile{{ pedido.id }}"
                                                        data-bs-toggle="dropdown"
                                                        aria-expanded="false">
                                                    <i class="fas fa-edit"></i> Cambiar Estado
                                                </button>
                                                <ul class="dropdown-menu w-100" aria-labelledby="dropdownEstadoMobile{{ pedido.id }}">
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'pendiente')">
                                                        <i class="fas fa-clock me-2 text-warning"></i>Pendiente
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'confirmado')">
                                                        <i class="fas fa-check me-2 text-info"></i>Confirmar
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'enviado')">
                                                        <i class="fas fa-shipping-fast me-2 text-primary"></i>Enviar
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'llegando')">
                                                        <i class="fas fa-truck me-2 text-info"></i>En camino
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'entregado')">
                                                        <i class="fas fa-check-circle me-2 text-success"></i>Entregado
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'cancelado')">
                                                        <i class="fas fa-times-circle me-2"></i>Cancelar
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="text-center py-5">
                                <i class="fas fa-shopping-cart text-muted" style="font-size: 4rem;"></i>
                                <h4 class="text-muted mt-3">No hay pedidos</h4>
                                <p class="text-muted">Los pedidos aparecer√°n aqu√≠ cuando los clientes realicen compras.</p>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Modal para ver detalles del pedido -->
                <div class="modal fade" id="pedidoModal" tabindex="-1" aria-labelledby="pedidoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="pedidoModalLabel">
                                    <i class="fas fa-shopping-cart"></i> Detalles del Pedido
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="pedidoModalContent">
                                <!-- El contenido se carga din√°micamente -->
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
             {% elif request.GET.view == "inventario" %}
                <!-- INVENTARIO MODERNIZADO Y PROFESIONAL -->
                <div class="inventario-dashboard-modern" data-print-date="{{ "now"|date:"d/m/Y H:i" }}">
                    <!-- Header responsive con acciones -->
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4 gap-3">
                        <div>
                            <h2 class="mb-1">
                                <i class="fas fa-warehouse me-2 text-primary"></i>
                                Gesti√≥n de Inventario
                            </h2>
                            <p class="text-muted mb-0 d-none d-sm-block">Control avanzado de stock y valoraci√≥n</p>
                        </div>
                        <div class="d-flex flex-wrap gap-2 w-100 w-lg-auto">
                            <button type="button" class="btn btn-success flex-fill flex-sm-grow-0" onclick="exportInventoryReport('pdf')">
                                <i class="fas fa-file-pdf"></i><span class="d-none d-sm-inline ms-1">PDF</span>
                            </button>
                            <button type="button" class="btn btn-primary flex-fill flex-sm-grow-0" onclick="exportInventoryReport('excel')">
                                <i class="fas fa-file-excel"></i><span class="d-none d-sm-inline ms-1">Excel</span>
                            </button>
                            <button type="button" class="btn btn-info flex-fill flex-sm-grow-0" onclick="printInventory()">
                                <i class="fas fa-print"></i><span class="d-none d-sm-inline ms-1">Imprimir</span>
                            </button>
                        </div>
                    </div>

                    <!-- Filtros Avanzados responsive -->
                    <div class="card modern-card shadow-sm mb-4">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center d-lg-none">
                            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h6>
                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#inventoryFiltersCollapse" 
                                    aria-expanded="true" aria-controls="inventoryFiltersCollapse">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="collapse show" id="inventoryFiltersCollapse">
                                <form id="inventario-filter-form" method="get" action="" class="row g-3 align-items-end">
                                    <input type="hidden" name="view" value="inventario">
                                    
                                    <div class="col-12 col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-filter me-1"></i>Categor√≠a
                                        </label>
                                        <select name="inventory_category" id="inventory_category_select" class="form-select">
                                            <option value="">Todas las categor√≠as</option>
                                            {% for categoria in categorias %}
                                                <option value="{{ categoria.id }}" {% if selected_category and selected_category == categoria.id %}selected{% endif %}>
                                                    {{ categoria.nombre }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-12 col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-boxes me-1"></i>Estado de Stock
                                        </label>
                                        <select name="stock_status" id="stock_status_select" class="form-select">
                                            <option value="">Todos</option>
                                            <option value="critical">Stock Cr√≠tico (‚â§10)</option>
                                            <option value="low">Stock Bajo (‚â§30)</option>
                                            <option value="normal">Stock Normal (&gt;30)</option>
                                            <option value="out">Sin Stock (0)</option>
                                        </select>
                                    </div>

                                    <div class="col-12 col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-sort-amount-down me-1"></i>Ordenar por
                                        </label>
                                        <select name="sort_by" id="sort_by_select" class="form-select">
                                            <option value="name">Nombre A-Z</option>
                                            <option value="stock_asc">Stock Menor a Mayor</option>
                                            <option value="stock_desc">Stock Mayor a Menor</option>
                                            <option value="value_desc">Valor Mayor a Menor</option>
                                            <option value="margin_desc">Margen Mayor a Menor</option>
                                        </select>
                                    </div>

                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-search me-1"></i>Aplicar Filtros
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs de Inventario responsive -->
                    <div class="row g-3 mb-4">
                        <div class="col-6 col-md-3">
                            <div class="modern-stat-card gradient-primary">
                                <div class="stat-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        ${{ resumen_inventario.valor_invertido|floatformat:0 }}
                                    </div>
                                    <div class="stat-label">Capital Invertido</div>
                                    <div class="stat-trend">
                                        <i class="fas fa-shopping-cart me-1"></i>
                                        <span>Costo de adquisici√≥n</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6 col-md-3">
                            <div class="modern-stat-card gradient-success">
                                <div class="stat-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        ${{ resumen_inventario.valor_productos|floatformat:0 }}
                                    </div>
                                    <div class="stat-label">Valor Venta</div>
                                    <div class="stat-trend d-none d-lg-block">
                                        <i class="fas fa-tag me-1"></i>
                                        <span>Valor al p√∫blico</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6 col-md-3">
                            <div class="modern-stat-card gradient-warning">
                                <div class="stat-icon">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        ${{ resumen_inventario.margen_ganancia|floatformat:0 }}
                                    </div>
                                    <div class="stat-label">Margen Ganancia</div>
                                    <div class="stat-trend d-none d-lg-block">
                                        {% widthratio resumen_inventario.margen_ganancia resumen_inventario.valor_invertido 100 as margin_percent %}
                                        <i class="fas fa-arrow-up me-1"></i>
                                        <span>{{ margin_percent }}% de margen</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6 col-md-3">
                            <div class="modern-stat-card gradient-info">
                                <div class="stat-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        {{ resumen_inventario.cantidad_productos_stock }}
                                    </div>
                                    <div class="stat-label">Unidades Stock</div>
                                    <div class="stat-trend d-none d-lg-block">
                                        <i class="fas fa-cube me-1"></i>
                                        <span>Total de productos</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°ficos de An√°lisis responsive -->
                    <div class="row g-3 mb-4">
                        <!-- Gr√°fico de Valoraci√≥n por Categor√≠a -->
                        <div class="col-12 col-lg-7">
                            <div class="card modern-card shadow-sm">
                                <div class="card-header bg-white border-bottom">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-chart-bar me-2 text-primary"></i>
                                            Valoraci√≥n por Categor√≠a
                                        </h5>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary active" data-inv-chart-type="bar">
                                                <i class="fas fa-chart-bar"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" data-inv-chart-type="doughnut">
                                                <i class="fas fa-circle-notch"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" id="value-chart-container" style="position: relative; height: 350px;">
                                        <canvas id="inventoryValueChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estado de Stock por Categor√≠a -->
                        <div class="col-12 col-lg-5">
                            <div class="card modern-card shadow-sm h-100">
                                <div class="card-header bg-white border-bottom">
                                    <h5 class="mb-0">
                                        <i class="fas fa-layer-group me-2 text-info"></i>
                                        Stock por Categor√≠a
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" id="stock-chart-container" style="position: relative; height: 300px;">
                                        <canvas id="inventoryStockChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Detallada por Categor√≠a -->
                    {% if inventario_by_category %}
                        {% for cat in inventario_by_category %}
                        <div class="card modern-card shadow-sm mb-3">
                            <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <div class="d-flex justify-content-between align-items-center text-white">
                                    <div>
                                        <h5 class="mb-1">
                                            <i class="fas fa-folder me-2"></i>
                                            {{ cat.category_name }}
                                        </h5>
                                        <small class="opacity-75">{{ cat.items|length }} productos en esta categor√≠a</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="mb-1">
                                            <i class="fas fa-boxes me-1"></i>
                                            Stock: <strong>{{ cat.cantidad_stock }}</strong> unidades
                                        </div>
                                        <div class="mb-1">
                                            <i class="fas fa-dollar-sign me-1"></i>
                                            Inversi√≥n: <strong>${{ cat.valor_invertido|floatformat:0 }}</strong>
                                        </div>
                                        <div>
                                            <i class="fas fa-chart-line me-1"></i>
                                            Valor Venta: <strong>${{ cat.valor_productos|floatformat:0 }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 40%">
                                                    <i class="fas fa-box me-1"></i>Producto
                                                </th>
                                                <th class="text-center" style="width: 10%">
                                                    <i class="fas fa-layer-group me-1"></i>Stock
                                                </th>
                                                <th class="text-end" style="width: 12.5%">
                                                    <i class="fas fa-shopping-cart me-1"></i>P. Compra
                                                </th>
                                                <th class="text-end" style="width: 12.5%">
                                                    <i class="fas fa-tag me-1"></i>P. Venta
                                                </th>
                                                <th class="text-end" style="width: 12.5%">
                                                    <i class="fas fa-wallet me-1"></i>Inv. Total
                                                </th>
                                                <th class="text-end" style="width: 12.5%">
                                                    <i class="fas fa-money-bill-wave me-1"></i>Valor Total
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in cat.items %}
                                            <tr class="{% if item.stock == 0 %}table-danger{% elif item.stock <= 10 %}table-warning{% endif %}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="product-status-indicator me-2" 
                                                             style="width: 8px; height: 8px; border-radius: 50%; 
                                                                    background: {% if item.stock == 0 %}#dc3545{% elif item.stock <= 10 %}#ffc107{% elif item.stock <= 30 %}#0dcaf0{% else %}#198754{% endif %};">
                                                        </div>
                                                        <strong>{{ item.product_name }}</strong>
                                                    </div>
                                                </td>
                                                <td class="text-center">
                                                    {% if item.stock == 0 %}
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-times-circle"></i> 0
                                                        </span>
                                                    {% elif item.stock <= 10 %}
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-exclamation-triangle"></i> {{ item.stock }}
                                                        </span>
                                                    {% elif item.stock <= 30 %}
                                                        <span class="badge bg-info">
                                                            {{ item.stock }}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-success">
                                                            {{ item.stock }}
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-end text-muted">
                                                    ${{ item.price_buy|floatformat:0 }}
                                                </td>
                                                <td class="text-end">
                                                    <strong class="text-primary">${{ item.price|floatformat:0 }}</strong>
                                                </td>
                                                <td class="text-end">
                                                    <span class="badge bg-secondary-subtle text-secondary px-3 py-2">
                                                        ${{ item.subtotal_buy|floatformat:0 }}
                                                    </span>
                                                </td>
                                                <td class="text-end">
                                                    <span class="badge bg-success-subtle text-success px-3 py-2">
                                                        ${{ item.subtotal_sell|floatformat:0 }}
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot class="table-light fw-bold">
                                            <tr>
                                                <td>TOTAL CATEGOR√çA</td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ cat.cantidad_stock }}</span>
                                                </td>
                                                <td colspan="2"></td>
                                                <td class="text-end">
                                                    <span class="text-secondary">${{ cat.valor_invertido|floatformat:0 }}</span>
                                                </td>
                                                <td class="text-end">
                                                    <span class="text-success">${{ cat.valor_productos|floatformat:0 }}</span>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="card modern-card shadow-sm">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                                <h5 class="text-muted">No hay productos en inventario</h5>
                                <p class="text-muted">No se encontraron productos para los filtros seleccionados</p>
                                <a href="?view=inventario" class="btn btn-primary">
                                    <i class="fas fa-redo me-1"></i>Limpiar Filtros
                                </a>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Alertas de Stock al Final -->
                    {% if inventario_by_category %}
                        <div class="mt-4">
                            <h5 class="mb-3">
                                <i class="fas fa-bell me-2 text-warning"></i>
                                Alertas de Stock
                            </h5>
                            {% for cat in inventario_by_category %}
                                {% for item in cat.items %}
                                    {% if item.stock <= 10 %}
                                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Stock Cr√≠tico:</strong> {{ item.product_name }} ({{ cat.category_name }}) - Solo quedan {{ item.stock }} unidades
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        </div>
                                    {% elif item.stock <= 30 %}
                                        {% if forloop.counter <= 3 %}
                                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Stock Bajo:</strong> {{ item.product_name }} ({{ cat.category_name }}) - Quedan {{ item.stock }} unidades
                                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
    
            {% elif request.GET.view == "bonos" %}
                <!-- SECCI√ìN DE BONOS DE DESCUENTO -->
                <div class="bonos-section">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 gap-3">
                        <h2><i class="fas fa-percentage me-2"></i>Bonos de Descuento</h2>
                        <button type="button" class="btn btn-success w-100 w-sm-auto" data-bs-toggle="modal" data-bs-target="#modalNuevoBono">
                            <i class="fas fa-plus me-2"></i>Crear Nuevo Bono
                        </button>
                    </div>
                    
                    <!-- Estad√≠sticas de Bonos responsive -->
                    {% if bonos %}
                        <div class="row g-3 mb-4">
                            <div class="col-6 col-md-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body p-3">
                                        <h5 class="text-success mb-1">{{ bonos|length }}</h5>
                                        <small>Total Bonos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body p-3">
                                        <h5 class="text-primary mb-1">{% for bono in bonos %}{% if bono.is_valid %}1{% endif %}{% empty %}0{% endfor %}</h5>
                                        <small>Bonos Activos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body p-3">
                                        <h5 class="text-warning mb-1">{% for bono in bonos %}{% if bono.get_estado_display == 'Expirado' %}1{% endif %}{% empty %}0{% endfor %}</h5>
                                        <small>Bonos Expirados</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body p-3">
                                        <h5 class="text-info mb-1">{% for bono in bonos %}{{ bono.usos_realizados|add:0 }}{% empty %}0{% endfor %}</h5>
                                        <small>Total Usos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Tabla de Bonos desktop -->
                    <div class="card d-none d-lg-block">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>Lista de Bonos
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if bonos %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>C√≥digo</th>
                                                <th>Descripci√≥n</th>
                                                <th>Tipo</th>
                                                <th>Descuento</th>
                                                <th>Compra M√≠n.</th>
                                                <th>Vigencia</th>
                                                <th>Usos</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for bono in bonos %}
                                                <tr>
                                                    <td>
                                                        <code class="bg-light px-2 py-1 rounded">{{ bono.codigo }}</code>
                                                    </td>
                                                    <td>{{ bono.descripcion|truncatechars:50 }}</td>
                                                    <td>
                                                        <span class="badge {% if bono.tipo_descuento == 'porcentaje' %}bg-info{% else %}bg-warning{% endif %}">
                                                            {% if bono.tipo_descuento == 'porcentaje' %}Porcentaje{% else %}Valor Fijo{% endif %}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <strong>
                                                            {% if bono.tipo_descuento == 'porcentaje' %}
                                                                {{ bono.valor_descuento }}%
                                                            {% else %}
                                                                ${{ bono.valor_descuento|floatformat:0 }}
                                                            {% endif %}
                                                        </strong>
                                                    </td>
                                                    <td>${{ bono.valor_minimo_compra|floatformat:0 }}</td>
                                                    <td>
                                                        <small>
                                                            {{ bono.fecha_inicio|date:"d/m/Y H:i" }}<br>
                                                            {{ bono.fecha_fin|date:"d/m/Y H:i" }}
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">
                                                            {{ bono.usos_realizados }}/{{ bono.usos_maximos }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-{{ bono.get_estado_badge_class|slice:"6:" }}">
                                                            {{ bono.get_estado_display }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex gap-1">
                                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                                    onclick="editarBono({{ bono.id }})"
                                                                    title="Editar bono">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <form method="post" style="display: inline;" 
                                                                  onsubmit="return confirm('¬øEst√°s seguro de eliminar el bono {{ bono.codigo }}?')">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="action" value="eliminar_bono">
                                                                <input type="hidden" name="bono_id" value="{{ bono.id }}">
                                                                <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                                        title="Eliminar bono">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-percentage text-muted" style="font-size: 4rem;"></i>
                                    <h4 class="text-muted mt-3">No hay bonos creados</h4>
                                    <p class="text-muted">Crea tu primer bono de descuento para incentivar las ventas.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
    
            {% elif request.GET.view == "categoria" %}
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 gap-3">
                    <h2><i class="fas fa-folder me-2"></i>Categor√≠as</h2>
                    <button type="button" class="btn btn-primary w-100 w-sm-auto" data-bs-toggle="modal" data-bs-target="#modalNuevaCategoria">
                        <i class="fas fa-plus"></i> Nueva Categor√≠a
                    </button>
                </div>
                 
                <div class="card d-none d-md-block">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Slug</th>
                            <th scope="col">Productos</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="categorias-table-body">
                        {% for categoria in categorias %}
                        <tr data-category-id="{{ categoria.id }}">
                            <td>{{ categoria.id }}</td>
                            <td>{{ categoria.nombre }}</td>
                            <td>{{ categoria.slug }}</td>
                            <td>{{ categoria.products.count }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary edit-category-btn" 
                                        data-category-id="{{ categoria.id }}"
                                        data-category-nombre="{{ categoria.nombre }}"
                                        data-category-slug="{{ categoria.slug }}"
                                        data-bs-toggle="modal" data-bs-target="#modalEditarCategoria">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button type="button" class="btn btn-sm btn-danger delete-category-btn" 
                                        data-category-id="{{ categoria.id }}"
                                        data-category-nombre="{{ categoria.nombre }}">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="no-categories-row">
                            <td colspan="5" class="text-center">No hay categor√≠as registradas.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table> 
            {% elif request.GET.view == "tipos" %}
                 <h2>Tipos</h2>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoTipo">
                     Nuevo Tipo
                    </button>

                <table class="table mt-3">
                     <thead>
                         <tr>
                            <th>Nombre</th>
                            <th>Acciones</th>
                         </tr>
                     </thead>
                <tbody>
               {% for tipo in tipos %}
                 <tr>
                   <td>{{ tipo.name }}</td>
                   <td>
                      <a href="{% url 'edit_tipo' tipo.id %}" class="btn btn-sm btn-primary">Editar</a>
                      <a href="{% url 'delete_tipo' tipo.id %}" class="btn btn-sm btn-danger">x</a>
                   </td>
                 </tr>
               {% empty %}
              <tr><td colspan="2">No hay tipos registrados.</td></tr>
            {% endfor %}
        </tbody>
    </table>

            {% elif request.GET.view == "ventas" %}
                <!-- AN√ÅLISIS DE VENTAS MODERNIZADO -->
                <div class="ventas-dashboard-modern">
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4 gap-3">
                        <h2 class="mb-0">
                            <i class="fas fa-chart-line me-2 text-primary"></i>
                            An√°lisis de Ventas
                        </h2>
                        <div class="btn-group w-100 w-lg-auto" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-period="all">
                                <i class="fas fa-infinity"></i><span class="d-none d-sm-inline ms-1">Todo</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-period="today">
                                <i class="fas fa-calendar-day"></i><span class="d-none d-sm-inline ms-1">Hoy</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-period="week">
                                <i class="fas fa-calendar-week"></i><span class="d-none d-sm-inline ms-1">Semana</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-period="month">
                                <i class="fas fa-calendar-alt"></i><span class="d-none d-sm-inline ms-1">Mes</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- KPIs Cards Modernos responsive -->
                    <div class="row g-3 mb-4">
                        <!-- Ventas Totales -->
                        <div class="col-6 col-lg-3">
                            <div class="modern-stat-card gradient-primary">
                                <div class="stat-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" data-stat="ingresos-totales">
                                        ${{ total_ventas_general|floatformat:0 }}
                                    </div>
                                    <div class="stat-label">Ventas Totales</div>
                                    <div class="stat-trend">
                                        <i class="fas fa-arrow-up me-1"></i>
                                        <span class="small">Hoy: ${{ estadisticas_diarias.ventas_hoy|default:"0"|floatformat:0 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pedidos Totales -->
                        <div class="col-6 col-lg-3">
                            <div class="modern-stat-card gradient-success">
                                <div class="stat-icon">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" data-stat="total-pedidos">
                                        {{ estadisticas_ventas.pedidos_totales }}
                                    </div>
                                    <div class="stat-label">Pedidos Totales</div>
                                    <div class="stat-trend d-none d-lg-block">
                                        <i class="fas fa-calendar-day me-1"></i>
                                        <span class="small">Hoy: {{ estadisticas_diarias.pedidos_hoy }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Productos Vendidos -->
                        <div class="col-6 col-lg-3">
                            <div class="modern-stat-card gradient-info">
                                <div class="stat-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" data-stat="total-productos">
                                        {{ estadisticas_ventas.productos_vendidos }}
                                    </div>
                                    <div class="stat-label">Productos Vendidos</div>
                                    <div class="stat-trend">
                                        <i class="fas fa-box-open me-1"></i>
                                        <span class="small">Hoy: {{ estadisticas_diarias.productos_vendidos_hoy }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Promedio por Pedido -->
                        <div class="col-md-3">
                            <div class="modern-stat-card gradient-warning">
                                <div class="stat-icon">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        ${{ estadisticas_ventas.promedio_por_pedido|floatformat:0 }}
                                    </div>
                                    <div class="stat-label">Promedio por Pedido</div>
                                    <div class="stat-trend">
                                        <i class="fas fa-chart-line me-1"></i>
                                        <span class="small">Ticket promedio</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ventas por Categor√≠a Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <div class="card shadow-sm" id="ventasCategoriasCard">
                                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-layer-group text-primary me-2"></i>
                                        Valor Vendido por Categor√≠a
                                    </h5>
                                    <button class="btn btn-sm btn-outline-primary" id="toggleVentasCategorias" type="button">
                                        <i class="fas fa-chevron-up" id="iconVentasCategorias"></i>
                                    </button>
                                </div>
                                <div class="card-body" id="ventasCategoriasContent">
                                    {% if ventas_por_categoria %}
                                    <div class="row g-3">
                                        {% for categoria in ventas_por_categoria %}
                                        <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                                            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                <div class="card-body text-white">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div>
                                                            <h6 class="text-white mb-1 fw-bold">{{ categoria.nombre }}</h6>
                                                            <small class="opacity-75">
                                                                <i class="fas fa-shopping-bag me-1"></i>{{ categoria.cantidad_pedidos }} pedido{{ categoria.cantidad_pedidos|pluralize }}
                                                            </small>
                                                        </div>
                                                        <div class="text-end">
                                                            <i class="fas fa-chart-line fa-2x opacity-50"></i>
                                                        </div>
                                                    </div>
                                                    <div class="mt-3">
                                                        <div class="d-flex justify-content-between align-items-end">
                                                            <div>
                                                                <div class="h3 mb-0 fw-bold">${{ categoria.total_ingresos|floatformat:0 }}</div>
                                                                <small class="opacity-75">Total vendido</small>
                                                            </div>
                                                            <div class="text-end">
                                                                <div class="badge bg-white bg-opacity-25">
                                                                    {{ categoria.cantidad_productos }} und
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-3 pt-3 border-top border-white border-opacity-25">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small class="opacity-75">
                                                                <i class="fas fa-percentage me-1"></i>
                                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                                {{ porcentaje|floatformat:1 }}% del total
                                                            </small>
                                                            <button class="btn btn-sm btn-light" 
                                                                    data-bs-toggle="collapse" 
                                                                    data-bs-target="#detalles-{{ forloop.counter }}"
                                                                    aria-expanded="false">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="collapse" id="detalles-{{ forloop.counter }}">
                                                    <div class="card-footer bg-white bg-opacity-10 border-0">
                                                        <small class="text-white d-block mb-2 fw-bold">
                                                            <i class="fas fa-box-open me-1"></i>Productos vendidos:
                                                        </small>
                                                        <div class="list-group list-group-flush bg-transparent">
                                                            {% for producto in categoria.productos_vendidos|slice:":5" %}
                                                            <div class="list-group-item bg-transparent text-white border-white border-opacity-25 p-2">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <small class="text-truncate me-2">{{ producto.nombre }}</small>
                                                                    <span class="badge bg-white text-dark">{{ producto.cantidad }}x</span>
                                                                </div>
                                                            </div>
                                                            {% endfor %}
                                                            {% if categoria.productos_vendidos|length > 5 %}
                                                            <div class="list-group-item bg-transparent text-white border-0 p-2">
                                                                <small class="opacity-75">
                                                                    <i class="fas fa-ellipsis-h me-1"></i>
                                                                    y {{ categoria.productos_vendidos|length|add:"-5" }} m√°s...
                                                                </small>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-shopping-cart fa-3x mb-3 opacity-50"></i>
                                        <h5>No hay ventas registradas</h5>
                                        <p class="mb-0">Las ventas por categor√≠a aparecer√°n aqu√≠</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                   
                    <!-- Gr√°ficos de An√°lisis -->
                    <div class="row g-3 mb-4">
                        <!-- Gr√°fico de Ventas por Categor√≠a -->
                        <div class="col-lg-8">
                            <div class="card shadow-sm" id="graficoVentasCard">
                                <div class="card-header bg-white border-bottom">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-chart-bar text-primary me-2"></i>
                                            Ventas por Categor√≠a
                                        </h5>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-secondary active" data-chart-type="bar">
                                                    <i class="fas fa-chart-bar"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" data-chart-type="pie">
                                                    <i class="fas fa-chart-pie"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" data-chart-type="doughnut">
                                                    <i class="fas fa-dot-circle"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-outline-primary" id="toggleGraficoVentas" type="button">
                                                <i class="fas fa-chevron-up" id="iconGraficoVentas"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body" id="graficoVentasContent" style="height: 400px;">
                                    <canvas id="ventasCategoriaChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Top 5 Categor√≠as -->
                        <div class="col-lg-4">
                            <div class="card shadow-sm" id="topCategoriasCard">
                                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-trophy text-warning me-2"></i>
                                        Top 5 Categor√≠as
                                    </h5>
                                    <button class="btn btn-sm btn-outline-primary" id="toggleTopCategorias" type="button">
                                        <i class="fas fa-chevron-up" id="iconTopCategorias"></i>
                                    </button>
                                </div>
                                <div class="card-body p-0" id="topCategoriasContent">
                                    <div class="list-group list-group-flush">
                                        {% for categoria in ventas_por_categoria|slice:":5" %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="me-auto">
                                                    <div class="fw-bold text-dark">{{ categoria.nombre }}</div>
                                                    <small class="text-muted">
                                                        {{ categoria.cantidad_pedidos }} pedido{{ categoria.cantidad_pedidos|pluralize }} ¬∑ 
                                                        {{ categoria.cantidad_productos }} producto{{ categoria.cantidad_productos|pluralize }}
                                                    </small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">
                                                    ${{ categoria.total_ingresos|floatformat:0 }}
                                                </span>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                <div class="progress-bar bg-gradient" role="progressbar" 
                                                     style="width: {{ porcentaje }}%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);">
                                                </div>
                                            </div>
                                            <small class="text-muted">{{ porcentaje|floatformat:1 }}% del total</small>
                                        </div>
                                        {% empty %}
                                        <div class="list-group-item text-center text-muted py-5">
                                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                                            <p class="mb-0">Sin datos de ventas</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Detallada Moderna desktop -->
                    <div class="card shadow-sm d-none d-lg-block">
                        <div class="card-header bg-white border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-table text-primary me-2"></i>
                                    Detalle de Ventas por Categor√≠a
                                </h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportToExcel()">
                                    <i class="fas fa-download me-1"></i>Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="ventasTable">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0">#</th>
                                            <th class="border-0">Categor√≠a</th>
                                            <th class="border-0 text-end">Ingresos</th>
                                            <th class="border-0 text-center">Productos</th>
                                            <th class="border-0 text-center">Pedidos</th>
                                            <th class="border-0 text-end">Promedio</th>
                                            <th class="border-0">Participaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for categoria in ventas_por_categoria %}
                                        <tr>
                                            <td class="fw-bold text-muted">{{ forloop.counter }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="category-color-indicator me-2" 
                                                         style="width: 8px; height: 8px; border-radius: 50%; background: {% cycle 'rgba(102, 126, 234, 0.8)' 'rgba(118, 75, 162, 0.8)' 'rgba(79, 172, 254, 0.8)' 'rgba(0, 242, 254, 0.8)' 'rgba(67, 233, 123, 0.8)' 'rgba(245, 87, 108, 0.8)' 'rgba(255, 159, 64, 0.8)' 'rgba(255, 205, 86, 0.8)' 'rgba(153, 102, 255, 0.8)' 'rgba(201, 203, 207, 0.8)' %};"></div>
                                                    <strong class="text-dark">{{ categoria.nombre }}</strong>
                                                </div>
                                            </td>
                                            <td class="text-end">
                                                <span class="badge bg-success-subtle text-success px-3 py-2">
                                                    ${{ categoria.total_ingresos|floatformat:0 }}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-info-subtle text-info">
                                                    {{ categoria.cantidad_productos }}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-primary-subtle text-primary">
                                                    {{ categoria.cantidad_pedidos }}
                                                </span>
                                            </td>
                                            <td class="text-end text-muted">
                                                {% widthratio categoria.total_ingresos categoria.cantidad_pedidos 1 as promedio %}
                                                ${{ promedio|floatformat:0 }}
                                            </td>
                                            <td style="min-width: 150px;">
                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                <div class="d-flex align-items-center gap-2">
                                                    <div class="progress flex-grow-1" style="height: 8px;">
                                                        <div class="progress-bar bg-gradient" role="progressbar" 
                                                             style="width: {{ porcentaje }}%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);">
                                                        </div>
                                                    </div>
                                                    <small class="text-muted fw-bold" style="min-width: 45px;">{{ porcentaje|floatformat:1 }}%</small>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-5">
                                                <i class="fas fa-chart-line fa-3x mb-3 d-block" style="opacity: 0.3;"></i>
                                                <p class="mb-0">No hay ventas registradas a√∫n</p>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            {% elif request.GET.view == "proveedores" %}
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 gap-3">
                    <h2><i class="fas fa-truck me-2"></i>Proveedores</h2>
                    <a href="{% url 'create_proveedor' %}" data-bs-toggle="modal" data-bs-target="#modalNuevoProveedor" class="btn btn-primary w-100 w-sm-auto">
                        <i class="fas fa-plus me-2"></i>Crear Proveedor
                    </a>
                </div>
                <div class="card d-none d-md-block">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                        <tr>
                              <th>Nombre</th>
                            <th>C√©dula</th>                          
                            <th>Email</th>
                            <th>Tel√©fono</th>
                            <th>Direcci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    {% if proveedores %}
                        <tr>
                            {% for proveedor in proveedores %}
                                <td>{{ proveedor.nombre }}</td>
                                <td>{{ proveedor.cedulaOnita }}</td>
                                <td>{{ proveedor.email }}</td>
                                <td>{{ proveedor.telefono }}</td>
                                <td>{{ proveedor.direccion }}</td>
                                <td>
                                    <a href="{% url 'edit_proveedor' proveedor.id %}" class="btn btn-sm btn-warning">Editar</a>
                                    <a href="{% url 'delete_proveedor' proveedor.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                                </td>
                          
                        </tr>
                        {% endfor %}
                {% else %}
                    <p>No hay proveedores disponibles.</p>
                {% endif %}
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${{ total_ventas_general|floatformat:0 }}</h4>
                                            <p class="mb-0">Ventas Totales</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-dollar-sign fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ estadisticas_ventas.pedidos_totales }}</h4>
                                            <p class="mb-0">Pedidos Totales</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-shopping-cart fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ estadisticas_ventas.productos_vendidos }}</h4>
                                            <p class="mb-0">Productos Vendidos</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-boxes fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${{ estadisticas_ventas.promedio_por_pedido|floatformat:0 }}</h4>
                                            <p class="mb-0">Promedio por Pedido</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-calculator fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Categor√≠as Destacadas -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-crown me-2"></i>Categor√≠a con Mayores Ingresos</h5>
                                </div>
                                <div class="card-body">
                                    {% if estadisticas_ventas.categoria_mayor_ingresos %}
                                        <h4 class="text-primary">{{ estadisticas_ventas.categoria_mayor_ingresos.nombre }}</h4>
                                        <p class="mb-1"><strong>Ingresos:</strong> ${{ estadisticas_ventas.categoria_mayor_ingresos.total_ingresos|floatformat:0 }}</p>
                                        <p class="mb-1"><strong>Productos vendidos:</strong> {{ estadisticas_ventas.categoria_mayor_ingresos.cantidad_productos }}</p>
                                        <p class="mb-0"><strong>Pedidos:</strong> {{ estadisticas_ventas.categoria_mayor_ingresos.cantidad_pedidos }}</p>
                                    {% else %}
                                        <p class="text-muted">No hay datos de ventas disponibles</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Categor√≠a M√°s Vendida</h5>
                                </div>
                                <div class="card-body">
                                    {% if estadisticas_ventas.categoria_mas_vendida %}
                                        <h4 class="text-success">{{ estadisticas_ventas.categoria_mas_vendida.nombre }}</h4>
                                        <p class="mb-1"><strong>Productos vendidos:</strong> {{ estadisticas_ventas.categoria_mas_vendida.cantidad_productos }}</p>
                                        <p class="mb-1"><strong>Ingresos:</strong> ${{ estadisticas_ventas.categoria_mas_vendida.total_ingresos|floatformat:0 }}</p>
                                        <p class="mb-0"><strong>Pedidos:</strong> {{ estadisticas_ventas.categoria_mas_vendida.cantidad_pedidos }}</p>
                                    {% else %}
                                        <p class="text-muted">No hay datos de ventas disponibles</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Completa de Ventas por Categor√≠a -->
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-table me-2"></i>An√°lisis Detallado por Categor√≠a</h5>
                                <div>
                                    <a href="/dashboard/dashboard_home/" class="btn btn-sm btn-outline-light me-2">
                                        <i class="fas fa-home"></i> Volver al Home
                                    </a>
                                    <button class="btn btn-sm btn-outline-light" onclick="window.print()">
                                        <i class="fas fa-print"></i> Imprimir
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Categor√≠a</th>
                                            <th scope="col">Ingresos Totales</th>
                                            <th scope="col">Productos Vendidos</th>
                                            <th scope="col">Pedidos</th>
                                            <th scope="col">Promedio por Pedido</th>
                                            <th scope="col">% del Total</th>
                                            <th scope="col">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for categoria in ventas_por_categoria %}
                                        <tr>
                                            <td>
                                                {% if forloop.counter <= 3 %}
                                                    <span class="badge bg-warning text-dark">
                                                        {% if forloop.counter == 1 %}ü•á{% elif forloop.counter == 2 %}ü•à{% else %}ü•â{% endif %}
                                                        {{ forloop.counter }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ forloop.counter }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <strong class="text-primary">{{ categoria.nombre }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">${{ categoria.total_ingresos|floatformat:0 }}</span>
                                            </td>
                                            <td>{{ categoria.cantidad_productos }}</td>
                                            <td>{{ categoria.cantidad_pedidos }}</td>
                                            <td>
                                                {% widthratio categoria.total_ingresos categoria.cantidad_pedidos 1 as promedio %}
                                                ${{ promedio|floatformat:0 }}
                                            </td>
                                            <td>
                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                <div class="progress" style="width: 60px;">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ porcentaje }}%">
                                                        {{ porcentaje|floatformat:1 }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary ver-detalle-categoria" 
                                                        data-categoria="{{ categoria.nombre }}"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#modalDetalleCategoriaVentas">
                                                    <i class="fas fa-eye"></i> Ver Detalles
                                                </button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>No hay ventas registradas a√∫n
                                                <br><small>Las estad√≠sticas aparecer√°n cuando se registren los primeros pedidos</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            {% elif request.GET.view == "proveedores" %>
                <h2>Proveedores</h2>
                    <a href="{% url 'create_proveedor' %}" data-bs-toggle="modal" data-bs-target="#modalNuevoProveedor" class="btn btn-primary mb-3">Crear Proveedor</a>
                    <table>
                        <tr>
                              <th>Nombre</th>
                            <th>C√©dula</th>                          
                            <th>Email</th>
                            <th>Tel√©fono</th>
                            <th>Direcci√≥n</th>
                            <th>Acciones</th>
                        </tr>
                    {% if proveedores %}
                        <tr>
                            {% for proveedor in proveedores %}
                                <td>{{ proveedor.nombre }}</td>
                                <td>{{ proveedor.cedulaOnita }}</td>
                                <td>{{ proveedor.email }}</td>
                                <td>{{ proveedor.telefono }}</td>
                                <td>{{ proveedor.direccion }}</td>
                                <td>
                                    <a href="{% url 'edit_proveedor' proveedor.id %}" class="btn btn-sm btn-warning">Editar</a>
                                    <a href="{% url 'delete_proveedor' proveedor.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                                </td>
                          
                        </tr>
                        {% endfor %}
                {% else %}
                    <p>No hay proveedores disponibles.</p>
                {% endif %}
            {% elif request.GET.view == "mensajes" %}
                <!-- Vista de Mensajes del Dashboard -->
                <div class="messages-dashboard">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-comments me-2"></i>Centro de Mensajes</h2>
                            <p class="text-muted mb-0">Gestiona las consultas y conversaciones con los usuarios</p>
                        </div>
                        <div>
                            <button class="btn btn-primary" id="refreshMessages">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                    </div>

                    <!-- Estad√≠sticas r√°pidas -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ conversations_stats.total_conversations|default:0 }}</h4>
                                            <p class="mb-0">Total Conversaciones</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-comments fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ conversations_stats.pending_conversations|default:0 }}</h4>
                                            <p class="mb-0">Sin Respuesta</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-clock fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ conversations_stats.today_messages|default:0 }}</h4>
                                            <p class="mb-0">Mensajes Hoy</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-envelope fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ conversations_stats.active_conversations|default:0 }}</h4>
                                            <p class="mb-0">Conversaciones Activas</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-comment-dots fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de conversaciones -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Conversaciones</h5>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="conversation-filter" id="filter-all" checked>
                                    <label class="btn btn-outline-primary btn-sm" for="filter-all">Todas</label>

                                    <input type="radio" class="btn-check" name="conversation-filter" id="filter-pending">
                                    <label class="btn btn-outline-warning btn-sm" for="filter-pending">Sin Respuesta</label>

                                    <input type="radio" class="btn-check" name="conversation-filter" id="filter-active">
                                    <label class="btn btn-outline-success btn-sm" for="filter-active">Activas</label>

                                    <input type="radio" class="btn-check" name="conversation-filter" id="filter-closed">
                                    <label class="btn btn-outline-secondary btn-sm" for="filter-closed">Cerradas</label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if conversations %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Usuario</th>
                                                <th>Asunto</th>
                                                <th>Estado</th>
                                                <th>√öltimo Mensaje</th>
                                                <th>Fecha</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="conversations-table-body">
                                            {% for conversation in conversations %}
                                            <tr class="conversation-row" data-status="{{ conversation.status }}" data-conversation-id="{{ conversation.id }}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="avatar-circle me-2">
                                                            {{ conversation.user.username|first|upper }}
                                                        </div>
                                                        <div>
                                                            <strong>{{ conversation.user.username }}</strong>
                                                            {% if conversation.user.email %}
                                                                <br><small class="text-muted">{{ conversation.user.email }}</small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <strong>{{ conversation.subject }}</strong>
                                                    <!-- Referencia a pedido eliminada temporalmente -->
                                                </td>
                                                <td>
                                                    <span class="badge bg-{% if conversation.status == 'open' %}warning{% elif conversation.status == 'in_progress' %}info{% elif conversation.status == 'resolved' %}success{% else %}secondary{% endif %}">
                                                        {% if conversation.status == 'open' %}Abierta
                                                        {% elif conversation.status == 'in_progress' %}En Progreso
                                                        {% elif conversation.status == 'resolved' %}Resuelta
                                                        {% else %}Cerrada
                                                        {% endif %}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if conversation.last_message %}
                                                        <div class="message-preview">
                                                            {{ conversation.last_message.message|truncatechars:60 }}
                                                        </div>
                                                        <small class="text-muted">
                                                            {% if conversation.last_message.is_admin %}
                                                                <i class="fas fa-user-shield"></i> Admin
                                                            {% else %}
                                                                <i class="fas fa-user"></i> Usuario
                                                            {% endif %}
                                                        </small>
                                                    {% else %}
                                                        <em class="text-muted">Sin mensajes</em>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="date-info">
                                                        {{ conversation.created_at|date:"d/m/Y" }}
                                                        <br><small class="text-muted">{{ conversation.created_at|time:"H:i" }}</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-sm btn-primary" 
                                                                onclick="viewConversation({{ conversation.id }})"
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#conversationModal">
                                                            <i class="fas fa-eye"></i> Ver
                                                        </button>
                                                        <div class="btn-group" role="group">
                                                            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                                    data-bs-toggle="dropdown" aria-expanded="false">
                                                                <i class="fas fa-cog"></i>
                                                            </button>
                                                            <ul class="dropdown-menu">
                                                                <li><a class="dropdown-item" href="#" onclick="updateConversationStatus({{ conversation.id }}, 'in_progress')">
                                                                    <i class="fas fa-play text-info"></i> Marcar en Progreso
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="#" onclick="updateConversationStatus({{ conversation.id }}, 'resolved')">
                                                                    <i class="fas fa-check text-success"></i> Marcar Resuelta
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="#" onclick="updateConversationStatus({{ conversation.id }}, 'closed')">
                                                                    <i class="fas fa-times text-secondary"></i> Cerrar
                                                                </a></li>
                                                                <li><hr class="dropdown-divider"></li>
                                                                <li><a class="dropdown-item" href="#" onclick="updateConversationStatus({{ conversation.id }}, 'open')">
                                                                    <i class="fas fa-redo text-warning"></i> Reabrir
                                                                </a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Paginaci√≥n -->
                                {% if conversations.has_other_pages %}
                                <nav aria-label="Paginaci√≥n de conversaciones" class="mt-4">
                                    <ul class="pagination justify-content-center">
                                        {% if conversations.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link" href="?view=mensajes&page={{ conversations.previous_page_number }}">Anterior</a>
                                            </li>
                                        {% endif %}
                                        
                                        {% for num in conversations.paginator.page_range %}
                                            {% if conversations.number == num %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ num }}</span>
                                                </li>
                                            {% else %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?view=mensajes&page={{ num }}">{{ num }}</a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if conversations.has_next %}
                                            <li class="page-item">
                                                <a class="page-link" href="?view=mensajes&page={{ conversations.next_page_number }}">Siguiente</a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                                {% endif %}

                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-comment-slash text-muted" style="font-size: 4rem;"></i>
                                    <h4 class="text-muted mt-3">No hay conversaciones</h4>
                                    <p class="text-muted">Las conversaciones con usuarios aparecer√°n aqu√≠ cuando se registren consultas.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

            {% elif request.GET.view == "wompi_config" %}
            <!-- Vista de configuracion de wompi -->
             <div class="container mt-4">
                    <div class="row">
                        <div class="col-lg-8 offset-lg-2">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h3 class="mb-0"><i class="fas fa-credit-card me-2"></i>Configuraci√≥n de Wompi Payment Gateway</h3>
                                </div>
                                <div class="card-body">
                                    {% if messages %}
                                    <div class="mb-3">
                                      {% for message in messages %}
                                         <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                         </div>
                                      {% endfor %}
                                    </div>
                                    {% endif %}

                                    <form method="post">
                                        {% csrf_token %}
                                        
                                        <!-- Public Key -->
                                        <div class="mb-4">
                                            <label for="public_key" class="form-label fw-bold">
                                                <i class="fas fa-key me-2"></i>Public Key (Clave P√∫blica)
                                            </label>
                                            <input type="text" 
                                                   class="form-control form-control-lg" 
                                                   id="public_key" 
                                                   name="public_key" 
                                                   value="{{ config.public_key }}" 
                                                   placeholder="pub_test_xxxxxxxxxx"
                                                   required>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Clave p√∫blica proporcionada por Wompi. Visible en el frontend.
                                            </div>
                                        </div>

                                        <!-- Private Key -->
                                        <div class="mb-4">
                                            <label for="private_key" class="form-label fw-bold">
                                                <i class="fas fa-lock me-2"></i>Private Key (Clave Privada)
                                            </label>
                                            <input type="password" 
                                                   class="form-control form-control-lg" 
                                                   id="private_key" 
                                                   name="private_key" 
                                                   value="{{ config.private_key }}" 
                                                   placeholder="prv_test_xxxxxxxxxx"
                                                   required>
                                            <div class="form-text">
                                                <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                                                <strong>¬°Mant√©n esta clave segura!</strong> Solo debe usarse en el servidor.
                                            </div>
                                        </div>

                                        <!-- Environment -->
                                        <div class="mb-4">
                                            <label for="environment" class="form-label fw-bold">
                                                <i class="fas fa-server me-2"></i>Ambiente
                                            </label>
                                            <select class="form-select form-select-lg" id="environment" name="environment">
                                                <option value="production" {% if config.environment == 'production' %}selected{% endif %}>üü¢ Producci√≥n (Pagos Reales)</option>
                                                <option value="test" {% if config.environment == 'test' %}selected{% endif %}>üß™ Pruebas (Sandbox)</option>
                                            </select>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                <strong>Producci√≥n:</strong> Procesa pagos reales. <strong>Pruebas:</strong> Para desarrollo y testing.
                                            </div>
                                        </div>

                                        <!-- Base URL -->
                                        <div class="mb-4">
                                            <label for="base_url" class="form-label fw-bold">
                                                <i class="fas fa-link me-2"></i>Base URL de API
                                            </label>
                                            <input type="url" 
                                                   class="form-control form-control-lg" 
                                                   id="base_url" 
                                                   name="base_url" 
                                                   value="{{ config.base_url }}" 
                                                   placeholder="https://production.wompi.co/v1"
                                                   required>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                URL base de la API de Wompi. Generalmente: <code>https://production.wompi.co/v1</code>
                                            </div>
                                        </div>

                                        <!-- Activar/Desactivar -->
                                        <div class="mb-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="is_active" 
                                                       name="is_active"
                                                       {% if config.is_active %}checked{% endif %}>
                                                <label class="form-check-label fw-bold" for="is_active">
                                                    <i class="fas fa-power-off me-2"></i>Activar Wompi como m√©todo de pago
                                                </label>
                                            </div>
                                            <div class="form-text">
                                                Desactiva temporalmente Wompi sin perder la configuraci√≥n
                                            </div>
                                        </div>

                                        <!-- Botones -->
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='?view=usuarios'">
                                                <i class="fas fa-times me-2"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i>Guardar Configuraci√≥n
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Info adicional -->
                            <div class="alert alert-info mt-4">
                                <h5 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Informaci√≥n Importante</h5>
                                <ul class="mb-0">
                                    <li><strong>Obt√©n tus claves:</strong> Reg√≠strate en <a href="https://comercios.wompi.co/" target="_blank" class="alert-link">Wompi Comercios</a></li>
                                    <li><strong>Ambiente de pruebas:</strong> Usa las claves de test para desarrollo</li>
                                    <li><strong>Producci√≥n:</strong> Verifica tu cuenta antes de activar pagos reales</li>
                                    <li><strong>Seguridad:</strong> Nunca compartas tu clave privada</li>
                                    <li><strong>Documentaci√≥n:</strong> <a href="https://docs.wompi.co/" target="_blank" class="alert-link">docs.wompi.co</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
             </div>

             {% elif request.GET.view == "whatsapp_config" %}
             <!-- Vista de configuracion de WhatsApp -->
             <div class="container mt-4">
                    <div class="row">
                        <div class="col-lg-8 offset-lg-2">
                            <div class="card shadow-sm">
                                <div class="card-header bg-success text-white">
                                    <h3 class="mb-0"><i class="fab fa-whatsapp me-2"></i>Configuraci√≥n de WhatsApp Business</h3>
                                </div>
                                <div class="card-body">
                                    {% if messages %}
                                    <div class="mb-3">
                                      {% for message in messages %}
                                         <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                         </div>
                                      {% endfor %}
                                    </div>
                                    {% endif %}

                                    <form method="post">
                                        {% csrf_token %}
                                        
                                        <!-- N√∫mero de WhatsApp -->
                                        <div class="mb-4">
                                            <label for="admin_phone" class="form-label fw-bold">
                                                <i class="fas fa-phone me-2"></i>N√∫mero de WhatsApp del Administrador
                                            </label>
                                            <input type="text" 
                                                   class="form-control form-control-lg" 
                                                   id="admin_phone" 
                                                   name="admin_phone" 
                                                   value="{{ whatsapp_config.admin_phone }}" 
                                                   placeholder="+573001234567"
                                                   pattern="\+[0-9]{10,15}"
                                                   required>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Formato: +57 seguido del n√∫mero (incluir c√≥digo de pa√≠s). Ejemplo: +573001234567
                                            </div>
                                        </div>

                                        <!-- Tipos de Notificaciones -->
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-bell me-2"></i>¬øCu√°ndo quieres recibir notificaciones?
                                            </label>
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="notify_new_order" 
                                                       name="notify_new_order"
                                                       {% if whatsapp_config.notify_new_order %}checked{% endif %}>
                                                <label class="form-check-label" for="notify_new_order">
                                                    <strong>Nuevos Pedidos</strong> - Recibe un mensaje cuando alguien hace un pedido
                                                </label>
                                            </div>

                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="notify_status_change" 
                                                       name="notify_status_change"
                                                       {% if whatsapp_config.notify_status_change %}checked{% endif %}>
                                                <label class="form-check-label" for="notify_status_change">
                                                    <strong>Cambios de Estado</strong> - Notificaciones cuando actualizas el estado de un pedido
                                                </label>
                                            </div>

                                            <div class="form-check form-switch">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="notify_low_stock" 
                                                       name="notify_low_stock"
                                                       {% if whatsapp_config.notify_low_stock %}checked{% endif %}>
                                                <label class="form-check-label" for="notify_low_stock">
                                                    <strong>Stock Bajo</strong> - Alerta cuando un producto tiene poco inventario
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Plantilla de Mensaje -->
                                        <div class="mb-4">
                                            <label for="message_template" class="form-label fw-bold">
                                                <i class="fas fa-message me-2"></i>Plantilla del Mensaje
                                            </label>
                                            <textarea class="form-control" 
                                                      id="message_template" 
                                                      name="message_template" 
                                                      rows="8"
                                                      required>{{ whatsapp_config.message_template }}</textarea>
                                            <div class="form-text">
                                                <i class="fas fa-code me-1"></i>
                                                Variables disponibles: <code>{order_id}</code>, <code>{customer_name}</code>, 
                                                <code>{customer_phone}</code>, <code>{total}</code>, <code>{payment_method}</code>, 
                                                <code>{address}</code>
                                            </div>
                                        </div>

                                        <!-- Activar/Desactivar -->
                                        <div class="mb-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="is_active" 
                                                       name="is_active"
                                                       {% if whatsapp_config.is_active %}checked{% endif %}>
                                                <label class="form-check-label fw-bold" for="is_active">
                                                    <i class="fas fa-power-off me-2"></i>Activar Sistema de Notificaciones
                                                </label>
                                            </div>
                                            <div class="form-text">
                                                Puedes desactivar temporalmente las notificaciones sin perder tu configuraci√≥n
                                            </div>
                                        </div>

                                        <!-- Botones -->
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='?view=usuarios'">
                                                <i class="fas fa-times me-2"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-save me-2"></i>Guardar Configuraci√≥n
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Info adicional -->
                            <div class="alert alert-info mt-4">
                                <h5 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Informaci√≥n Importante</h5>
                                <ul class="mb-0">
                                    <li>Aseg√∫rate de que el n√∫mero de WhatsApp est√© activo y pueda recibir mensajes</li>
                                    <li>Incluye el c√≥digo de pa√≠s en el formato internacional (+57 para Colombia)</li>
                                    <li>Las notificaciones se enviar√°n autom√°ticamente seg√∫n tu configuraci√≥n</li>
                                    <li>Puedes personalizar el mensaje usando las variables disponibles</li>
                                </ul>
                            </div>
                        </div>
                    </div>
             </div>

            {% elif request.GET.view == "datos_tienda" %}
            <!-- Vista de Datos de mi Tienda -->
             <div class="container mt-4">
                    <div class="row">
                        <div class="col-lg-10 offset-lg-1">
                            <div class="card shadow-sm">
                                <div class="card-header bg-info text-white">
                                    <h3 class="mb-0"><i class="fas fa-store me-2"></i>Informaci√≥n de Mi Tienda</h3>
                                </div>
                                <div class="card-body">
                                    {% if messages %}
                                    <div class="mb-3">
                                      {% for message in messages %}
                                         <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                         </div>
                                      {% endfor %}
                                    </div>
                                    {% endif %}

                                    <form method="post" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        
                                        <div class="row">
                                            <!-- Informaci√≥n B√°sica -->
                                            <div class="col-md-6">
                                                <h5 class="mb-3"><i class="fas fa-building me-2"></i>Informaci√≥n B√°sica</h5>
                                                
                                                <div class="mb-3">
                                                    <label for="nombre_tienda" class="form-label fw-bold">Nombre de la Tienda</label>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           id="nombre_tienda" 
                                                           name="nombre_tienda" 
                                                           value="{{ store_config.nombre_tienda }}"
                                                           placeholder="Nombre de tu tienda"
                                                           required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="slogan" class="form-label fw-bold">Slogan</label>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           id="slogan" 
                                                           name="slogan" 
                                                           value="{{ store_config.slogan }}"
                                                           placeholder="Tu slogan aqu√≠">
                                                </div>

                                                <div class="mb-3">
                                                    <label for="email_tienda" class="form-label fw-bold">Email de Contacto</label>
                                                    <input type="email" 
                                                           class="form-control" 
                                                           id="email_tienda" 
                                                           name="email_tienda" 
                                                           value="{{ store_config.email_tienda }}"
                                                           placeholder="contacto@tienda.com">
                                                </div>

                                                <div class="mb-3">
                                                    <label for="telefono_tienda" class="form-label fw-bold">Tel√©fono</label>
                                                    <input type="tel" 
                                                           class="form-control" 
                                                           id="telefono_tienda" 
                                                           name="telefono_tienda" 
                                                           value="{{ store_config.telefono_tienda }}"
                                                           placeholder="+57 300 123 4567">
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="logo" class="form-label fw-bold"><i class="fas fa-image me-2"></i>Logo de la Tienda</label>
                                                    {% if store_config.logo %}
                                                    <div class="mb-2">
                                                        <img src="{{ store_config.logo.url }}" alt="Logo actual" class="img-thumbnail" style="max-height: 100px;">
                                                        <small class="d-block text-muted">Logo actual</small>
                                                    </div>
                                                    {% endif %}
                                                    <input type="file" 
                                                           class="form-control" 
                                                           id="logo" 
                                                           name="logo"
                                                           accept="image/*">
                                                    <div class="form-text">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        Formato recomendado: PNG o JPG, m√°ximo 2MB
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Ubicaci√≥n y Redes -->
                                            <div class="col-md-6">
                                                <h5 class="mb-3"><i class="fas fa-map-marker-alt me-2"></i>Ubicaci√≥n</h5>
                                                
                                                <div class="mb-3">
                                                    <label for="direccion_tienda" class="form-label fw-bold">Direcci√≥n</label>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           id="direccion_tienda" 
                                                           name="direccion_tienda" 
                                                           value="{{ store_config.direccion_tienda }}"
                                                           placeholder="Calle Principal #123">
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="ciudad_tienda" class="form-label fw-bold">Ciudad</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               id="ciudad_tienda" 
                                                               name="ciudad_tienda" 
                                                               value="{{ store_config.ciudad_tienda }}"
                                                               placeholder="Tu ciudad">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="pais_tienda" class="form-label fw-bold">Pa√≠s</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               id="pais_tienda" 
                                                               name="pais_tienda" 
                                                               value="{{ store_config.pais_tienda }}"
                                                               placeholder="Colombia">
                                                    </div>
                                                </div>

                                                
                                                
                                                <div class="mb-3">
                                                    <label for="whatsapp" class="form-label"><i class="fab fa-whatsapp me-1"></i> WhatsApp Comercial</label>
                                                    <input type="tel" 
                                                           class="form-control" 
                                                           id="whatsapp" 
                                                           name="whatsapp" 
                                                           value="{{ store_config.whatsapp }}"
                                                           placeholder="+57 300 123 4567">
                                                    <div class="form-text">
                                                        Formato: +57XXXXXXXXXX (para bot√≥n de contacto en la tienda)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Horarios -->
                                        <div class="row mt-4">
                                            <div class="col-12">
                                                <h5 class="mb-3"><i class="fas fa-clock me-2"></i>Horario de Atenci√≥n</h5>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="horario_semana" class="form-label fw-bold">Lunes a Viernes</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               id="horario_semana" 
                                                               name="horario_semana" 
                                                               value="{{ store_config.horario_semana }}"
                                                               placeholder="8:00 AM - 6:00 PM">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="horario_sabado" class="form-label fw-bold">S√°bados</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               id="horario_sabado" 
                                                               name="horario_sabado" 
                                                               value="{{ store_config.horario_sabado }}"
                                                               placeholder="9:00 AM - 2:00 PM">
                                                    </div>
                                                    <div class="col-md-12 mb-3">
                                                        <label for="horario_domingo" class="form-label fw-bold">Domingos y Festivos</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               id="horario_domingo" 
                                                               name="horario_domingo" 
                                                               value="{{ store_config.horario_domingo }}"
                                                               placeholder="Cerrado">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Botones -->
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='?view=usuarios'">
                                                <i class="fas fa-times me-2"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-info text-white">
                                                <i class="fas fa-save me-2"></i>Guardar Informaci√≥n
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Info adicional -->
                            <div class="alert alert-success mt-4">
                                <h5 class="alert-heading"><i class="fas fa-check-circle me-2"></i>Informaci√≥n de la Tienda</h5>
                                <ul class="mb-0">
                                    <li><strong>Personaliza tu tienda:</strong> Configura el nombre, logo y datos de contacto</li>
                                    <li><strong>Redes sociales:</strong> Agrega tus perfiles para que los clientes te encuentren</li>
                                    <li><strong>Horarios:</strong> Informa a tus clientes cu√°ndo est√°s disponible</li>
                                    <li><strong>Logo:</strong> Sube tu logo para que aparezca en tu tienda</li>
                                </ul>
                            </div>
                        </div>
                    </div>
             </div>

            {% endif %}
        </main>
    </div>
    

    <!--modal crear tipo-->
    <div class="modal fade" id="modalNuevoTipo" tabindex="-1" aria-labelledby="modalNuevoTipoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'crear_tipo' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalNuevoTipoLabel">Crear nuevo tipo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <label for="nombre_tipo">Nombre del tipo:</label>
                        <input type="text" class="form-control" id="nombre_tipo" name="nombre" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para crear nuevas categor√≠as -->
    <div class="modal fade" id="modalNuevaCategoria" tabindex="-1" aria-labelledby="modalNuevaCategoriaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="create-category-form">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalNuevaCategoriaLabel">Crear nueva categor√≠a</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nombre_categoria" class="form-label">Nombre de la categor√≠a:</label>
                            <input type="text" class="form-control" id="nombre_categoria" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="slug_categoria" class="form-label">Slug:</label>
                            <input type="text" class="form-control" id="slug_categoria" name="slug" required>
                            <div class="form-text">URL amigable para la categor√≠a (ej: electronica, computadoras)</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar categor√≠as -->
    <div class="modal fade" id="modalEditarCategoria" tabindex="-1" aria-labelledby="modalEditarCategoriaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="edit-category-form">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarCategoriaLabel">Editar categor√≠a</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit_categoria_id" name="categoria_id">
                        <div class="mb-3">
                            <label for="edit_nombre_categoria" class="form-label">Nombre de la categor√≠a:</label>
                            <input type="text" class="form-control" id="edit_nombre_categoria" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_slug_categoria" class="form-label">Slug:</label>
                            <input type="text" class="form-control" id="edit_slug_categoria" name="slug" required>
                            <div class="form-text">URL amigable para la categor√≠a (ej: electronica, computadoras)</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            Actualizar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar eliminaci√≥n de categor√≠a -->
    <div class="modal fade" id="modalEliminarCategoria" tabindex="-1" aria-labelledby="modalEliminarCategoriaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEliminarCategoriaLabel">Confirmar eliminaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle text-warning me-3" style="font-size: 2rem;"></i>
                        <div>
                            <p class="mb-1">¬øEst√°s seguro de que deseas eliminar la categor√≠a?</p>
                            <strong id="delete-category-name" class="text-danger"></strong>
                            <p class="small text-muted mt-2 mb-0">Esta acci√≥n no se puede deshacer.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="confirm-delete-category" class="btn btn-danger">
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear nuevos proveedores -->
    <div class="modal fade" id="modalNuevoProveedor" tabindex="-1" aria-labelledby="modalNuevoProveedorLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'create_proveedor' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalNuevoProveedorLabel">Crear nuevo proveedor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="nombre_proveedor">Nombre del proveedor:</label>
          <input type="text" class="form-control" id="nombre_proveedor" name="nombre" required>
            <label for="cedula_proveedor">C√©dula:</label>
            <input type="text" class="form-control" id="cedula_proveedor" name="cedulaOnita" >
            <label for="email_proveedor">Email:</label>
            <input type="email" class="form-control" id="email_proveedor" name="email" >
            <label for="telefono_proveedor">Tel√©fono:</label>
            <input type="text" class="form-control" id="telefono_proveedor" name="telefono" >
            <label for="direccion_proveedor">Direcci√≥n:</label>
            <input type="text" class="form-control" id="direccion_proveedor" name="direccion" >

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>
    <!-- Modal para editar usuario -->
    <div id="editModal" class="modal1">
        <div class="modal-content1">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h3>Editar Usuario</h3>
            <form id="editForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="user_id" id="modal_user_id" />
                <label>Username:</label>
                <input type="text" name="username" id="modal_username" required />
                <label>Email:</label>
                <input type="email" name="email" id="modal_email" required />
                <label>Contrase√±a (dejar en blanco para no cambiar):</label>
                <input type="password" name="password" id="modal_password" />
                <label>Celular:</label>
                <input type="text" name="celular" id="modal_celular" />
                <label>Direcci√≥n:</label>
                <input type="text" name="direccion" id="modal_direccion" />
                <label>Ciudad:</label>
                <input type="text" name="ciudad" id="modal_ciudad" />
                <label>Pa√≠s:</label>
                <input type="text" name="pais" id="modal_pais" />
                <label>C√≥digo postal:</label>
                <input type="text" name="codigo_postal" id="modal_codigo_postal" />
                <label>Fecha de creaci√≥n:</label>
                <input type="date" name="created_at" id="modal_created_at" />
                <label>Fecha de nacimiento:</label>
                <input type="date" name="fecha_nacimiento" id="modal_fecha_nacimiento" />
                <label>G√©nero:</label>
                <input type="text" name="genero" id="modal_genero" />
                <button type="submit">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Modal para ver detalles de ventas por categor√≠a -->
    <div class="modal fade" id="modalDetalleCategoriaVentas" tabindex="-1" aria-labelledby="modalDetalleCategoriaVentasLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDetalleCategoriaVentasLabel">
                        <i class="fas fa-chart-bar me-2"></i>Detalles de Ventas - <span id="modal-categoria-nombre"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card bg-success text-white text-center">
                                <div class="card-body">
                                    <h5 id="modal-categoria-ingresos">$0</h5>
                                    <small>Ingresos Totales</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white text-center">
                                <div class="card-body">
                                    <h5 id="modal-categoria-productos">0</h5>
                                    <small>Productos Vendidos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-white text-center">
                                <div class="card-body">
                                    <h5 id="modal-categoria-pedidos">0</h5>
                                    <small>Pedidos</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h6><i class="fas fa-list me-2"></i>Productos m√°s vendidos en esta categor√≠a:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="modal-productos-detalle">
                                <!-- Se llenar√° din√°micamente con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <a href="?view=ventas" class="btn btn-primary">
                        <i class="fas fa-chart-line"></i> Ver An√°lisis Completo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES DE BONOS DE DESCUENTO -->
    <!-- Modal para crear nuevo bono -->
    <div class="modal fade" id="modalNuevoBono" tabindex="-1" aria-labelledby="modalNuevoBonoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="post" id="formNuevoBono">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="crear_bono">
                    
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalNuevoBonoLabel">
                            <i class="fas fa-plus me-2"></i>Crear Nuevo Bono de Descuento
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="codigo" class="form-label">C√≥digo del Bono <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="codigo" id="codigo" 
                                           placeholder="ej: DESCUENTO50, NAVIDAD2025" required>
                                    <div class="form-text">C√≥digo √∫nico que usar√°n los clientes</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="descripcion" class="form-label">Descripci√≥n <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="descripcion" id="descripcion" 
                                           placeholder="Descripci√≥n interna del bono" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tipo_descuento" class="form-label">Tipo de Descuento <span class="text-danger">*</span></label>
                                    <select class="form-select" name="tipo_descuento" id="tipo_descuento" required>
                                        <option value="porcentaje">Porcentaje (%)</option>
                                        <option value="fijo">Valor Fijo ($)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="valor_descuento" class="form-label">Valor del Descuento <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="valor_descuento" id="valor_descuento" 
                                           min="0" step="0.01" placeholder="ej: 50 o 10000" required>
                                    <div class="form-text" id="descuentoHelp">Ingresa el porcentaje (0-100) o valor fijo</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="valor_minimo_compra" class="form-label">Compra M√≠nima</label>
                                    <input type="number" class="form-control" name="valor_minimo_compra" id="valor_minimo_compra" 
                                           min="0" step="0.01" value="0" placeholder="0">
                                    <div class="form-text">Valor m√≠nimo para aplicar el descuento</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="usos_maximos" class="form-label">Usos M√°ximos <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="usos_maximos" id="usos_maximos" 
                                           min="1" value="1" required>
                                    <div class="form-text">N√∫mero m√°ximo de veces que se puede usar</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fecha_inicio" class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" name="fecha_inicio" id="fecha_inicio" required>
                                    <div class="form-text">Puede ser desde 5 minutos atr√°s hasta fechas futuras</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fecha_fin" class="form-label">Fecha de Fin <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" name="fecha_fin" id="fecha_fin" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="activo" id="activo" checked>
                                <label class="form-check-label" for="activo">
                                    Bono activo
                                </label>
                                <div class="form-text">Si est√° desactivado, no se podr√° usar aunque est√© dentro de vigencia</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Crear Bono
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar bono -->
    <div class="modal fade" id="modalEditarBono" tabindex="-1" aria-labelledby="modalEditarBonoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="post" id="formEditarBono">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="editar_bono">
                    <input type="hidden" name="bono_id" id="edit_bono_id">
                    
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarBonoLabel">
                            <i class="fas fa-edit me-2"></i>Editar Bono de Descuento
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    
                    <div class="modal-body" id="editBonoModalBody">
                        <!-- Se llenar√° din√°micamente con JavaScript -->
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para ver conversaciones completas -->
    <div class="modal fade" id="conversationModal" tabindex="-1" aria-labelledby="conversationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="conversationModalLabel">
                        <i class="fas fa-comments"></i> <span id="conversation-title">Conversaci√≥n</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="conversationContent">
                        <!-- Informaci√≥n de la conversaci√≥n -->
                        <div class="conversation-header p-3 bg-light border-bottom">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-1">
                                        <i class="fas fa-user"></i> <span id="conv-user-name">Usuario</span>
                                    </h6>
                                    <p class="mb-0 text-muted small" id="conv-user-email">email@ejemplo.com</p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <span class="badge" id="conv-status-badge">Estado</span>
                                    <br><small class="text-muted" id="conv-created-date">Fecha</small>
                                </div>
                            </div>
                            <div class="row mt-2" id="conv-order-info" style="display: none;">
                                <div class="col-12">
                                    <div class="alert alert-info mb-0 py-2">
                                        <i class="fas fa-shopping-cart"></i> 
                                        <strong>Relacionado con pedido:</strong> 
                                        <span id="conv-order-number">#123</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de mensajes -->
                        <div class="messages-container p-3" style="max-height: 400px; overflow-y: auto;">
                            <div id="messages-list">
                                <!-- Los mensajes se cargar√°n din√°micamente -->
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando mensajes...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formulario para responder -->
                        <div class="response-form p-3 bg-light border-top">
                            <form id="responseForm">
                                <div class="mb-3">
                                    <label for="admin-response" class="form-label">
                                        <i class="fas fa-reply"></i> Tu Respuesta:
                                    </label>
                                    <textarea class="form-control" id="admin-response" rows="3" 
                                              placeholder="Escribe tu respuesta aqu√≠..." required></textarea>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="mark-resolved">
                                            <label class="form-check-label" for="mark-resolved">
                                                Marcar como resuelta despu√©s de enviar
                                            </label>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> Enviar Respuesta
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-warning btn-sm" 
                                onclick="updateConversationStatusInModal('in_progress')">
                            <i class="fas fa-play"></i> En Progreso
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" 
                                onclick="updateConversationStatusInModal('resolved')">
                            <i class="fas fa-check"></i> Resuelta
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                onclick="updateConversationStatusInModal('closed')">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"> </script>.
  <!-- Bootstrap Bundle JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"></script>
    
    <!-- Scripts Base del Dashboard -->
    <script src="{% static 'js/dashboard.js' %}"></script>
    
    <!-- Scripts de Inventario (selector de categor√≠a) -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Debug para verificar que el men√∫ m√≥vil funcione
        console.log('üì± Verificando elementos del men√∫ m√≥vil...');
        
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileHeader = document.querySelector('.mobile-header');
        
        if (mobileHeader) {
          console.log('‚úÖ Mobile header encontrado');
        } else {
          console.error('‚ùå Mobile header NO encontrado');
        }
        
        if (mobileMenuBtn) {
          console.log('‚úÖ Bot√≥n men√∫ m√≥vil encontrado');
          
          // Test adicional para el bot√≥n
          mobileMenuBtn.addEventListener('click', function() {
            console.log('üî• Click en bot√≥n m√≥vil detectado!');
          });
        } else {
          console.error('‚ùå Bot√≥n men√∫ m√≥vil NO encontrado');
        }
        
        // Script del inventario
        const inventorySelect = document.getElementById('inventory_category_select');
        if (inventorySelect) {
          inventorySelect.addEventListener('change', function(){
            const val = this.value;
            const url = new URL(window.location.href);
            url.searchParams.set('view','inventario');
            if(val) url.searchParams.set('inventory_category', val);
            else url.searchParams.delete('inventory_category');
            window.location.href = url.toString();
          });
        }

        // Script para gesti√≥n de pedidos
        console.log('üõí Inicializando gesti√≥n de pedidos...');
      });

      // Funciones para gesti√≥n de pedidos
      function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
               getCookie('csrftoken');
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      // NOTA: Las funciones viewPedidoDetails, updateEstado, updateAdminNotes, 
      // buildPedidoDetailHTML, getEstadoBadgeColor, etc.
      // est√°n TODAS definidas en dashboard-pedidos.js
      // NO las redefinas aqu√≠ para evitar conflictos

      // ========================================
      // SISTEMA DE AUTO-ACTUALIZACI√ìN DE PEDIDOS
      // ========================================
      
      let autoRefreshInterval = null;
      let lastPedidosCount = {{ pedidos|length }};
      const REFRESH_INTERVAL = 15000; // 15 segundos - actualizaci√≥n en tiempo real

      // Iniciar auto-actualizaci√≥n si estamos en la vista de pedidos
      {% if request.GET.view == "pedidos" or not request.GET.view %}
      if (window.location.search.includes('view=pedidos') || !window.location.search.includes('view=')) {
        console.log('üîÑ Iniciando auto-actualizaci√≥n de pedidos...');
        startAutoRefresh();
      }
      {% endif %}

      function startAutoRefresh() {
        // Limpiar intervalo existente si hay uno
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }

        // Crear intervalo de actualizaci√≥n
        autoRefreshInterval = setInterval(() => {
          // No actualizar si hay un modal abierto
          const modalOpen = document.querySelector('.modal.show');
          if (modalOpen) {
            console.log('‚è∏Ô∏è Modal abierto - pausando auto-actualizaci√≥n');
            return;
          }
          checkForNewPedidos();
        }, REFRESH_INTERVAL);

        console.log('‚úÖ Auto-actualizaci√≥n de pedidos activada (cada 15s - tiempo real)');
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log('üõë Auto-actualizaci√≥n desactivada');
        }
      }

      function checkForNewPedidos() {
        console.log('üîç Verificando nuevos pedidos...');
        
        // Construir URL con los mismos filtros actuales
        const urlParams = new URLSearchParams(window.location.search);
        const apiUrl = '/dashboard/api/pedidos-count/?' + urlParams.toString();

        fetch(apiUrl, {
          method: 'GET',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const newCount = data.count;
            console.log(`üìä Pedidos: ${lastPedidosCount} -> ${newCount}`);
            
            if (newCount !== lastPedidosCount) {
              console.log('üÜï ¬°Cambios detectados! Actualizando lista...');
              lastPedidosCount = newCount;
              reloadPedidosList();
            } else {
              console.log('‚úÖ Sin cambios');
            }
          }
        })
        .catch(error => {
          console.error('‚ùå Error verificando pedidos:', error);
        });
      }

      function reloadPedidosList() {
        console.log('üîÑ Recargando lista de pedidos...');
        
        // Obtener la tabla de pedidos
        const tableBody = document.querySelector('table tbody');
        if (!tableBody) {
          console.error('‚ùå No se encontr√≥ la tabla de pedidos');
          return;
        }

        // Mostrar indicador de carga
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'alert alert-info alert-dismissible fade show position-fixed';
        loadingIndicator.style.top = '20px';
        loadingIndicator.style.right = '20px';
        loadingIndicator.style.zIndex = '9999';
        loadingIndicator.innerHTML = `
          <i class="fas fa-sync-alt fa-spin"></i> Actualizando pedidos...
        `;
        document.body.appendChild(loadingIndicator);

        // Construir URL con los mismos filtros actuales
        const urlParams = new URLSearchParams(window.location.search);
        const apiUrl = '/dashboard/api/pedidos-list/?' + urlParams.toString();

        fetch(apiUrl, {
          method: 'GET',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Actualizar la tabla
            tableBody.innerHTML = data.html;
            
            // Mostrar notificaci√≥n de √©xito
            loadingIndicator.className = 'alert alert-success alert-dismissible fade show position-fixed';
            loadingIndicator.innerHTML = `
              <i class="fas fa-check"></i> Lista actualizada (${data.count} pedidos)
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
              loadingIndicator.remove();
            }, 3000);
            
            console.log('‚úÖ Lista actualizada con √©xito');
          } else {
            throw new Error(data.error || 'Error desconocido');
          }
        })
        .catch(error => {
          console.error('‚ùå Error recargando lista:', error);
          loadingIndicator.className = 'alert alert-danger alert-dismissible fade show position-fixed';
          loadingIndicator.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> Error al actualizar
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          setTimeout(() => {
            loadingIndicator.remove();
          }, 3000);
        });
      }

      // Limpiar intervalo cuando se cambia de vista
      window.addEventListener('beforeunload', () => {
        stopAutoRefresh();
      });

      // Mostrar alertas
      function showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alert-container') || createAlertContainer();
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        alertContainer.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }

      function createAlertContainer() {
        const container = document.createElement('div');
        container.id = 'alert-container';
        container.style.position = 'fixed';
        container.style.top = '20px';
        container.style.right = '20px';
        container.style.zIndex = '9999';
        container.style.maxWidth = '400px';
        document.body.appendChild(container);
        return container;
      }

      // FUNCIONES PARA GESTI√ìN DE MENSAJES
      let currentConversationId = null;

      // Ver detalles de una conversaci√≥n
      function viewConversation(conversationId) {
        currentConversationId = conversationId;
        console.log('üëÄ Cargando conversaci√≥n:', conversationId);
        
        const modalContent = document.getElementById('conversationContent');
        const messagesList = document.getElementById('messages-list');
        
        // Reset del formulario
        document.getElementById('responseForm').reset();
        
        // Mostrar spinner
        messagesList.innerHTML = `
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando mensajes...</span>
            </div>
          </div>
        `;

        // Hacer request para obtener detalles de la conversaci√≥n
        fetch(`/dashboard/admin/conversation/${conversationId}/`, {
          method: 'GET',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          console.log('üîç Respuesta del servidor:', data);
          if (data.success) {
            console.log('‚úÖ Datos de conversaci√≥n:', data.conversation);
            loadConversationData(data.conversation);
          } else {
            console.error('‚ùå Error del servidor:', data.error);
            messagesList.innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                Error al cargar la conversaci√≥n: ${data.error || 'Error desconocido'}
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('‚ùå Error de red:', error);
          messagesList.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i> 
              Error de conexi√≥n. Por favor intenta de nuevo.
            </div>
          `;
        });
      }

      // Cargar datos de la conversaci√≥n en el modal
      function loadConversationData(conversation) {
        console.log('üìã Cargando datos de conversaci√≥n:', conversation);
        
        try {
          // Actualizar t√≠tulo y informaci√≥n b√°sica
          try {
            document.getElementById('conversation-title').textContent = conversation.subject || 'Conversaci√≥n sin t√≠tulo';
            console.log('‚úÖ T√≠tulo actualizado');
          } catch (error) {
            console.error('‚ùå Error al actualizar t√≠tulo:', error);
          }
          
          try {
            document.getElementById('conv-user-name').textContent = conversation.user?.username || 'Usuario desconocido';
            console.log('‚úÖ Usuario actualizado');
          } catch (error) {
            console.error('‚ùå Error al actualizar usuario:', error);
          }
          
          try {
            document.getElementById('conv-user-email').textContent = conversation.user?.email || 'No especificado';
            console.log('‚úÖ Email actualizado');
          } catch (error) {
            console.error('‚ùå Error al actualizar email:', error);
          }
          
          // Debug de fecha
          try {
            console.log('üïí Fecha recibida para conversaci√≥n:', conversation.created_at);
            console.log('üïí Tipo de fecha recibida:', typeof conversation.created_at);
            const formattedDate = formatDate(conversation.created_at);
            console.log('üïí Fecha formateada:', formattedDate);
            document.getElementById('conv-created-date').textContent = formattedDate;
            console.log('‚úÖ Fecha actualizada');
          } catch (error) {
            console.error('‚ùå Error al actualizar fecha:', error);
            document.getElementById('conv-created-date').textContent = 'Fecha no disponible';
          }
          
          // Actualizar badge de estado
          try {
            const statusBadge = document.getElementById('conv-status-badge');
            const statusColor = getConversationStatusColor(conversation.status);
            const statusText = getConversationStatusText(conversation.status);
            console.log('üè∑Ô∏è Status color:', statusColor, 'Status text:', statusText);
            statusBadge.className = `badge bg-${statusColor}`;
            statusBadge.textContent = statusText;
            console.log('‚úÖ Estado actualizado');
          } catch (error) {
            console.error('‚ùå Error al actualizar estado:', error);
          }
          
          // Mostrar informaci√≥n del pedido si existe (temporalmente deshabilitado)
          try {
            const orderInfo = document.getElementById('conv-order-info');
            orderInfo.style.display = 'none';
            console.log('‚úÖ Info de pedido ocultada');
          } catch (error) {
            console.error('‚ùå Error al ocultar info de pedido:', error);
          }
          
          // Cargar mensajes
          try {
            console.log('üì® Mensajes a cargar:', conversation.messages);
            loadMessages(conversation.messages || []);
            console.log('‚úÖ Mensajes cargados');
          } catch (error) {
            console.error('‚ùå Error al cargar mensajes:', error);
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = `
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                Error al cargar mensajes: ${error.message}
              </div>
            `;
          }
          
        } catch (error) {
          console.error('‚ùå Error general al cargar datos de conversaci√≥n:', error);
          const messagesList = document.getElementById('messages-list');
          messagesList.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i> 
              Error al mostrar los datos de la conversaci√≥n: ${error.message}
            </div>
          `;
        }
      }

      // Cargar lista de mensajes
      function loadMessages(messages) {
        console.log('üí¨ Cargando mensajes:', messages);
        const messagesList = document.getElementById('messages-list');
        
        if (!messages || messages.length === 0) {
          console.log('‚ö†Ô∏è No hay mensajes para mostrar');
          messagesList.innerHTML = `
            <div class="text-center text-muted py-4">
              <i class="fas fa-comment-slash fa-2x mb-2"></i>
              <p>No hay mensajes en esta conversaci√≥n</p>
            </div>
          `;
          return;
        }

        try {
          const messagesHTML = messages.map((message, index) => {
            console.log(`üìù Procesando mensaje ${index + 1}:`, message);
            console.log(`üïí Fecha del mensaje ${index + 1}:`, message.created_at);
            console.log(`üïí Tipo de fecha del mensaje ${index + 1}:`, typeof message.created_at);
            
            let formattedDateTime;
            try {
              formattedDateTime = formatDateTime(message.created_at);
              console.log(`üïí Fecha formateada del mensaje ${index + 1}:`, formattedDateTime);
            } catch (dateError) {
              console.error(`‚ùå Error al formatear fecha del mensaje ${index + 1}:`, dateError);
              formattedDateTime = 'Fecha no disponible';
            }
            
            return `
            <div class="message-item mb-3 ${message.is_admin ? 'admin-message' : 'user-message'}">
              <div class="d-flex ${message.is_admin ? 'justify-content-end' : 'justify-content-start'}">
                <div class="message-bubble ${message.is_admin ? 'bg-primary text-white' : 'bg-light'}" style="max-width: 80%;">
                  <div class="message-header mb-1">
                    <small class="fw-bold ${message.is_admin ? 'text-light' : 'text-primary'}">
                      ${message.is_admin ? 'üë®‚Äçüíº Admin' : 'üë§ ' + (message.sender_name || 'Usuario')}
                    </small>
                    <small class="ms-2 ${message.is_admin ? 'text-light opacity-75' : 'text-muted'}">
                      ${formattedDateTime}
                    </small>
                  </div>
                  <div class="message-content">
                    ${message.message || 'Mensaje sin contenido'}
                  </div>
                </div>
              </div>
            </div>
          `;
          }).join('');
          
          console.log('‚úÖ HTML de mensajes generado correctamente');
          messagesList.innerHTML = messagesHTML;
          
          // Scroll al final de los mensajes
          setTimeout(() => {
            try {
              const messagesContainer = document.querySelector('.messages-container');
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
              console.log('‚úÖ Scroll aplicado');
            } catch (scrollError) {
              console.error('‚ùå Error al aplicar scroll:', scrollError);
            }
          }, 100);
          
        } catch (error) {
          console.error('‚ùå Error general al procesar mensajes:', error);
          messagesList.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i> 
              Error al procesar mensajes: ${error.message}
            </div>
          `;
        }
      }

      // Enviar respuesta del administrador
      document.getElementById('responseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentConversationId) {
          showAlert('‚ùå Error: No hay conversaci√≥n seleccionada', 'danger');
          return;
        }

        const responseText = document.getElementById('admin-response').value.trim();
        const markResolved = document.getElementById('mark-resolved').checked;
        
        if (!responseText) {
          showAlert('‚ùå Por favor escribe una respuesta', 'warning');
          return;
        }

        console.log('üì© Enviando respuesta a conversaci√≥n:', currentConversationId);

        // Deshabilitar el bot√≥n de env√≠o
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

        fetch('/dashboard/admin/conversation/reply/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conversation_id: currentConversationId,
            message: responseText,
            mark_resolved: markResolved
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showAlert('‚úÖ Respuesta enviada correctamente', 'success');
            
            // Limpiar el formulario
            document.getElementById('admin-response').value = '';
            document.getElementById('mark-resolved').checked = false;
            
            // Recargar la conversaci√≥n
            viewConversation(currentConversationId);
            
            // Actualizar la tabla si la conversaci√≥n fue marcada como resuelta
            if (markResolved) {
              setTimeout(() => {
                location.reload();
              }, 2000);
            }
          } else {
            showAlert('‚ùå Error al enviar respuesta: ' + (data.error || 'Error desconocido'), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('‚ùå Error de conexi√≥n. Intenta de nuevo.', 'danger');
        })
        .finally(() => {
          // Restaurar el bot√≥n
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        });
      });

      // Actualizar estado de conversaci√≥n desde el modal
      function updateConversationStatusInModal(newStatus) {
        if (!currentConversationId) {
          showAlert('‚ùå Error: No hay conversaci√≥n seleccionada', 'danger');
          return;
        }

        updateConversationStatus(currentConversationId, newStatus);
      }

      // Actualizar estado de conversaci√≥n
      function updateConversationStatus(conversationId, newStatus) {
        const confirmMessage = `¬øEst√°s seguro de cambiar el estado de esta conversaci√≥n a "${getConversationStatusText(newStatus)}"?`;
        
        if (!confirm(confirmMessage)) {
          return;
        }

        console.log('üîÑ Actualizando estado de conversaci√≥n:', conversationId, 'a', newStatus);

        fetch('/dashboard/admin/conversation/update-status/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conversation_id: conversationId,
            new_status: newStatus
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showAlert(`‚úÖ Estado actualizado a "${getConversationStatusText(newStatus)}" correctamente`, 'success');
            
            // Actualizar el badge en el modal si est√° abierto
            if (currentConversationId === conversationId) {
              const statusBadge = document.getElementById('conv-status-badge');
              statusBadge.className = `badge bg-${getConversationStatusColor(newStatus)}`;
              statusBadge.textContent = getConversationStatusText(newStatus);
            }
            
            // Actualizar la fila en la tabla
            updateConversationRowStatus(conversationId, newStatus);
            
            // Recargar estad√≠sticas
            setTimeout(() => {
              location.reload();
            }, 2000);
          } else {
            showAlert('‚ùå Error al actualizar estado: ' + (data.error || 'Error desconocido'), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('‚ùå Error de conexi√≥n. Intenta de nuevo.', 'danger');
        });
      }

      // Actualizar fila de conversaci√≥n en la tabla
      function updateConversationRowStatus(conversationId, newStatus) {
        const row = document.querySelector(`[data-conversation-id="${conversationId}"]`);
        if (row) {
          const statusBadge = row.querySelector('.badge');
          if (statusBadge) {
            statusBadge.className = `badge bg-${getConversationStatusColor(newStatus)}`;
            statusBadge.textContent = getConversationStatusText(newStatus);
          }
          
          // Actualizar el atributo data-status para los filtros
          row.setAttribute('data-status', newStatus);
        }
      }

      // Funciones auxiliares para conversaciones
      function getConversationStatusColor(status) {
        const colors = {
          'open': 'warning',
          'in_progress': 'info', 
          'resolved': 'success',
          'closed': 'secondary'
        };
        return colors[status] || 'secondary';
      }

      function getConversationStatusText(status) {
        const texts = {
          'open': 'Abierta',
          'in_progress': 'En Progreso',
          'resolved': 'Resuelta', 
          'closed': 'Cerrada'
        };
        return texts[status] || 'Desconocido';
      }

      // Filtros de conversaciones
      document.addEventListener('DOMContentLoaded', function() {
        const filterButtons = document.querySelectorAll('input[name="conversation-filter"]');
        filterButtons.forEach(button => {
          button.addEventListener('change', function() {
            const filterValue = this.id.replace('filter-', '');
            filterConversations(filterValue);
          });
        });
      });

      function filterConversations(filter) {
        const rows = document.querySelectorAll('.conversation-row');
        
        rows.forEach(row => {
          const status = row.getAttribute('data-status');
          let shouldShow = false;
          
          switch(filter) {
            case 'all':
              shouldShow = true;
              break;
            case 'pending':
              shouldShow = status === 'open';
              break;
            case 'active':
              shouldShow = status === 'in_progress';
              break;
            case 'closed':
              shouldShow = status === 'closed' || status === 'resolved';
              break;
          }
          
          row.style.display = shouldShow ? '' : 'none';
        });
      }

      // Actualizar mensajes autom√°ticamente
      document.getElementById('refreshMessages').addEventListener('click', function() {
        location.reload();
      });

      // Formatear fechas
      function formatDate(dateString) {
        console.log('üîç formatDate llamado con:', dateString, 'tipo:', typeof dateString);
        try {
          if (!dateString) {
            console.log('‚ö†Ô∏è formatDate: dateString est√° vac√≠o');
            return 'Fecha no disponible';
          }
          console.log('üîç formatDate: Creando objeto Date...');
          const date = new Date(dateString);
          console.log('üîç formatDate: Date creado:', date);
          if (isNaN(date.getTime())) {
            console.error('‚ùå formatDate: Fecha inv√°lida:', dateString);
            return 'Fecha inv√°lida';
          }
          const result = date.toLocaleDateString('es-CO') + ' ' + date.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});
          console.log('‚úÖ formatDate: Resultado:', result);
          return result;
        } catch (error) {
          console.error('‚ùå formatDate: Error al formatear fecha:', error, dateString);
          console.error('‚ùå formatDate: Stack trace:', error.stack);
          return 'Error en fecha';
        }
      }

      function formatDateTime(dateString) {
        console.log('üîç formatDateTime llamado con:', dateString, 'tipo:', typeof dateString);
        try {
          if (!dateString) {
            console.log('‚ö†Ô∏è formatDateTime: dateString est√° vac√≠o');
            return 'Fecha no disponible';
          }
          console.log('üîç formatDateTime: Creando objeto Date...');
          const date = new Date(dateString);
          console.log('üîç formatDateTime: Date creado:', date);
          if (isNaN(date.getTime())) {
            console.error('‚ùå formatDateTime: Fecha/hora inv√°lida:', dateString);
            return 'Fecha inv√°lida';
          }
          const now = new Date();
          const diffInMs = now - date;
          const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
          
          let result;
          if (diffInDays === 0) {
            result = 'Hoy ' + date.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});
          } else if (diffInDays === 1) {
            result = 'Ayer ' + date.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});
          } else {
            result = date.toLocaleDateString('es-CO') + ' ' + date.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});
          }
          console.log('‚úÖ formatDateTime: Resultado:', result);
          return result;
        } catch (error) {
          console.error('‚ùå formatDateTime: Error al formatear fecha/hora:', error, dateString);
          console.error('‚ùå formatDateTime: Stack trace:', error.stack);
          return 'Error en fecha';
        }
      }

      // FUNCIONES PARA BONOS DE DESCUENTO
      function editarBono(bonoId) {
        // Por ahora, redirigir a la p√°gina con par√°metros para edici√≥n
        // En una implementaci√≥n m√°s avanzada, se podr√≠a cargar via AJAX
        alert('Funcionalidad de edici√≥n en desarrollo. Por ahora puedes eliminar y crear nuevamente el bono.');
      }

      // Validaci√≥n de formularios de bonos
      document.addEventListener('DOMContentLoaded', function() {
        // Actualizar fecha m√≠nima al cargar
        const now = new Date();
        const minDate = now.toISOString().slice(0, 16);
        
        const fechaInicioInput = document.getElementById('fecha_inicio');
        const fechaFinInput = document.getElementById('fecha_fin');
        
        if (fechaInicioInput) {
          fechaInicioInput.min = minDate;
          fechaInicioInput.value = minDate;
        }
        
        if (fechaFinInput) {
          fechaFinInput.min = minDate;
          // Establecer fecha fin como 1 semana despu√©s
          const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
          fechaFinInput.value = nextWeek.toISOString().slice(0, 16);
        }
      });
    </script>

  
    <!-- M√≥dulos JS Especializados -->
    <script src="{% static 'js/dashboard-users.js' %}"></script>
    <script src="{% static 'js/dashboard-pedidos.js' %}"></script>
    <script src="{% static 'js/dashboard-autorefresh.js' %}"></script>
    
    <!-- Script de Inicializaci√≥n y Debug -->
    <script>
        console.log('üîç DEBUG: Verificando elementos data-stat en la p√°gina');
        document.addEventListener('DOMContentLoaded', function() {
            const ventasHoyElement = document.querySelector('[data-stat="ventas-hoy"]');
            if (ventasHoyElement) {
                console.log('‚úÖ Elemento ventas-hoy encontrado');
                console.log('   Valor inicial:', ventasHoyElement.textContent);
            } else {
                console.error('‚ùå Elemento ventas-hoy NO encontrado');
            }
            
            // Listar todos los elementos con data-stat
            const allStats = document.querySelectorAll('[data-stat]');
            console.log(`üìä Total elementos data-stat: ${allStats.length}`);
            allStats.forEach(el => {
                console.log(`   - ${el.getAttribute('data-stat')}: "${el.textContent.trim()}"`);
            });
            
            // Verificar funciones de pedidos
            console.log('üîç Verificando funciones de pedidos...');
            if (typeof viewPedidoDetails === 'function') {
                console.log('‚úÖ viewPedidoDetails est√° disponible');
            } else {
                console.error('‚ùå viewPedidoDetails NO est√° disponible');
            }
            
            if (typeof updateEstado === 'function') {
                console.log('‚úÖ updateEstado est√° disponible');
            } else {
                console.error('‚ùå updateEstado NO est√° disponible');
            }
            
            if (typeof confirmarPago === 'function') {
                console.log('‚úÖ confirmarPago est√° disponible');
            } else {
                console.error('‚ùå confirmarPago NO est√° disponible');
            }
            
            // Verificar si DashboardAutoRefresh est√° disponible
            setTimeout(() => {
                if (window.DashboardAutoRefresh) {
                    console.log('‚úÖ DashboardAutoRefresh disponible');
                    console.log('   M√©todos:', Object.keys(window.DashboardAutoRefresh));
                    
                    // Forzar actualizaci√≥n manual para test
                    console.log('üîÑ Forzando actualizaci√≥n manual de stats...');
                    window.DashboardAutoRefresh.refreshStats();
                } else {
                    console.error('‚ùå DashboardAutoRefresh NO disponible');
                }
            }, 1000);
            
            // Configurar event listeners para el modal de pedidos
            const pedidoModal = document.getElementById('pedidoModal');
            if (pedidoModal) {
                pedidoModal.addEventListener('show.bs.modal', function(event) {
                    console.log('üîì Modal de pedido abierto');
                });
                
                pedidoModal.addEventListener('hidden.bs.modal', function(event) {
                    console.log('üîí Modal de pedido cerrado');
                });
            }
        });
    </script>
    
</body>
<script>
(function() {
    var ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    var ws_path = ws_scheme + '://' + window.location.host + '/ws/dashboard/';
    var dashboardSocket = new WebSocket(ws_path);

    dashboardSocket.onopen = function(e) {
        console.log('[WebSocket] Dashboard conectado para notificaciones de visitas');
    };
    dashboardSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        if (data.message === 'new_visit') {
            // Modern alert: SweetAlert2 si est√° disponible, si no, toast, si no, alert
            if (window.Swal && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: '¬°Nuevo visitante en tienda!',
                    text: 'Alguien acaba de ingresar a la tienda online.',
                    icon: 'info',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3500,
                    timerProgressBar: true,
                    background: '#f0f9ff',
                    color: '#222',
                    customClass: {
                        popup: 'swal2-modern-toast swal2-shadow'
                    }
                });
            } else if (window.showToast) {
                showToast('Nuevo visitante', 'Alguien acaba de ingresar a la tienda', 'info', 3500);
            } else {
                alert('Nuevo visitante en la tienda');
            }
            console.log('[WebSocket] Nuevo visitante:', data.timestamp);
            
            // Auto-refresh si estamos en la vista de visitas
            if (window.location.search.includes('view=visitas')) {
                refreshVisitas();
            }
        }
    };
    dashboardSocket.onclose = function(e) {
        console.log('[WebSocket] Dashboard desconectado');
    };
})();
</script>

<!-- Auto-refresh para visitas en tiempo real -->
<script>
(function() {
    'use strict';
    
    // Solo ejecutar en la vista de visitas
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view') !== 'visitas') {
        return;
    }
    
    console.log('üîÑ Iniciando sistema de auto-refresh para visitas');
    
    let refreshInterval = null;
    const REFRESH_INTERVAL = 10000; // 10 segundos
    
    // Funci√≥n para actualizar visitas
    window.refreshVisitas = function() {
        const filterForm = document.getElementById('visitas-filter-form');
        if (!filterForm) return;
        
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        
        console.log('üîÑ Actualizando visitas...', params.toString());
        
        fetch(`/dashboard/api/visitas-live/?${params.toString()}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('‚úÖ Visitas actualizadas:', data.visitas.length);
                
                // Actualizar AMBAS versiones: desktop Y mobile
                updateVisitasTable(data.visitas);
                updateVisitasCards(data.visitas);
                updateVisitasStats(data.stats);
                
                // Animar indicador en vivo
                const liveIndicator = document.getElementById('live-indicator');
                if (liveIndicator) {
                    liveIndicator.style.animation = 'none';
                    setTimeout(() => {
                        liveIndicator.style.animation = '';
                    }, 10);
                }
            }
        })
        .catch(error => {
            console.error('‚ùå Error al actualizar visitas:', error);
        });
    };
    
    // Funci√≥n auxiliar para parsear timestamp del API
    function parseTimestamp(timestamp) {
        // Formato del API: "05/12/2025 14:30:45"
        const parts = timestamp.split(' ');
        const datePart = parts[0]; // "05/12/2025"
        const timePart = parts[1]; // "14:30:45"
        const timeShort = timePart.substring(0, 5); // "14:30"
        
        return {
            date: datePart,
            time: timeShort,
            full: timestamp
        };
    }
    
    // Funci√≥n auxiliar para generar badge de tipo de visita
    function generateVisitTypeBadge(visita) {
        const types = {
            'home': { gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', icon: 'fa-home', label: 'Home' },
            'store': { gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', icon: 'fa-store', label: 'Tienda' },
            'product_detail': { gradient: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', icon: 'fa-box', label: visita.product_name || `Producto ${visita.product_id ? '#' + visita.product_id : ''}` },
            'cart': { gradient: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', icon: 'fa-shopping-basket', label: 'Carrito' },
            'checkout': { gradient: 'linear-gradient(135deg, #ffd89b 0%, #19547b 100%)', icon: 'fa-shopping-cart', label: 'Checkout' }
        };
        
        const type = types[visita.visit_type] || { gradient: '#6c757d', icon: 'fa-question', label: '-' };
        return `<span class="badge rounded-pill" style="background: ${type.gradient};"><i class="fas ${type.icon}"></i> ${type.label}</span>`;
    }
    
    // Funci√≥n auxiliar para generar info de usuario
    function generateUserInfo(visita) {
        if (visita.is_authenticated) {
            const userName = visita.user_name || visita.user_email || 'Usuario';
            const initial = userName.charAt(0).toUpperCase();
            return {
                avatar: `<div class="user-avatar me-2" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${initial}</div>`,
                name: userName,
                status: '‚úÖ Autenticado',
                simple: `<span class="badge bg-primary"><i class="fas fa-user"></i> ${userName}</span>`
            };
        } else {
            return {
                avatar: `<div class="user-avatar me-2" style="width: 32px; height: 32px; border-radius: 50%; background: #6c757d; display: flex; align-items: center; justify-content: center; color: white;"><i class="fas fa-user-secret"></i></div>`,
                name: 'An√≥nimo',
                status: 'üîí No identificado',
                simple: '<span class="text-secondary small">An√≥nimo</span>'
            };
        }
    }
    
    // Funci√≥n auxiliar para color del border seg√∫n tipo
    function getBorderColor(visitType) {
        const colors = {
            'home': '#667eea',
            'store': '#4facfe',
            'product_detail': '#43e97b',
            'cart': '#fa709a',
            'checkout': '#ffd89b'
        };
        return colors[visitType] || '#6c757d';
    }
    
    // Funci√≥n para actualizar tabla de visitas (DESKTOP)
    function updateVisitasTable(visitas) {
        const tbody = document.getElementById('visitas-tbody');
        if (!tbody) return;
        
        if (visitas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4"><i class="fas fa-eye-slash me-2"></i>Sin visitas recientes</td></tr>';
            return;
        }
        
        tbody.innerHTML = visitas.map(visita => {
            const timestamp = parseTimestamp(visita.timestamp);
            const userInfo = generateUserInfo(visita);
            const location = (visita.city || visita.country) 
                ? `<div class="d-flex align-items-center"><i class="fas fa-map-marker-alt text-danger me-2"></i><div><div class="fw-semibold">${visita.city || 'Desconocida'}</div>${visita.country ? `<small class="text-muted">${visita.country}</small>` : ''}</div></div>`
                : '<small class="text-muted"><i class="fas fa-question-circle"></i> No disponible</small>';
            
            return `
                <tr class="visita-row" style="transition: all 0.3s ease;">
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="visit-time-badge">
                                <div class="fw-bold">${timestamp.time}</div>
                                <small class="text-muted">${timestamp.date}</small>
                            </div>
                        </div>
                    </td>
                    <td>${generateVisitTypeBadge(visita)}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            ${userInfo.avatar}
                            <div>
                                <div class="fw-semibold">${userInfo.name}</div>
                                <small class="text-muted">${userInfo.status}</small>
                            </div>
                        </div>
                    </td>
                    <td>${location}</td>
                    <td><code class="small">${visita.ip_address || '-'}</code></td>
                </tr>
            `;
        }).join('');
    }
    
    // Funci√≥n para actualizar cards m√≥viles (MOBILE)
    function updateVisitasCards(visitas) {
        // Buscar el contenedor de cards m√≥viles
        const mobileContainer = document.querySelector('.col-12.d-lg-none > div[style*="max-height"]');
        if (!mobileContainer) return;
        
        if (visitas.length === 0) {
            mobileContainer.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-eye-slash fa-3x mb-3 d-block"></i>
                    <p class="mb-0">No hay visitas con los filtros seleccionados</p>
                </div>
            `;
            return;
        }
        
        mobileContainer.innerHTML = visitas.map(visita => {
            const timestamp = parseTimestamp(visita.timestamp);
            const userInfo = generateUserInfo(visita);
            const borderColor = getBorderColor(visita.visit_type);
            const location = (visita.city || visita.country)
                ? `<small class="text-muted"><i class="fas fa-map-marker-alt text-danger"></i> ${visita.city || 'Desconocida'}${visita.country ? ', ' + visita.country : ''}</small>`
                : '<small class="text-muted"><i class="fas fa-question-circle"></i> No disponible</small>';
            
            return `
                <div class="card mb-3 shadow-sm border-0" style="border-left: 4px solid ${borderColor} !important;">
                    <div class="card-body p-3">
                        <!-- Header de la card -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>${generateVisitTypeBadge(visita)}</div>
                            <div class="text-end">
                                <div class="fw-bold">${timestamp.time}</div>
                                <small class="text-muted">${timestamp.date}</small>
                            </div>
                        </div>
                        
                        <!-- Usuario -->
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                ${userInfo.avatar.replace('32px', '40px')}
                                <div>
                                    <div class="fw-semibold">${userInfo.name}</div>
                                    <small class="text-muted">${userInfo.status}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer con ubicaci√≥n e IP -->
                        <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                            <div>${location}</div>
                            <code class="small bg-light px-2 py-1 rounded">${visita.ip_address || '-'}</code>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Funci√≥n para actualizar estad√≠sticas
    function updateVisitasStats(stats) {
        const statElements = {
            'visitas_count': stats.total_filtrado,
            'visitas_count_today': stats.total_hoy,
            'visitas_count_week': stats.total_semana,
            'visitas_count_month': stats.total_mes,
            'visitas_count_auth': stats.total_autenticados,
            'visitas_count_anon': stats.total_anonimos,
            'visitas_count_store': stats.total_tienda,
            'visitas_count_product': stats.total_productos
        };
        
        // Actualizar badges en el sidebar
        document.querySelectorAll('.badge').forEach(badge => {
            const text = badge.textContent.trim();
            // Reemplazar n√∫meros en badges
            for (const [key, value] of Object.entries(stats)) {
                const currentBadge = badge.closest('.small, .mb-3');
                if (currentBadge) {
                    const parentText = currentBadge.textContent;
                    if (parentText.includes('Total filtrado') && key === 'total_filtrado') {
                        badge.textContent = value;
                    } else if (parentText.includes('Hoy') && key === 'total_hoy') {
                        badge.textContent = value;
                    } else if (parentText.includes('Esta semana') && key === 'total_semana') {
                        badge.textContent = value;
                    } else if (parentText.includes('Este mes') && key === 'total_mes') {
                        badge.textContent = value;
                    } else if (parentText.includes('Autenticados') && key === 'total_autenticados') {
                        badge.textContent = value;
                    } else if (parentText.includes('An√≥nimos') && key === 'total_anonimos') {
                        badge.textContent = value;
                    } else if (parentText.includes('Tienda') && key === 'total_tienda') {
                        badge.textContent = value;
                    } else if (parentText.includes('Productos') && key === 'total_productos') {
                        badge.textContent = value;
                    }
                }
            }
        });
    }
    
    // Funci√≥n para actualizar productos m√°s visitados
    function refreshProductosMasVisitados() {
        const periodoSelect = document.getElementById('periodo-productos');
        if (!periodoSelect) return;
        
        const periodo = periodoSelect.value;
        
        fetch(`/dashboard/api/productos-mas-visitados/?periodo=${periodo}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('‚úÖ Productos m√°s visitados actualizados:', data.productos.length);
                updateProductosVisitados(data.productos);
            }
        })
        .catch(error => {
            console.error('‚ùå Error al actualizar productos:', error);
        });
    }
    
    // Funci√≥n para actualizar contenedor de productos
    function updateProductosVisitados(productos) {
        const container = document.getElementById('productos-visitados-container');
        if (!container) return;
        
        if (productos.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No hay datos de productos visitados en este per√≠odo
                    </div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = productos.map(item => {
            const imageHtml = item.product_image ? 
                `<img src="${item.product_image}" alt="${item.product_name}" class="rounded" width="60" height="60" style="object-fit: cover;">` :
                `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                    <i class="fas fa-image text-muted"></i>
                </div>`;
            
            return `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    ${imageHtml}
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">${item.product_name}</h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-danger">
                                            <i class="fas fa-eye"></i> ${item.total_visitas} visita${item.total_visitas !== 1 ? 's' : ''}
                                        </span>
                                        <span class="text-muted small">
                                            $${parseFloat(item.product_price).toLocaleString()}
                                        </span>
                                    </div>
                                    <div class="mt-1">
                                        <span class="badge bg-secondary small">Stock: ${item.product_stock}</span>
                                        <span class="badge bg-info small">${item.product_category}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Bot√≥n de refresh manual de visitas
        const refreshBtn = document.getElementById('refresh-visitas');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                console.log('üîÑ Refresh manual de visitas solicitado');
                
                // Verificar si hay paginaci√≥n de productos activa
                const urlParams = new URLSearchParams(window.location.search);
                const hasProductosPagination = urlParams.has('productos_page');
                
                if (hasProductosPagination) {
                    // Si hay paginaci√≥n, recargar toda la p√°gina para mantener el estado
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.add('fa-spin');
                    }
                    window.location.reload();
                } else {
                    // Si no hay paginaci√≥n, usar AJAX normal
                    refreshVisitas();
                    
                    // Feedback visual
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.add('fa-spin');
                        setTimeout(() => icon.classList.remove('fa-spin'), 1000);
                    }
                }
            });
        }
        
        // Selector de per√≠odo de productos - Usar recarga de p√°gina para mantener paginaci√≥n
        const periodoSelect = document.getElementById('periodo-productos');
        if (periodoSelect) {
            periodoSelect.addEventListener('change', function() {
                console.log('üìä Cambiando per√≠odo de productos:', this.value);
                
                // Construir URL con par√°metros actuales
                const url = new URL(window.location);
                url.searchParams.set('periodo_productos', this.value);
                url.searchParams.delete('productos_page'); // Reset a primera p√°gina
                
                // Redirigir con nuevos par√°metros
                window.location.href = url.toString();
            });
        }
        
        // Bot√≥n de refresh de productos
        const refreshProductosBtn = document.getElementById('refresh-productos');
        if (refreshProductosBtn) {
            refreshProductosBtn.addEventListener('click', function() {
                console.log('üîÑ Refresh manual de productos');
                
                // Feedback visual
                const icon = this.querySelector('i');
                if (icon) {
                    icon.classList.add('fa-spin');
                }
                
                // Recargar p√°gina actual
                window.location.reload();
            });
        }
        
        // Verificar si hay paginaci√≥n activa en productos
        const urlParams = new URLSearchParams(window.location.search);
        const hasProductosPagination = urlParams.has('productos_page');
        
        // Solo iniciar auto-refresh si NO hay paginaci√≥n de productos activa
        if (!hasProductosPagination) {
            // Iniciar auto-refresh solo para visitas (no productos)
            refreshInterval = setInterval(() => {
                refreshVisitas();
                // NO refrescar productos si hay paginaci√≥n
            }, REFRESH_INTERVAL);
            
            console.log(`‚úÖ Auto-refresh iniciado solo para visitas (cada ${REFRESH_INTERVAL/1000}s)`);
            
            // Refresh inicial despu√©s de 2 segundos
            setTimeout(() => {
                refreshVisitas();
            }, 2000);
        } else {
            console.log('‚è∏Ô∏è Auto-refresh deshabilitado - Paginaci√≥n de productos activa');
            
            // Agregar mensaje informativo
            const infoMsg = document.createElement('div');
            infoMsg.className = 'alert alert-info alert-dismissible fade show mt-3';
            infoMsg.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>Auto-actualizaci√≥n pausada:</strong> La actualizaci√≥n autom√°tica est√° deshabilitada mientras navegas por las p√°ginas. 
                Usa el bot√≥n <i class="fas fa-sync-alt"></i> para actualizar manualmente.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const productosSection = document.querySelector('.card.modern-card .card-body');
            if (productosSection && productosSection.querySelector('.row.g-3')) {
                productosSection.insertBefore(infoMsg, productosSection.firstChild);
            }
        }
    });
    
    // Limpiar interval al salir de la p√°gina
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            console.log('üõë Auto-refresh detenido');
        }
    });
    
    // CSS para animaci√≥n del indicador en vivo
    const style = document.createElement('style');
    style.textContent = `
        /* Animaci√≥n de pulso */
        @keyframes pulse-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-animation {
            animation: pulse-animation 2s ease-in-out infinite;
        }
        
        /* Scrollbar personalizado moderno */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        /* Animaci√≥n suave para filas de tabla */
        .visita-row:hover {
            background-color: #f8f9fa !important;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Estilo para tiempo de visita */
        .visit-time-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        /* Animaci√≥n de entrada para cards m√≥viles */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card {
            animation: fadeInUp 0.3s ease-out;
        }
        
        /* Efecto hover mejorado para cards */
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            transition: all 0.3s ease;
        }
    `;
    document.head.appendChild(style);
    
})();
</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Script de Gr√°ficos de Ventas -->
<script>
(function() {
    'use strict';
    
    // Solo ejecutar en la vista de ventas
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view') !== 'ventas') {
        return;
    }
    
    console.log('üìä Inicializando gr√°ficos de an√°lisis de ventas');
    
    // Datos de ventas por categor√≠a desde Django
    const ventasData = {
        categorias: [
            {% for categoria in ventas_por_categoria %}
                '{{ categoria.nombre }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        ingresos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.total_ingresos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        productos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.cantidad_productos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        pedidos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.cantidad_pedidos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    // Colores modernos para los gr√°ficos
    const colors = [
        'rgba(102, 126, 234, 0.8)',   // P√∫rpura
        'rgba(118, 75, 162, 0.8)',    // Morado oscuro
        'rgba(79, 172, 254, 0.8)',    // Azul claro
        'rgba(0, 242, 254, 0.8)',     // Cyan
        'rgba(67, 233, 123, 0.8)',    // Verde
        'rgba(245, 87, 108, 0.8)',    // Rosa
        'rgba(255, 159, 64, 0.8)',    // Naranja
        'rgba(255, 205, 86, 0.8)',    // Amarillo
        'rgba(153, 102, 255, 0.8)',   // Violeta
        'rgba(201, 203, 207, 0.8)'    // Gris
    ];
    
    const borderColors = colors.map(color => color.replace('0.8', '1'));
    
    // Configuraci√≥n del gr√°fico
    const ctx = document.getElementById('ventasCategoriaChart');
    if (!ctx) {
        console.error('‚ùå Canvas del gr√°fico no encontrado');
        return;
    }
    
    let currentChart = null;
    let currentChartType = 'bar';
    
    // Funci√≥n para crear/actualizar el gr√°fico
    function createChart(type = 'bar') {
        if (currentChart) {
            currentChart.destroy();
        }
        
        const config = {
            type: type,
            data: {
                labels: ventasData.categorias,
                datasets: [{
                    label: 'Ingresos ($)',
                    data: ventasData.ingresos,
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: type === 'bar' ? 8 : 0,
                    hoverOffset: type === 'pie' || type === 'doughnut' ? 10 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: type !== 'bar',
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        return {
                                            text: label + ' ($' + value.toLocaleString() + ')',
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '$' + context.parsed.y.toLocaleString();
                                return label;
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: type === 'bar' ? {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                } : {}
            }
        };
        
        currentChart = new Chart(ctx, config);
        currentChartType = type;
        
        console.log(`‚úÖ Gr√°fico ${type} creado exitosamente`);
    }
    
    // Crear gr√°fico inicial
    createChart('bar');
    
    // Event listeners para cambio de tipo de gr√°fico
    document.querySelectorAll('[data-chart-type]').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.getAttribute('data-chart-type');
            
            // Actualizar botones activos
            document.querySelectorAll('[data-chart-type]').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            // Crear nuevo gr√°fico
            createChart(type);
            
            console.log('üìä Tipo de gr√°fico cambiado a:', type);
        });
    });
    
    // Funci√≥n para cargar datos de ventas por per√≠odo
    let currentPeriod = 'all';
    
    async function loadVentasPorPeriodo(periodo) {
        try {
            console.log(`üìä Cargando ventas para per√≠odo: ${periodo}`);
            
            // Mostrar indicador de carga
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                chartContainer.style.opacity = '0.5';
            }
            
            const response = await fetch(`/dashboard/api/ventas-por-periodo/?periodo=${periodo}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error('Error al cargar datos de ventas');
            }
            
            console.log('‚úÖ Datos cargados:', data);
            
            // Actualizar datos del gr√°fico
            ventasData.categorias = data.ventas_por_categoria.map(c => c.nombre);
            ventasData.ingresos = data.ventas_por_categoria.map(c => c.total_ingresos);
            ventasData.productos = data.ventas_por_categoria.map(c => c.cantidad_productos);
            ventasData.pedidos = data.ventas_por_categoria.map(c => c.cantidad_pedidos);
            
            // Recrear gr√°fico con nuevos datos
            createChart(currentChartType);
            
            // Actualizar KPIs
            updateKPIs(data.estadisticas, data.ventas_por_categoria);
            
            // Actualizar tabla
            updateTable(data.ventas_por_categoria);
            
            // Actualizar top 5
            updateTop5(data.ventas_por_categoria);
            
            currentPeriod = periodo;
            
            // Restaurar opacidad
            if (chartContainer) {
                chartContainer.style.opacity = '1';
            }
            
            console.log('‚úÖ Vista actualizada exitosamente');
            
        } catch (error) {
            console.error('‚ùå Error cargando ventas:', error);
            alert('Error al cargar datos de ventas. Por favor intente nuevamente.');
        }
    }
    
    // Funci√≥n para actualizar KPIs
    function updateKPIs(stats, categorias) {
        // Total ventas
        const totalVentasEl = document.querySelector('.modern-stat-card:nth-child(1) .stat-value');
        if (totalVentasEl) {
            totalVentasEl.textContent = '$' + stats.total_ventas.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }
        
        // Productos vendidos
        const totalProductosEl = document.querySelector('.modern-stat-card:nth-child(2) .stat-value');
        if (totalProductosEl) {
            totalProductosEl.textContent = stats.total_productos.toLocaleString();
        }
        
        // Promedio por pedido
        const promedioEl = document.querySelector('.modern-stat-card:nth-child(3) .stat-value');
        if (promedioEl) {
            promedioEl.textContent = '$' + stats.promedio_por_pedido.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }
        
        // Total pedidos
        const pedidosEl = document.querySelector('.modern-stat-card:nth-child(4) .stat-value');
        if (pedidosEl) {
            pedidosEl.textContent = stats.pedidos_totales.toLocaleString();
        }
        
        console.log('‚úÖ KPIs actualizados');
    }
    
    // Funci√≥n para actualizar tabla
    function updateTable(categorias) {
        const tbody = document.querySelector('.table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        categorias.forEach((categoria, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="fw-bold text-muted">${index + 1}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="category-color-indicator me-2" 
                             style="width: 8px; height: 8px; border-radius: 50%; background: ${colors[index % colors.length]};"></div>
                        <strong class="text-dark">${categoria.nombre}</strong>
                    </div>
                </td>
                <td class="text-end">
                    <span class="badge bg-success-subtle text-success px-3 py-2">
                        $${categoria.total_ingresos.toLocaleString('es-CO', {minimumFractionDigits: 0})}
                    </span>
                </td>
                <td class="text-center">
                    <span class="badge bg-info-subtle text-info">
                        ${categoria.cantidad_productos}
                    </span>
                </td>
                <td class="text-center">
                    <span class="badge bg-primary-subtle text-primary">
                        ${categoria.cantidad_pedidos}
                    </span>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        console.log('‚úÖ Tabla actualizada');
    }
    
    // Funci√≥n para actualizar top 5
    function updateTop5(categorias) {
        const container = document.querySelector('.top-5-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        const top5 = categorias.slice(0, 5);
        const maxIngresos = top5[0]?.total_ingresos || 1;
        
        top5.forEach((categoria, index) => {
            const percentage = (categoria.total_ingresos / maxIngresos) * 100;
            const item = document.createElement('div');
            item.className = 'top-category-item';
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="fw-bold">${index + 1}. ${categoria.nombre}</span>
                        <small class="text-muted d-block">${categoria.cantidad_productos} productos</small>
                    </div>
                    <span class="badge bg-success">$${categoria.total_ingresos.toLocaleString('es-CO', {minimumFractionDigits: 0})}</span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: ${percentage}%; background: linear-gradient(90deg, ${colors[index % colors.length]}, ${colors[(index + 1) % colors.length]});"
                         aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            `;
            container.appendChild(item);
        });
        
        console.log('‚úÖ Top 5 actualizado');
    }
    
    // Event listeners para botones de per√≠odo
    document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', function() {
            const periodo = this.getAttribute('data-period');
            
            // Actualizar botones activos
            document.querySelectorAll('[data-period]').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            // Cargar datos del per√≠odo
            loadVentasPorPeriodo(periodo);
            
            console.log('üìÖ Per√≠odo cambiado a:', periodo);
        });
    });
    
    // Funci√≥n para exportar a Excel (simplificada)
    window.exportToExcel = function() {
        console.log('üì• Exportando datos a Excel...');
        
        // Crear datos CSV
        let csv = 'Categor√≠a,Ingresos,Productos Vendidos,Pedidos\n';
        for (let i = 0; i < ventasData.categorias.length; i++) {
            csv += `${ventasData.categorias[i]},${ventasData.ingresos[i]},${ventasData.productos[i]},${ventasData.pedidos[i]}\n`;
        }
        
        // Descargar archivo
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'analisis_ventas_' + currentPeriod + '_' + new Date().toISOString().split('T')[0] + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('‚úÖ Datos exportados exitosamente');
    };
    
    console.log('‚úÖ Sistema de gr√°ficos inicializado correctamente');
    
})();
</script>

<!-- Script de Gr√°ficos del HOME -->
<script>
(function() {
    'use strict';
    
    // Solo ejecutar en la vista home (sin par√°metro view)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view')) {
        return; // No es la vista home
    }
    
    console.log('üè† Inicializando gr√°ficos del panel principal (HOME)');
    
    // Datos de ventas por categor√≠a desde Django
    const homeVentasData = {
        categorias: [
            {% for categoria in ventas_por_categoria %}
                '{{ categoria.nombre }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        ingresos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.total_ingresos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        productos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.cantidad_productos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        pedidos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.cantidad_pedidos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    // Colores modernos para los gr√°ficos
    const homeColors = [
        'rgba(102, 126, 234, 0.8)',
        'rgba(118, 75, 162, 0.8)',
        'rgba(79, 172, 254, 0.8)',
        'rgba(0, 242, 254, 0.8)',
        'rgba(67, 233, 123, 0.8)',
        'rgba(245, 87, 108, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(201, 203, 207, 0.8)'
    ];
    
    const homeBorderColors = homeColors.map(color => color.replace('0.8', '1'));
    
    // Configuraci√≥n del gr√°fico
    const homeCtx = document.getElementById('homeVentasChart');
    if (!homeCtx) {
        console.warn('‚ö†Ô∏è Canvas del gr√°fico HOME no encontrado');
        return;
    }
    
    let homeCurrentChart = null;
    let homeCurrentChartType = 'bar';
    
    // Funci√≥n para crear/actualizar el gr√°fico
    function createHomeChart(type = 'bar') {
        if (homeCurrentChart) {
            homeCurrentChart.destroy();
        }
        
        const config = {
            type: type,
            data: {
                labels: homeVentasData.categorias,
                datasets: [{
                    label: 'Ingresos ($)',
                    data: homeVentasData.ingresos,
                    backgroundColor: homeColors,
                    borderColor: homeBorderColors,
                    borderWidth: 2,
                    borderRadius: type === 'bar' ? 8 : 0,
                    hoverOffset: type === 'pie' || type === 'doughnut' ? 10 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: type !== 'bar',
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        return {
                                            text: label + ' ($' + value.toLocaleString() + ')',
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (type === 'bar') {
                                    label += '$' + context.parsed.y.toLocaleString();
                                } else {
                                    label += '$' + context.parsed.toLocaleString();
                                }
                                return label;
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: type === 'bar' ? {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                } : {}
            }
        };
        
        homeCurrentChart = new Chart(homeCtx, config);
        homeCurrentChartType = type;
        
        console.log(`‚úÖ Gr√°fico HOME ${type} creado exitosamente`);
    }
    
    // Crear gr√°fico inicial
    createHomeChart('bar');
    
    // Event listeners para cambio de tipo de gr√°fico en HOME
    document.querySelectorAll('[data-chart-type]').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.getAttribute('data-chart-type');
            
            // Actualizar botones activos
            document.querySelectorAll('[data-chart-type]').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            // Crear nuevo gr√°fico
            createHomeChart(type);
            
            console.log('üìä Tipo de gr√°fico HOME cambiado a:', type);
        });
    });
    
    // Funci√≥n para exportar a Excel del HOME
    window.exportToExcelHome = function() {
        console.log('üì• Exportando datos del HOME a Excel...');
        
        // Crear datos CSV
        let csv = 'Categor√≠a,Ingresos,Productos Vendidos,Pedidos\n';
        for (let i = 0; i < homeVentasData.categorias.length; i++) {
            csv += `${homeVentasData.categorias[i]},${homeVentasData.ingresos[i]},${homeVentasData.productos[i]},${homeVentasData.pedidos[i]}\n`;
        }
        
        // Descargar archivo
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'resumen_ventas_' + new Date().toISOString().split('T')[0] + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('‚úÖ Datos del HOME exportados exitosamente');
    };
    
    console.log('‚úÖ Sistema de gr√°ficos HOME inicializado correctamente');
    
})();
</script>

<!-- Script de Gr√°ficos de Inventario -->
<script>
(function() {
    'use strict';
    
    // Solo ejecutar en la vista de inventario
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view') !== 'inventario') {
        return;
    }
    
    console.log('üì¶ Inicializando sistema de inventario avanzado');
    
    // Datos de inventario por categor√≠a desde Django
    const inventoryData = {
        categorias: [
            {% for cat in inventario_by_category %}
                '{{ cat.category_name }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        valorInvertido: [
            {% for cat in inventario_by_category %}
                {{ cat.valor_invertido|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        valorVenta: [
            {% for cat in inventario_by_category %}
                {{ cat.valor_productos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        stock: [
            {% for cat in inventario_by_category %}
                {{ cat.cantidad_stock|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        productos: [
            {% for cat in inventario_by_category %}
                {{ cat.items|length }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    // Verificar si hay datos
    const hasData = inventoryData.categorias.length > 0;
    const hasSingleCategory = inventoryData.categorias.length === 1;
    
    console.log('üìä Datos de inventario:', {
        categorias: inventoryData.categorias.length,
        hasData: hasData,
        hasSingleCategory: hasSingleCategory
    });
    
    if (!hasData) {
        console.warn('‚ö†Ô∏è No hay datos de inventario para mostrar gr√°ficos');
    } else if (hasSingleCategory) {
        console.log('‚ÑπÔ∏è Mostrando datos de una sola categor√≠a:', inventoryData.categorias[0]);
    }
    
    // Funci√≥n para mostrar placeholder
    function showPlaceholder(canvasId, icon = 'chart-bar') {
        const canvas = document.getElementById(canvasId);
        if (canvas) {
            const container = canvas.closest('.chart-container');
            if (container) {
                container.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <i class="fas fa-${icon} fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">No hay datos para mostrar</p>
                            <small class="text-muted">Selecciona una categor√≠a con productos</small>
                        </div>
                    </div>
                `;
            }
        }
    }
    
    // Si no hay datos, mostrar placeholders y salir
    if (!hasData) {
        showPlaceholder('inventoryValueChart', 'chart-bar');
        showPlaceholder('inventoryStockChart', 'chart-pie');
        return;
    }
    
    // Colores para gr√°ficos
    const invColors = [
        'rgba(102, 126, 234, 0.8)',
        'rgba(118, 75, 162, 0.8)',
        'rgba(79, 172, 254, 0.8)',
        'rgba(0, 242, 254, 0.8)',
        'rgba(67, 233, 123, 0.8)',
        'rgba(245, 87, 108, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(201, 203, 207, 0.8)'
    ];
    
    const invBorderColors = invColors.map(color => color.replace('0.8', '1'));
    
    // GR√ÅFICO 1: Valoraci√≥n por Categor√≠a
    const valueChartCtx = document.getElementById('inventoryValueChart');
    let valueChart = null;
    let currentValueChartType = 'bar';
    
    if (valueChartCtx) {
        function createValueChart(type = 'bar') {
            if (valueChart) {
                valueChart.destroy();
            }
            
            // Para una sola categor√≠a, forzar tipo bar para mejor visualizaci√≥n
            const chartType = hasSingleCategory ? 'bar' : type;
            
            const config = {
                type: chartType,
                data: {
                    labels: inventoryData.categorias,
                    datasets: [{
                        label: 'Valor Invertido',
                        data: inventoryData.valorInvertido,
                        backgroundColor: chartType === 'bar' ? 'rgba(220, 53, 69, 0.7)' : invColors,
                        borderColor: chartType === 'bar' ? 'rgba(220, 53, 69, 1)' : invBorderColors,
                        borderWidth: 2,
                        borderRadius: chartType === 'bar' ? 6 : 0
                    }, {
                        label: 'Valor de Venta',
                        data: inventoryData.valorVenta,
                        backgroundColor: chartType === 'bar' ? 'rgba(25, 135, 84, 0.7)' : invColors,
                        borderColor: chartType === 'bar' ? 'rgba(25, 135, 84, 1)' : invBorderColors,
                        borderWidth: 2,
                        borderRadius: chartType === 'bar' ? 6 : 0,
                        hidden: chartType !== 'bar'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: type === 'bar' ? 'top' : 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = type === 'bar' ? context.parsed.y : context.parsed;
                                    label += '$' + value.toLocaleString();
                                    return label;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: chartType === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    } : {}
                }
            };
            
            valueChart = new Chart(valueChartCtx, config);
            currentValueChartType = chartType;
            console.log(`‚úÖ Gr√°fico de valoraci√≥n (${chartType}) creado con ${inventoryData.categorias.length} categor√≠a(s)`);
        }
        
        createValueChart('bar');
        
        // Event listeners para cambio de tipo (deshabilitar si solo hay una categor√≠a)
        document.querySelectorAll('[data-inv-chart-type]').forEach(btn => {
            if (hasSingleCategory) {
                // Deshabilitar botones de doughnut cuando solo hay una categor√≠a
                if (btn.getAttribute('data-inv-chart-type') === 'doughnut') {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Requiere m√∫ltiples categor√≠as';
                }
            }
            
            btn.addEventListener('click', function() {
                if (this.disabled) return;
                
                const type = this.getAttribute('data-inv-chart-type');
                document.querySelectorAll('[data-inv-chart-type]').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                createValueChart(type);
            });
        });
    }
    
    // GR√ÅFICO 2: Stock por Categor√≠a (Doughnut o Bar para una sola categor√≠a)
    const stockChartCtx = document.getElementById('inventoryStockChart');
    
    if (stockChartCtx) {
        // Si solo hay una categor√≠a, usar gr√°fico de barras en lugar de doughnut
        const stockChartType = hasSingleCategory ? 'bar' : 'doughnut';
        
        const stockChart = new Chart(stockChartCtx, {
            type: stockChartType,
            data: {
                labels: inventoryData.categorias,
                datasets: [{
                    label: 'Unidades en Stock',
                    data: inventoryData.stock,
                    backgroundColor: hasSingleCategory ? 'rgba(79, 172, 254, 0.8)' : invColors,
                    borderColor: hasSingleCategory ? 'rgba(79, 172, 254, 1)' : invBorderColors,
                    borderWidth: 2,
                    borderRadius: hasSingleCategory ? 6 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: !hasSingleCategory,
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10,
                            font: { size: 11 },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        return {
                                            text: label + ' (' + value + ')',
                                            fillStyle: data.datasets[0].backgroundColor[i] || data.datasets[0].backgroundColor,
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = hasSingleCategory ? context.parsed.y : context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value + ' unidades' + (hasSingleCategory ? '' : ' (' + percentage + '%)');
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: hasSingleCategory ? {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' unidades';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                } : {}
            }
        });
        
        console.log(`‚úÖ Gr√°fico de stock (${stockChartType}) creado con ${inventoryData.categorias.length} categor√≠a(s)`);
    }
    
    // Funci√≥n para exportar reportes
    window.exportInventoryReport = function(format) {
        console.log(`üì• Exportando reporte de inventario (${format})...`);
        
        if (!hasData) {
            showNotification('No hay datos para exportar', 'warning');
            return;
        }
        
        if (format === 'excel' || format === 'pdf') {
            // Extraer datos de las tablas del DOM
            let csv = 'Categor√≠a,Producto,Stock,Precio Compra,Precio Venta,Inversi√≥n Total,Valor Total,Margen\n';
            
            // Recorrer todas las tablas de categor√≠as
            const tables = document.querySelectorAll('.modern-card table tbody');
            tables.forEach(tbody => {
                const rows = tbody.querySelectorAll('tr:not(tfoot tr)');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 6) {
                        // Obtener categor√≠a del header m√°s cercano
                        const card = row.closest('.modern-card');
                        const categoryName = card ? card.querySelector('.card-header h5')?.textContent.trim().replace(/\\n/g, ' ').replace(/\\s+/g, ' ') : 'Sin Categor√≠a';
                        
                        const productName = cells[0].querySelector('strong')?.textContent.trim() || '';
                        const stock = cells[1].textContent.trim().replace(/[^0-9]/g, '');
                        const priceBuy = cells[2].textContent.trim().replace(/[$,]/g, '');
                        const priceSell = cells[3].textContent.trim().replace(/[$,]/g, '');
                        const invTotal = cells[4].textContent.trim().replace(/[$,]/g, '');
                        const valTotal = cells[5].textContent.trim().replace(/[$,]/g, '');
                        const margin = (parseFloat(valTotal) - parseFloat(invTotal)).toFixed(2);
                        
                        csv += `"${categoryName}","${productName}",${stock},${priceBuy},${priceSell},${invTotal},${valTotal},${margin}\\n`;
                    }
                });
            });
            
            // Agregar resumen general
            csv += '\\n\\nRESUMEN GENERAL\\n';
            csv += 'Concepto,Valor\\n';
            csv += 'Total Productos,{{ resumen_inventario.cantidad_productos_stock }}\\n';
            csv += 'Capital Invertido,${{ resumen_inventario.valor_invertido|floatformat:2 }}\\n';
            csv += 'Valor de Venta,${{ resumen_inventario.valor_productos|floatformat:2 }}\\n';
            csv += 'Margen de Ganancia,${{ resumen_inventario.margen_ganancia|floatformat:2 }}\\n';
            
            // Agregar informaci√≥n de categor√≠as
            csv += '\\n\\nDETALLE POR CATEGOR√çA\\n';
            csv += 'Categor√≠a,Stock Total,Inversi√≥n,Valor Venta\\n';
            inventoryData.categorias.forEach((cat, i) => {
                csv += `"${cat}",${inventoryData.stock[i]},$${inventoryData.valorInvertido[i]},$${inventoryData.valorVenta[i]}\\n`;
            });
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fecha = new Date().toISOString().split('T')[0];
            a.download = `inventario_completo_${fecha}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('‚úÖ Reporte exportado exitosamente');
            showNotification('¬°Reporte generado exitosamente!', 'success');
        }
    };
    
    // Funci√≥n auxiliar para mostrar notificaciones
    function showNotification(message, type = 'success') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alert.style.zIndex = '9999';
        alert.style.minWidth = '300px';
        
        const icon = type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle';
        alert.innerHTML = `
            <i class="fas fa-${icon} me-2"></i>
            <strong>${message}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }, 4000);
    }
    
    // Funci√≥n para imprimir inventario
    window.printInventory = function() {
        console.log('üñ®Ô∏è Preparando impresi√≥n...');
        
        if (!hasData) {
            showNotification('No hay datos para imprimir', 'warning');
            return;
        }
        
        // Agregar clase temporal para ocultar elementos innecesarios
        document.body.classList.add('printing-inventory');
        
        // Imprimir
        setTimeout(() => {
            window.print();
            // Remover clase despu√©s de imprimir
            setTimeout(() => {
                document.body.classList.remove('printing-inventory');
            }, 100);
        }, 100);
    };
    
    console.log('‚úÖ Sistema de inventario inicializado correctamente');
    
})();
</script>

<!-- Estilos adicionales para visitas y impresi√≥n -->
<style>
/* Estilos para scroll de visitas - Desktop */
.visitas-table-scroll {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: hidden;
    scroll-behavior: smooth;
}

.visitas-table-scroll::-webkit-scrollbar {
    width: 10px;
}

.visitas-table-scroll::-webkit-scrollbar-track {
    background: #e9ecef;
    border-radius: 10px;
}

.visitas-table-scroll::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 10px;
    border: 2px solid #e9ecef;
}

.visitas-table-scroll::-webkit-scrollbar-thumb:hover {
    background: #495057;
}

/* Headers sticky para tabla de visitas */
.visitas-thead-sticky {
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: #f8f9fa !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.visitas-thead-sticky th {
    background-color: #f8f9fa !important;
}

/* Scroll suave para tarjetas m√≥viles */
.visitas-mobile-scroll {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: hidden;
    scroll-behavior: smooth;
}

.visitas-mobile-scroll::-webkit-scrollbar {
    width: 8px;
}

.visitas-mobile-scroll::-webkit-scrollbar-track {
    background: #e9ecef;
    border-radius: 10px;
}

.visitas-mobile-scroll::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 10px;
    border: 2px solid #e9ecef;
}

.visitas-mobile-scroll::-webkit-scrollbar-thumb:hover {
    background: #495057;
}

@media print {
    /* Ocultar elementos innecesarios */
    .sidebar, 
    .mobile-header, 
    .btn, 
    .alert:not(.alert-danger):not(.alert-warning), 
    .form-select,
    .form-control,
    nav,
    .btn-group,
    .card-header .btn,
    .modern-stat-card .stat-trend {
        display: none !important;
    }
    
    /* Ajustar contenido principal */
    .main-content {
        margin: 0 !important;
        padding: 20px !important;
        width: 100% !important;
    }
    
    /* Evitar saltos de p√°gina en cards */
    .card {
        break-inside: avoid;
        page-break-inside: avoid;
        margin-bottom: 20px !important;
        box-shadow: none !important;
        border: 1px solid #ddd !important;
    }
    
    /* Ocultar gr√°ficos en impresi√≥n */
    .chart-container {
        display: none !important;
    }
    
    /* Mantener KPIs visibles */
    .modern-stat-card {
        break-inside: avoid;
        page-break-inside: avoid;
        border: 1px solid #ddd !important;
        box-shadow: none !important;
    }
    
    .modern-stat-card .stat-value {
        font-size: 1.5rem !important;
    }
    
    /* Mejorar visualizaci√≥n de tablas */
    table {
        font-size: 0.85rem !important;
    }
    
    thead {
        background: #f8f9fa !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    /* Encabezado de reporte */
    .inventario-dashboard-modern::before {
        content: 'REPORTE DE INVENTARIO - CompuEasys';
        display: block;
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #333;
    }
    
    .inventario-dashboard-modern::after {
        content: 'Fecha: ' attr(data-print-date);
        display: block;
        text-align: right;
        font-size: 0.9rem;
        margin-top: 10px;
    }
}

/* Estilos adicionales para indicadores de stock */
.product-status-indicator {
    display: inline-block;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Animaci√≥n para notificaciones */
@keyframes slideInDown {
    from {
        transform: translate(-50%, -100%);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

.alert.position-fixed {
    animation: slideInDown 0.3s ease-out;
}
</style>

<script>
// Autofocus en el campo nombre del producto al crear o editar
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si estamos en la vista de productos y en modo crear o editar
    const urlParams = new URLSearchParams(window.location.search);
    const isProductView = urlParams.get('view') === 'productos';
    const isCreating = urlParams.has('crear');
    const isEditing = urlParams.has('editar');
    
    if (isProductView && (isCreating || isEditing)) {
        const productNameInput = document.getElementById('producto_name');
        if (productNameInput) {
            // Hacer focus despu√©s de un peque√±o delay para asegurar que el DOM est√© listo
            setTimeout(() => {
                productNameInput.focus();
                // Seleccionar todo el texto si estamos editando
                if (isEditing && productNameInput.value) {
                    productNameInput.select();
                }
            }, 100);
        }
    }
});

// Sistema de colapso de cards del dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Configuraci√≥n de cards colapsables
    const collapsibleCards = [
        {
            id: 'ventasCategorias',
            toggleBtn: 'toggleVentasCategorias',
            content: 'ventasCategoriasContent',
            icon: 'iconVentasCategorias',
            storageKey: 'ventasCategoriasCollapsed'
        },
        {
            id: 'graficoVentas',
            toggleBtn: 'toggleGraficoVentas',
            content: 'graficoVentasContent',
            icon: 'iconGraficoVentas',
            storageKey: 'graficoVentasCollapsed'
        },
        {
            id: 'topCategorias',
            toggleBtn: 'toggleTopCategorias',
            content: 'topCategoriasContent',
            icon: 'iconTopCategorias',
            storageKey: 'topCategoriasCollapsed'
        }
    ];

    // Funci√≥n para colapsar/expandir un card
    function setupCollapsibleCard(config) {
        const toggleBtn = document.getElementById(config.toggleBtn);
        const content = document.getElementById(config.content);
        const icon = document.getElementById(config.icon);
        
        if (!toggleBtn || !content || !icon) return;

        // Restaurar estado desde localStorage
        const isCollapsed = localStorage.getItem(config.storageKey) === 'true';
        if (isCollapsed) {
            content.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }

        // Agregar transici√≥n suave
        content.style.transition = 'all 0.3s ease-in-out';
        icon.style.transition = 'transform 0.3s ease-in-out';

        // Manejar click en el bot√≥n
        toggleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const currentlyHidden = content.style.display === 'none';
            
            if (currentlyHidden) {
                // Expandir
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                localStorage.setItem(config.storageKey, 'false');
            } else {
                // Colapsar
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                localStorage.setItem(config.storageKey, 'true');
            }
        });
    }

    // Inicializar todos los cards colapsables
    collapsibleCards.forEach(config => setupCollapsibleCard(config));
});
</script>
</html>