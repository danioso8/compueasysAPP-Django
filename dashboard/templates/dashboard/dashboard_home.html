<!-- filepath: d:\ESCRITORIO\CompueasysApp\dashboard\templates\dashboard\dashboard_home.html -->
{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Tienda</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- PLUG Tailwind Pro Dashboard CSS -->
    <link rel="stylesheet" href="{% static 'css/dashboard-tailwind-pro.css' %}" />
    
    <!-- Dashboard Moderno V2 CSS -->
    <link rel="stylesheet" href="{% static 'css/dashboard-modern-v2.css' %}" />
    
    <!-- Dashboard Animations & Advanced Effects -->
    <link rel="stylesheet" href="{% static 'css/dashboard-animations.css' %}" />
    
    <!-- Google Fonts - Inter for Pro Look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        /* Estilos para placeholder en filtros */
        #search::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        #search:focus {
            background: rgba(255, 255, 255, 0.3) !important;
            color: white !important;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
        }
        
        #categoria_filter:focus {
            background: rgba(255, 255, 255, 0.3) !important;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
        }
    </style>

</head>
<body>
    <!-- Header Superior Moderno con Usuario -->
    <nav class="top-navbar">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center w-100">
                <!-- Logo y botÃ³n menÃº mÃ³vil -->
                <div class="d-flex align-items-center gap-3">
                    <button class="mobile-menu-btn d-md-none" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="top-navbar-brand d-none d-md-flex align-items-center gap-2">
                        <i class="fas fa-desktop text-primary"></i>
                        <span class="fw-bold">CompuEasys</span>
                    </div>
                </div>

                <!-- MenÃº de Usuario -->
                <div class="dropdown">
                    <button class="btn btn-link text-decoration-none p-0 user-menu-btn" type="button" id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="d-flex align-items-center gap-2">
                            <div class="user-avatar-small">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <div class="d-none d-sm-block text-start">
                                <div class="user-name">{{ request.session.superuser_username }}</div>
                                <div class="user-role">{% if is_superuser %}Superusuario{% else %}STAFF{% endif %}</div>
                            </div>
                            <i class="fas fa-chevron-down ms-2"></i>
                        </div>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="userMenuDropdown">
                        <!-- Perfil -->
                        <li>
                            <div class="dropdown-header d-flex align-items-center gap-2 pb-2 border-bottom">
                                <div class="user-avatar-dropdown">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ request.session.superuser_username }}</div>
                                    <small class="text-muted">{{ request.session.superuser_email }}</small>
                                </div>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        
                        <!-- Opciones de usuario -->
                        <li>
                            <a class="dropdown-item" href="?view=mi_perfil">
                                <i class="fas fa-user-edit me-2 text-primary"></i>
                                Mi Perfil
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="?view=usuarios">
                                <i class="fas fa-users-cog me-2 text-info"></i>
                                Gestionar Usuarios
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="?view=datos_tienda">
                                <i class="fas fa-store-alt me-2 text-success"></i>
                                ConfiguraciÃ³n Tienda
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        
                        <!-- Cerrar sesiÃ³n -->
                        <li>
                            <a class="dropdown-item text-danger" href="{% url 'logout_view' %}">
                                <i class="fas fa-sign-out-alt me-2"></i>
                                Cerrar SesiÃ³n
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Overlay para cerrar menÃº en mÃ³vil -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    
    <div class="dashboard-container">
        <aside class="sidebar modern-sidebar" id="sidebar">
            <!-- Header Corporativo Mejorado -->
            <div class="sidebar-brand">
                <div class="brand-logo">
                    <div class="logo-icon">
                        <i class="fas fa-desktop"></i>
                    </div>
                    <div class="brand-identity">
                        <span class="brand-name">CompuEasys</span>
                        <span class="brand-tagline">Dashboard Pro</span>
                    </div>
                </div>
                <button class="sidebar-collapse-btn" id="sidebarToggle" title="Contraer/Expandir">
                    <i class="fas fa-angles-left"></i>
                </button>
            </div>

         
            
            <!-- NavegaciÃ³n Moderna con Grupos -->
            <nav class="sidebar-navigation">
                <!-- GRUPO: PANEL DE CONTROL -->
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-grip-horizontal"></i>
                        <span class="sidebar-text">Panel de Control</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item">
                            <a href="/dashboard/dashboard_home/" class="nav-menu-link {% if not request.GET.view %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-home"></i>
                                </span>
                                <span class="nav-menu-text">Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=ventas" class="nav-menu-link {% if request.GET.view == 'ventas' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-chart-line"></i>
                                </span>
                                <span class="nav-menu-text">AnÃ¡lisis de Ventas</span>
                            </a>
                        </li>
                        {% if is_superuser or is_staff %}
                        <li class="nav-menu-item">
                            <a href="?view=visitas" class="nav-menu-link {% if request.GET.view == 'visitas' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-chart-area"></i>
                                </span>
                                <span class="nav-menu-text">AnÃ¡lisis de Visitas</span>
                                <span class="nav-menu-badge live">
                                    <i class="fas fa-circle"></i> Live
                                </span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <!-- GRUPO: GESTIÃ“N COMERCIAL -->
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-shopping-bag"></i>
                        <span class="sidebar-text">GestiÃ³n Comercial</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item">
                            <a href="?view=pedidos" class="nav-menu-link {% if request.GET.view == 'pedidos' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-shopping-cart"></i>
                                </span>
                                <span class="nav-menu-text">Pedidos</span>
                                <span class="nav-menu-badge primary">{{ estadisticas_diarias.pedidos_hoy|default:"0" }}</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=productos" class="nav-menu-link {% if request.GET.view == 'productos' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-box-open"></i>
                                </span>
                                <span class="nav-menu-text">Productos</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=inventario" class="nav-menu-link {% if request.GET.view == 'inventario' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-warehouse"></i>
                                </span>
                                <span class="nav-menu-text">Inventario</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=bonos" class="nav-menu-link {% if request.GET.view == 'bonos' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-gift"></i>
                                </span>
                                <span class="nav-menu-text">Promociones</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- GRUPO: FACTURACIÃ“N -->
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span class="sidebar-text">FacturaciÃ³n</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item">
                            <a href="{% url 'billing:invoice_list' %}" class="nav-menu-link">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-file-invoice"></i>
                                </span>
                                <span class="nav-menu-text">Factura Normal</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="{% url 'billing:invoice_list' %}?filter=electronic" class="nav-menu-link">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-file-contract"></i>
                                </span>
                                <span class="nav-menu-text">Factura ElectrÃ³nica</span>
                                <span class="nav-menu-badge success">
                                    <i class="fas fa-check-circle"></i> DIAN
                                </span>
                            </a>
                        </li>
                        {% if is_superuser %}
                        <li class="nav-menu-item">
                            <a href="{% url 'billing:matias_config' %}" class="nav-menu-link">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-cogs"></i>
                                </span>
                                <span class="nav-menu-text">ConfiguraciÃ³n DIAN</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <!-- GRUPO: ORGANIZACIÃ“N -->
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-layer-group"></i>
                        <span class="sidebar-text">OrganizaciÃ³n</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item">
                            <a href="?view=categoria" class="nav-menu-link {% if request.GET.view == 'categoria' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-folder-tree"></i>
                                </span>
                                <span class="nav-menu-text">CategorÃ­as</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=tipos" class="nav-menu-link {% if request.GET.view == 'tipos' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-tag"></i>
                                </span>
                                <span class="nav-menu-text">Tipos</span>
                            </a>
                        </li>
                        {% if is_superuser %}
                        <li class="nav-menu-item">
                            <a href="?view=proveedores" class="nav-menu-link {% if request.GET.view == 'proveedores' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-truck-loading"></i>
                                </span>
                                <span class="nav-menu-text">Proveedores</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <!-- GRUPO: COMUNICACIÃ“N -->
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-comments"></i>
                        <span class="sidebar-text">ComunicaciÃ³n</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item">
                            <a href="?view=mensajes" class="nav-menu-link {% if request.GET.view == 'mensajes' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-envelope"></i>
                                </span>
                                <span class="nav-menu-text">Mensajes</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=notificaciones_stock" class="nav-menu-link {% if request.GET.view == 'notificaciones_stock' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-bell"></i>
                                </span>
                                <span class="nav-menu-text">Notificaciones Stock</span>
                                {% if stock_notifications_count %}
                                <span class="nav-menu-badge warning">{{ stock_notifications_count }}</span>
                                {% endif %}
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- GRUPO: CONFIGURACIÃ“N - Solo Superuser -->
                {% if is_superuser %}
                <div class="nav-section">
                    <div class="nav-section-title">
                        <i class="fas fa-sliders-h"></i>
                        <span class="sidebar-text">ConfiguraciÃ³n</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-menu-item has-submenu">
                            <a href="#" class="nav-menu-link" data-bs-toggle="collapse" data-bs-target="#configSubmenu">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-cog"></i>
                                </span>
                                <span class="nav-menu-text">Sistema</span>
                                <span class="nav-menu-arrow">
                                    <i class="fas fa-chevron-down"></i>
                                </span>
                            </a>
                            <ul class="nav-submenu collapse" id="configSubmenu">
                                <li class="nav-submenu-item">
                                    <a href="?view=wompi_config" class="nav-submenu-link">
                                        <i class="fas fa-credit-card"></i>
                                        <span>Pagos (Wompi)</span>
                                    </a>
                                </li>
                                <li class="nav-submenu-item">
                                    <a href="?view=whatsapp_config" class="nav-submenu-link">
                                        <i class="fab fa-whatsapp"></i>
                                        <span>WhatsApp</span>
                                    </a>
                                </li>
                                <li class="nav-submenu-item">
                                    <a href="?view=datos_tienda" class="nav-submenu-link">
                                        <i class="fas fa-store-alt"></i>
                                        <span>Datos de Tienda</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=usuarios" class="nav-menu-link {% if request.GET.view == 'usuarios' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-users-cog"></i>
                                </span>
                                <span class="nav-menu-text">Usuarios</span>
                            </a>
                        </li>
                        <li class="nav-menu-item">
                            <a href="?view=proyectos" class="nav-menu-link {% if request.GET.view == 'proyectos' %}active{% endif %}">
                                <span class="nav-menu-icon">
                                    <i class="fas fa-project-diagram"></i>
                                </span>
                                <span class="nav-menu-text">Proyectos</span>
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </nav>
            
            <!-- Footer Corporativo Mejorado -->
            <div class="sidebar-footer">
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <a href="/" target="_blank" class="quick-action-btn" title="Ver Tienda">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                    <a href="#" class="quick-action-btn" title="Soporte" onclick="alert('Contacto: soporte@compueasys.com')">
                        <i class="fas fa-life-ring"></i>
                    </a>
                    <a href="#" class="quick-action-btn" title="Notificaciones">
                        <i class="fas fa-bell"></i>
                    </a>
                </div>

                <!-- Version Info -->
                <div class="sidebar-version">
                    <small>CompuEasys v2.0 Pro</small>
                </div>
            </div>
        </aside>
        <main class="main-content">
            {% if not request.GET.view %}
            <!-- HOME DASHBOARD - Vista por defecto -->
            <div class="home-dashboard-modern">
                <div class="mb-4">
                    <h2 class="mb-1">
                        <i class="fas fa-chart-line me-2 text-primary"></i>
                        Panel de Control
                    </h2>
                    <p class="text-muted">Resumen general de ventas y rendimiento de tu tienda</p>
                </div>
                
                <!-- KPIs Cards Modernos -->
                <div class="row g-3 mb-4">
                    <!-- Ventas Totales -->
                    <div class="col-md-3">
                        <div class="modern-stat-card gradient-primary">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" style="font-family: 'Courier New', monospace;">
                                    ${{ total_ventas_general|floatformat:0|intcomma }}
                                </div>
                                <div class="stat-label">Ventas Totales</div>
                                <div class="stat-trend">
                                    <i class="fas fa-arrow-up me-1"></i>
                                    <span>Todas las ventas</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Productos Vendidos -->
                    <div class="col-md-3">
                        <div class="modern-stat-card gradient-success">
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">
                                    {{ estadisticas_ventas.productos_vendidos|intcomma }}
                                </div>
                                <div class="stat-label">Productos Vendidos</div>
                                <div class="stat-trend">
                                    <i class="fas fa-shopping-cart me-1"></i>
                                    <span>Total unidades</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Promedio por Pedido -->
                    <div class="col-md-3">
                        <div class="modern-stat-card gradient-warning">
                            <div class="stat-icon">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" style="font-family: 'Courier New', monospace;">
                                    ${{ estadisticas_ventas.promedio_por_pedido|floatformat:0|intcomma }}
                                </div>
                                <div class="stat-label">Promedio por Pedido</div>
                                <div class="stat-trend">
                                    <i class="fas fa-calculator me-1"></i>
                                    <span>Ticket promedio</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Pedidos -->
                    <div class="col-md-3">
                        <div class="modern-stat-card gradient-info">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">
                                    {{ estadisticas_ventas.pedidos_totales|intcomma }}
                                </div>
                                <div class="stat-label">Total Pedidos</div>
                                <div class="stat-trend">
                                    <i class="fas fa-chart-bar me-1"></i>
                                    <span>Pedidos confirmados</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actividad en Tiempo Real Modernizada CON MÃS COLORES -->
                <div class="card border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); overflow: hidden; border-radius: 16px;">
                    <div class="card-body p-4 text-white position-relative">
                        <!-- PatrÃ³n de fondo animado -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.15; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.15) 10px, rgba(255,255,255,.15) 20px); animation: slide 20s linear infinite;"></div>
                        
                        <div class="position-relative">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h4 class="mb-1 fw-bold" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                                        <i class="fas fa-calendar-day me-2"></i>Actividad de Hoy
                                    </h4>
                                    <small class="opacity-90">Actualizado en tiempo real</small>
                                </div>
                                <div class="pulse-badge">
                                    <span class="badge" style="background: rgba(255,255,255,0.35); backdrop-filter: blur(10px); font-size: 0.9rem; padding: 0.6rem 1.2rem; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                                        <i class="fas fa-sync-alt fa-spin me-2"></i>En Vivo
                                    </span>
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-3 col-6">
                                    <div class="p-3 rounded" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(37, 99, 235, 0.25) 100%); backdrop-filter: blur(15px); border: 2px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.15);" onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 12px 30px rgba(59, 130, 246, 0.4)'; this.style.background='linear-gradient(135deg, rgba(59, 130, 246, 0.35) 0%, rgba(37, 99, 235, 0.35) 100%)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'; this.style.background='linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(37, 99, 235, 0.25) 100%)'">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="stat-icon-mini" style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);">
                                                <i class="fas fa-shopping-cart" style="font-size: 1.4rem; color: white;"></i>
                                            </div>
                                            <div class="trend-arrow">
                                                <i class="fas fa-arrow-up" style="color: #86efac; font-size: 1.2rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));"></i>
                                            </div>
                                        </div>
                                        <h3 class="mb-1 fw-bold" data-stat="pedidos-hoy" style="font-size: 2.2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">{{ estadisticas_diarias.pedidos_hoy }}</h3>
                                        <small class="opacity-90" style="font-weight: 500;">Pedidos de Hoy</small>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="p-3 rounded" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.25) 0%, rgba(5, 150, 105, 0.25) 100%); backdrop-filter: blur(15px); border: 2px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.15);" onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 12px 30px rgba(16, 185, 129, 0.4)'; this.style.background='linear-gradient(135deg, rgba(16, 185, 129, 0.35) 0%, rgba(5, 150, 105, 0.35) 100%)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'; this.style.background='linear-gradient(135deg, rgba(16, 185, 129, 0.25) 0%, rgba(5, 150, 105, 0.25) 100%)'">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="stat-icon-mini" style="width: 50px; height: 50px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">
                                                <i class="fas fa-dollar-sign" style="font-size: 1.4rem; color: white;"></i>
                                            </div>
                                            <div class="trend-arrow">
                                                <i class="fas fa-chart-line" style="color: #a7f3d0; font-size: 1.2rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));"></i>
                                            </div>
                                        </div>
                                        <h3 class="mb-1 fw-bold" data-stat="ventas-hoy" style="font-size: 1.6rem; font-family: 'Courier New', monospace; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">${{ estadisticas_diarias.ventas_hoy|default:"0"|floatformat:0|intcomma }}</h3>
                                        <small class="opacity-90" style="font-weight: 500;">Ventas de Hoy</small>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="p-3 rounded" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.25) 0%, rgba(249, 115, 22, 0.25) 100%); backdrop-filter: blur(15px); border: 2px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.15);" onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 12px 30px rgba(251, 146, 60, 0.4)'; this.style.background='linear-gradient(135deg, rgba(251, 146, 60, 0.35) 0%, rgba(249, 115, 22, 0.35) 100%)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'; this.style.background='linear-gradient(135deg, rgba(251, 146, 60, 0.25) 0%, rgba(249, 115, 22, 0.25) 100%)'">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="stat-icon-mini" style="width: 50px; height: 50px; background: linear-gradient(135deg, #fb923c, #f97316); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(251, 146, 60, 0.4);">
                                                <i class="fas fa-box-open" style="font-size: 1.4rem; color: white;"></i>
                                            </div>
                                            <div class="trend-arrow">
                                                <i class="fas fa-fire" style="color: #fde68a; font-size: 1.2rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));"></i>
                                            </div>
                                        </div>
                                        <h3 class="mb-1 fw-bold" data-stat="productos-vendidos-hoy" style="font-size: 2.2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">{{ estadisticas_diarias.productos_vendidos_hoy }}</h3>
                                        <small class="opacity-90" style="font-weight: 500;">Productos Vendidos</small>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="p-3 rounded" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.25) 0%, rgba(219, 39, 119, 0.25) 100%); backdrop-filter: blur(15px); border: 2px solid rgba(255, 255, 255, 0.3); transition: all 0.3s ease; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.15);" onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 12px 30px rgba(236, 72, 153, 0.4)'; this.style.background='linear-gradient(135deg, rgba(236, 72, 153, 0.35) 0%, rgba(219, 39, 119, 0.35) 100%)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'; this.style.background='linear-gradient(135deg, rgba(236, 72, 153, 0.25) 0%, rgba(219, 39, 119, 0.25) 100%)'">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="stat-icon-mini" style="width: 50px; height: 50px; background: linear-gradient(135deg, #ec4899, #db2777); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);">
                                                <i class="fas fa-users" style="font-size: 1.4rem; color: white;"></i>
                                            </div>
                                            <div class="trend-arrow">
                                                <i class="fas fa-user-plus" style="color: #fde047; font-size: 1.2rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));"></i>
                                            </div>
                                        </div>
                                        <h3 class="mb-1 fw-bold" data-stat="total-usuarios" style="font-size: 2.2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">{{ usuarios|length }}</h3>
                                        <small class="opacity-90" style="font-weight: 500;">Total Usuarios</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GrÃ¡fico y Top 5 CategorÃ­as -->
                <div class="row g-3 mb-4">
                    <!-- GrÃ¡fico Principal -->
                    <div class="col-lg-8">
                        <div class="card modern-card shadow-sm">
                            <div class="card-header bg-white border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-pie me-2 text-primary"></i>
                                        Ventas por CategorÃ­a
                                    </h5>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary active" data-chart-type="bar">
                                            <i class="fas fa-chart-bar"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" data-chart-type="pie">
                                            <i class="fas fa-chart-pie"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" data-chart-type="doughnut">
                                            <i class="fas fa-circle-notch"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 350px;">
                                    <canvas id="homeVentasChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 CategorÃ­as -->
                    <div class="col-lg-4">
                        <div class="card modern-card shadow-sm h-100">
                            <div class="card-header bg-white border-bottom">
                                <h5 class="mb-0">
                                    <i class="fas fa-trophy me-2 text-warning"></i>
                                    Top 5 CategorÃ­as
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="top-5-list" id="home-top-5">
                                    {% for categoria in ventas_por_categoria|slice:":5" %}
                                    <div class="top-category-item mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <span class="fw-bold">{{ forloop.counter }}. {{ categoria.nombre }}</span>
                                                <small class="text-muted d-block">{{ categoria.cantidad_productos }} productos</small>
                                            </div>
                                            <span class="badge bg-success" style="font-family: 'Courier New', monospace; font-size: 0.95rem;">${{ categoria.total_ingresos|floatformat:0|intcomma }}</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            {% widthratio categoria.total_ingresos ventas_por_categoria.0.total_ingresos 100 as percentage %}
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ percentage }}%; background: {% cycle 'linear-gradient(90deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8))' 'linear-gradient(90deg, rgba(79, 172, 254, 0.8), rgba(0, 242, 254, 0.8))' 'linear-gradient(90deg, rgba(67, 233, 123, 0.8), rgba(79, 172, 254, 0.8))' 'linear-gradient(90deg, rgba(245, 87, 108, 0.8), rgba(255, 159, 64, 0.8))' 'linear-gradient(90deg, rgba(255, 205, 86, 0.8), rgba(153, 102, 255, 0.8))' %};"
                                                 aria-valuenow="{{ percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                        <p>No hay datos de ventas</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla Detallada de Ventas -->
                <div class="card modern-card shadow-sm">
                    <div class="card-header bg-white border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2 text-info"></i>
                                Detalle por CategorÃ­a
                            </h5>
                            <button type="button" class="btn btn-sm btn-success" onclick="exportToExcelHome()">
                                <i class="fas fa-file-excel me-1"></i>
                                Exportar a Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-center" style="width: 60px;">#</th>
                                        <th>CategorÃ­a</th>
                                        <th class="text-end">Ingresos Totales</th>
                                        <th class="text-center">Productos Vendidos</th>
                                        <th class="text-center">Pedidos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for categoria in ventas_por_categoria %}
                                    <tr>
                                        <td class="fw-bold text-muted">{{ forloop.counter }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="category-color-indicator me-2" 
                                                     style="width: 8px; height: 8px; border-radius: 50%; background: {% cycle 'rgba(102, 126, 234, 0.8)' 'rgba(118, 75, 162, 0.8)' 'rgba(79, 172, 254, 0.8)' 'rgba(0, 242, 254, 0.8)' 'rgba(67, 233, 123, 0.8)' 'rgba(245, 87, 108, 0.8)' 'rgba(255, 159, 64, 0.8)' 'rgba(255, 205, 86, 0.8)' 'rgba(153, 102, 255, 0.8)' 'rgba(201, 203, 207, 0.8)' %};"></div>
                                                <strong class="text-dark">{{ categoria.nombre }}</strong>
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2" style="font-family: 'Courier New', monospace; font-weight: 600;">
                                                ${{ categoria.total_ingresos|floatformat:0|intcomma }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-info-subtle text-info">
                                                {{ categoria.cantidad_productos }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary-subtle text-primary">
                                                {{ categoria.cantidad_pedidos }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-2x mb-2"></i>
                                            <p class="mb-0">No hay datos de ventas disponibles</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            {% elif request.GET.view == 'visitas' %}
            <!-- SecciÃ³n Visitas Recientes responsive y moderna -->
             <section class="mb-4">
                <div class="card modern-card shadow-sm">
                    <div class="card-header modern-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
                            <div class="text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    AnÃ¡lisis de Visitas
                                    <span class="badge bg-white text-primary ms-2 pulse-animation">
                                        <i class="fas fa-circle" style="font-size: 8px;"></i> En vivo
                                    </span>
                                </h5>
                                <small class="opacity-75">Monitoreo en tiempo real de tu tienda</small>
                            </div>
                            <form method="get" class="d-flex flex-wrap gap-2 align-items-center mb-0 w-100 w-md-auto" id="visitas-filter-form">
                                <input type="hidden" name="view" value="visitas">
                                <select name="visitas_filter" class="form-select form-select-sm flex-fill flex-md-grow-0 shadow-sm" id="visitas_filter" onchange="this.form.submit()" style="min-width: 100px;">
                                    <option value="all" {% if request.GET.visitas_filter == 'all' or not request.GET.visitas_filter %}selected{% endif %}>ðŸ“… Todas</option>
                                    <option value="today" {% if request.GET.visitas_filter == 'today' %}selected{% endif %}>ðŸŒŸ Hoy</option>
                                    <option value="week" {% if request.GET.visitas_filter == 'week' %}selected{% endif %}>ðŸ“Š Semana</option>
                                    <option value="month" {% if request.GET.visitas_filter == 'month' %}selected{% endif %}>ðŸ“ˆ Mes</option>
                                </select>
                                <select name="visitas_user" class="form-select form-select-sm flex-fill flex-md-grow-0 shadow-sm" id="visitas_user" onchange="this.form.submit()" style="min-width: 100px;">
                                    <option value="all" {% if request.GET.visitas_user == 'all' or not request.GET.visitas_user %}selected{% endif %}>ðŸ‘¥ Todos</option>
                                    <option value="auth" {% if request.GET.visitas_user == 'auth' %}selected{% endif %}>âœ… Autenticados</option>
                                    <option value="anon" {% if request.GET.visitas_user == 'anon' %}selected{% endif %}>ðŸ”’ AnÃ³nimos</option>
                                </select>
                                <select name="visitas_type" class="form-select form-select-sm flex-fill flex-md-grow-0 shadow-sm" id="visitas_type" onchange="this.form.submit()" style="min-width: 100px;">
                                    <option value="all" {% if request.GET.visitas_type == 'all' or not request.GET.visitas_type %}selected{% endif %}>ðŸŒ Todos</option>
                                    <option value="home" {% if request.GET.visitas_type == 'home' %}selected{% endif %}>ðŸ  Home</option>
                                    <option value="store" {% if request.GET.visitas_type == 'store' %}selected{% endif %}>ðŸª Tienda</option>
                                    <option value="product_detail" {% if request.GET.visitas_type == 'product_detail' %}selected{% endif %}>ðŸ“¦ Productos</option>
                                    <option value="cart" {% if request.GET.visitas_type == 'cart' %}selected{% endif %}>ðŸ›’ Carrito</option>
                                    <option value="checkout" {% if request.GET.visitas_type == 'checkout' %}selected{% endif %}>ðŸ’³ Checkout</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-light shadow-sm" id="refresh-visitas" title="Refrescar ahora">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Mensaje informativo -->
                    <div class="alert alert-info mx-3 mt-3 mb-0 d-flex align-items-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <div class="small">
                            <strong>Scroll infinito:</strong> Mostrando hasta 1000 visitas. 
                            Usa los filtros o presiona <i class="fas fa-sync-alt mx-1"></i> para actualizar.
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <!-- EstadÃ­sticas en cards responsive modernos (solo mÃ³vil) -->
                        <div class="d-lg-none p-3 bg-light">
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <div class="card text-center h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <div class="card-body p-3 text-white">
                                            <h5 class="mb-1 fw-bold">{{ visitas_count }}</h5>
                                            <small class="opacity-75">ðŸ“Š Total Filtrado</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card text-center h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                        <div class="card-body p-3 text-white">
                                            <h5 class="mb-1 fw-bold">{{ visitas_count_today }}</h5>
                                            <small class="opacity-75">ðŸŒŸ Hoy</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card text-center h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                        <div class="card-body p-3 text-white">
                                            <h5 class="mb-1 fw-bold">{{ visitas_count_auth }}</h5>
                                            <small class="opacity-75">âœ… Autenticados</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="card text-center h-100 border-0 shadow-sm" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                        <div class="card-body p-3 text-white">
                                            <h5 class="mb-1 fw-bold">{{ visitas_count_anon }}</h5>
                                            <small class="opacity-75">ðŸ”’ AnÃ³nimos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-0">
                            <!-- Sidebar de estadÃ­sticas modernizado (solo desktop) -->
                            <div class="col-lg-3 d-none d-lg-block border-end bg-light">
                                <div class="p-3">
                                    <!-- Total filtrado destacado -->
                                    <div class="card border-0 shadow-sm mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <div class="card-body text-center text-white p-3">
                                            <h4 class="mb-1 fw-bold">{{ visitas_count }}</h4>
                                            <small class="opacity-75">ðŸ“Š Total Filtrado</small>
                                        </div>
                                    </div>
                                    
                                    <!-- Por PerÃ­odo -->
                                    <div class="mb-3">
                                        <h6 class="mb-2 text-primary fw-bold"><i class="fas fa-calendar-alt me-1"></i> Por PerÃ­odo</h6>
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm">
                                            <span class="small">ðŸŒŸ Hoy:</span>
                                            <span class="badge" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">{{ visitas_count_today }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm">
                                            <span class="small">ðŸ“Š Semana:</span>
                                            <span class="badge" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">{{ visitas_count_week }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm">
                                            <span class="small">ðŸ“ˆ Mes:</span>
                                            <span class="badge" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">{{ visitas_count_month }}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Por Usuario -->
                                    <div class="mb-3">
                                        <h6 class="mb-2 text-success fw-bold"><i class="fas fa-users me-1"></i> Por Usuario</h6>
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm">
                                            <span class="small">âœ… Autenticados:</span>
                                            <span class="badge bg-success">{{ visitas_count_auth }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm">
                                            <span class="small">ðŸ”’ AnÃ³nimos:</span>
                                            <span class="badge bg-secondary">{{ visitas_count_anon }}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Por Tipo -->
                                    <div>
                                        <h6 class="mb-2 text-info fw-bold"><i class="fas fa-map-signs me-1"></i> Por Tipo</h6>
                                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-white rounded shadow-sm">
                                            <span class="small">ðŸ  Home:</span>
                                            <span class="badge bg-primary">{{ visitas_count_home }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-white rounded shadow-sm">
                                            <span class="small">ðŸª Tienda:</span>
                                            <span class="badge bg-info">{{ visitas_count_store }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-white rounded shadow-sm">
                                            <span class="small">ðŸ“¦ Productos:</span>
                                            <span class="badge bg-success">{{ visitas_count_product }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-white rounded shadow-sm">
                                            <span class="small">ðŸ›’ Carrito:</span>
                                            <span class="badge" style="background: #6f42c1;">{{ visitas_count_cart }}</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1 p-2 bg-white rounded shadow-sm">
                                            <span class="small">ðŸ’³ Checkout:</span>
                                            <span class="badge bg-warning text-dark">{{ visitas_count_checkout }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contenedor de visitas con scroll moderno (desktop) -->
                            <div class="col-lg-9 d-none d-lg-block">
                                <!-- Header con contador -->
                                <div class="p-3 border-bottom bg-white sticky-top">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="text-muted">Mostrando</span>
                                            <span class="badge bg-primary">{{ visitas_count }}</span>
                                            <span class="text-muted">visitas</span>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-arrow-down me-1"></i>DesplÃ¡zate para ver mÃ¡s
                                        </small>
                                    </div>
                                </div>
                                
                                <!-- Contenedor con scroll -->
                                <div style="max-height: 800px; overflow-y: auto; overflow-x: hidden;" class="custom-scrollbar">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                                            <tr>
                                                <th style="min-width: 140px;">
                                                    <i class="fas fa-clock text-primary"></i> Fecha/Hora
                                                </th>
                                                <th style="min-width: 120px;">
                                                    <i class="fas fa-tag text-success"></i> Tipo
                                                </th>
                                                <th style="min-width: 150px;">
                                                    <i class="fas fa-user text-info"></i> Usuario
                                                </th>
                                                <th style="min-width: 180px;">
                                                    <i class="fas fa-map-marker-alt text-danger"></i> UbicaciÃ³n
                                                </th>
                                                <th style="min-width: 120px;">
                                                    <i class="fas fa-network-wired text-secondary"></i> IP
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="visitas-tbody">
                                            {% for visita in visitas_recientes %}
                                            <tr class="visita-row" style="transition: all 0.3s ease;">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="visit-time-badge">
                                                            <div class="fw-bold">{{ visita.timestamp|date:"H:i" }}</div>
                                                            <small class="text-muted">{{ visita.timestamp|date:"d/m/Y" }}</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if visita.visit_type == 'home' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-home"></i> Home</span>
                                                    {% elif visita.visit_type == 'store' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><i class="fas fa-store"></i> Tienda</span>
                                                    {% elif visita.visit_type == 'product_detail' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                                            <i class="fas fa-box"></i> 
                                                            {% if visita.product %}
                                                                {{ visita.product.name|truncatewords:3 }}
                                                            {% elif visita.product_id %}
                                                                Producto #{{ visita.product_id }}
                                                            {% else %}
                                                                Producto
                                                            {% endif %}
                                                        </span>
                                                    {% elif visita.visit_type == 'cart' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="fas fa-shopping-basket"></i> Carrito</span>
                                                    {% elif visita.visit_type == 'checkout' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);"><i class="fas fa-shopping-cart"></i> Checkout</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary rounded-pill">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if visita.user %}
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                                                {{ visita.user.name|default:visita.user.email|first|upper }}
                                                            </div>
                                                            <div>
                                                                <div class="fw-semibold">{{ visita.user.name|default:visita.user.email|truncatewords:2 }}</div>
                                                                <small class="text-muted">âœ… Autenticado</small>
                                                            </div>
                                                        </div>
                                                    {% else %}
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2" style="width: 32px; height: 32px; border-radius: 50%; background: #6c757d; display: flex; align-items: center; justify-content: center; color: white;">
                                                                <i class="fas fa-user-secret"></i>
                                                            </div>
                                                            <div>
                                                                <div class="text-secondary">AnÃ³nimo</div>
                                                                <small class="text-muted">ðŸ”’ No identificado</small>
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if visita.city or visita.country %}
                                                        <div class="d-flex align-items-center">
                                                            <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                            <div>
                                                                <div class="fw-semibold">{{ visita.city|default:'Desconocida' }}</div>
                                                                <small class="text-muted">{{ visita.country|default:'-' }}</small>
                                                            </div>
                                                        </div>
                                                    {% else %}
                                                        <div class="text-muted">
                                                            <i class="fas fa-question-circle me-1"></i>No disponible
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <code class="px-2 py-1 bg-light rounded">{{ visita.ip_address|default:'-' }}</code>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center py-5">
                                                    <i class="fas fa-eye-slash fa-3x text-muted mb-3 d-block"></i>
                                                    <p class="text-muted">No hay visitas con los filtros seleccionados</p>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tarjetas mÃ³viles con scroll moderno -->
                            <div class="col-12 d-lg-none">
                                <!-- Header contador mÃ³vil -->
                                <div class="p-3 border-bottom bg-white sticky-top">
                                    <div class="text-center">
                                        <span class="badge bg-primary">{{ visitas_count }}</span>
                                        <span class="text-muted small">visitas totales</span>
                                        <div class="mt-1">
                                            <small class="text-muted">
                                                <i class="fas fa-arrow-down me-1"></i>Desliza para ver mÃ¡s
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contenedor con scroll -->
                                <div style="max-height: 700px; overflow-y: auto; overflow-x: hidden;" class="custom-scrollbar p-3">
                                    {% for visita in visitas_recientes %}
                                    <div class="card mb-3 shadow-sm border-0" style="border-left: 4px solid {% if visita.visit_type == 'home' %}#667eea{% elif visita.visit_type == 'store' %}#4facfe{% elif visita.visit_type == 'product_detail' %}#43e97b{% elif visita.visit_type == 'cart' %}#fa709a{% elif visita.visit_type == 'checkout' %}#ffd89b{% else %}#6c757d{% endif %} !important;">
                                        <div class="card-body p-3">
                                            <!-- Header de la card -->
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div>
                                                    {% if visita.visit_type == 'home' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-home"></i> Home</span>
                                                    {% elif visita.visit_type == 'store' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><i class="fas fa-store"></i> Tienda</span>
                                                    {% elif visita.visit_type == 'product_detail' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                                            <i class="fas fa-box"></i> 
                                                            {% if visita.product %}
                                                                {{ visita.product.name|truncatewords:3 }}
                                                            {% elif visita.product_id %}
                                                                Producto #{{ visita.product_id }}
                                                            {% else %}
                                                                Producto
                                                            {% endif %}
                                                        </span>
                                                    {% elif visita.visit_type == 'cart' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="fas fa-shopping-basket"></i> Carrito</span>
                                                    {% elif visita.visit_type == 'checkout' %}
                                                        <span class="badge rounded-pill" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);"><i class="fas fa-shopping-cart"></i> Checkout</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary rounded-pill">-</span>
                                                    {% endif %}
                                                </div>
                                                <div class="text-end">
                                                    <div class="fw-bold">{{ visita.timestamp|date:"H:i" }}</div>
                                                    <small class="text-muted">{{ visita.timestamp|date:"d/m/Y" }}</small>
                                                </div>
                                            </div>
                                            
                                            <!-- Usuario -->
                                            <div class="mb-2">
                                                {% if visita.user %}
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                                            {{ visita.user.name|default:visita.user.email|first|upper }}
                                                        </div>
                                                        <div>
                                                            <div class="fw-semibold">{{ visita.user.name|default:visita.user.email|truncatewords:2 }}</div>
                                                            <small class="text-muted">âœ… Autenticado</small>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar me-2" style="width: 40px; height: 40px; border-radius: 50%; background: #6c757d; display: flex; align-items: center; justify-content: center; color: white;">
                                                            <i class="fas fa-user-secret"></i>
                                                        </div>
                                                        <div>
                                                            <div class="text-secondary">AnÃ³nimo</div>
                                                            <small class="text-muted">ðŸ”’ No identificado</small>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Footer con ubicaciÃ³n e IP -->
                                            <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                                                <div>
                                                    {% if visita.city or visita.country %}
                                                        <small class="text-muted">
                                                            <i class="fas fa-map-marker-alt text-danger"></i> 
                                                            {{ visita.city|default:'Desconocida' }}{% if visita.country %}, {{ visita.country }}{% endif %}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">
                                                            <i class="fas fa-question-circle"></i> No disponible
                                                        </small>
                                                    {% endif %}
                                                </div>
                                                <code class="small bg-light px-2 py-1 rounded">{{ visita.ip_address|default:'-' }}</code>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-eye-slash fa-3x mb-3 d-block"></i>
                                        <p class="mb-0">No hay visitas con los filtros seleccionados</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SecciÃ³n Productos MÃ¡s Visitados responsive -->
            <section class="mb-4">
                <div class="card modern-card">
                    <div class="card-header modern-header">
                        <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-3">
                            <div>
                                <i class="fas fa-fire me-2 text-danger"></i>
                                <strong>Productos MÃ¡s Visitados</strong>
                                {% if productos_visitados_page %}
                                <span class="badge bg-info ms-2">{{ productos_visitados_page.paginator.count }} productos</span>
                                {% endif %}
                            </div>
                            <div class="d-flex gap-2 align-items-center w-100 w-sm-auto">
                                <select class="form-select form-select-sm flex-fill flex-sm-grow-0" id="periodo-productos" style="min-width: 120px;">
                                    <option value="all" {% if request.GET.periodo_productos == 'all' or not request.GET.periodo_productos %}selected{% endif %}>Todo</option>
                                    <option value="today" {% if request.GET.periodo_productos == 'today' %}selected{% endif %}>Hoy</option>
                                    <option value="week" {% if request.GET.periodo_productos == 'week' %}selected{% endif %}>Semana</option>
                                    <option value="month" {% if request.GET.periodo_productos == 'month' %}selected{% endif %}>Mes</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-success" id="refresh-productos" title="Refrescar productos">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if productos_visitados_page %}
                        <!-- InformaciÃ³n de paginaciÃ³n -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <small class="text-muted">
                                Mostrando {{ productos_visitados_page.start_index }} - {{ productos_visitados_page.end_index }} 
                                de {{ productos_visitados_page.paginator.count }} productos
                            </small>
                            <small class="text-muted">
                                PÃ¡gina {{ productos_visitados_page.number }} de {{ productos_visitados_page.paginator.num_pages }}
                            </small>
                        </div>
                        
                        <div class="row g-3" id="productos-visitados-container">
                            {% for item in productos_visitados_page %}
                            <div class="col-12 col-sm-6 col-lg-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                {% if item.product.imagen %}
                                                    <img src="{{ item.product.imagen.url }}" alt="{{ item.product.name }}" 
                                                         class="rounded" width="60" height="60" style="object-fit: cover;">
                                                {% else %}
                                                    <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                                        <i class="fas fa-image text-muted"></i>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-1">{{ item.product.name|truncatewords:5 }}</h6>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-eye"></i> {{ item.total_visitas }} visita{{ item.total_visitas|pluralize }}
                                                    </span>
                                                    <span class="text-muted small">
                                                        ${{ item.product.price|floatformat:0 }}
                                                    </span>
                                                </div>
                                                <div class="mt-1">
                                                    <span class="badge bg-secondary small">Stock: {{ item.product.stock }}</span>
                                                    {% if item.product.category %}
                                                        <span class="badge bg-info small">{{ item.product.category.nombre }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No hay datos de productos visitados en este perÃ­odo
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- PaginaciÃ³n de productos visitados -->
                        {% if productos_visitados_page.paginator.num_pages > 1 %}
                        <nav aria-label="PaginaciÃ³n de productos visitados" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <!-- Primera pÃ¡gina -->
                                {% if productos_visitados_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?view=visitas&productos_page=1{% if request.GET.visitas_filter %}&visitas_filter={{ request.GET.visitas_filter }}{% endif %}{% if request.GET.visitas_user %}&visitas_user={{ request.GET.visitas_user }}{% endif %}{% if request.GET.visitas_type %}&visitas_type={{ request.GET.visitas_type }}{% endif %}{% if request.GET.periodo_productos %}&periodo_productos={{ request.GET.periodo_productos }}{% endif %}">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?view=visitas&productos_page={{ productos_visitados_page.previous_page_number }}{% if request.GET.visitas_filter %}&visitas_filter={{ request.GET.visitas_filter }}{% endif %}{% if request.GET.visitas_user %}&visitas_user={{ request.GET.visitas_user }}{% endif %}{% if request.GET.visitas_type %}&visitas_type={{ request.GET.visitas_type }}{% endif %}{% if request.GET.periodo_productos %}&periodo_productos={{ request.GET.periodo_productos }}{% endif %}">
                                        <i class="fas fa-angle-left"></i> Anterior
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-left"></i> Anterior</span>
                                </li>
                                {% endif %}

                                <!-- PÃ¡ginas numeradas -->
                                {% for num in productos_visitados_page.paginator.page_range %}
                                    {% if productos_visitados_page.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                    {% elif num > productos_visitados_page.number|add:'-3' and num < productos_visitados_page.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?view=visitas&productos_page={{ num }}{% if request.GET.visitas_filter %}&visitas_filter={{ request.GET.visitas_filter }}{% endif %}{% if request.GET.visitas_user %}&visitas_user={{ request.GET.visitas_user }}{% endif %}{% if request.GET.visitas_type %}&visitas_type={{ request.GET.visitas_type }}{% endif %}{% if request.GET.periodo_productos %}&periodo_productos={{ request.GET.periodo_productos }}{% endif %}">{{ num }}</a>
                                    </li>
                                    {% endif %}
                                {% endfor %}

                                <!-- Ãšltima pÃ¡gina -->
                                {% if productos_visitados_page.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?view=visitas&productos_page={{ productos_visitados_page.next_page_number }}{% if request.GET.visitas_filter %}&visitas_filter={{ request.GET.visitas_filter }}{% endif %}{% if request.GET.visitas_user %}&visitas_user={{ request.GET.visitas_user }}{% endif %}{% if request.GET.visitas_type %}&visitas_type={{ request.GET.visitas_type }}{% endif %}{% if request.GET.periodo_productos %}&periodo_productos={{ request.GET.periodo_productos }}{% endif %}">
                                        Siguiente <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?view=visitas&productos_page={{ productos_visitados_page.paginator.num_pages }}{% if request.GET.visitas_filter %}&visitas_filter={{ request.GET.visitas_filter }}{% endif %}{% if request.GET.visitas_user %}&visitas_user={{ request.GET.visitas_user }}{% endif %}{% if request.GET.visitas_type %}&visitas_type={{ request.GET.visitas_type }}{% endif %}{% if request.GET.periodo_productos %}&periodo_productos={{ request.GET.periodo_productos }}{% endif %}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Siguiente <i class="fas fa-angle-right"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No hay datos de productos visitados
                        </div>
                        {% endif %}
                    </div>
                </div>
            </section>
            {% endif %}
           






            {% if request.GET.view == "mi_perfil" %}
                <div class="mi-perfil-dashboard">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-user-circle me-2"></i>Mi Perfil</h2>
                    </div>

                    <div class="row">
                        <!-- Tarjeta de informaciÃ³n del perfil -->
                        <div class="col-md-4 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-body text-center">
                                    <div class="mb-3">
                                        <i class="fas fa-user-circle fa-5x text-primary"></i>
                                    </div>
                                    <h4 class="mb-1">{{ superuser_username }}</h4>
                                    <p class="text-muted mb-2">{{ superuser_email }}</p>
                                    {% if is_superuser %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-crown me-1"></i>Superusuario
                                        </span>
                                    {% elif is_staff %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-user-shield me-1"></i>STAFF
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Formulario de ediciÃ³n de perfil -->
                        <div class="col-md-8 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Editar Perfil</h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="?view=mi_perfil">
                                        {% csrf_token %}
                                        
                                        <div class="mb-3">
                                            <label for="username" class="form-label">Nombre de Usuario</label>
                                            <input type="text" class="form-control" id="username" name="username" 
                                                   value="{{ superuser_username }}" required>
                                        </div>

                                        <div class="mb-3">
                                            <label for="email" class="form-label">Correo ElectrÃ³nico</label>
                                            <input type="email" class="form-control" id="email" name="email" 
                                                   value="{{ superuser_email }}" required>
                                        </div>

                                        <hr class="my-4">
                                        
                                        <h6 class="mb-3">Cambiar ContraseÃ±a (Opcional)</h6>
                                        
                                        <div class="mb-3">
                                            <label for="current_password" class="form-label">ContraseÃ±a Actual</label>
                                            <input type="password" class="form-control" id="current_password" name="current_password" 
                                                   placeholder="Dejar en blanco si no desea cambiarla">
                                        </div>

                                        <div class="mb-3">
                                            <label for="new_password" class="form-label">Nueva ContraseÃ±a</label>
                                            <input type="password" class="form-control" id="new_password" name="new_password" 
                                                   placeholder="MÃ­nimo 8 caracteres">
                                        </div>

                                        <div class="mb-3">
                                            <label for="confirm_password" class="form-label">Confirmar Nueva ContraseÃ±a</label>
                                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                                                   placeholder="Repetir nueva contraseÃ±a">
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i>Guardar Cambios
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- EstadÃ­sticas rÃ¡pidas -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Resumen de Actividad</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h3 class="text-primary">{{ productos|length }}</h3>
                                        <p class="text-muted mb-0">Productos</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h3 class="text-success">{{ pedidos_totales|default:0 }}</h3>
                                        <p class="text-muted mb-0">Pedidos Totales</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h3 class="text-info">{{ usuarios|length }}</h3>
                                        <p class="text-muted mb-0">Usuarios</p>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h3 class="text-warning">{{ categorias|length }}</h3>
                                        <p class="text-muted mb-0">CategorÃ­as</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            {% elif request.GET.view == "usuarios" %}
                <div class="usuarios-dashboard">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-users me-2"></i>GestiÃ³n de Usuarios</h2>
                        <div class="d-flex gap-2">
                            <span class="badge bg-primary">Total: {{ usuarios|length }}</span>
                            <span class="badge bg-success">Simples: {{ usuarios|length|add:"-"|add:"0" }}</span>
                            <span class="badge bg-warning">Admins: {{ usuarios|length|add:"-"|add:"0" }}</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre</th>
                                            <th>Email</th>
                                            <th>TelÃ©fono</th>
                                            <th>Ciudad</th>
                                            <th>Username</th>
                                            <th>Tipo de Usuario</th>
                                            <th>Fecha de Registro</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for usuario in usuarios %}
                                        <tr>
                                            <td>{{ usuario.id }}</td>
                                            <td>
                                                <strong>{{ usuario.name|default:"Sin nombre" }}</strong>
                                            </td>
                                            <td>
                                                <a href="mailto:{{ usuario.email }}">{{ usuario.email }}</a>
                                            </td>
                                            <td>
                                                {{ usuario.phone|default:"Sin telÃ©fono" }}
                                            </td>
                                            <td>
                                                {{ usuario.city|default:"Sin ciudad" }}
                                            </td>
                                            <td>
                                                {{ usuario.username|default:"Sin username" }}
                                            </td>
                                            <td class="text-center">
                                                {% if usuario.is_admin %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-crown me-1"></i>Administrador
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-user me-1"></i>Usuario Simple
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    {{ usuario.date_joined|date:"d/m/Y H:i"|default:"Sin fecha" }}
                                                </small>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group" role="group">
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-primary edit-user-btn" 
                                                            data-user-id="{{ usuario.id }}"
                                                            data-model-type="{{ usuario.model_type }}"
                                                            title="Editar usuario">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    {% if not usuario.is_admin %}
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-danger delete-user-btn" 
                                                            data-user-id="{{ usuario.id }}"
                                                            data-model-type="{{ usuario.model_type }}"
                                                            data-user-name="{{ usuario.name }}"
                                                            title="Eliminar usuario">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% else %}
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-secondary" 
                                                            disabled
                                                            title="No se pueden eliminar administradores">
                                                        <i class="fas fa-shield-alt"></i>
                                                    </button>
                                                    {% endif %}
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-info view-user-btn" 
                                                            data-user-id="{{ usuario.id }}"
                                                            data-model-type="{{ usuario.model_type }}"
                                                            title="Ver detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="9" class="text-center">
                                                <div class="py-4">
                                                    <i class="fas fa-users text-muted fa-3x mb-3"></i>
                                                    <h5 class="text-muted">No hay usuarios registrados</h5>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal para editar usuario -->
                <div class="modal fade" id="editUserModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-edit me-2"></i>Editar Usuario
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editUserForm">
                                    <input type="hidden" id="editUserId" name="user_id">
                                    <input type="hidden" id="editUserModelType" name="model_type">
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserName" class="form-label">Nombre</label>
                                                <input type="text" class="form-control" id="editUserName" name="name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserEmail" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="editUserEmail" name="email" required>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserPhone" class="form-label">TelÃ©fono</label>
                                                <input type="text" class="form-control" id="editUserPhone" name="phone">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserUsername" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="editUserUsername" name="username">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserAddress" class="form-label">DirecciÃ³n</label>
                                                <input type="text" class="form-control" id="editUserAddress" name="address">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserCity" class="form-label">Ciudad</label>
                                                <input type="text" class="form-control" id="editUserCity" name="city">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- SecciÃ³n de Seguridad -->
                                    <hr>
                                    <h6 class="text-primary"><i class="fas fa-shield-alt me-2"></i>Seguridad y Permisos</h6>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserPassword" class="form-label">
                                                    <i class="fas fa-key me-1"></i>Nueva ContraseÃ±a
                                                </label>
                                                <input type="password" class="form-control" id="editUserPassword" name="password" 
                                                       placeholder="Dejar vacÃ­o para mantener actual">
                                                <div class="form-text">Solo completar si desea cambiar la contraseÃ±a</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="editUserConfirmPassword" class="form-label">
                                                    <i class="fas fa-key me-1"></i>Confirmar ContraseÃ±a
                                                </label>
                                                <input type="password" class="form-control" id="editUserConfirmPassword" name="confirm_password" 
                                                       placeholder="Confirmar nueva contraseÃ±a">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Permisos (solo para register_superuser) -->
                                    <div id="permissionsSection" class="permissions-section" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <label class="form-label">
                                                    <i class="fas fa-user-cog me-1"></i>Permisos de Usuario
                                                </label>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-check form-switch mb-2">
                                                    <input class="form-check-input" type="checkbox" id="editUserIsActive" name="is_active">
                                                    <label class="form-check-label" for="editUserIsActive">
                                                        <i class="fas fa-user-check me-1"></i>Usuario Activo
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check form-switch mb-2">
                                                    <input class="form-check-input" type="checkbox" id="editUserIsStaff" name="is_staff">
                                                    <label class="form-check-label" for="editUserIsStaff">
                                                        <i class="fas fa-user-tie me-1"></i>Es Staff
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check form-switch mb-2">
                                                    <input class="form-check-input" type="checkbox" id="editUserIsSuperuser" name="is_superuser">
                                                    <label class="form-check-label" for="editUserIsSuperuser">
                                                        <i class="fas fa-crown me-1"></i>Super Usuario
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Estado del Usuario Simple -->
                                    <div id="simpleUserSection" class="simple-user-section" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check form-switch mb-2">
                                                    <input class="form-check-input" type="checkbox" id="editSimpleUserIsActive" name="simple_is_active">
                                                    <label class="form-check-label" for="editSimpleUserIsActive">
                                                        <i class="fas fa-user-check me-1"></i>Usuario Activo
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="alert alert-info alert-sm">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    <small>Los usuarios simples tienen permisos limitados por defecto</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="saveUserChanges">
                                    <i class="fas fa-save me-2"></i>Guardar Cambios
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal para ver detalles del usuario -->
                <div class="modal fade" id="viewUserModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-user-circle me-2"></i>Detalles del Usuario
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="userDetailsContent">
                                <!-- El contenido se carga dinÃ¡micamente -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Script especÃ­fico para gestiÃ³n de usuarios -->
                <script>
                    // Asegurar que la gestiÃ³n de usuarios se inicialice
                    document.addEventListener('DOMContentLoaded', function() {
                        console.log('Inicializando gestiÃ³n de usuarios inline...');
                        
                        // Event listeners para botones de usuarios
                        document.addEventListener('click', function(e) {
                            if (e.target.matches('.edit-user-btn') || e.target.closest('.edit-user-btn')) {
                                e.preventDefault();
                                const btn = e.target.matches('.edit-user-btn') ? e.target : e.target.closest('.edit-user-btn');
                                const userId = btn.dataset.userId;
                                const modelType = btn.dataset.modelType;
                                
                                console.log('Edit user clicked:', { userId, modelType });
                                loadUserForEditInline(userId, modelType);
                            }
                            
                            if (e.target.matches('.view-user-btn') || e.target.closest('.view-user-btn')) {
                                e.preventDefault();
                                const btn = e.target.matches('.view-user-btn') ? e.target : e.target.closest('.view-user-btn');
                                const userId = btn.dataset.userId;
                                const modelType = btn.dataset.modelType;
                                
                                console.log('View user clicked:', { userId, modelType });
                                viewUserDetailsInline(userId, modelType);
                            }
                            
                            if (e.target.matches('.delete-user-btn') || e.target.closest('.delete-user-btn')) {
                                e.preventDefault();
                                const btn = e.target.matches('.delete-user-btn') ? e.target : e.target.closest('.delete-user-btn');
                                const userId = btn.dataset.userId;
                                const modelType = btn.dataset.modelType;
                                const userName = btn.dataset.userName;
                                
                                console.log('Delete user clicked:', { userId, modelType, userName });
                                confirmDeleteUserInline(userId, modelType, userName);
                            }
                        });
                        
                        // Listener para guardar cambios
                        const saveBtn = document.getElementById('saveUserChanges');
                        if (saveBtn) {
                            saveBtn.addEventListener('click', saveUserChangesInline);
                        }
                    });
                    
                    // FunciÃ³n para cargar usuario para ediciÃ³n
                    async function loadUserForEditInline(userId, modelType) {
                        console.log('loadUserForEditInline called with:', userId, modelType);
                        try {
                            const response = await fetch(`/dashboard/usuario/${userId}/${modelType}/detalles/`);
                            console.log('Response received:', response);
                            const data = await response.json();
                            console.log('Data parsed:', data);
                            
                            if (data.success) {
                                const user = data.user;
                                
                                // Llenar campos bÃ¡sicos
                                document.getElementById('editUserId').value = user.id;
                                document.getElementById('editUserModelType').value = user.model_type;
                                document.getElementById('editUserName').value = user.name || '';
                                document.getElementById('editUserEmail').value = user.email || '';
                                document.getElementById('editUserPhone').value = user.phone || '';
                                document.getElementById('editUserAddress').value = user.address || '';
                                document.getElementById('editUserCity').value = user.city || '';
                                document.getElementById('editUserUsername').value = user.username || '';
                                
                                // Limpiar campos de contraseÃ±a
                                document.getElementById('editUserPassword').value = '';
                                document.getElementById('editUserConfirmPassword').value = '';
                                
                                // Mostrar/ocultar secciones segÃºn el tipo de usuario
                                const permissionsSection = document.getElementById('permissionsSection');
                                const simpleUserSection = document.getElementById('simpleUserSection');
                                
                                if (modelType === 'register_superuser') {
                                    // Mostrar secciÃ³n de permisos completa para administradores
                                    permissionsSection.style.display = 'block';
                                    simpleUserSection.style.display = 'none';
                                    
                                    // Llenar campos de permisos usando los nuevos datos
                                    document.getElementById('editUserIsActive').checked = user.is_active !== false;
                                    document.getElementById('editUserIsStaff').checked = user.is_staff || false;
                                    document.getElementById('editUserIsSuperuser').checked = user.is_superuser || false;
                                } else {
                                    // Mostrar secciÃ³n simple para usuarios normales
                                    permissionsSection.style.display = 'none';
                                    simpleUserSection.style.display = 'block';
                                    
                                    // Llenar campo de estado activo para usuario simple
                                    document.getElementById('editSimpleUserIsActive').checked = user.is_active !== false;
                                }
                                
                                console.log('About to show modal...');
                                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                                modal.show();
                                console.log('Modal show() called');
                            } else {
                                console.error('API error:', data.error);
                                alert('Error al cargar usuario: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error de conexiÃ³n');
                        }
                    }
                    
                    // FunciÃ³n para ver detalles
                    async function viewUserDetailsInline(userId, modelType) {
                        try {
                            const response = await fetch(`/dashboard/usuario/${userId}/${modelType}/detalles/`);
                            const data = await response.json();
                            
                            if (data.success) {
                                const user = data.user;
                                
                                const detailsContent = `
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-user me-2"></i>InformaciÃ³n Personal</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>ID:</strong></td><td>${user.id}</td></tr>
                                                <tr><td><strong>Nombre:</strong></td><td>${user.name || 'Sin nombre'}</td></tr>
                                                <tr><td><strong>Email:</strong></td><td>${user.email}</td></tr>
                                                <tr><td><strong>TelÃ©fono:</strong></td><td>${user.phone || 'Sin telÃ©fono'}</td></tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-info-circle me-2"></i>InformaciÃ³n Adicional</h6>
                                            <table class="table table-sm">
                                                <tr><td><strong>Username:</strong></td><td>${user.username || 'Sin username'}</td></tr>
                                                <tr><td><strong>Ciudad:</strong></td><td>${user.city || 'Sin ciudad'}</td></tr>
                                                <tr><td><strong>DirecciÃ³n:</strong></td><td>${user.address || 'Sin direcciÃ³n'}</td></tr>
                                                <tr><td><strong>Fecha:</strong></td><td>${user.date_joined || 'Sin fecha'}</td></tr>
                                            </table>
                                        </div>
                                    </div>
                                `;
                                
                                document.getElementById('userDetailsContent').innerHTML = detailsContent;
                                const modal = new bootstrap.Modal(document.getElementById('viewUserModal'));
                                modal.show();
                            } else {
                                alert('Error al cargar detalles: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error de conexiÃ³n');
                        }
                    }
                    
                    // FunciÃ³n para confirmar eliminaciÃ³n
                    function confirmDeleteUserInline(userId, modelType, userName) {
                        if (modelType === 'register_superuser') {
                            alert('No se pueden eliminar usuarios administradores por seguridad.');
                            return;
                        }
                        
                        if (confirm(`Â¿EstÃ¡s seguro de que quieres eliminar el usuario "${userName}"?`)) {
                            deleteUserInline(userId, modelType);
                        }
                    }
                    
                    // FunciÃ³n para eliminar usuario
                    async function deleteUserInline(userId, modelType) {
                        try {
                            const response = await fetch('/dashboard/usuario/eliminar/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify({
                                    user_id: userId,
                                    model_type: modelType
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                alert(data.message);
                                location.reload();
                            } else {
                                alert('Error: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error de conexiÃ³n');
                        }
                    }
                    
                    // FunciÃ³n para guardar cambios
                    async function saveUserChangesInline() {
                        const form = document.getElementById('editUserForm');
                        const formData = new FormData(form);
                        
                        // Validar contraseÃ±as
                        const password = document.getElementById('editUserPassword').value;
                        const confirmPassword = document.getElementById('editUserConfirmPassword').value;
                        
                        if (password && password !== confirmPassword) {
                            alert('Las contraseÃ±as no coinciden');
                            return;
                        }
                        
                        if (password && password.length < 6) {
                            alert('La contraseÃ±a debe tener al menos 6 caracteres');
                            return;
                        }
                        
                        const modelType = formData.get('model_type');
                        
                        const userData = {
                            user_id: formData.get('user_id'),
                            model_type: modelType,
                            name: formData.get('name'),
                            email: formData.get('email'),
                            phone: formData.get('phone'),
                            address: formData.get('address'),
                            city: formData.get('city'),
                            username: formData.get('username')
                        };
                        
                        // Agregar contraseÃ±a si se proporcionÃ³
                        if (password) {
                            userData.password = password;
                        }
                        
                        // Agregar permisos segÃºn el tipo de usuario
                        if (modelType === 'register_superuser') {
                            userData.is_active = document.getElementById('editUserIsActive').checked;
                            userData.is_staff = document.getElementById('editUserIsStaff').checked;
                            userData.is_superuser = document.getElementById('editUserIsSuperuser').checked;
                        } else {
                            userData.is_active = document.getElementById('editSimpleUserIsActive').checked;
                        }
                        
                        try {
                            const response = await fetch('/dashboard/usuario/editar/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify(userData)
                            });
                            
                            const data = await response.json();
                            
                            if (data.success) {
                                alert(data.message);
                                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                                location.reload();
                            } else {
                                alert('Error: ' + data.error);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Error de conexiÃ³n');
                        }
                    }
                    
                    // FunciÃ³n para obtener cookie CSRF
                    function getCookie(name) {
                        const match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
                        return match ? match.pop() : '';
                    }
                </script>

            {% elif request.GET.view == "productos" %}
                <div class="productos-dashboard animate-in">
                    <!-- Header con estadÃ­sticas rÃ¡pidas -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h2 class="mb-1"><i class="fas fa-boxes me-2 text-primary"></i>GestiÃ³n de Inventario</h2>
                                    <p class="text-muted mb-0">Administra tu inventario completo por categorÃ­as</p>
                                </div>
                                <a href="?view=productos&crear=1" class="btn btn-primary btn-lg shadow-sm">
                                    <i class="fas fa-plus me-2"></i>Crear Producto
                                </a>
                            </div>
                            
                            <!-- Mini estadÃ­sticas del inventario -->
                            <div class="row g-3">
                                <div class="col-md-3 col-sm-6">
                                    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <div class="card-body text-white">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <p class="mb-1 opacity-75 small">Total Productos</p>
                                                    <h3 class="mb-0 fw-bold">{{ productos_page.paginator.count }}</h3>
                                                </div>
                                                <div class="opacity-50">
                                                    <i class="fas fa-box fa-2x"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6">
                                    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                        <div class="card-body text-white">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <p class="mb-1 opacity-75 small">CategorÃ­as</p>
                                                    <h3 class="mb-0 fw-bold">{{ categorias|length }}</h3>
                                                </div>
                                                <div class="opacity-50">
                                                    <i class="fas fa-folder fa-2x"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6">
                                    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                        <div class="card-body text-white">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <p class="mb-1 opacity-75 small">ðŸ’° Valor Total</p>
                                                    <h3 class="mb-0 fw-bold" style="font-family: 'Courier New', monospace;">${{ total_valor_inventario|floatformat:0|intcomma }}</h3>
                                                </div>
                                                <div class="opacity-50">
                                                    <i class="fas fa-dollar-sign fa-2x"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6">
                                    <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                        <div class="card-body text-white">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <p class="mb-1 opacity-75 small">ðŸ“¦ Stock Total</p>
                                                    <h3 class="mb-0 fw-bold" style="font-family: 'Courier New', monospace;">{{ total_stock_inventario|intcomma }}</h3>
                                                </div>
                                                <div class="opacity-50">
                                                    <i class="fas fa-warehouse fa-2x"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros Simplificados -->
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body p-3">
                            <form method="GET" class="row g-3 align-items-end">
                                <input type="hidden" name="view" value="productos">
                                
                                <div class="col-md-4">
                                    <label for="categoria_filter" class="form-label fw-semibold mb-1">
                                        <i class="fas fa-folder me-1 text-primary"></i> CategorÃ­a
                                    </label>
                                    <select name="categoria_filter" id="categoria_filter" class="form-select">
                                        <option value="">Todas las categorÃ­as</option>
                                        {% for categoria in categorias %}
                                            <option value="{{ categoria.id }}" {% if categoria_filter == categoria.id|stringformat:"s" %}selected{% endif %}>
                                                {{ categoria.nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="col-md-5">
                                    <label for="search" class="form-label fw-semibold mb-1">
                                        <i class="fas fa-search me-1 text-primary"></i> Buscar producto
                                    </label>
                                    <input type="text" name="search" id="search" class="form-control" 
                                           value="{{ search_query }}" placeholder="Nombre o descripciÃ³n...">
                                </div>
                                
                                <div class="col-md-3">
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary flex-fill">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        <a href="?view=productos" class="btn btn-outline-secondary">
                                            <i class="fas fa-redo"></i>
                                        </a>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- InformaciÃ³n de resultados modernos -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
                        <div class="results-info">
                            <span class="badge bg-primary badge-modern me-2">
                                <i class="fas fa-box me-1"></i> Total: {{ productos_page.paginator.count }}
                            </span>
                            {% if categoria_filter %}
                                <span class="badge bg-success badge-modern me-2">
                                    <i class="fas fa-filter me-1"></i> Filtrado por categorÃ­a
                                </span>
                            {% endif %}
                            {% if search_query %}
                                <span class="badge bg-warning badge-modern text-dark me-2">
                                    <i class="fas fa-search me-1"></i> "{{ search_query }}"
                                </span>
                            {% endif %}
                        </div>
                        
                        <div class="pagination-info">
                            <small class="text-muted">
                                <i class="fas fa-file-alt me-1"></i>
                                PÃ¡gina {{ productos_page.number }} de {{ productos_page.paginator.num_pages }}
                            </small>
                        </div>
                    </div>

                    <!-- Vista Desktop - Tabla de productos -->
                    <div class="card d-none d-lg-block shadow-sm border-0">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                        <tr>
                                            <th scope="col" style="width: 80px;">Imagen</th>
                                            <th scope="col">Nombre</th>
                                            <th scope="col">CategorÃ­a</th>
                                            <th scope="col">Stock</th>
                                            <th scope="col">Precio Compra</th>
                                            <th scope="col">Precio Venta</th>
                                            <th scope="col">Proveedor</th>
                                            <th scope="col" style="width: 180px;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for producto in productos_page %}
                                        <tr data-producto-id="{{ producto.id }}">
                                            <td class="text-center">
                                                {% if producto.imagen %}
                                                    <img src="{{ producto.imagen.url }}" alt="{{ producto.name }}" 
                                                         class="product-thumbnail rounded" width="50" height="50" 
                                                         style="object-fit: cover;"/>
                                                {% else %}
                                                    <div class="no-image-placeholder d-flex align-items-center justify-content-center" 
                                                         style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 4px;">
                                                        <i class="fas fa-image text-muted"></i>
                                                    </div>
                                                {% endif %} 
                                            </td>
                                            <td class="align-middle">
                                                <strong>{{ producto.name }}</strong>
                                                {% if producto.description %}
                                                    <br><small class="text-muted">{{ producto.description|truncatechars:50 }}</small>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                {% if producto.category %}
                                                    <span class="badge bg-primary">{{ producto.category.nombre }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Sin categorÃ­a</span>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                {% if producto.stock > 10 %}
                                                    <span class="badge bg-success">{{ producto.stock }}</span>
                                                {% elif producto.stock > 0 %}
                                                    <span class="badge bg-warning text-dark">{{ producto.stock }}</span>
                                                {% else %}
                                                    <span class="badge bg-danger">{{ producto.stock }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                <span class="text-muted fw-semibold" style="font-family: 'Courier New', monospace; font-size: 0.95rem;">
                                                    ${{ producto.price_buy|floatformat:0|intcomma }}
                                                </span>
                                            </td>
                                            <td class="align-middle">
                                                <strong class="text-success fw-bold" style="font-family: 'Courier New', monospace; font-size: 1.05rem;">
                                                    ${{ producto.price|floatformat:0|intcomma }}
                                                </strong>
                                            </td>
                                            <td class="align-middle">
                                                {% if producto.proveedor %}
                                                    <small>{{ producto.proveedor.nombre }}</small>
                                                {% else %}
                                                    <small class="text-muted">Sin proveedor</small>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="?view=productos&editar={{ producto.id }}" 
                                                       class="btn btn-outline-primary btn-sm" title="Editar">
                                                        <i class="fas fa-edit"></i> Editar
                                                    </a>
                                                    <button type="button" 
                                                            class="btn btn-outline-danger btn-sm delete-product-btn" 
                                                            data-product-id="{{ producto.id }}" title="Eliminar">
                                                        <i class="fas fa-trash"></i> Eliminar
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center py-4">
                                                <div class="no-products">
                                                    <i class="fas fa-box-open text-muted" style="font-size: 3rem;"></i>
                                                    <h5 class="mt-3 text-muted">No hay productos</h5>
                                                    <p class="text-muted">
                                                        {% if categoria_filter or search_query %}
                                                            No se encontraron productos con los filtros aplicados.
                                                        {% else %}
                                                            AÃºn no has agregado productos a tu inventario.
                                                        {% endif %}
                                                    </p>
                                                    {% if not categoria_filter and not search_query %}
                                                        <a href="?view=productos&crear=1" class="btn btn-primary">
                                                            <i class="fas fa-plus me-2"></i>Crear primer producto
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Vista MÃ³vil - Tarjetas de productos -->
                    <div class="d-lg-none">
                        {% for producto in productos_page %}
                        <div class="card producto-card-mobile mb-3" data-producto-id="{{ producto.id }}">
                            <div class="card-body">
                                <!-- Header con imagen y nombre -->
                                <div class="row g-3">
                                    <div class="col-4">
                                        {% if producto.imagen %}
                                            <img src="{{ producto.imagen.url }}" alt="{{ producto.name }}" 
                                                 class="img-fluid rounded" style="width: 100%; aspect-ratio: 1; object-fit: cover;"/>
                                        {% else %}
                                            <div class="no-image-placeholder d-flex align-items-center justify-content-center rounded" 
                                                 style="width: 100%; aspect-ratio: 1; background: #f0f0f0;">
                                                <i class="fas fa-image fa-2x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-8">
                                        <h6 class="mb-2">{{ producto.name }}</h6>
                                        {% if producto.category %}
                                            <span class="badge bg-primary mb-2">{{ producto.category.nombre }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary mb-2">Sin categorÃ­a</span>
                                        {% endif %}
                                        <br>
                                        {% if producto.stock > 10 %}
                                            <span class="badge bg-success">Stock: {{ producto.stock }}</span>
                                        {% elif producto.stock > 0 %}
                                            <span class="badge bg-warning text-dark">Stock: {{ producto.stock }}</span>
                                        {% else %}
                                            <span class="badge bg-danger">Sin stock</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- DescripciÃ³n -->
                                {% if producto.description %}
                                <div class="mt-3">
                                    <small class="text-muted">{{ producto.description|truncatechars:80 }}</small>
                                </div>
                                {% endif %}

                                <!-- InformaciÃ³n de precios y proveedor -->
                                <div class="row g-2 mt-3">
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded">
                                            <small class="text-muted d-block">ðŸ’µ Compra</small>
                                            <strong style="font-family: 'Courier New', monospace;">${{ producto.price_buy|floatformat:0|intcomma }}</strong>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-success bg-opacity-10 rounded">
                                            <small class="text-muted d-block">ðŸ’° Venta</small>
                                            <strong class="text-success" style="font-family: 'Courier New', monospace; font-size: 1.1rem;">${{ producto.price|floatformat:0|intcomma }}</strong>
                                        </div>
                                    </div>
                                    {% if producto.proveedor %}
                                    <div class="col-12">
                                        <div class="p-2 bg-light rounded">
                                            <small class="text-muted d-block">
                                                <i class="fas fa-truck me-1"></i>Proveedor
                                            </small>
                                            <small>{{ producto.proveedor.nombre }}</small>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Botones de acciÃ³n -->
                                <div class="row g-2 mt-3">
                                    <div class="col-6">
                                        <a href="?view=productos&editar={{ producto.id }}" 
                                           class="btn btn-outline-primary btn-sm w-100">
                                            <i class="fas fa-edit"></i> Editar
                                        </a>
                                    </div>
                                    <div class="col-6">
                                        <button type="button" 
                                                class="btn btn-outline-danger btn-sm w-100 delete-product-btn" 
                                                data-product-id="{{ producto.id }}">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="card">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-box-open text-muted" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-muted">No hay productos</h5>
                                <p class="text-muted">
                                    {% if categoria_filter or search_query %}
                                        No se encontraron productos con los filtros aplicados.
                                    {% else %}
                                        AÃºn no has agregado productos a tu inventario.
                                    {% endif %}
                                </p>
                                {% if not categoria_filter and not search_query %}
                                    <a href="?view=productos&crear=1" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>Crear primer producto
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- PaginaciÃ³n -->
                    {% if productos_page.paginator.num_pages > 1 %}
                    <nav aria-label="PaginaciÃ³n de productos" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <!-- Primera pÃ¡gina -->
                            {% if productos_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page=1">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <!-- PÃ¡gina anterior -->
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ productos_page.previous_page_number }}">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-left"></i></span>
                                </li>
                            {% endif %}

                            <!-- PÃ¡ginas numeradas -->
                            {% for num in productos_page.paginator.page_range %}
                                {% if num == productos_page.number %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > productos_page.number|add:'-3' and num < productos_page.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ num }}">
                                            {{ num }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            <!-- PÃ¡gina siguiente -->
                            {% if productos_page.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ productos_page.next_page_number }}">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <!-- Ãšltima pÃ¡gina -->
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ productos_page.paginator.num_pages }}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-right"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                                </li>
                            {% endif %}
                            <!-- Link Visitas en el sidebar principal -->
                            <li class="nav-item">
                                <a href="?view=visitas" class="nav-link {% if request.GET.view == 'visitas' %}active{% endif %}" title="Visitas a la tienda">
                                    <i class="fas fa-eye nav-icon"></i>
                                    <span class="sidebar-text">Visitas</span>
                                </a>
                            </li>
                        </ul>
                    </nav>

                    <!-- InformaciÃ³n de la paginaciÃ³n -->
                    <div class="text-center text-muted">
                        <small>
                            Mostrando 
                            <strong>{{ productos_page.start_index }}</strong> - <strong>{{ productos_page.end_index }}</strong> 
                            de <strong>{{ productos_page.paginator.count }}</strong> productos
                        </small>
                    </div>
                    {% endif %}
                </div>
                </table>
               
            <!-- ...existing code... -->
            {% if show_create_product_form or show_edit_product_form %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 class="mb-0" id="form-title">
                        <i class="fas {% if producto_to_edit %}fa-edit{% else %}fa-plus{% endif %} me-2"></i>
                        {% if producto_to_edit %}Editar Producto{% else %}Crear Producto{% endif %}
                    </h3>
                </div>
                <div class="card-body p-4">
               <form id="form-crear-producto" method="post" enctype="multipart/form-data" class="form-crear-producto" action="?view=productos{% if producto_to_edit %}&editar={{ producto_to_edit.id }}{% else %}&crear=1{% endif %}{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if request.GET.page %}&page={{ request.GET.page }}{% endif %}" data-create-action="?view=productos&crear=1">
               {% csrf_token %}
              <input type="hidden" name="product_id" id="producto_id" value="{% if producto_to_edit %}{{ producto_to_edit.id }}{% endif %}" />
              <input type="hidden" name="categoria_filter" value="{{ categoria_filter }}" />
              <input type="hidden" name="search_query" value="{{ search_query }}" />
              <input type="hidden" name="page" value="{{ request.GET.page }}" />

             <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold"><i class="fas fa-tag me-1 text-primary"></i>Nombre del Producto *</label>
                    <input type="text" name="name" id="producto_name" value="{% if producto_to_edit %}{{ producto_to_edit.name }}{% endif %}" class="form-control" required />
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold"><i class="fas fa-folder me-1 text-primary"></i>CategorÃ­a *</label>
                    <select name="categoria" id="producto_categoria" class="form-select" required>
                        <option value="">Seleccione una categorÃ­a</option>
                        {% for categoria in categorias %}
                            <option value="{{ categoria.id }}" {% if producto_to_edit and producto_to_edit.category.id == categoria.id %}selected{% endif %}>{{ categoria.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
             </div>

             <div class="mt-3">
                <label class="form-label fw-semibold"><i class="fas fa-align-left me-1 text-primary"></i>DescripciÃ³n</label>
                <textarea name="description" id="producto_description" class="form-control" rows="3">{% if producto_to_edit %}{{ producto_to_edit.description }}{% endif %}</textarea>
             </div>
 
             <div class="row g-3 mt-2">
              <div class="col-md-4">
                <label class="form-label fw-semibold"><i class="fas fa-shopping-cart me-1 text-success"></i>Precio de Compra *</label>
                <input type="number" name="price_buy" id="producto_price_buy" step="0.01" value="{% if producto_to_edit %}{{ producto_to_edit.price_buy }}{% endif %}" class="form-control" placeholder="$0.00" required />
             </div>
            <div class="col-md-4">
                <label class="form-label fw-semibold"><i class="fas fa-dollar-sign me-1 text-success"></i>Precio de Venta *</label>
                <input type="number" name="price" id="producto_price" step="0.01" value="{% if producto_to_edit %}{{ producto_to_edit.price }}{% endif %}" class="form-control" placeholder="$0.00" required />
            </div>
            <div class="col-md-4">
                <label class="form-label fw-semibold"><i class="fas fa-box me-1 text-primary"></i>Stock *</label>
                <input type="number" name="stock" id="producto_stock" value="{% if producto_to_edit %}{{ producto_to_edit.stock }}{% endif %}" class="form-control" placeholder="0" required />
            </div>
            </div>
            
            <div class="row g-3 mt-2">
            <div class="col-md-4">
                <label class="form-label fw-semibold"><i class="fas fa-percent me-1 text-warning"></i>Descuento %</label>
                <input type="number" name="descuento" id="producto_descuento" step="0.01" value="{% if producto_to_edit %}{{ producto_to_edit.descuento|default:0 }}{% endif %}" class="form-control" placeholder="0" />
            </div>
            <div class="col-md-4">
                <label class="form-label fw-semibold"><i class="fas fa-receipt me-1 text-info"></i>IVA %</label>
                <input type="number" name="iva" id="producto_iva" step="0.01" value="{% if producto_to_edit %}{{ producto_to_edit.iva|default:0 }}{% endif %}" class="form-control" placeholder="0" />
            </div>
            <div class="col-md-4">
                <label class="form-label fw-semibold"><i class="fas fa-layer-group me-1 text-secondary"></i>Tipo de Producto</label>
                <select name="type" id="producto_type" class="form-select">
                    <option value="">Seleccione un tipo</option>
                    {% for tipo in tipos %}
                        <option value="{{ tipo.id }}" {% if producto_to_edit and producto_to_edit.type.id == tipo.id %}selected{% endif %}>{{ tipo.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="row g-3 mt-2">
            <div class="col-md-6">
                <label class="form-label fw-semibold"><i class="fas fa-truck me-1 text-info"></i>Proveedor</label>
                <select name="proveedor" id="producto_proveedor" class="form-select">
                    <option value="">Seleccione un proveedor</option>
                    {% for prov in proveedores %}
                        <option value="{{ prov.id }}" {% if producto_to_edit and producto_to_edit.proveedor.id == prov.id %}selected{% endif %}>{{ prov.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="mt-4">
            <label class="form-label fw-semibold"><i class="fas fa-image me-1 text-primary"></i>Imagen Principal</label>
            <input type="file" name="images" id="producto_images" class="form-control" accept="image/*" />
            <div id="preview-main" class="mt-2">
                {% if producto_to_edit and producto_to_edit.imagen %}
                    <div class="position-relative d-inline-block">
                        <img src="{{ producto_to_edit.imagen.url }}" alt="{{ producto_to_edit.name }}" class="img-thumbnail" style="max-width:200px;" />
                        <span class="badge bg-success position-absolute top-0 end-0 m-1"><i class="fas fa-check"></i> Actual</span>
                    </div>
                {% endif %}
                <img id="preview-main-img" src="" alt="Nueva imagen" class="img-thumbnail" style="max-width:200px; display:none; margin-top:8px;" />
            </div>
        </div>

        <div class="mt-4">
            <label class="form-label fw-semibold"><i class="fas fa-images me-1 text-primary"></i>GalerÃ­a de ImÃ¡genes</label>
            <small class="text-muted d-block mb-2">{% if producto_to_edit %}AÃ±ade mÃ¡s imÃ¡genes o elimina las existentes{% else %}Selecciona mÃºltiples imÃ¡genes{% endif %}</small>
            <input type="file" name="galeria" id="producto_galeria" multiple accept="image/*" class="form-control" />
<div id="preview-gallery" style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;">
  {# imÃ¡genes existentes (solo si existe producto_to_edit) #}
  {% if producto_to_edit %}
    {% for img in producto_to_edit.galeria.all %}
      <div class="gallery-item position-relative" data-gallery-id="{{ img.id }}" style="position:relative; border:2px solid #28a745; border-radius:8px; padding:4px; background:#f8f9fa;">
        {% if img.galeria and img.galeria.name %}
          <img src="{{ img.galeria.url }}" style="max-width:120px; max-height:120px; object-fit:cover; border-radius:6px; display:block;" />
        {% elif img.imagen and img.imagen.name %}
          <img src="{{ img.imagen.url }}" style="max-width:120px; max-height:120px; object-fit:cover; border-radius:6px; display:block;" />
        {% elif img.image and img.image.name %}
          <img src="{{ img.image.url }}" style="max-width:120px; max-height:120px; object-fit:cover; border-radius:6px; display:block;" />
        {% endif %}
        <button type="button" class="btn btn-sm btn-danger gallery-remove-btn" data-gallery-id="{{ img.id }}" title="Eliminar imagen" style="position:absolute; top:0px; right:0px; width:24px; height:24px; padding:0; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; line-height:1;">Ã—</button>
        <input type="hidden" class="gallery-keep" name="galeria_keep[]" value="{{ img.id }}">
      </div>
    {% endfor %}
  {% endif %}
  {# previews de archivos nuevos serÃ¡n aÃ±adidos por JS aquÃ­ #}
</div>

<!-- Variantes -->
<label>Variantes:</label>
<small class="text-muted d-block mb-2">{% if producto_to_edit %}Modifica, elimina o agrega nuevas variantes{% else %}Agrega variantes del producto (colores, tallas, etc.){% endif %}</small>
<div id="variantes-container">
  {# variantes existentes (editar) #}
  {% if producto_to_edit %}
    {% for v in producto_to_edit.variants.all %}
      <div class="variante-row-mobile mb-3 p-3 border rounded position-relative" data-variant-id="{{ v.id }}" style="background:#f8f9fa;">
        <button type="button" class="btn btn-sm btn-danger variant-remove-btn" data-variant-id="{{ v.id }}" title="Eliminar variante" style="position:absolute; top:8px; right:8px; width:28px; height:28px; padding:0; border-radius:50%; z-index:10;">Ã—</button>
        <input type="hidden" class="variant-keep" name="variante_id[]" value="{{ v.id }}">
        
        <div class="row g-2">
          <!-- Imagen primero en mÃ³vil -->
          <div class="col-12 col-md-auto text-center mb-2">
            {% if v.imagen and v.imagen.name %}
              <img src="{{ v.imagen.url }}" class="img-thumbnail" style="max-width:100px; max-height:100px; object-fit:cover;" />
              <small class="d-block text-muted" style="font-size:10px;">Actual</small>
            {% else %}
              <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width:100px; height:100px; margin:0 auto;">
                <i class="fas fa-image text-muted"></i>
              </div>
            {% endif %}
            
            <div class="image-preview-container mt-2 mb-2" id="preview_{{ forloop.counter0 }}" style="display:none;">
              <img src="" alt="Nueva" class="img-thumbnail" style="max-width:100px; max-height:100px; object-fit:cover;" />
              <button type="button" class="btn btn-sm btn-danger ms-1" onclick="clearImagePreview({{ forloop.counter0 }})">
                <i class="fas fa-times"></i>
              </button>
              <small class="d-block text-success" style="font-size:10px;">Nueva imagen</small>
            </div>
            
            <input type="file" name="variante_imagen_{{ forloop.counter0 }}" class="form-control form-control-sm mt-2 variant-image-input" accept="image/*" data-variant-index="{{ forloop.counter0 }}" data-preview-id="preview_{{ forloop.counter0 }}" />
            <small class="text-muted" style="font-size:10px;">Cambiar imagen</small>
          </div>
          
          <!-- Campos en grid responsive -->
          <div class="col-12 col-md">
            <div class="row g-2">
              <div class="col-12 col-sm-6">
                <label class="small">Nombre</label>
                <input type="text" name="variante_nombre[]" value="{{ v.nombre }}" placeholder="Nombre" class="form-control form-control-sm" />
              </div>
              <div class="col-6 col-sm-3">
                <label class="small">Precio</label>
                <input type="number" name="variante_precio[]" value="{{ v.precio }}" placeholder="Precio" step="0.01" class="form-control form-control-sm" />
              </div>
              <div class="col-6 col-sm-3">
                <label class="small">Stock</label>
                <input type="number" name="variante_stock[]" value="{{ v.stock }}" placeholder="Stock" class="form-control form-control-sm" />
              </div>
              <div class="col-6 col-sm-6">
                <label class="small">Color</label>
                <input type="text" name="variante_color[]" value="{{ v.color|default:'' }}" placeholder="Color" class="form-control form-control-sm" />
              </div>
              <div class="col-6 col-sm-6">
                <label class="small">Talla</label>
                <input type="text" name="variante_talla[]" value="{{ v.talla|default:'' }}" placeholder="Talla" class="form-control form-control-sm" />
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    {# fila vacÃ­a por defecto para crear #}
    <div class="variante-row-mobile mb-3 p-3 border rounded position-relative" style="background:#f8f9fa;">
      <button type="button" class="btn btn-sm btn-danger variant-remove-btn-new" style="display:none; position:absolute; top:8px; right:8px; width:28px; height:28px; padding:0; border-radius:50%; z-index:10;">Ã—</button>
      <div class="row g-2">
        <div class="col-12 col-sm-6">
          <label class="small">Nombre</label>
          <input type="text" name="variante_nombre[]" placeholder="Nombre de la variante" class="form-control form-control-sm" />
        </div>
        <div class="col-6 col-sm-3">
          <label class="small">Precio</label>
          <input type="number" name="variante_precio[]" placeholder="0.00" step="0.01" class="form-control form-control-sm" />
        </div>
        <div class="col-6 col-sm-3">
          <label class="small">Stock</label>
          <input type="number" name="variante_stock[]" placeholder="0" class="form-control form-control-sm" />
        </div>
        <div class="col-6 col-sm-6">
          <label class="small">Color</label>
          <input type="text" name="variante_color[]" placeholder="Ej: Rojo" class="form-control form-control-sm" />
        </div>
        <div class="col-6 col-sm-6">
          <label class="small">Talla</label>
          <input type="text" name="variante_talla[]" placeholder="Ej: M" class="form-control form-control-sm" />
        </div>
        <div class="col-12">
          <label class="small">Imagen</label>
          <div class="image-preview-container mb-2" id="preview_0" style="display:none;">
            <img src="" alt="Preview" class="img-thumbnail" style="max-width:120px; max-height:120px; object-fit:cover;" />
            <button type="button" class="btn btn-sm btn-danger ms-2" onclick="clearImagePreview(0)">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <input type="file" name="variante_imagen_0" class="form-control form-control-sm variant-image-input" accept="image/*" data-variant-index="0" data-preview-id="preview_0" />
        </div>
      </div>
    </div>
  {% endif %}
</div>
        <button type="button" class="btn btn-secondary btn-sm mt-3 w-100 w-md-auto" onclick="agregarVariante()"><i class="fas fa-plus me-1"></i>Agregar variante</button>
        <div class="d-grid gap-2 d-md-flex mt-3">
          <button type="submit" id="form-submit-btn" class="btn btn-success"><i class="fas fa-save me-1"></i>{% if producto_to_edit %}Actualizar{% else %}Guardar{% endif %}</button>
          <button type="button" id="form-clear-btn" class="btn btn-outline-secondary"><i class="fas fa-plus me-1"></i>Nuevo Producto</button>
          {% if producto_to_edit %}
            <a href="{% url 'dashboard_home' %}?view=productos" class="btn btn-outline-danger"><i class="fas fa-times me-1"></i>Cancelar</a>
          {% endif %}
        </div>
    </form>
{% endif %}


<!-- ...existing code... -->
            {% elif request.GET.view == "pedidos" %}
                <!-- Header de Pedidos -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2><i class="fas fa-shopping-cart me-2"></i>GestiÃ³n de Pedidos</h2>
                        <p class="text-muted mb-0">Administra y da seguimiento a todos los pedidos</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                            <i class="fas fa-sync"></i> Actualizar
                        </button>
                    </div>
                </div>

                <!-- EstadÃ­sticas Diarias - TIEMPO REAL -->
                <div class="alert alert-info mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-calendar-day me-2"></i>Actividad de Hoy
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-sync-alt fa-spin"></i> Tiempo Real
                        </span>
                    </h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-primary">
                                    <i class="fas fa-shopping-cart me-2"></i>
                                    <span data-stat="pedidos-hoy">{{ estadisticas_diarias.pedidos_hoy }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Pedidos de Hoy</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-success">
                                    <i class="fas fa-dollar-sign me-2"></i>
                                    <span data-stat="ventas-hoy">${{ estadisticas_diarias.ventas_hoy|default:"0"|floatformat:0 }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Ventas de Hoy</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-info">
                                    <i class="fas fa-box-open me-2"></i>
                                    <span data-stat="productos-vendidos-hoy">{{ estadisticas_diarias.productos_vendidos_hoy }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Productos Vendidos Hoy</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h3 class="text-warning">
                                    <i class="fas fa-users me-2"></i>
                                    <span data-stat="total-usuarios">{{ usuarios|length }}</span>
                                </h3>
                                <p class="mb-0 text-muted">Total Usuarios</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EstadÃ­sticas rÃ¡pidas responsive -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center p-3">
                                <h4 class="text-primary mb-1">{{ pedidos|length }}</h4>
                                <small class="text-muted">Total Pedidos</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center p-3">
                                <h4 class="text-warning mb-1">{{ pedidos_pendientes_count|default:0 }}</h4>
                                <small class="text-muted">Pendientes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-info h-100">
                            <div class="card-body text-center p-3">
                                <h4 class="text-info mb-1">{{ pedidos_enviados_count|default:0 }}</h4>
                                <small class="text-muted">En camino</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-success h-100">
                            <div class="card-body text-center p-3">
                                <h4 class="text-success mb-1">{{ pedidos_entregados_count|default:0 }}</h4>
                                <small class="text-muted">Entregados</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros Responsive -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form method="get" class="row g-3">
                            <input type="hidden" name="view" value="pedidos">
                            <div class="col-12 col-md-6 col-lg-3">
                                <label class="form-label small fw-bold">Estado:</label>
                                <select name="estado_filter" class="form-select form-select-sm">
                                    <option value="">Todos los estados</option>
                                    <option value="pendiente" {% if request.GET.estado_filter == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                    <option value="confirmado" {% if request.GET.estado_filter == 'confirmado' %}selected{% endif %}>Confirmado</option>
                                    <option value="enviado" {% if request.GET.estado_filter == 'enviado' %}selected{% endif %}>Enviado</option>
                                    <option value="llegando" {% if request.GET.estado_filter == 'llegando' %}selected{% endif %}>En camino</option>
                                    <option value="entregado" {% if request.GET.estado_filter == 'entregado' %}selected{% endif %}>Entregado</option>
                                </select>
                            </div>
                            <div class="col-12 col-md-6 col-lg-3">
                                <label class="form-label small fw-bold">MÃ©todo de pago:</label>
                                <select name="metodo_filter" class="form-select form-select-sm">
                                    <option value="">Todos los mÃ©todos</option>
                                    <option value="contraentrega" {% if request.GET.metodo_filter == 'contraentrega' %}selected{% endif %}>Contra entrega</option>
                                    <option value="recoger_tienda" {% if request.GET.metodo_filter == 'recoger_tienda' %}selected{% endif %}>Recoger en tienda</option>
                                    <option value="tarjeta" {% if request.GET.metodo_filter == 'tarjeta' %}selected{% endif %}>Tarjeta</option>
                                </select>
                            </div>
                            <div class="col-12 col-lg-4">
                                <label class="form-label small fw-bold">Buscar:</label>
                                <input type="text" name="search" class="form-control form-control-sm" 
                                       placeholder="Buscar por nombre, email, ID..." 
                                       value="{{ request.GET.search }}"
                                       style="font-size: 16px;">
                            </div>
                            <div class="col-12 col-lg-2 d-flex align-items-end gap-2">
                                <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                                    <i class="fas fa-search"></i><span class="d-none d-sm-inline ms-1">Filtrar</span>
                                </button>
                                <a href="?view=pedidos" class="btn btn-outline-secondary btn-sm flex-grow-1">
                                    <i class="fas fa-times"></i><span class="d-none d-sm-inline ms-1">Limpiar</span>
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista/Tabla de Pedidos Responsive -->
                {% if pedidos %}
                    <!-- Vista Desktop: Tabla -->
                    <div class="d-none d-lg-block">
                        <div class="card shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-striped mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Cliente</th>
                                                <th>Contacto</th>
                                                <th>Total</th>
                                                <th>MÃ©todo Pago</th>
                                                <th>Estado</th>
                                                <th>Estado Pago</th>
                                                <th>Fecha</th>
                                                <th class="text-center">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for pedido in pedidos %}
                                            <tr>
                                                <td>
                                                    <strong class="text-primary">#{{ pedido.id }}</strong>
                                                    {% if pedido.transaction_id %}
                                                        <br><small class="text-muted">{{ pedido.transaction_id|slice:":8" }}...</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div>
                                                        <strong>{{ pedido.nombre }}</strong><br>
                                                        <small class="text-muted">{{ pedido.user.email }}</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if pedido.telefono %}
                                                        <small><i class="fas fa-phone"></i> {{ pedido.telefono }}</small><br>
                                                    {% endif %}
                                                    <small class="text-muted">
                                                        <i class="fas fa-map-marker-alt"></i> {{ pedido.ciudad }}, {{ pedido.departamento }}
                                                    </small>
                                                </td>
                                                <td>
                                                    <strong class="text-success">${{ pedido.total|floatformat:0 }}</strong>
                                                    {% if pedido.subtotal and pedido.envio %}
                                                        <br>
                                                        <small class="text-muted">
                                                            Sub: ${{ pedido.subtotal|floatformat:0 }}
                                                            {% if pedido.envio > 0 %} + EnvÃ­o: ${{ pedido.envio|floatformat:0 }}{% endif %}
                                                        </small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if pedido.metodo_pago == 'contraentrega' %}
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-money-bill"></i> Contra entrega
                                                        </span>
                                                    {% elif pedido.metodo_pago == 'recoger_tienda' %}
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-store"></i> Recoger en tienda
                                                        </span>
                                                    {% elif pedido.metodo_pago == 'wompi_tarjeta' or pedido.metodo_pago == 'wompi' %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-credit-card"></i> Wompi
                                                        </span>
                                                        {% if pedido.transaction_id %}
                                                            <br><small class="text-success" title="ID de transacciÃ³n Wompi">
                                                                <i class="fas fa-check-circle"></i> {{ pedido.transaction_id|slice:":12" }}...
                                                            </small>
                                                        {% endif %}
                                                    {% elif pedido.metodo_pago == 'tarjeta' %}
                                                        <span class="badge bg-primary">
                                                            <i class="fas fa-credit-card"></i> Tarjeta
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ pedido.get_metodo_pago_display }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ pedido.get_estado_badge_class|slice:"6:" }}">
                                                        {% if pedido.estado == 'pendiente' %}
                                                            <i class="fas fa-clock"></i>
                                                        {% elif pedido.estado == 'confirmado' %}
                                                            <i class="fas fa-check"></i>
                                                        {% elif pedido.estado == 'enviado' %}
                                                            <i class="fas fa-shipping-fast"></i>
                                                        {% elif pedido.estado == 'llegando' %}
                                                            <i class="fas fa-truck"></i>
                                                        {% elif pedido.estado == 'entregado' %}
                                                            <i class="fas fa-check-circle"></i>
                                                        {% endif %}
                                                        {{ pedido.get_estado_display }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ pedido.get_pago_badge_class|slice:"6:" }}">
                                                        {% if pedido.estado_pago == 'completado' %}
                                                            <i class="fas fa-check-circle"></i>
                                                        {% elif pedido.estado_pago == 'fallido' %}
                                                            <i class="fas fa-times-circle"></i>
                                                        {% elif pedido.estado_pago == 'procesando' %}
                                                            <i class="fas fa-spinner"></i>
                                                        {% else %}
                                                            <i class="fas fa-clock"></i>
                                                        {% endif %}
                                                        {{ pedido.get_estado_pago_display }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <small>{{ pedido.fecha|date:"d/m/Y H:i" }}</small>
                                                    {% if pedido.fecha_entregado %}
                                                        <br><small class="text-success">Entregado: {{ pedido.fecha_entregado|date:"d/m" }}</small>
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    <div class="d-flex flex-column gap-1">
                                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                                onclick="event.preventDefault(); loadPedidoDetails({{ pedido.id }})"
                                                                title="Ver detalles del pedido">
                                                            <i class="fas fa-eye me-1"></i> Ver
                                                        </button>
                                                        {% if pedido.estado_pago != 'completado' %}
                                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                                onclick="confirmarPago({{ pedido.id }})"
                                                                title="Confirmar pago del pedido">
                                                            <i class="fas fa-dollar-sign me-1"></i> Pago
                                                        </button>
                                                        {% endif %}
                                                        <div class="dropdown">
                                                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" 
                                                                    type="button" 
                                                                    id="dropdownEstado{{ pedido.id }}"
                                                                    data-bs-toggle="dropdown"
                                                                    aria-expanded="false"
                                                                    title="Cambiar estado del pedido">
                                                                <i class="fas fa-edit me-1"></i> Estado
                                                            </button>
                                                            <ul class="dropdown-menu" aria-labelledby="dropdownEstado{{ pedido.id }}">
                                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'pendiente')">
                                                                    <i class="fas fa-clock me-2 text-warning"></i>Pendiente
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'confirmado')">
                                                                    <i class="fas fa-check me-2 text-info"></i>Confirmar
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'enviado')">
                                                                    <i class="fas fa-shipping-fast me-2 text-primary"></i>Enviar
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'llegando')">
                                                                    <i class="fas fa-truck me-2 text-info"></i>En camino
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'entregado')">
                                                                    <i class="fas fa-check-circle me-2 text-success"></i>Entregado
                                                                </a></li>
                                                                <li><hr class="dropdown-divider"></li>
                                                                <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'cancelado')">
                                                                    <i class="fas fa-times-circle me-2"></i>Cancelar
                                                                </a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vista MÃ³vil: Cards -->
                    <div class="d-lg-none">
                        {% for pedido in pedidos %}
                        <div class="card shadow-sm mb-3 pedido-card-mobile">
                            <div class="card-body p-3">
                                <!-- Header con ID y Total -->
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">
                                            <strong class="text-primary">#{{ pedido.id }}</strong>
                                        </h6>
                                        {% if pedido.transaction_id %}
                                            <small class="text-muted">{{ pedido.transaction_id|slice:":8" }}...</small>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <h5 class="mb-0 text-success">${{ pedido.total|floatformat:0 }}</h5>
                                        <small class="text-muted">{{ pedido.fecha|date:"d/m/Y" }}</small>
                                    </div>
                                </div>

                                <!-- Cliente y Contacto -->
                                <div class="border-top pt-2 mb-2">
                                    <strong class="d-block">{{ pedido.nombre }}</strong>
                                    <small class="text-muted d-block"><i class="fas fa-envelope"></i> {{ pedido.user.email }}</small>
                                    {% if pedido.telefono %}
                                        <small class="text-muted d-block"><i class="fas fa-phone"></i> {{ pedido.telefono }}</small>
                                    {% endif %}
                                    <small class="text-muted d-block"><i class="fas fa-map-marker-alt"></i> {{ pedido.ciudad }}, {{ pedido.departamento }}</small>
                                </div>

                                <!-- Badges de Estado -->
                                <div class="border-top pt-2 mb-2">
                                    <div class="d-flex flex-wrap gap-2">
                                        <!-- MÃ©todo de Pago -->
                                        {% if pedido.metodo_pago == 'contraentrega' %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-money-bill"></i> Contra entrega
                                            </span>
                                        {% elif pedido.metodo_pago == 'recoger_tienda' %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-store"></i> Recoger
                                            </span>
                                        {% elif pedido.metodo_pago == 'wompi_tarjeta' or pedido.metodo_pago == 'wompi' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-credit-card"></i> Wompi
                                            </span>
                                            {% if pedido.transaction_id %}
                                                <br><small class="text-success" title="ID de transacciÃ³n Wompi">
                                                    <i class="fas fa-check-circle"></i> {{ pedido.transaction_id|slice:":12" }}...
                                                </small>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">{{ pedido.get_metodo_pago_display }}</span>
                                        {% endif %}

                                        <!-- Estado del Pedido -->
                                        <span class="badge bg-{{ pedido.get_estado_badge_class|slice:"6:" }}">
                                            {% if pedido.estado == 'pendiente' %}
                                                <i class="fas fa-clock"></i>
                                            {% elif pedido.estado == 'confirmado' %}
                                                <i class="fas fa-check"></i>
                                            {% elif pedido.estado == 'enviado' %}
                                                <i class="fas fa-shipping-fast"></i>
                                            {% elif pedido.estado == 'llegando' %}
                                                <i class="fas fa-truck"></i>
                                            {% elif pedido.estado == 'entregado' %}
                                                <i class="fas fa-check-circle"></i>
                                            {% endif %}
                                            {{ pedido.get_estado_display }}
                                        </span>

                                        <!-- Estado de Pago -->
                                        <span class="badge bg-{{ pedido.get_pago_badge_class|slice:"6:" }}">
                                            {% if pedido.estado_pago == 'completado' %}
                                                <i class="fas fa-check-circle"></i>
                                            {% elif pedido.estado_pago == 'fallido' %}
                                                <i class="fas fa-times-circle"></i>
                                            {% elif pedido.estado_pago == 'procesando' %}
                                                <i class="fas fa-spinner"></i>
                                            {% else %}
                                                <i class="fas fa-clock"></i>
                                            {% endif %}
                                            {{ pedido.get_estado_pago_display }}
                                        </span>
                                    </div>
                                </div>

                                <!-- Botones de AcciÃ³n -->
                                <div class="border-top pt-2 d-grid gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" 
                                            onclick="event.preventDefault(); loadPedidoDetails({{ pedido.id }})">
                                        <i class="fas fa-eye me-1"></i> Ver Detalles
                                    </button>
                                    <div class="row g-2">
                                        {% if pedido.estado_pago != 'completado' %}
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-success btn-sm w-100" 
                                                    onclick="confirmarPago({{ pedido.id }})">
                                                <i class="fas fa-dollar-sign"></i> Confirmar Pago
                                            </button>
                                        </div>
                                        {% endif %}
                                        <div class="{% if pedido.estado_pago != 'completado' %}col-6{% else %}col-12{% endif %}">
                                            <div class="dropdown w-100">
                                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle w-100" 
                                                        type="button" 
                                                        id="dropdownEstadoMobile{{ pedido.id }}"
                                                        data-bs-toggle="dropdown"
                                                        aria-expanded="false">
                                                    <i class="fas fa-edit"></i> Cambiar Estado
                                                </button>
                                                <ul class="dropdown-menu w-100" aria-labelledby="dropdownEstadoMobile{{ pedido.id }}">
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'pendiente')">
                                                        <i class="fas fa-clock me-2 text-warning"></i>Pendiente
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'confirmado')">
                                                        <i class="fas fa-check me-2 text-info"></i>Confirmar
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'enviado')">
                                                        <i class="fas fa-shipping-fast me-2 text-primary"></i>Enviar
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'llegando')">
                                                        <i class="fas fa-truck me-2 text-info"></i>En camino
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'entregado')">
                                                        <i class="fas fa-check-circle me-2 text-success"></i>Entregado
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="event.preventDefault(); updateEstado({{ pedido.id }}, 'cancelado')">
                                                        <i class="fas fa-times-circle me-2"></i>Cancelar
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="text-center py-5">
                                <i class="fas fa-shopping-cart text-muted" style="font-size: 4rem;"></i>
                                <h4 class="text-muted mt-3">No hay pedidos</h4>
                                <p class="text-muted">Los pedidos aparecerÃ¡n aquÃ­ cuando los clientes realicen compras.</p>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Modal para ver detalles del pedido -->
                <div class="modal fade" id="pedidoModal" tabindex="-1" aria-labelledby="pedidoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="pedidoModalLabel">
                                    <i class="fas fa-shopping-cart"></i> Detalles del Pedido
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="pedidoModalContent">
                                <!-- El contenido se carga dinÃ¡micamente -->
                                <div class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
             {% elif request.GET.view == "inventario" %}
                <!-- INVENTARIO MODERNIZADO Y PROFESIONAL -->
                <div class="inventario-dashboard-modern" data-print-date="{{ "now"|date:"d/m/Y H:i" }}">
                    <!-- Header responsive con acciones -->
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4 gap-3">
                        <div>
                            <h2 class="mb-1">
                                <i class="fas fa-warehouse me-2 text-primary"></i>
                                GestiÃ³n de Inventario
                            </h2>
                            <p class="text-muted mb-0 d-none d-sm-block">Control avanzado de stock y valoraciÃ³n</p>
                        </div>
                        <div class="d-flex flex-wrap gap-2 w-100 w-lg-auto">
                            <button type="button" class="btn btn-success flex-fill flex-sm-grow-0" onclick="exportInventoryReport('pdf')">
                                <i class="fas fa-file-pdf"></i><span class="d-none d-sm-inline ms-1">PDF</span>
                            </button>
                            <button type="button" class="btn btn-primary flex-fill flex-sm-grow-0" onclick="exportInventoryReport('excel')">
                                <i class="fas fa-file-excel"></i><span class="d-none d-sm-inline ms-1">Excel</span>
                            </button>
                            <button type="button" class="btn btn-info flex-fill flex-sm-grow-0" onclick="printInventory()">
                                <i class="fas fa-print"></i><span class="d-none d-sm-inline ms-1">Imprimir</span>
                            </button>
                        </div>
                    </div>

                    <!-- Filtros Avanzados - Siempre visibles -->
                    <div class="card modern-card shadow-sm mb-4">
                        <div class="card-header bg-white">
                            <h6 class="mb-0 fw-bold"><i class="fas fa-filter me-2"></i>Filtros de Inventario</h6>
                        </div>
                        <div class="card-body">
                            <div>
                                <form id="inventario-filter-form" method="get" action="" class="row g-3 align-items-end">
                                    <input type="hidden" name="view" value="inventario">
                                    
                                    <div class="col-12 col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-filter me-1"></i>CategorÃ­a
                                        </label>
                                        <select name="inventory_category" id="inventory_category_select" class="form-select">
                                            <option value="">Todas las categorÃ­as</option>
                                            {% for categoria in categorias %}
                                                <option value="{{ categoria.id }}" {% if selected_category and selected_category == categoria.id %}selected{% endif %}>
                                                    {{ categoria.nombre }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="col-12 col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-boxes me-1"></i>Estado de Stock
                                        </label>
                                        <select name="stock_status" id="stock_status_select" class="form-select">
                                            <option value="">Todos</option>
                                            <option value="critical">Stock CrÃ­tico (â‰¤10)</option>
                                            <option value="low">Stock Bajo (â‰¤30)</option>
                                            <option value="normal">Stock Normal (&gt;30)</option>
                                            <option value="out">Sin Stock (0)</option>
                                        </select>
                                    </div>

                                    <div class="col-12 col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-sort-amount-down me-1"></i>Ordenar por
                                        </label>
                                        <select name="sort_by" id="sort_by_select" class="form-select">
                                            <option value="name">Nombre A-Z</option>
                                            <option value="stock_asc">Stock Menor a Mayor</option>
                                            <option value="stock_desc">Stock Mayor a Menor</option>
                                            <option value="value_desc">Valor Mayor a Menor</option>
                                            <option value="margin_desc">Margen Mayor a Menor</option>
                                        </select>
                                    </div>

                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-search me-1"></i>Aplicar Filtros
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs de Inventario responsive -->
                    <div class="row g-3 mb-4">
                        <div class="col-6 col-md-3">
                            <div class="modern-stat-card gradient-primary">
                                <div class="stat-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" style="font-family: 'Courier New', monospace;">
                                        ${{ resumen_inventario.valor_invertido|floatformat:0|intcomma }}
                                    </div>
                                    <div class="stat-label">Capital Invertido</div>
                                    <div class="stat-trend">
                                        <i class="fas fa-shopping-cart me-1"></i>
                                        <span>Costo de adquisiciÃ³n</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6 col-md-3">
                            <div class="modern-stat-card gradient-success">
                                <div class="stat-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" style="font-family: 'Courier New', monospace;">
                                        ${{ resumen_inventario.valor_productos|floatformat:0|intcomma }}
                                    </div>
                                    <div class="stat-label">Valor Venta</div>
                                    <div class="stat-trend d-none d-lg-block">
                                        <i class="fas fa-tag me-1"></i>
                                        <span>Valor al pÃºblico</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6 col-md-3">
                            <div class="modern-stat-card gradient-warning">
                                <div class="stat-icon">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" style="font-family: 'Courier New', monospace;">
                                        ${{ resumen_inventario.margen_ganancia|floatformat:0|intcomma }}
                                    </div>
                                    <div class="stat-label">Margen Ganancia</div>
                                    <div class="stat-trend d-none d-lg-block">
                                        {% widthratio resumen_inventario.margen_ganancia resumen_inventario.valor_invertido 100 as margin_percent %}
                                        <i class="fas fa-arrow-up me-1"></i>
                                        <span>{{ margin_percent }}% de margen</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6 col-md-3">
                            <div class="modern-stat-card gradient-info">
                                <div class="stat-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        {{ resumen_inventario.cantidad_productos_stock }}
                                    </div>
                                    <div class="stat-label">Unidades Stock</div>
                                    <div class="stat-trend d-none d-lg-block">
                                        <i class="fas fa-cube me-1"></i>
                                        <span>Total de productos</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GrÃ¡ficos de AnÃ¡lisis responsive -->
                    <div class="row g-3 mb-4">
                        <!-- GrÃ¡fico de ValoraciÃ³n por CategorÃ­a -->
                        <div class="col-12 col-lg-7">
                            <div class="card modern-card shadow-sm">
                                <div class="card-header bg-white border-bottom">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-chart-bar me-2 text-primary"></i>
                                            ValoraciÃ³n por CategorÃ­a
                                        </h5>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary active" data-inv-chart-type="bar">
                                                <i class="fas fa-chart-bar"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" data-inv-chart-type="doughnut">
                                                <i class="fas fa-circle-notch"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" id="value-chart-container" style="position: relative; height: 350px;">
                                        <canvas id="inventoryValueChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estado de Stock por CategorÃ­a -->
                        <div class="col-12 col-lg-5">
                            <div class="card modern-card shadow-sm h-100">
                                <div class="card-header bg-white border-bottom">
                                    <h5 class="mb-0">
                                        <i class="fas fa-layer-group me-2 text-info"></i>
                                        Stock por CategorÃ­a
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" id="stock-chart-container" style="position: relative; height: 300px;">
                                        <canvas id="inventoryStockChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Detallada por CategorÃ­a -->
                    {% if inventario_by_category %}
                        {% for cat in inventario_by_category %}
                        <div class="card modern-card shadow-sm mb-3" style="border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden;">
                            <div class="card-header" style="background: linear-gradient(to right, #f8f9fa, #ffffff); border-bottom: 3px solid #667eea;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1 fw-bold" style="color: #2c3e50;">
                                            <i class="fas fa-folder me-2" style="color: #667eea;"></i>
                                            {{ cat.category_name }}
                                        </h5>
                                        <small class="text-muted">{{ cat.items|length }} productos en esta categorÃ­a</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="mb-1">
                                            <i class="fas fa-boxes me-1" style="color: #667eea;"></i>
                                            <span style="color: #495057;">Stock:</span> <strong style="color: #2c3e50;">{{ cat.cantidad_stock }}</strong> <span style="color: #6c757d;">unidades</span>
                                        </div>
                                        <div class="mb-1">
                                            <i class="fas fa-dollar-sign me-1" style="color: #28a745;"></i>
                                            <span style="color: #495057;">InversiÃ³n:</span> <strong style="font-family: 'Courier New', monospace; color: #2c3e50;">${{ cat.valor_invertido|floatformat:0|intcomma }}</strong>
                                        </div>
                                        <div>
                                            <i class="fas fa-chart-line me-1" style="color: #17a2b8;"></i>
                                            <span style="color: #495057;">Valor Venta:</span> <strong style="font-family: 'Courier New', monospace; color: #2c3e50;">${{ cat.valor_productos|floatformat:0|intcomma }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0" style="border-collapse: separate; border-spacing: 0;">
                                        <thead style="background: linear-gradient(to right, #f8f9fa, #e9ecef); border-bottom: 2px solid #dee2e6;">
                                            <tr>
                                                <th style="width: 40%; padding: 16px; color: #2c3e50; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                                    <i class="fas fa-box me-2" style="color: #667eea;"></i>Producto
                                                </th>
                                                <th class="text-center" style="width: 10%; padding: 16px; color: #2c3e50; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                                    <i class="fas fa-layer-group me-2" style="color: #667eea;"></i>Stock
                                                </th>
                                                <th class="text-end" style="width: 12.5%; padding: 16px; color: #2c3e50; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                                    <i class="fas fa-shopping-cart me-2" style="color: #667eea;"></i>P. Compra
                                                </th>
                                                <th class="text-end" style="width: 12.5%; padding: 16px; color: #2c3e50; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                                    <i class="fas fa-tag me-2" style="color: #667eea;"></i>P. Venta
                                                </th>
                                                <th class="text-end" style="width: 12.5%; padding: 16px; color: #2c3e50; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                                    <i class="fas fa-wallet me-2" style="color: #667eea;"></i>Inv. Total
                                                </th>
                                                <th class="text-end" style="width: 12.5%; padding: 16px; color: #2c3e50; font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                                    <i class="fas fa-money-bill-wave me-2" style="color: #667eea;"></i>Valor Total
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in cat.items %}
                                            <tr class="{% if item.stock == 0 %}table-danger{% elif item.stock <= 10 %}table-warning{% endif %}" style="border-bottom: 1px solid #f1f3f5; transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#f8f9fa'; this.style.transform='scale(1.005)';" onmouseout="this.style.backgroundColor=''; this.style.transform='scale(1)';">
                                                <td style="padding: 14px 16px; vertical-align: middle;">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <div class="product-status-indicator" 
                                                             style="width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
                                                                    background: {% if item.stock == 0 %}#dc3545{% elif item.stock <= 10 %}#ffc107{% elif item.stock <= 30 %}#0dcaf0{% else %}#198754{% endif %};">
                                                        </div>
                                                        <div>
                                                            <strong class="d-block" style="color: #2c3e50; font-size: 0.95rem;">{{ item.product_name }}</strong>
                                                            <small class="text-muted" style="font-size: 0.8rem;">
                                                                <i class="fas fa-tag me-1" style="color: #667eea;"></i>{{ cat.category_name }}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="text-center" style="padding: 14px 16px; vertical-align: middle;">
                                                    {% if item.stock == 0 %}
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-times-circle"></i> 0
                                                        </span>
                                                    {% elif item.stock <= 10 %}
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="fas fa-exclamation-triangle"></i> {{ item.stock }}
                                                        </span>
                                                    {% elif item.stock <= 30 %}
                                                        <span class="badge bg-info">
                                                            {{ item.stock }}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-success">
                                                            {{ item.stock }}
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-end">
                                                    <span class="text-muted" style="font-family: 'Courier New', monospace;">
                                                        ${{ item.price_buy|floatformat:0|intcomma }}
                                                    </span>
                                                </td>
                                                <td class="text-end">
                                                    <strong class="text-primary" style="font-family: 'Courier New', monospace;">
                                                        ${{ item.price|floatformat:0|intcomma }}
                                                    </strong>
                                                </td>
                                                <td class="text-end">
                                                    <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2" style="font-family: 'Courier New', monospace; font-weight: 600;">
                                                        ${{ item.subtotal_buy|floatformat:0|intcomma }}
                                                    </span>
                                                </td>
                                                <td class="text-end">
                                                    <span class="badge bg-success bg-opacity-10 text-success px-3 py-2" style="font-family: 'Courier New', monospace; font-weight: 600;">
                                                        ${{ item.subtotal_sell|floatformat:0|intcomma }}
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot class="table-light fw-bold">
                                            <tr>
                                                <td>TOTAL CATEGORÃA</td>
                                                <td class="text-center">
                                                    <span class="badge bg-primary">{{ cat.cantidad_stock }}</span>
                                                </td>
                                                <td colspan="2"></td>
                                                <td class="text-end">
                                                    <span class="text-secondary" style="font-family: 'Courier New', monospace;">${{ cat.valor_invertido|floatformat:0|intcomma }}</span>
                                                </td>
                                                <td class="text-end">
                                                    <span class="text-success" style="font-family: 'Courier New', monospace;">${{ cat.valor_productos|floatformat:0|intcomma }}</span>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="card modern-card shadow-sm">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                                <h5 class="text-muted">No hay productos en inventario</h5>
                                <p class="text-muted">No se encontraron productos para los filtros seleccionados</p>
                                <a href="?view=inventario" class="btn btn-primary">
                                    <i class="fas fa-redo me-1"></i>Limpiar Filtros
                                </a>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Alertas de Stock al Final -->
                    {% if inventario_by_category %}
                        <div class="mt-4">
                            <h5 class="mb-3">
                                <i class="fas fa-bell me-2 text-warning"></i>
                                Alertas de Stock
                            </h5>
                            {% for cat in inventario_by_category %}
                                {% for item in cat.items %}
                                    {% if item.stock <= 10 %}
                                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Stock CrÃ­tico:</strong> {{ item.product_name }} ({{ cat.category_name }}) - Solo quedan {{ item.stock }} unidades
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        </div>
                                    {% elif item.stock <= 30 %}
                                        {% if forloop.counter <= 3 %}
                                            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Stock Bajo:</strong> {{ item.product_name }} ({{ cat.category_name }}) - Quedan {{ item.stock }} unidades
                                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
    
            {% elif request.GET.view == "bonos" %}
                <!-- SECCIÃ“N DE BONOS DE DESCUENTO -->
                <div class="bonos-section">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 gap-3">
                        <h2><i class="fas fa-percentage me-2"></i>Bonos de Descuento</h2>
                        <button type="button" class="btn btn-success w-100 w-sm-auto" data-bs-toggle="modal" data-bs-target="#modalNuevoBono">
                            <i class="fas fa-plus me-2"></i>Crear Nuevo Bono
                        </button>
                    </div>
                    
                    <!-- EstadÃ­sticas de Bonos responsive -->
                    {% if bonos %}
                        <div class="row g-3 mb-4">
                            <div class="col-6 col-md-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body p-3">
                                        <h5 class="text-success mb-1">{{ bonos|length }}</h5>
                                        <small>Total Bonos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body p-3">
                                        <h5 class="text-primary mb-1">{% for bono in bonos %}{% if bono.is_valid %}1{% endif %}{% empty %}0{% endfor %}</h5>
                                        <small>Bonos Activos</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body p-3">
                                        <h5 class="text-warning mb-1">{% for bono in bonos %}{% if bono.get_estado_display == 'Expirado' %}1{% endif %}{% empty %}0{% endfor %}</h5>
                                        <small>Bonos Expirados</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card text-center bg-light h-100">
                                    <div class="card-body p-3">
                                        <h5 class="text-info mb-1">{% for bono in bonos %}{{ bono.usos_realizados|add:0 }}{% empty %}0{% endfor %}</h5>
                                        <small>Total Usos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Tabla de Bonos desktop -->
                    <div class="card d-none d-lg-block">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>Lista de Bonos
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if bonos %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>CÃ³digo</th>
                                                <th>DescripciÃ³n</th>
                                                <th>Tipo</th>
                                                <th>Descuento</th>
                                                <th>Compra MÃ­n.</th>
                                                <th>Vigencia</th>
                                                <th>Usos</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for bono in bonos %}
                                                <tr>
                                                    <td>
                                                        <code class="bg-light px-2 py-1 rounded">{{ bono.codigo }}</code>
                                                    </td>
                                                    <td>{{ bono.descripcion|truncatechars:50 }}</td>
                                                    <td>
                                                        <span class="badge {% if bono.tipo_descuento == 'porcentaje' %}bg-info{% else %}bg-warning{% endif %}">
                                                            {% if bono.tipo_descuento == 'porcentaje' %}Porcentaje{% else %}Valor Fijo{% endif %}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <strong>
                                                            {% if bono.tipo_descuento == 'porcentaje' %}
                                                                {{ bono.valor_descuento }}%
                                                            {% else %}
                                                                ${{ bono.valor_descuento|floatformat:0 }}
                                                            {% endif %}
                                                        </strong>
                                                    </td>
                                                    <td>${{ bono.valor_minimo_compra|floatformat:0 }}</td>
                                                    <td>
                                                        <small>
                                                            {{ bono.fecha_inicio|date:"d/m/Y H:i" }}<br>
                                                            {{ bono.fecha_fin|date:"d/m/Y H:i" }}
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-secondary">
                                                            {{ bono.usos_realizados }}/{{ bono.usos_maximos }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-{{ bono.get_estado_badge_class|slice:"6:" }}">
                                                            {{ bono.get_estado_display }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex gap-1">
                                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                                    onclick="editarBono({{ bono.id }})"
                                                                    title="Editar bono">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <form method="post" style="display: inline;" 
                                                                  onsubmit="return confirm('Â¿EstÃ¡s seguro de eliminar el bono {{ bono.codigo }}?')">
                                                                {% csrf_token %}
                                                                <input type="hidden" name="action" value="eliminar_bono">
                                                                <input type="hidden" name="bono_id" value="{{ bono.id }}">
                                                                <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                                        title="Eliminar bono">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-percentage text-muted" style="font-size: 4rem;"></i>
                                    <h4 class="text-muted mt-3">No hay bonos creados</h4>
                                    <p class="text-muted">Crea tu primer bono de descuento para incentivar las ventas.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
    
            {% elif request.GET.view == "categoria" %}
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 gap-3">
                    <h2><i class="fas fa-folder me-2"></i>CategorÃ­as</h2>
                    <button type="button" class="btn btn-primary w-100 w-sm-auto" data-bs-toggle="modal" data-bs-target="#modalNuevaCategoria">
                        <i class="fas fa-plus"></i> Nueva CategorÃ­a
                    </button>
                </div>
                 
                <div class="card d-none d-md-block">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Slug</th>
                            <th scope="col">Productos</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="categorias-table-body">
                        {% for categoria in categorias %}
                        <tr data-category-id="{{ categoria.id }}">
                            <td>{{ categoria.id }}</td>
                            <td>{{ categoria.nombre }}</td>
                            <td>{{ categoria.slug }}</td>
                            <td>{{ categoria.products.count }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary edit-category-btn" 
                                        data-category-id="{{ categoria.id }}"
                                        data-category-nombre="{{ categoria.nombre }}"
                                        data-category-slug="{{ categoria.slug }}"
                                        data-bs-toggle="modal" data-bs-target="#modalEditarCategoria">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button type="button" class="btn btn-sm btn-danger delete-category-btn" 
                                        data-category-id="{{ categoria.id }}"
                                        data-category-nombre="{{ categoria.nombre }}">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="no-categories-row">
                            <td colspan="5" class="text-center">No hay categorÃ­as registradas.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table> 
            {% elif request.GET.view == "tipos" %}
                 <h2>Tipos</h2>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoTipo">
                     Nuevo Tipo
                    </button>

                <table class="table mt-3">
                     <thead>
                         <tr>
                            <th>Nombre</th>
                            <th>Acciones</th>
                         </tr>
                     </thead>
                <tbody>
               {% for tipo in tipos %}
                 <tr>
                   <td>{{ tipo.name }}</td>
                   <td>
                      <a href="{% url 'edit_tipo' tipo.id %}" class="btn btn-sm btn-primary">Editar</a>
                      <a href="{% url 'delete_tipo' tipo.id %}" class="btn btn-sm btn-danger">x</a>
                   </td>
                 </tr>
               {% empty %}
              <tr><td colspan="2">No hay tipos registrados.</td></tr>
            {% endfor %}
        </tbody>
    </table>

            {% elif request.GET.view == "ventas" %}
                <!-- ANÃLISIS DE VENTAS MODERNIZADO -->
                <div class="ventas-dashboard-modern">
                    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4 gap-3">
                        <h2 class="mb-0">
                            <i class="fas fa-chart-line me-2 text-primary"></i>
                            AnÃ¡lisis de Ventas
                        </h2>
                        <div class="btn-group w-100 w-lg-auto" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-period="all">
                                <i class="fas fa-infinity"></i><span class="d-none d-sm-inline ms-1">Todo</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-period="today">
                                <i class="fas fa-calendar-day"></i><span class="d-none d-sm-inline ms-1">Hoy</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-period="week">
                                <i class="fas fa-calendar-week"></i><span class="d-none d-sm-inline ms-1">Semana</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-period="month">
                                <i class="fas fa-calendar-alt"></i><span class="d-none d-sm-inline ms-1">Mes</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- KPIs Cards Modernos responsive -->
                    <div class="row g-3 mb-4">
                        <!-- Ventas Totales -->
                        <div class="col-6 col-lg-3">
                            <div class="modern-stat-card gradient-primary">
                                <div class="stat-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" data-stat="ingresos-totales">
                                        ${{ total_ventas_general|floatformat:0 }}
                                    </div>
                                    <div class="stat-label">Ventas Totales</div>
                                    <div class="stat-trend">
                                        <i class="fas fa-arrow-up me-1"></i>
                                        <span class="small">Hoy: ${{ estadisticas_diarias.ventas_hoy|default:"0"|floatformat:0 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pedidos Totales -->
                        <div class="col-6 col-lg-3">
                            <div class="modern-stat-card gradient-success">
                                <div class="stat-icon">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" data-stat="total-pedidos">
                                        {{ estadisticas_ventas.pedidos_totales }}
                                    </div>
                                    <div class="stat-label">Pedidos Totales</div>
                                    <div class="stat-trend d-none d-lg-block">
                                        <i class="fas fa-calendar-day me-1"></i>
                                        <span class="small">Hoy: {{ estadisticas_diarias.pedidos_hoy }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Productos Vendidos -->
                        <div class="col-6 col-lg-3">
                            <div class="modern-stat-card gradient-info">
                                <div class="stat-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value" data-stat="total-productos">
                                        {{ estadisticas_ventas.productos_vendidos }}
                                    </div>
                                    <div class="stat-label">Productos Vendidos</div>
                                    <div class="stat-trend">
                                        <i class="fas fa-box-open me-1"></i>
                                        <span class="small">Hoy: {{ estadisticas_diarias.productos_vendidos_hoy }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Promedio por Pedido -->
                        <div class="col-md-3">
                            <div class="modern-stat-card gradient-warning">
                                <div class="stat-icon">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-value">
                                        ${{ estadisticas_ventas.promedio_por_pedido|floatformat:0 }}
                                    </div>
                                    <div class="stat-label">Promedio por Pedido</div>
                                    <div class="stat-trend">
                                        <i class="fas fa-chart-line me-1"></i>
                                        <span class="small">Ticket promedio</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ventas por CategorÃ­a Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <div class="card shadow-sm" id="ventasCategoriasCard">
                                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-layer-group text-primary me-2"></i>
                                        Valor Vendido por CategorÃ­a
                                    </h5>
                                    <button class="btn btn-sm btn-outline-primary" id="toggleVentasCategorias" type="button">
                                        <i class="fas fa-chevron-up" id="iconVentasCategorias"></i>
                                    </button>
                                </div>
                                <div class="card-body" id="ventasCategoriasContent">
                                    {% if ventas_por_categoria %}
                                    <div class="row g-3">
                                        {% for categoria in ventas_por_categoria %}
                                        <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                                            <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                <div class="card-body text-white">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div>
                                                            <h6 class="text-white mb-1 fw-bold">{{ categoria.nombre }}</h6>
                                                            <small class="opacity-75">
                                                                <i class="fas fa-shopping-bag me-1"></i>{{ categoria.cantidad_pedidos }} pedido{{ categoria.cantidad_pedidos|pluralize }}
                                                            </small>
                                                        </div>
                                                        <div class="text-end">
                                                            <i class="fas fa-chart-line fa-2x opacity-50"></i>
                                                        </div>
                                                    </div>
                                                    <div class="mt-3">
                                                        <div class="d-flex justify-content-between align-items-end">
                                                            <div>
                                                                <div class="h3 mb-0 fw-bold">${{ categoria.total_ingresos|floatformat:0 }}</div>
                                                                <small class="opacity-75">Total vendido</small>
                                                            </div>
                                                            <div class="text-end">
                                                                <div class="badge bg-white bg-opacity-25">
                                                                    {{ categoria.cantidad_productos }} und
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="mt-3 pt-3 border-top border-white border-opacity-25">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small class="opacity-75">
                                                                <i class="fas fa-percentage me-1"></i>
                                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                                {{ porcentaje|floatformat:1 }}% del total
                                                            </small>
                                                            <button class="btn btn-sm btn-light" 
                                                                    data-bs-toggle="collapse" 
                                                                    data-bs-target="#detalles-{{ forloop.counter }}"
                                                                    aria-expanded="false">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="collapse" id="detalles-{{ forloop.counter }}">
                                                    <div class="card-footer bg-white bg-opacity-10 border-0">
                                                        <small class="text-white d-block mb-2 fw-bold">
                                                            <i class="fas fa-box-open me-1"></i>Productos vendidos:
                                                        </small>
                                                        <div class="list-group list-group-flush bg-transparent">
                                                            {% for producto in categoria.productos_vendidos|slice:":5" %}
                                                            <div class="list-group-item bg-transparent text-white border-white border-opacity-25 p-2">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <small class="text-truncate me-2">{{ producto.nombre }}</small>
                                                                    <span class="badge bg-white text-dark">{{ producto.cantidad }}x</span>
                                                                </div>
                                                            </div>
                                                            {% endfor %}
                                                            {% if categoria.productos_vendidos|length > 5 %}
                                                            <div class="list-group-item bg-transparent text-white border-0 p-2">
                                                                <small class="opacity-75">
                                                                    <i class="fas fa-ellipsis-h me-1"></i>
                                                                    y {{ categoria.productos_vendidos|length|add:"-5" }} mÃ¡s...
                                                                </small>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-shopping-cart fa-3x mb-3 opacity-50"></i>
                                        <h5>No hay ventas registradas</h5>
                                        <p class="mb-0">Las ventas por categorÃ­a aparecerÃ¡n aquÃ­</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                   
                    <!-- GrÃ¡ficos de AnÃ¡lisis -->
                    <div class="row g-3 mb-4">
                        <!-- GrÃ¡fico de Ventas por CategorÃ­a -->
                        <div class="col-lg-8">
                            <div class="card shadow-sm" id="graficoVentasCard">
                                <div class="card-header bg-white border-bottom">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="fas fa-chart-bar text-primary me-2"></i>
                                            Ventas por CategorÃ­a
                                        </h5>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-secondary active" data-chart-type="bar">
                                                    <i class="fas fa-chart-bar"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" data-chart-type="pie">
                                                    <i class="fas fa-chart-pie"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" data-chart-type="doughnut">
                                                    <i class="fas fa-dot-circle"></i>
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-outline-primary" id="toggleGraficoVentas" type="button">
                                                <i class="fas fa-chevron-up" id="iconGraficoVentas"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body" id="graficoVentasContent" style="height: 400px;">
                                    <canvas id="ventasCategoriaChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Top 5 CategorÃ­as -->
                        <div class="col-lg-4">
                            <div class="card shadow-sm" id="topCategoriasCard">
                                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-trophy text-warning me-2"></i>
                                        Top 5 CategorÃ­as
                                    </h5>
                                    <button class="btn btn-sm btn-outline-primary" id="toggleTopCategorias" type="button">
                                        <i class="fas fa-chevron-up" id="iconTopCategorias"></i>
                                    </button>
                                </div>
                                <div class="card-body p-0" id="topCategoriasContent">
                                    <div class="list-group list-group-flush">
                                        {% for categoria in ventas_por_categoria|slice:":5" %}
                                        <div class="list-group-item">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="me-auto">
                                                    <div class="fw-bold text-dark">{{ categoria.nombre }}</div>
                                                    <small class="text-muted">
                                                        {{ categoria.cantidad_pedidos }} pedido{{ categoria.cantidad_pedidos|pluralize }} Â· 
                                                        {{ categoria.cantidad_productos }} producto{{ categoria.cantidad_productos|pluralize }}
                                                    </small>
                                                </div>
                                                <span class="badge bg-success rounded-pill">
                                                    ${{ categoria.total_ingresos|floatformat:0 }}
                                                </span>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                <div class="progress-bar bg-gradient" role="progressbar" 
                                                     style="width: {{ porcentaje }}%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);">
                                                </div>
                                            </div>
                                            <small class="text-muted">{{ porcentaje|floatformat:1 }}% del total</small>
                                        </div>
                                        {% empty %}
                                        <div class="list-group-item text-center text-muted py-5">
                                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                                            <p class="mb-0">Sin datos de ventas</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Detallada Moderna desktop -->
                    <div class="card shadow-sm d-none d-lg-block">
                        <div class="card-header bg-white border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-table text-primary me-2"></i>
                                    Detalle de Ventas por CategorÃ­a
                                </h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportToExcel()">
                                    <i class="fas fa-download me-1"></i>Exportar
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0" id="ventasTable">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="border-0">#</th>
                                            <th class="border-0">CategorÃ­a</th>
                                            <th class="border-0 text-end">Ingresos</th>
                                            <th class="border-0 text-center">Productos</th>
                                            <th class="border-0 text-center">Pedidos</th>
                                            <th class="border-0 text-end">Promedio</th>
                                            <th class="border-0">ParticipaciÃ³n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for categoria in ventas_por_categoria %}
                                        <tr>
                                            <td class="fw-bold text-muted">{{ forloop.counter }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="category-color-indicator me-2" 
                                                         style="width: 8px; height: 8px; border-radius: 50%; background: {% cycle 'rgba(102, 126, 234, 0.8)' 'rgba(118, 75, 162, 0.8)' 'rgba(79, 172, 254, 0.8)' 'rgba(0, 242, 254, 0.8)' 'rgba(67, 233, 123, 0.8)' 'rgba(245, 87, 108, 0.8)' 'rgba(255, 159, 64, 0.8)' 'rgba(255, 205, 86, 0.8)' 'rgba(153, 102, 255, 0.8)' 'rgba(201, 203, 207, 0.8)' %};"></div>
                                                    <strong class="text-dark">{{ categoria.nombre }}</strong>
                                                </div>
                                            </td>
                                            <td class="text-end">
                                                <span class="badge bg-success-subtle text-success px-3 py-2">
                                                    ${{ categoria.total_ingresos|floatformat:0 }}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-info-subtle text-info">
                                                    {{ categoria.cantidad_productos }}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-primary-subtle text-primary">
                                                    {{ categoria.cantidad_pedidos }}
                                                </span>
                                            </td>
                                            <td class="text-end text-muted">
                                                {% widthratio categoria.total_ingresos categoria.cantidad_pedidos 1 as promedio %}
                                                ${{ promedio|floatformat:0 }}
                                            </td>
                                            <td style="min-width: 150px;">
                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                <div class="d-flex align-items-center gap-2">
                                                    <div class="progress flex-grow-1" style="height: 8px;">
                                                        <div class="progress-bar bg-gradient" role="progressbar" 
                                                             style="width: {{ porcentaje }}%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);">
                                                        </div>
                                                    </div>
                                                    <small class="text-muted fw-bold" style="min-width: 45px;">{{ porcentaje|floatformat:1 }}%</small>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-5">
                                                <i class="fas fa-chart-line fa-3x mb-3 d-block" style="opacity: 0.3;"></i>
                                                <p class="mb-0">No hay ventas registradas aÃºn</p>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            {% elif request.GET.view == "proveedores" %}
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4 gap-3">
                    <h2><i class="fas fa-truck me-2"></i>Proveedores</h2>
                    <a href="{% url 'create_proveedor' %}" data-bs-toggle="modal" data-bs-target="#modalNuevoProveedor" class="btn btn-primary w-100 w-sm-auto">
                        <i class="fas fa-plus me-2"></i>Crear Proveedor
                    </a>
                </div>
                <div class="card d-none d-md-block">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                        <tr>
                              <th>Nombre</th>
                            <th>CÃ©dula</th>                          
                            <th>Email</th>
                            <th>TelÃ©fono</th>
                            <th>DirecciÃ³n</th>
                            <th>Acciones</th>
                        </tr>
                    {% if proveedores %}
                        <tr>
                            {% for proveedor in proveedores %}
                                <td>{{ proveedor.nombre }}</td>
                                <td>{{ proveedor.cedulaOnita }}</td>
                                <td>{{ proveedor.email }}</td>
                                <td>{{ proveedor.telefono }}</td>
                                <td>{{ proveedor.direccion }}</td>
                                <td>
                                    <a href="{% url 'edit_proveedor' proveedor.id %}" class="btn btn-sm btn-warning">Editar</a>
                                    <a href="{% url 'delete_proveedor' proveedor.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                                </td>
                          
                        </tr>
                        {% endfor %}
                {% else %}
                    <p>No hay proveedores disponibles.</p>
                {% endif %}
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${{ total_ventas_general|floatformat:0 }}</h4>
                                            <p class="mb-0">Ventas Totales</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-dollar-sign fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ estadisticas_ventas.pedidos_totales }}</h4>
                                            <p class="mb-0">Pedidos Totales</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-shopping-cart fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ estadisticas_ventas.productos_vendidos }}</h4>
                                            <p class="mb-0">Productos Vendidos</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-boxes fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${{ estadisticas_ventas.promedio_por_pedido|floatformat:0 }}</h4>
                                            <p class="mb-0">Promedio por Pedido</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-calculator fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CategorÃ­as Destacadas -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-crown me-2"></i>CategorÃ­a con Mayores Ingresos</h5>
                                </div>
                                <div class="card-body">
                                    {% if estadisticas_ventas.categoria_mayor_ingresos %}
                                        <h4 class="text-primary">{{ estadisticas_ventas.categoria_mayor_ingresos.nombre }}</h4>
                                        <p class="mb-1"><strong>Ingresos:</strong> ${{ estadisticas_ventas.categoria_mayor_ingresos.total_ingresos|floatformat:0 }}</p>
                                        <p class="mb-1"><strong>Productos vendidos:</strong> {{ estadisticas_ventas.categoria_mayor_ingresos.cantidad_productos }}</p>
                                        <p class="mb-0"><strong>Pedidos:</strong> {{ estadisticas_ventas.categoria_mayor_ingresos.cantidad_pedidos }}</p>
                                    {% else %}
                                        <p class="text-muted">No hay datos de ventas disponibles</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>CategorÃ­a MÃ¡s Vendida</h5>
                                </div>
                                <div class="card-body">
                                    {% if estadisticas_ventas.categoria_mas_vendida %}
                                        <h4 class="text-success">{{ estadisticas_ventas.categoria_mas_vendida.nombre }}</h4>
                                        <p class="mb-1"><strong>Productos vendidos:</strong> {{ estadisticas_ventas.categoria_mas_vendida.cantidad_productos }}</p>
                                        <p class="mb-1"><strong>Ingresos:</strong> ${{ estadisticas_ventas.categoria_mas_vendida.total_ingresos|floatformat:0 }}</p>
                                        <p class="mb-0"><strong>Pedidos:</strong> {{ estadisticas_ventas.categoria_mas_vendida.cantidad_pedidos }}</p>
                                    {% else %}
                                        <p class="text-muted">No hay datos de ventas disponibles</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Completa de Ventas por CategorÃ­a -->
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-table me-2"></i>AnÃ¡lisis Detallado por CategorÃ­a</h5>
                                <div>
                                    <a href="/dashboard/dashboard_home/" class="btn btn-sm btn-outline-light me-2">
                                        <i class="fas fa-home"></i> Volver al Home
                                    </a>
                                    <button class="btn btn-sm btn-outline-light" onclick="window.print()">
                                        <i class="fas fa-print"></i> Imprimir
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">CategorÃ­a</th>
                                            <th scope="col">Ingresos Totales</th>
                                            <th scope="col">Productos Vendidos</th>
                                            <th scope="col">Pedidos</th>
                                            <th scope="col">Promedio por Pedido</th>
                                            <th scope="col">% del Total</th>
                                            <th scope="col">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for categoria in ventas_por_categoria %}
                                        <tr>
                                            <td>
                                                {% if forloop.counter <= 3 %}
                                                    <span class="badge bg-warning text-dark">
                                                        {% if forloop.counter == 1 %}ðŸ¥‡{% elif forloop.counter == 2 %}ðŸ¥ˆ{% else %}ðŸ¥‰{% endif %}
                                                        {{ forloop.counter }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ forloop.counter }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <strong class="text-primary">{{ categoria.nombre }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">${{ categoria.total_ingresos|floatformat:0 }}</span>
                                            </td>
                                            <td>{{ categoria.cantidad_productos }}</td>
                                            <td>{{ categoria.cantidad_pedidos }}</td>
                                            <td>
                                                {% widthratio categoria.total_ingresos categoria.cantidad_pedidos 1 as promedio %}
                                                ${{ promedio|floatformat:0 }}
                                            </td>
                                            <td>
                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                <div class="progress" style="width: 60px;">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ porcentaje }}%">
                                                        {{ porcentaje|floatformat:1 }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary ver-detalle-categoria" 
                                                        data-categoria="{{ categoria.nombre }}"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#modalDetalleCategoriaVentas">
                                                    <i class="fas fa-eye"></i> Ver Detalles
                                                </button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>No hay ventas registradas aÃºn
                                                <br><small>Las estadÃ­sticas aparecerÃ¡n cuando se registren los primeros pedidos</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            {% elif request.GET.view == "proveedores" %>
                <h2>Proveedores</h2>
                    <a href="{% url 'create_proveedor' %}" data-bs-toggle="modal" data-bs-target="#modalNuevoProveedor" class="btn btn-primary mb-3">Crear Proveedor</a>
                    <table>
                        <tr>
                              <th>Nombre</th>
                            <th>CÃ©dula</th>                          
                            <th>Email</th>
                            <th>TelÃ©fono</th>
                            <th>DirecciÃ³n</th>
                            <th>Acciones</th>
                        </tr>
                    {% if proveedores %}
                        <tr>
                            {% for proveedor in proveedores %}
                                <td>{{ proveedor.nombre }}</td>
                                <td>{{ proveedor.cedulaOnita }}</td>
                                <td>{{ proveedor.email }}</td>
                                <td>{{ proveedor.telefono }}</td>
                                <td>{{ proveedor.direccion }}</td>
                                <td>
                                    <a href="{% url 'edit_proveedor' proveedor.id %}" class="btn btn-sm btn-warning">Editar</a>
                                    <a href="{% url 'delete_proveedor' proveedor.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                                </td>
                          
                        </tr>
                        {% endfor %}
                {% else %}
                    <p>No hay proveedores disponibles.</p>
                {% endif %}
            {% elif request.GET.view == "mensajes" %}
                <!-- Vista de Mensajes del Dashboard -->
                <div class="messages-dashboard">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2><i class="fas fa-comments me-2"></i>Centro de Mensajes</h2>
                            <p class="text-muted mb-0">Gestiona las consultas y conversaciones con los usuarios</p>
                        </div>
                        <div>
                            <button class="btn btn-primary" id="refreshMessages">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                    </div>

                    <!-- EstadÃ­sticas rÃ¡pidas -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ conversations_stats.total_conversations|default:0 }}</h4>
                                            <p class="mb-0">Total Conversaciones</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-comments fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ conversations_stats.pending_conversations|default:0 }}</h4>
                                            <p class="mb-0">Sin Respuesta</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-clock fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ conversations_stats.today_messages|default:0 }}</h4>
                                            <p class="mb-0">Mensajes Hoy</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-envelope fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ conversations_stats.active_conversations|default:0 }}</h4>
                                            <p class="mb-0">Conversaciones Activas</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-comment-dots fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de conversaciones -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Conversaciones</h5>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="conversation-filter" id="filter-all" checked>
                                    <label class="btn btn-outline-primary btn-sm" for="filter-all">Todas</label>

                                    <input type="radio" class="btn-check" name="conversation-filter" id="filter-pending">
                                    <label class="btn btn-outline-warning btn-sm" for="filter-pending">Sin Respuesta</label>

                                    <input type="radio" class="btn-check" name="conversation-filter" id="filter-active">
                                    <label class="btn btn-outline-success btn-sm" for="filter-active">Activas</label>

                                    <input type="radio" class="btn-check" name="conversation-filter" id="filter-closed">
                                    <label class="btn btn-outline-secondary btn-sm" for="filter-closed">Cerradas</label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if conversations %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Usuario</th>
                                                <th>Asunto</th>
                                                <th>Estado</th>
                                                <th>Ãšltimo Mensaje</th>
                                                <th>Fecha</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="conversations-table-body">
                                            {% for conversation in conversations %}
                                            <tr class="conversation-row" data-status="{{ conversation.status }}" data-conversation-id="{{ conversation.id }}">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="avatar-circle me-2">
                                                            {{ conversation.user.username|first|upper }}
                                                        </div>
                                                        <div>
                                                            <strong>{{ conversation.user.username }}</strong>
                                                            {% if conversation.user.email %}
                                                                <br><small class="text-muted">{{ conversation.user.email }}</small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <strong>{{ conversation.subject }}</strong>
                                                    <!-- Referencia a pedido eliminada temporalmente -->
                                                </td>
                                                <td>
                                                    <span class="badge bg-{% if conversation.status == 'open' %}warning{% elif conversation.status == 'in_progress' %}info{% elif conversation.status == 'resolved' %}success{% else %}secondary{% endif %}">
                                                        {% if conversation.status == 'open' %}Abierta
                                                        {% elif conversation.status == 'in_progress' %}En Progreso
                                                        {% elif conversation.status == 'resolved' %}Resuelta
                                                        {% else %}Cerrada
                                                        {% endif %}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if conversation.last_message %}
                                                        <div class="message-preview">
                                                            {{ conversation.last_message.message|truncatechars:60 }}
                                                        </div>
                                                        <small class="text-muted">
                                                            {% if conversation.last_message.is_admin %}
                                                                <i class="fas fa-user-shield"></i> Admin
                                                            {% else %}
                                                                <i class="fas fa-user"></i> Usuario
                                                            {% endif %}
                                                        </small>
                                                    {% else %}
                                                        <em class="text-muted">Sin mensajes</em>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="date-info">
                                                        {{ conversation.created_at|date:"d/m/Y" }}
                                                        <br><small class="text-muted">{{ conversation.created_at|time:"H:i" }}</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-sm btn-primary" 
                                                                onclick="viewConversation({{ conversation.id }})"
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#conversationModal">
                                                            <i class="fas fa-eye"></i> Ver
                                                        </button>
                                                        <div class="btn-group" role="group">
                                                            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                                    data-bs-toggle="dropdown" aria-expanded="false">
                                                                <i class="fas fa-cog"></i>
                                                            </button>
                                                            <ul class="dropdown-menu">
                                                                <li><a class="dropdown-item" href="#" onclick="updateConversationStatus({{ conversation.id }}, 'in_progress')">
                                                                    <i class="fas fa-play text-info"></i> Marcar en Progreso
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="#" onclick="updateConversationStatus({{ conversation.id }}, 'resolved')">
                                                                    <i class="fas fa-check text-success"></i> Marcar Resuelta
                                                                </a></li>
                                                                <li><a class="dropdown-item" href="#" onclick="updateConversationStatus({{ conversation.id }}, 'closed')">
                                                                    <i class="fas fa-times text-secondary"></i> Cerrar
                                                                </a></li>
                                                                <li><hr class="dropdown-divider"></li>
                                                                <li><a class="dropdown-item" href="#" onclick="updateConversationStatus({{ conversation.id }}, 'open')">
                                                                    <i class="fas fa-redo text-warning"></i> Reabrir
                                                                </a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- PaginaciÃ³n -->
                                {% if conversations.has_other_pages %}
                                <nav aria-label="PaginaciÃ³n de conversaciones" class="mt-4">
                                    <ul class="pagination justify-content-center">
                                        {% if conversations.has_previous %}
                                            <li class="page-item">
                                                <a class="page-link" href="?view=mensajes&page={{ conversations.previous_page_number }}">Anterior</a>
                                            </li>
                                        {% endif %}
                                        
                                        {% for num in conversations.paginator.page_range %}
                                            {% if conversations.number == num %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ num }}</span>
                                                </li>
                                            {% else %}
                                                <li class="page-item">
                                                    <a class="page-link" href="?view=mensajes&page={{ num }}">{{ num }}</a>
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if conversations.has_next %}
                                            <li class="page-item">
                                                <a class="page-link" href="?view=mensajes&page={{ conversations.next_page_number }}">Siguiente</a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </nav>
                                {% endif %}

                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-comment-slash text-muted" style="font-size: 4rem;"></i>
                                    <h4 class="text-muted mt-3">No hay conversaciones</h4>
                                    <p class="text-muted">Las conversaciones con usuarios aparecerÃ¡n aquÃ­ cuando se registren consultas.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

            {% elif request.GET.view == "notificaciones_stock" %}
                <!-- Vista de Notificaciones de Stock - DiseÃ±o Moderno con Tailwind -->
                <div class="stock-notifications-dashboard">
                    <!-- Header con Gradiente -->
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center">
                            <div class="text-white">
                                <h2 class="text-3xl font-bold flex items-center gap-3">
                                    <i class="fas fa-bell"></i>
                                    Notificaciones de Stock
                                </h2>
                                <p class="text-purple-100 mt-2">
                                    Gestiona las solicitudes de notificaciÃ³n de usuarios cuando los productos estÃ©n disponibles
                                </p>
                            </div>
                            <button onclick="location.reload()" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-purple-50 transition-all shadow-md hover:shadow-lg">
                                <i class="fas fa-sync-alt mr-2"></i>Actualizar
                            </button>
                        </div>
                    </div>

                    <!-- EstadÃ­sticas con Tailwind -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-semibold uppercase">Total</p>
                                    <h3 class="text-3xl font-bold text-gray-800">{{ stock_notifications_stats.total|default:0 }}</h3>
                                </div>
                                <div class="bg-blue-100 p-4 rounded-full">
                                    <i class="fas fa-bell text-blue-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500 hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-semibold uppercase">Pendientes</p>
                                    <h3 class="text-3xl font-bold text-gray-800">{{ stock_notifications_stats.pending|default:0 }}</h3>
                                </div>
                                <div class="bg-yellow-100 p-4 rounded-full">
                                    <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-semibold uppercase">Enviadas</p>
                                    <h3 class="text-3xl font-bold text-gray-800">{{ stock_notifications_stats.sent|default:0 }}</h3>
                                </div>
                                <div class="bg-green-100 p-4 rounded-full">
                                    <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500 hover:shadow-xl transition-shadow">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-semibold uppercase">Hoy</p>
                                    <h3 class="text-3xl font-bold text-gray-800">{{ stock_notifications_stats.today|default:0 }}</h3>
                                </div>
                                <div class="bg-purple-100 p-4 rounded-full">
                                    <i class="fas fa-calendar-day text-purple-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros con Tailwind -->
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <h5 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-filter text-indigo-600"></i>
                            Filtros
                        </h5>
                        <form method="GET" class="flex flex-wrap gap-4">
                            <input type="hidden" name="view" value="notificaciones_stock">
                            
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                                <select name="status_filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">Todos</option>
                                    <option value="pending" {% if request.GET.status_filter == 'pending' %}selected{% endif %}>Pendiente</option>
                                    <option value="sent" {% if request.GET.status_filter == 'sent' %}selected{% endif %}>Enviada</option>
                                    <option value="failed" {% if request.GET.status_filter == 'failed' %}selected{% endif %}>Fallida</option>
                                </select>
                            </div>

                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select name="type_filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">Todos</option>
                                    <option value="stock_available" {% if request.GET.type_filter == 'stock_available' %}selected{% endif %}>Producto Disponible</option>
                                    <option value="price_drop" {% if request.GET.type_filter == 'price_drop' %}selected{% endif %}>Bajada de Precio</option>
                                    <option value="back_in_stock" {% if request.GET.type_filter == 'back_in_stock' %}selected{% endif %}>Regreso en Stock</option>
                                </select>
                            </div>

                            <div class="flex items-end">
                                <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                                    <i class="fas fa-search mr-2"></i>Filtrar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Tabla de Notificaciones con Tailwind -->
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                            <h5 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-list text-indigo-600"></i>
                                Lista de Notificaciones
                            </h5>
                        </div>
                        
                        {% if stock_notifications %}
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100 border-b border-gray-200">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Usuario</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Producto</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha Registro</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    {% for notification in stock_notifications %}
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold shadow-md">
                                                    {{ notification.email|first|upper }}
                                                </div>
                                                <div>
                                                    <p class="font-semibold text-gray-800">{{ notification.email }}</p>
                                                    {% if notification.user %}
                                                        <p class="text-sm text-gray-500">{{ notification.user.username }}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-3">
                                                {% if notification.product.imagen %}
                                                    <img src="{{ notification.product.imagen.url }}" alt="{{ notification.product.name }}" class="w-12 h-12 rounded-lg object-cover shadow">
                                                {% else %}
                                                    <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center">
                                                        <i class="fas fa-box text-gray-400"></i>
                                                    </div>
                                                {% endif %}
                                                <div>
                                                    <p class="font-semibold text-gray-800">{{ notification.product.name|truncatechars:40 }}</p>
                                                    <p class="text-sm text-gray-500">${{ notification.product.price|floatformat:0 }}</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold
                                                {% if notification.notification_type == 'stock_available' %}bg-blue-100 text-blue-700
                                                {% elif notification.notification_type == 'price_drop' %}bg-green-100 text-green-700
                                                {% elif notification.notification_type == 'back_in_stock' %}bg-purple-100 text-purple-700
                                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                                <i class="fas fa-{% if notification.notification_type == 'stock_available' %}box{% elif notification.notification_type == 'price_drop' %}tag{% else %}sync{% endif %}"></i>
                                                {{ notification.get_notification_type_display }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold
                                                {% if notification.status == 'pending' %}bg-yellow-100 text-yellow-700
                                                {% elif notification.status == 'sent' %}bg-green-100 text-green-700
                                                {% else %}bg-red-100 text-red-700{% endif %}">
                                                <i class="fas fa-{% if notification.status == 'pending' %}clock{% elif notification.status == 'sent' %}check{% else %}times{% endif %}"></i>
                                                {{ notification.get_status_display }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm">
                                                <p class="font-medium text-gray-800">{{ notification.created_at|date:"d/m/Y" }}</p>
                                                <p class="text-gray-500">{{ notification.created_at|time:"H:i" }}</p>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex gap-2">
                                                {% if notification.status == 'pending' %}
                                                <button onclick="markAsNotified({{ notification.id }})" 
                                                        class="bg-green-600 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors">
                                                    <i class="fas fa-paper-plane mr-1"></i>Notificar
                                                </button>
                                                {% endif %}
                                                <button onclick="viewNotificationDetails({{ notification.id }})" 
                                                        class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition-colors">
                                                    <i class="fas fa-eye mr-1"></i>Ver
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- PaginaciÃ³n con Tailwind -->
                        {% if stock_notifications_page.has_other_pages %}
                        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
                            <nav class="flex items-center justify-between">
                                <div class="flex gap-2">
                                    {% if stock_notifications_page.has_previous %}
                                        <a href="?view=notificaciones_stock&page={{ stock_notifications_page.previous_page_number }}{% if request.GET.status_filter %}&status_filter={{ request.GET.status_filter }}{% endif %}{% if request.GET.type_filter %}&type_filter={{ request.GET.type_filter }}{% endif %}" 
                                           class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                                            Anterior
                                        </a>
                                    {% endif %}
                                </div>
                                
                                <div class="flex gap-2">
                                    {% for num in stock_notifications_page.paginator.page_range %}
                                        {% if stock_notifications_page.number == num %}
                                            <span class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium">{{ num }}</span>
                                        {% else %}
                                            <a href="?view=notificaciones_stock&page={{ num }}{% if request.GET.status_filter %}&status_filter={{ request.GET.status_filter }}{% endif %}{% if request.GET.type_filter %}&type_filter={{ request.GET.type_filter }}{% endif %}" 
                                               class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                                                {{ num }}
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                <div class="flex gap-2">
                                    {% if stock_notifications_page.has_next %}
                                        <a href="?view=notificaciones_stock&page={{ stock_notifications_page.next_page_number }}{% if request.GET.status_filter %}&status_filter={{ request.GET.status_filter }}{% endif %}{% if request.GET.type_filter %}&type_filter={{ request.GET.type_filter }}{% endif %}" 
                                           class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                                            Siguiente
                                        </a>
                                    {% endif %}
                                </div>
                            </nav>
                        </div>
                        {% endif %}

                        {% else %}
                        <div class="text-center py-16">
                            <div class="inline-flex items-center justify-center w-20 h-20 bg-gray-100 rounded-full mb-4">
                                <i class="fas fa-bell-slash text-gray-400 text-3xl"></i>
                            </div>
                            <h4 class="text-xl font-semibold text-gray-800 mb-2">No hay notificaciones</h4>
                            <p class="text-gray-500">Las solicitudes de notificaciÃ³n de stock aparecerÃ¡n aquÃ­ cuando los usuarios las registren.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

            {% elif request.GET.view == "wompi_config" %}
            <!-- Vista de configuracion de wompi -->
             <div class="container mt-4">
                    <div class="row">
                        <div class="col-lg-8 offset-lg-2">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h3 class="mb-0"><i class="fas fa-credit-card me-2"></i>ConfiguraciÃ³n de Wompi Payment Gateway</h3>
                                </div>
                                <div class="card-body">
                                    {% if messages %}
                                    <div class="mb-3">
                                      {% for message in messages %}
                                         <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                         </div>
                                      {% endfor %}
                                    </div>
                                    {% endif %}

                                    <form method="post">
                                        {% csrf_token %}
                                        
                                        <!-- Public Key -->
                                        <div class="mb-4">
                                            <label for="public_key" class="form-label fw-bold">
                                                <i class="fas fa-key me-2"></i>Public Key (Clave PÃºblica)
                                            </label>
                                            <input type="text" 
                                                   class="form-control form-control-lg" 
                                                   id="public_key" 
                                                   name="public_key" 
                                                   value="{{ config.public_key }}" 
                                                   placeholder="pub_test_xxxxxxxxxx"
                                                   required>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Clave pÃºblica proporcionada por Wompi. Visible en el frontend.
                                            </div>
                                        </div>

                                        <!-- Private Key -->
                                        <div class="mb-4">
                                            <label for="private_key" class="form-label fw-bold">
                                                <i class="fas fa-lock me-2"></i>Private Key (Clave Privada)
                                            </label>
                                            <input type="password" 
                                                   class="form-control form-control-lg" 
                                                   id="private_key" 
                                                   name="private_key" 
                                                   value="{{ config.private_key }}" 
                                                   placeholder="prv_test_xxxxxxxxxx"
                                                   required>
                                            <div class="form-text">
                                                <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                                                <strong>Â¡MantÃ©n esta clave segura!</strong> Solo debe usarse en el servidor.
                                            </div>
                                        </div>

                                        <!-- Environment -->
                                        <div class="mb-4">
                                            <label for="environment" class="form-label fw-bold">
                                                <i class="fas fa-server me-2"></i>Ambiente
                                            </label>
                                            <select class="form-select form-select-lg" id="environment" name="environment">
                                                <option value="production" {% if config.environment == 'production' %}selected{% endif %}>ðŸŸ¢ ProducciÃ³n (Pagos Reales)</option>
                                                <option value="test" {% if config.environment == 'test' %}selected{% endif %}>ðŸ§ª Pruebas (Sandbox)</option>
                                            </select>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                <strong>ProducciÃ³n:</strong> Procesa pagos reales. <strong>Pruebas:</strong> Para desarrollo y testing.
                                            </div>
                                        </div>

                                        <!-- Base URL -->
                                        <div class="mb-4">
                                            <label for="base_url" class="form-label fw-bold">
                                                <i class="fas fa-link me-2"></i>Base URL de API
                                            </label>
                                            <input type="url" 
                                                   class="form-control form-control-lg" 
                                                   id="base_url" 
                                                   name="base_url" 
                                                   value="{{ config.base_url }}" 
                                                   placeholder="https://production.wompi.co/v1"
                                                   required>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                URL base de la API de Wompi. Generalmente: <code>https://production.wompi.co/v1</code>
                                            </div>
                                        </div>

                                        <!-- Activar/Desactivar -->
                                        <div class="mb-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="is_active" 
                                                       name="is_active"
                                                       {% if config.is_active %}checked{% endif %}>
                                                <label class="form-check-label fw-bold" for="is_active">
                                                    <i class="fas fa-power-off me-2"></i>Activar Wompi como mÃ©todo de pago
                                                </label>
                                            </div>
                                            <div class="form-text">
                                                Desactiva temporalmente Wompi sin perder la configuraciÃ³n
                                            </div>
                                        </div>

                                        <!-- Botones -->
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='?view=usuarios'">
                                                <i class="fas fa-times me-2"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i>Guardar ConfiguraciÃ³n
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Info adicional -->
                            <div class="alert alert-info mt-4">
                                <h5 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>InformaciÃ³n Importante</h5>
                                <ul class="mb-0">
                                    <li><strong>ObtÃ©n tus claves:</strong> RegÃ­strate en <a href="https://comercios.wompi.co/" target="_blank" class="alert-link">Wompi Comercios</a></li>
                                    <li><strong>Ambiente de pruebas:</strong> Usa las claves de test para desarrollo</li>
                                    <li><strong>ProducciÃ³n:</strong> Verifica tu cuenta antes de activar pagos reales</li>
                                    <li><strong>Seguridad:</strong> Nunca compartas tu clave privada</li>
                                    <li><strong>DocumentaciÃ³n:</strong> <a href="https://docs.wompi.co/" target="_blank" class="alert-link">docs.wompi.co</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
             </div>

             {% elif request.GET.view == "whatsapp_config" %}
             <!-- Vista de configuracion de WhatsApp -->
             <div class="container mt-4">
                    <div class="row">
                        <div class="col-lg-8 offset-lg-2">
                            <div class="card shadow-sm">
                                <div class="card-header bg-success text-white">
                                    <h3 class="mb-0"><i class="fab fa-whatsapp me-2"></i>ConfiguraciÃ³n de WhatsApp Business</h3>
                                </div>
                                <div class="card-body">
                                    {% if messages %}
                                    <div class="mb-3">
                                      {% for message in messages %}
                                         <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                         </div>
                                      {% endfor %}
                                    </div>
                                    {% endif %}

                                    <form method="post">
                                        {% csrf_token %}
                                        
                                        <!-- NÃºmero de WhatsApp -->
                                        <div class="mb-4">
                                            <label for="admin_phone" class="form-label fw-bold">
                                                <i class="fas fa-phone me-2"></i>NÃºmero de WhatsApp del Administrador
                                            </label>
                                            <input type="text" 
                                                   class="form-control form-control-lg" 
                                                   id="admin_phone" 
                                                   name="admin_phone" 
                                                   value="{{ whatsapp_config.admin_phone }}" 
                                                   placeholder="+573001234567"
                                                   pattern="\+[0-9]{10,15}"
                                                   required>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Formato: +57 seguido del nÃºmero (incluir cÃ³digo de paÃ­s). Ejemplo: +573001234567
                                            </div>
                                        </div>

                                        <!-- Tipos de Notificaciones -->
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-bell me-2"></i>Â¿CuÃ¡ndo quieres recibir notificaciones?
                                            </label>
                                            
                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="notify_new_order" 
                                                       name="notify_new_order"
                                                       {% if whatsapp_config.notify_new_order %}checked{% endif %}>
                                                <label class="form-check-label" for="notify_new_order">
                                                    <strong>Nuevos Pedidos</strong> - Recibe un mensaje cuando alguien hace un pedido
                                                </label>
                                            </div>

                                            <div class="form-check form-switch mb-2">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="notify_status_change" 
                                                       name="notify_status_change"
                                                       {% if whatsapp_config.notify_status_change %}checked{% endif %}>
                                                <label class="form-check-label" for="notify_status_change">
                                                    <strong>Cambios de Estado</strong> - Notificaciones cuando actualizas el estado de un pedido
                                                </label>
                                            </div>

                                            <div class="form-check form-switch">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="notify_low_stock" 
                                                       name="notify_low_stock"
                                                       {% if whatsapp_config.notify_low_stock %}checked{% endif %}>
                                                <label class="form-check-label" for="notify_low_stock">
                                                    <strong>Stock Bajo</strong> - Alerta cuando un producto tiene poco inventario
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Plantilla de Mensaje -->
                                        <div class="mb-4">
                                            <label for="message_template" class="form-label fw-bold">
                                                <i class="fas fa-message me-2"></i>Plantilla del Mensaje
                                            </label>
                                            <textarea class="form-control" 
                                                      id="message_template" 
                                                      name="message_template" 
                                                      rows="8"
                                                      required>{{ whatsapp_config.message_template }}</textarea>
                                            <div class="form-text">
                                                <i class="fas fa-code me-1"></i>
                                                Variables disponibles: <code>{order_id}</code>, <code>{customer_name}</code>, 
                                                <code>{customer_phone}</code>, <code>{total}</code>, <code>{payment_method}</code>, 
                                                <code>{address}</code>
                                            </div>
                                        </div>

                                        <!-- Activar/Desactivar -->
                                        <div class="mb-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       id="is_active" 
                                                       name="is_active"
                                                       {% if whatsapp_config.is_active %}checked{% endif %}>
                                                <label class="form-check-label fw-bold" for="is_active">
                                                    <i class="fas fa-power-off me-2"></i>Activar Sistema de Notificaciones
                                                </label>
                                            </div>
                                            <div class="form-text">
                                                Puedes desactivar temporalmente las notificaciones sin perder tu configuraciÃ³n
                                            </div>
                                        </div>

                                        <!-- Botones -->
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='?view=usuarios'">
                                                <i class="fas fa-times me-2"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-save me-2"></i>Guardar ConfiguraciÃ³n
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Info adicional -->
                            <div class="alert alert-info mt-4">
                                <h5 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>InformaciÃ³n Importante</h5>
                                <ul class="mb-0">
                                    <li>AsegÃºrate de que el nÃºmero de WhatsApp estÃ© activo y pueda recibir mensajes</li>
                                    <li>Incluye el cÃ³digo de paÃ­s en el formato internacional (+57 para Colombia)</li>
                                    <li>Las notificaciones se enviarÃ¡n automÃ¡ticamente segÃºn tu configuraciÃ³n</li>
                                    <li>Puedes personalizar el mensaje usando las variables disponibles</li>
                                </ul>
                            </div>
                        </div>
                    </div>
             </div>

            {% elif request.GET.view == "datos_tienda" %}
            <!-- Vista de Datos de mi Tienda -->
             <div class="container mt-4">
                    <div class="row">
                        <div class="col-lg-10 offset-lg-1">
                            <div class="card shadow-sm">
                                <div class="card-header bg-info text-white">
                                    <h3 class="mb-0"><i class="fas fa-store me-2"></i>InformaciÃ³n de Mi Tienda</h3>
                                </div>
                                <div class="card-body">
                                    {% if messages %}
                                    <div class="mb-3">
                                      {% for message in messages %}
                                         <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                         </div>
                                      {% endfor %}
                                    </div>
                                    {% endif %}

                                    <form method="post" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        
                                        <div class="row">
                                            <!-- InformaciÃ³n BÃ¡sica -->
                                            <div class="col-md-6">
                                                <h5 class="mb-3"><i class="fas fa-building me-2"></i>InformaciÃ³n BÃ¡sica</h5>
                                                
                                                <div class="mb-3">
                                                    <label for="nombre_tienda" class="form-label fw-bold">Nombre de la Tienda</label>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           id="nombre_tienda" 
                                                           name="nombre_tienda" 
                                                           value="{{ store_config.nombre_tienda }}"
                                                           placeholder="Nombre de tu tienda"
                                                           required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="slogan" class="form-label fw-bold">Slogan</label>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           id="slogan" 
                                                           name="slogan" 
                                                           value="{{ store_config.slogan }}"
                                                           placeholder="Tu slogan aquÃ­">
                                                </div>

                                                <div class="mb-3">
                                                    <label for="email_tienda" class="form-label fw-bold">Email de Contacto</label>
                                                    <input type="email" 
                                                           class="form-control" 
                                                           id="email_tienda" 
                                                           name="email_tienda" 
                                                           value="{{ store_config.email_tienda }}"
                                                           placeholder="contacto@tienda.com">
                                                </div>

                                                <div class="mb-3">
                                                    <label for="telefono_tienda" class="form-label fw-bold">TelÃ©fono</label>
                                                    <input type="tel" 
                                                           class="form-control" 
                                                           id="telefono_tienda" 
                                                           name="telefono_tienda" 
                                                           value="{{ store_config.telefono_tienda }}"
                                                           placeholder="+57 300 123 4567">
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="logo" class="form-label fw-bold"><i class="fas fa-image me-2"></i>Logo de la Tienda</label>
                                                    {% if store_config.logo %}
                                                    <div class="mb-2">
                                                        <img src="{{ store_config.logo.url }}" alt="Logo actual" class="img-thumbnail" style="max-height: 100px;">
                                                        <small class="d-block text-muted">Logo actual</small>
                                                    </div>
                                                    {% endif %}
                                                    <input type="file" 
                                                           class="form-control" 
                                                           id="logo" 
                                                           name="logo"
                                                           accept="image/*">
                                                    <div class="form-text">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        Formato recomendado: PNG o JPG, mÃ¡ximo 2MB
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- UbicaciÃ³n y Redes -->
                                            <div class="col-md-6">
                                                <h5 class="mb-3"><i class="fas fa-map-marker-alt me-2"></i>UbicaciÃ³n</h5>
                                                
                                                <div class="mb-3">
                                                    <label for="direccion_tienda" class="form-label fw-bold">DirecciÃ³n</label>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           id="direccion_tienda" 
                                                           name="direccion_tienda" 
                                                           value="{{ store_config.direccion_tienda }}"
                                                           placeholder="Calle Principal #123">
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="ciudad_tienda" class="form-label fw-bold">Ciudad</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               id="ciudad_tienda" 
                                                               name="ciudad_tienda" 
                                                               value="{{ store_config.ciudad_tienda }}"
                                                               placeholder="Tu ciudad">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="pais_tienda" class="form-label fw-bold">PaÃ­s</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               id="pais_tienda" 
                                                               name="pais_tienda" 
                                                               value="{{ store_config.pais_tienda }}"
                                                               placeholder="Colombia">
                                                    </div>
                                                </div>

                                                
                                                
                                                <div class="mb-3">
                                                    <label for="whatsapp" class="form-label"><i class="fab fa-whatsapp me-1"></i> WhatsApp Comercial</label>
                                                    <input type="tel" 
                                                           class="form-control" 
                                                           id="whatsapp" 
                                                           name="whatsapp" 
                                                           value="{{ store_config.whatsapp }}"
                                                           placeholder="+57 300 123 4567">
                                                    <div class="form-text">
                                                        Formato: +57XXXXXXXXXX (para botÃ³n de contacto en la tienda)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Horarios -->
                                        <div class="row mt-4">
                                            <div class="col-12">
                                                <h5 class="mb-3"><i class="fas fa-clock me-2"></i>Horario de AtenciÃ³n</h5>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="horario_semana" class="form-label fw-bold">Lunes a Viernes</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               id="horario_semana" 
                                                               name="horario_semana" 
                                                               value="{{ store_config.horario_semana }}"
                                                               placeholder="8:00 AM - 6:00 PM">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="horario_sabado" class="form-label fw-bold">SÃ¡bados</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               id="horario_sabado" 
                                                               name="horario_sabado" 
                                                               value="{{ store_config.horario_sabado }}"
                                                               placeholder="9:00 AM - 2:00 PM">
                                                    </div>
                                                    <div class="col-md-12 mb-3">
                                                        <label for="horario_domingo" class="form-label fw-bold">Domingos y Festivos</label>
                                                        <input type="text" 
                                                               class="form-control" 
                                                               id="horario_domingo" 
                                                               name="horario_domingo" 
                                                               value="{{ store_config.horario_domingo }}"
                                                               placeholder="Cerrado">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Botones -->
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='?view=usuarios'">
                                                <i class="fas fa-times me-2"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-info text-white">
                                                <i class="fas fa-save me-2"></i>Guardar InformaciÃ³n
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Info adicional -->
                            <div class="alert alert-success mt-4">
                                <h5 class="alert-heading"><i class="fas fa-check-circle me-2"></i>InformaciÃ³n de la Tienda</h5>
                                <ul class="mb-0">
                                    <li><strong>Personaliza tu tienda:</strong> Configura el nombre, logo y datos de contacto</li>
                                    <li><strong>Redes sociales:</strong> Agrega tus perfiles para que los clientes te encuentren</li>
                                    <li><strong>Horarios:</strong> Informa a tus clientes cuÃ¡ndo estÃ¡s disponible</li>
                                    <li><strong>Logo:</strong> Sube tu logo para que aparezca en tu tienda</li>
                                </ul>
                            </div>
                        </div>
                    </div>
             </div>

            {% endif %}
        </main>
    </div>
    

    <!--modal crear tipo-->
    <div class="modal fade" id="modalNuevoTipo" tabindex="-1" aria-labelledby="modalNuevoTipoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'crear_tipo' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalNuevoTipoLabel">Crear nuevo tipo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <label for="nombre_tipo">Nombre del tipo:</label>
                        <input type="text" class="form-control" id="nombre_tipo" name="nombre" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para crear nuevas categorÃ­as -->
    <div class="modal fade" id="modalNuevaCategoria" tabindex="-1" aria-labelledby="modalNuevaCategoriaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="create-category-form">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalNuevaCategoriaLabel">Crear nueva categorÃ­a</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nombre_categoria" class="form-label">Nombre de la categorÃ­a:</label>
                            <input type="text" class="form-control" id="nombre_categoria" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="slug_categoria" class="form-label">Slug:</label>
                            <input type="text" class="form-control" id="slug_categoria" name="slug" required>
                            <div class="form-text">URL amigable para la categorÃ­a (ej: electronica, computadoras)</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar categorÃ­as -->
    <div class="modal fade" id="modalEditarCategoria" tabindex="-1" aria-labelledby="modalEditarCategoriaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="edit-category-form">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarCategoriaLabel">Editar categorÃ­a</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit_categoria_id" name="categoria_id">
                        <div class="mb-3">
                            <label for="edit_nombre_categoria" class="form-label">Nombre de la categorÃ­a:</label>
                            <input type="text" class="form-control" id="edit_nombre_categoria" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_slug_categoria" class="form-label">Slug:</label>
                            <input type="text" class="form-control" id="edit_slug_categoria" name="slug" required>
                            <div class="form-text">URL amigable para la categorÃ­a (ej: electronica, computadoras)</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            Actualizar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar eliminaciÃ³n de categorÃ­a -->
    <div class="modal fade" id="modalEliminarCategoria" tabindex="-1" aria-labelledby="modalEliminarCategoriaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEliminarCategoriaLabel">Confirmar eliminaciÃ³n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle text-warning me-3" style="font-size: 2rem;"></i>
                        <div>
                            <p class="mb-1">Â¿EstÃ¡s seguro de que deseas eliminar la categorÃ­a?</p>
                            <strong id="delete-category-name" class="text-danger"></strong>
                            <p class="small text-muted mt-2 mb-0">Esta acciÃ³n no se puede deshacer.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="confirm-delete-category" class="btn btn-danger">
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear nuevos proveedores -->
    <div class="modal fade" id="modalNuevoProveedor" tabindex="-1" aria-labelledby="modalNuevoProveedorLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'create_proveedor' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalNuevoProveedorLabel">Crear nuevo proveedor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="nombre_proveedor">Nombre del proveedor:</label>
          <input type="text" class="form-control" id="nombre_proveedor" name="nombre" required>
            <label for="cedula_proveedor">CÃ©dula:</label>
            <input type="text" class="form-control" id="cedula_proveedor" name="cedulaOnita" >
            <label for="email_proveedor">Email:</label>
            <input type="email" class="form-control" id="email_proveedor" name="email" >
            <label for="telefono_proveedor">TelÃ©fono:</label>
            <input type="text" class="form-control" id="telefono_proveedor" name="telefono" >
            <label for="direccion_proveedor">DirecciÃ³n:</label>
            <input type="text" class="form-control" id="direccion_proveedor" name="direccion" >

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>
    <!-- Modal para editar usuario (Bootstrap) -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="modal-title" id="editUserModalLabel">
                        <i class="fas fa-user-edit me-2"></i>Editar Usuario
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editForm" method="post">
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" name="user_id" id="modal_user_id" />
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="fas fa-user me-1 text-primary"></i>Username *</label>
                                <input type="text" name="username" id="modal_username" class="form-control" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="fas fa-envelope me-1 text-primary"></i>Email *</label>
                                <input type="email" name="email" id="modal_email" class="form-control" required />
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label fw-semibold"><i class="fas fa-lock me-1 text-warning"></i>ContraseÃ±a</label>
                            <input type="password" name="password" id="modal_password" class="form-control" placeholder="Dejar en blanco para no cambiar" />
                            <small class="text-muted">Solo completa este campo si deseas cambiar la contraseÃ±a</small>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="fas fa-phone me-1 text-success"></i>Celular</label>
                                <input type="text" name="celular" id="modal_celular" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="fas fa-map-marker-alt me-1 text-danger"></i>Ciudad</label>
                                <input type="text" name="ciudad" id="modal_ciudad" class="form-control" />
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label fw-semibold"><i class="fas fa-home me-1 text-info"></i>DirecciÃ³n</label>
                            <input type="text" name="direccion" id="modal_direccion" class="form-control" />
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="fas fa-globe me-1 text-primary"></i>PaÃ­s</label>
                                <input type="text" name="pais" id="modal_pais" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="fas fa-mail-bulk me-1 text-secondary"></i>CÃ³digo Postal</label>
                                <input type="text" name="codigo_postal" id="modal_codigo_postal" class="form-control" />
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold"><i class="fas fa-calendar-plus me-1 text-info"></i>Fecha de CreaciÃ³n</label>
                                <input type="date" name="created_at" id="modal_created_at" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold"><i class="fas fa-birthday-cake me-1 text-warning"></i>Fecha de Nacimiento</label>
                                <input type="date" name="fecha_nacimiento" id="modal_fecha_nacimiento" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold"><i class="fas fa-venus-mars me-1 text-purple"></i>GÃ©nero</label>
                                <select name="genero" id="modal_genero" class="form-select">
                                    <option value="">Seleccionar</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Femenino</option>
                                    <option value="O">Otro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal antiguo para compatibilidad (oculto) -->
    <div id="editModal" class="modal1" style="display: none;">
        <div class="modal-content1">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h3>Editar Usuario</h3>
            <form id="editForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="user_id" id="modal_user_id" />
                <label>Username:</label>
                <input type="text" name="username" id="modal_username" required />
                <label>Email:</label>
                <input type="email" name="email" id="modal_email" required />
                <label>ContraseÃ±a (dejar en blanco para no cambiar):</label>
                <input type="password" name="password" id="modal_password" />
                <label>Celular:</label>
                <input type="text" name="celular" id="modal_celular" />
                <label>DirecciÃ³n:</label>
                <input type="text" name="direccion" id="modal_direccion" />
                <label>Ciudad:</label>
                <input type="text" name="ciudad" id="modal_ciudad" />
                <label>PaÃ­s:</label>
                <input type="text" name="pais" id="modal_pais" />
                <label>CÃ³digo postal:</label>
                <input type="text" name="codigo_postal" id="modal_codigo_postal" />
                <label>Fecha de creaciÃ³n:</label>
                <input type="date" name="created_at" id="modal_created_at" />
                <label>Fecha de nacimiento:</label>
                <input type="date" name="fecha_nacimiento" id="modal_fecha_nacimiento" />
                <label>GÃ©nero:</label>
                <input type="text" name="genero" id="modal_genero" />
                <button type="submit">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Modal para ver detalles de ventas por categorÃ­a -->
    <div class="modal fade" id="modalDetalleCategoriaVentas" tabindex="-1" aria-labelledby="modalDetalleCategoriaVentasLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDetalleCategoriaVentasLabel">
                        <i class="fas fa-chart-bar me-2"></i>Detalles de Ventas - <span id="modal-categoria-nombre"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card bg-success text-white text-center">
                                <div class="card-body">
                                    <h5 id="modal-categoria-ingresos">$0</h5>
                                    <small>Ingresos Totales</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white text-center">
                                <div class="card-body">
                                    <h5 id="modal-categoria-productos">0</h5>
                                    <small>Productos Vendidos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-white text-center">
                                <div class="card-body">
                                    <h5 id="modal-categoria-pedidos">0</h5>
                                    <small>Pedidos</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h6><i class="fas fa-list me-2"></i>Productos mÃ¡s vendidos en esta categorÃ­a:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="modal-productos-detalle">
                                <!-- Se llenarÃ¡ dinÃ¡micamente con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <a href="?view=ventas" class="btn btn-primary">
                        <i class="fas fa-chart-line"></i> Ver AnÃ¡lisis Completo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES DE BONOS DE DESCUENTO -->
    <!-- Modal para crear nuevo bono -->
    <div class="modal fade" id="modalNuevoBono" tabindex="-1" aria-labelledby="modalNuevoBonoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="post" id="formNuevoBono">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="crear_bono">
                    
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalNuevoBonoLabel">
                            <i class="fas fa-plus me-2"></i>Crear Nuevo Bono de Descuento
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="codigo" class="form-label">CÃ³digo del Bono <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="codigo" id="codigo" 
                                           placeholder="ej: DESCUENTO50, NAVIDAD2025" required>
                                    <div class="form-text">CÃ³digo Ãºnico que usarÃ¡n los clientes</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="descripcion" class="form-label">DescripciÃ³n <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="descripcion" id="descripcion" 
                                           placeholder="DescripciÃ³n interna del bono" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tipo_descuento" class="form-label">Tipo de Descuento <span class="text-danger">*</span></label>
                                    <select class="form-select" name="tipo_descuento" id="tipo_descuento" required>
                                        <option value="porcentaje">Porcentaje (%)</option>
                                        <option value="fijo">Valor Fijo ($)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="valor_descuento" class="form-label">Valor del Descuento <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="valor_descuento" id="valor_descuento" 
                                           min="0" step="0.01" placeholder="ej: 50 o 10000" required>
                                    <div class="form-text" id="descuentoHelp">Ingresa el porcentaje (0-100) o valor fijo</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="valor_minimo_compra" class="form-label">Compra MÃ­nima</label>
                                    <input type="number" class="form-control" name="valor_minimo_compra" id="valor_minimo_compra" 
                                           min="0" step="0.01" value="0" placeholder="0">
                                    <div class="form-text">Valor mÃ­nimo para aplicar el descuento</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="usos_maximos" class="form-label">Usos MÃ¡ximos <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="usos_maximos" id="usos_maximos" 
                                           min="1" value="1" required>
                                    <div class="form-text">NÃºmero mÃ¡ximo de veces que se puede usar</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fecha_inicio" class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" name="fecha_inicio" id="fecha_inicio" required>
                                    <div class="form-text">Puede ser desde 5 minutos atrÃ¡s hasta fechas futuras</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fecha_fin" class="form-label">Fecha de Fin <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" name="fecha_fin" id="fecha_fin" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="activo" id="activo" checked>
                                <label class="form-check-label" for="activo">
                                    Bono activo
                                </label>
                                <div class="form-text">Si estÃ¡ desactivado, no se podrÃ¡ usar aunque estÃ© dentro de vigencia</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Crear Bono
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar bono -->
    <div class="modal fade" id="modalEditarBono" tabindex="-1" aria-labelledby="modalEditarBonoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form method="post" id="formEditarBono">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="editar_bono">
                    <input type="hidden" name="bono_id" id="edit_bono_id">
                    
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarBonoLabel">
                            <i class="fas fa-edit me-2"></i>Editar Bono de Descuento
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    
                    <div class="modal-body" id="editBonoModalBody">
                        <!-- Se llenarÃ¡ dinÃ¡micamente con JavaScript -->
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para ver conversaciones completas -->
    <div class="modal fade" id="conversationModal" tabindex="-1" aria-labelledby="conversationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="conversationModalLabel">
                        <i class="fas fa-comments"></i> <span id="conversation-title">ConversaciÃ³n</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="conversationContent">
                        <!-- InformaciÃ³n de la conversaciÃ³n -->
                        <div class="conversation-header p-3 bg-light border-bottom">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-1">
                                        <i class="fas fa-user"></i> <span id="conv-user-name">Usuario</span>
                                    </h6>
                                    <p class="mb-0 text-muted small" id="conv-user-email">email@ejemplo.com</p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <span class="badge" id="conv-status-badge">Estado</span>
                                    <br><small class="text-muted" id="conv-created-date">Fecha</small>
                                </div>
                            </div>
                            <div class="row mt-2" id="conv-order-info" style="display: none;">
                                <div class="col-12">
                                    <div class="alert alert-info mb-0 py-2">
                                        <i class="fas fa-shopping-cart"></i> 
                                        <strong>Relacionado con pedido:</strong> 
                                        <span id="conv-order-number">#123</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Lista de mensajes -->
                        <div class="messages-container p-3" style="max-height: 400px; overflow-y: auto;">
                            <div id="messages-list">
                                <!-- Los mensajes se cargarÃ¡n dinÃ¡micamente -->
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando mensajes...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formulario para responder -->
                        <div class="response-form p-3 bg-light border-top">
                            <form id="responseForm">
                                <div class="mb-3">
                                    <label for="admin-response" class="form-label">
                                        <i class="fas fa-reply"></i> Tu Respuesta:
                                    </label>
                                    <textarea class="form-control" id="admin-response" rows="3" 
                                              placeholder="Escribe tu respuesta aquÃ­..." required></textarea>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="mark-resolved">
                                            <label class="form-check-label" for="mark-resolved">
                                                Marcar como resuelta despuÃ©s de enviar
                                            </label>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i> Enviar Respuesta
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-warning btn-sm" 
                                onclick="updateConversationStatusInModal('in_progress')">
                            <i class="fas fa-play"></i> En Progreso
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" 
                                onclick="updateConversationStatusInModal('resolved')">
                            <i class="fas fa-check"></i> Resuelta
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                onclick="updateConversationStatusInModal('closed')">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"> </script>.
  <!-- Bootstrap Bundle JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"></script>
    
    <!-- Scripts Base del Dashboard -->
    <script src="{% static 'js/dashboard.js' %}"></script>
    
    <!-- Scripts de Inventario (selector de categorÃ­a) -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Debug para verificar que el menÃº mÃ³vil funcione
        console.log('ðŸ“± Verificando elementos del menÃº mÃ³vil...');
        
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileHeader = document.querySelector('.mobile-header');
        
        if (mobileHeader) {
          console.log('âœ… Mobile header encontrado');
        } else {
          console.error('âŒ Mobile header NO encontrado');
        }
        
        if (mobileMenuBtn) {
          console.log('âœ… BotÃ³n menÃº mÃ³vil encontrado');
          
          // Test adicional para el botÃ³n
          mobileMenuBtn.addEventListener('click', function() {
            console.log('ðŸ”¥ Click en botÃ³n mÃ³vil detectado!');
          });
        } else {
          console.error('âŒ BotÃ³n menÃº mÃ³vil NO encontrado');
        }
        
        // Script del inventario
        const inventorySelect = document.getElementById('inventory_category_select');
        if (inventorySelect) {
          inventorySelect.addEventListener('change', function(){
            const val = this.value;
            const url = new URL(window.location.href);
            url.searchParams.set('view','inventario');
            if(val) url.searchParams.set('inventory_category', val);
            else url.searchParams.delete('inventory_category');
            window.location.href = url.toString();
          });
        }

        // Script para gestiÃ³n de pedidos
        console.log('ðŸ›’ Inicializando gestiÃ³n de pedidos...');
      });

      // Funciones para gestiÃ³n de pedidos
      function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
               getCookie('csrftoken');
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      // NOTA: Las funciones viewPedidoDetails, updateEstado, updateAdminNotes, 
      // buildPedidoDetailHTML, getEstadoBadgeColor, etc.
      // estÃ¡n TODAS definidas en dashboard-pedidos.js
      // NO las redefinas aquÃ­ para evitar conflictos

      // ========================================
      // SISTEMA DE AUTO-ACTUALIZACIÃ“N DE PEDIDOS
      // ========================================
      
      let autoRefreshInterval = null;
      let lastPedidosCount = {{ pedidos|length }};
      const REFRESH_INTERVAL = 15000; // 15 segundos - actualizaciÃ³n en tiempo real

      // Iniciar auto-actualizaciÃ³n si estamos en la vista de pedidos
      {% if request.GET.view == "pedidos" or not request.GET.view %}
      if (window.location.search.includes('view=pedidos') || !window.location.search.includes('view=')) {
        console.log('ðŸ”„ Iniciando auto-actualizaciÃ³n de pedidos...');
        startAutoRefresh();
      }
      {% endif %}

      function startAutoRefresh() {
        // Limpiar intervalo existente si hay uno
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }

        // Crear intervalo de actualizaciÃ³n
        autoRefreshInterval = setInterval(() => {
          // No actualizar si hay un modal abierto
          const modalOpen = document.querySelector('.modal.show');
          if (modalOpen) {
            console.log('â¸ï¸ Modal abierto - pausando auto-actualizaciÃ³n');
            return;
          }
          checkForNewPedidos();
        }, REFRESH_INTERVAL);

        console.log('âœ… Auto-actualizaciÃ³n de pedidos activada (cada 15s - tiempo real)');
      }

      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log('ðŸ›‘ Auto-actualizaciÃ³n desactivada');
        }
      }

      function checkForNewPedidos() {
        console.log('ðŸ” Verificando nuevos pedidos...');
        
        // Construir URL con los mismos filtros actuales
        const urlParams = new URLSearchParams(window.location.search);
        const apiUrl = '/dashboard/api/pedidos-count/?' + urlParams.toString();

        fetch(apiUrl, {
          method: 'GET',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const newCount = data.count;
            console.log(`ðŸ“Š Pedidos: ${lastPedidosCount} -> ${newCount}`);
            
            if (newCount !== lastPedidosCount) {
              console.log('ðŸ†• Â¡Cambios detectados! Actualizando lista...');
              lastPedidosCount = newCount;
              reloadPedidosList();
            } else {
              console.log('âœ… Sin cambios');
            }
          }
        })
        .catch(error => {
          console.error('âŒ Error verificando pedidos:', error);
        });
      }

      function reloadPedidosList() {
        console.log('ðŸ”„ Recargando lista de pedidos...');
        
        // Obtener la tabla de pedidos
        const tableBody = document.querySelector('table tbody');
        if (!tableBody) {
          console.error('âŒ No se encontrÃ³ la tabla de pedidos');
          return;
        }

        // Mostrar indicador de carga
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'alert alert-info alert-dismissible fade show position-fixed';
        loadingIndicator.style.top = '20px';
        loadingIndicator.style.right = '20px';
        loadingIndicator.style.zIndex = '9999';
        loadingIndicator.innerHTML = `
          <i class="fas fa-sync-alt fa-spin"></i> Actualizando pedidos...
        `;
        document.body.appendChild(loadingIndicator);

        // Construir URL con los mismos filtros actuales
        const urlParams = new URLSearchParams(window.location.search);
        const apiUrl = '/dashboard/api/pedidos-list/?' + urlParams.toString();

        fetch(apiUrl, {
          method: 'GET',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Actualizar la tabla
            tableBody.innerHTML = data.html;
            
            // Mostrar notificaciÃ³n de Ã©xito
            loadingIndicator.className = 'alert alert-success alert-dismissible fade show position-fixed';
            loadingIndicator.innerHTML = `
              <i class="fas fa-check"></i> Lista actualizada (${data.count} pedidos)
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Remover despuÃ©s de 3 segundos
            setTimeout(() => {
              loadingIndicator.remove();
            }, 3000);
            
            console.log('âœ… Lista actualizada con Ã©xito');
          } else {
            throw new Error(data.error || 'Error desconocido');
          }
        })
        .catch(error => {
          console.error('âŒ Error recargando lista:', error);
          loadingIndicator.className = 'alert alert-danger alert-dismissible fade show position-fixed';
          loadingIndicator.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i> Error al actualizar
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          setTimeout(() => {
            loadingIndicator.remove();
          }, 3000);
        });
      }

      // Limpiar intervalo cuando se cambia de vista
      window.addEventListener('beforeunload', () => {
        stopAutoRefresh();
      });

      // Mostrar alertas
      function showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alert-container') || createAlertContainer();
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        alertContainer.appendChild(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }

      function createAlertContainer() {
        const container = document.createElement('div');
        container.id = 'alert-container';
        container.style.position = 'fixed';
        container.style.top = '20px';
        container.style.right = '20px';
        container.style.zIndex = '9999';
        container.style.maxWidth = '400px';
        document.body.appendChild(container);
        return container;
      }

      // FUNCIONES PARA GESTIÃ“N DE MENSAJES
      let currentConversationId = null;

      // Ver detalles de una conversaciÃ³n
      function viewConversation(conversationId) {
        currentConversationId = conversationId;
        console.log('ðŸ‘€ Cargando conversaciÃ³n:', conversationId);
        
        const modalContent = document.getElementById('conversationContent');
        const messagesList = document.getElementById('messages-list');
        
        // Reset del formulario
        document.getElementById('responseForm').reset();
        
        // Mostrar spinner
        messagesList.innerHTML = `
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando mensajes...</span>
            </div>
          </div>
        `;

        // Hacer request para obtener detalles de la conversaciÃ³n
        fetch(`/dashboard/admin/conversation/${conversationId}/`, {
          method: 'GET',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          console.log('ðŸ” Respuesta del servidor:', data);
          if (data.success) {
            console.log('âœ… Datos de conversaciÃ³n:', data.conversation);
            loadConversationData(data.conversation);
          } else {
            console.error('âŒ Error del servidor:', data.error);
            messagesList.innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> 
                Error al cargar la conversaciÃ³n: ${data.error || 'Error desconocido'}
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('âŒ Error de red:', error);
          messagesList.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i> 
              Error de conexiÃ³n. Por favor intenta de nuevo.
            </div>
          `;
        });
      }

      // Cargar datos de la conversaciÃ³n en el modal
      function loadConversationData(conversation) {
        console.log('ðŸ“‹ Cargando datos de conversaciÃ³n:', conversation);
        
        try {
          // Actualizar tÃ­tulo y informaciÃ³n bÃ¡sica
          try {
            document.getElementById('conversation-title').textContent = conversation.subject || 'ConversaciÃ³n sin tÃ­tulo';
            console.log('âœ… TÃ­tulo actualizado');
          } catch (error) {
            console.error('âŒ Error al actualizar tÃ­tulo:', error);
          }
          
          try {
            document.getElementById('conv-user-name').textContent = conversation.user?.username || 'Usuario desconocido';
            console.log('âœ… Usuario actualizado');
          } catch (error) {
            console.error('âŒ Error al actualizar usuario:', error);
          }
          
          try {
            document.getElementById('conv-user-email').textContent = conversation.user?.email || 'No especificado';
            console.log('âœ… Email actualizado');
          } catch (error) {
            console.error('âŒ Error al actualizar email:', error);
          }
          
          // Debug de fecha
          try {
            console.log('ðŸ•’ Fecha recibida para conversaciÃ³n:', conversation.created_at);
            console.log('ðŸ•’ Tipo de fecha recibida:', typeof conversation.created_at);
            const formattedDate = formatDate(conversation.created_at);
            console.log('ðŸ•’ Fecha formateada:', formattedDate);
            document.getElementById('conv-created-date').textContent = formattedDate;
            console.log('âœ… Fecha actualizada');
          } catch (error) {
            console.error('âŒ Error al actualizar fecha:', error);
            document.getElementById('conv-created-date').textContent = 'Fecha no disponible';
          }
          
          // Actualizar badge de estado
          try {
            const statusBadge = document.getElementById('conv-status-badge');
            const statusColor = getConversationStatusColor(conversation.status);
            const statusText = getConversationStatusText(conversation.status);
            console.log('ðŸ·ï¸ Status color:', statusColor, 'Status text:', statusText);
            statusBadge.className = `badge bg-${statusColor}`;
            statusBadge.textContent = statusText;
            console.log('âœ… Estado actualizado');
          } catch (error) {
            console.error('âŒ Error al actualizar estado:', error);
          }
          
          // Mostrar informaciÃ³n del pedido si existe (temporalmente deshabilitado)
          try {
            const orderInfo = document.getElementById('conv-order-info');
            orderInfo.style.display = 'none';
            console.log('âœ… Info de pedido ocultada');
          } catch (error) {
            console.error('âŒ Error al ocultar info de pedido:', error);
          }
          
          // Cargar mensajes
          try {
            console.log('ðŸ“¨ Mensajes a cargar:', conversation.messages);
            loadMessages(conversation.messages || []);
            console.log('âœ… Mensajes cargados');
          } catch (error) {
            console.error('âŒ Error al cargar mensajes:', error);
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = `
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                Error al cargar mensajes: ${error.message}
              </div>
            `;
          }
          
        } catch (error) {
          console.error('âŒ Error general al cargar datos de conversaciÃ³n:', error);
          const messagesList = document.getElementById('messages-list');
          messagesList.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i> 
              Error al mostrar los datos de la conversaciÃ³n: ${error.message}
            </div>
          `;
        }
      }

      // Cargar lista de mensajes
      function loadMessages(messages) {
        console.log('ðŸ’¬ Cargando mensajes:', messages);
        const messagesList = document.getElementById('messages-list');
        
        if (!messages || messages.length === 0) {
          console.log('âš ï¸ No hay mensajes para mostrar');
          messagesList.innerHTML = `
            <div class="text-center text-muted py-4">
              <i class="fas fa-comment-slash fa-2x mb-2"></i>
              <p>No hay mensajes en esta conversaciÃ³n</p>
            </div>
          `;
          return;
        }

        try {
          const messagesHTML = messages.map((message, index) => {
            console.log(`ðŸ“ Procesando mensaje ${index + 1}:`, message);
            console.log(`ðŸ•’ Fecha del mensaje ${index + 1}:`, message.created_at);
            console.log(`ðŸ•’ Tipo de fecha del mensaje ${index + 1}:`, typeof message.created_at);
            
            let formattedDateTime;
            try {
              formattedDateTime = formatDateTime(message.created_at);
              console.log(`ðŸ•’ Fecha formateada del mensaje ${index + 1}:`, formattedDateTime);
            } catch (dateError) {
              console.error(`âŒ Error al formatear fecha del mensaje ${index + 1}:`, dateError);
              formattedDateTime = 'Fecha no disponible';
            }
            
            return `
            <div class="message-item mb-3 ${message.is_admin ? 'admin-message' : 'user-message'}">
              <div class="d-flex ${message.is_admin ? 'justify-content-end' : 'justify-content-start'}">
                <div class="message-bubble ${message.is_admin ? 'bg-primary text-white' : 'bg-light'}" style="max-width: 80%;">
                  <div class="message-header mb-1">
                    <small class="fw-bold ${message.is_admin ? 'text-light' : 'text-primary'}">
                      ${message.is_admin ? 'ðŸ‘¨â€ðŸ’¼ Admin' : 'ðŸ‘¤ ' + (message.sender_name || 'Usuario')}
                    </small>
                    <small class="ms-2 ${message.is_admin ? 'text-light opacity-75' : 'text-muted'}">
                      ${formattedDateTime}
                    </small>
                  </div>
                  <div class="message-content">
                    ${message.message || 'Mensaje sin contenido'}
                  </div>
                </div>
              </div>
            </div>
          `;
          }).join('');
          
          console.log('âœ… HTML de mensajes generado correctamente');
          messagesList.innerHTML = messagesHTML;
          
          // Scroll al final de los mensajes
          setTimeout(() => {
            try {
              const messagesContainer = document.querySelector('.messages-container');
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
              console.log('âœ… Scroll aplicado');
            } catch (scrollError) {
              console.error('âŒ Error al aplicar scroll:', scrollError);
            }
          }, 100);
          
        } catch (error) {
          console.error('âŒ Error general al procesar mensajes:', error);
          messagesList.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i> 
              Error al procesar mensajes: ${error.message}
            </div>
          `;
        }
      }

      // Enviar respuesta del administrador
      document.getElementById('responseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!currentConversationId) {
          showAlert('âŒ Error: No hay conversaciÃ³n seleccionada', 'danger');
          return;
        }

        const responseText = document.getElementById('admin-response').value.trim();
        const markResolved = document.getElementById('mark-resolved').checked;
        
        if (!responseText) {
          showAlert('âŒ Por favor escribe una respuesta', 'warning');
          return;
        }

        console.log('ðŸ“© Enviando respuesta a conversaciÃ³n:', currentConversationId);

        // Deshabilitar el botÃ³n de envÃ­o
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

        fetch('/dashboard/admin/conversation/reply/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conversation_id: currentConversationId,
            message: responseText,
            mark_resolved: markResolved
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showAlert('âœ… Respuesta enviada correctamente', 'success');
            
            // Limpiar el formulario
            document.getElementById('admin-response').value = '';
            document.getElementById('mark-resolved').checked = false;
            
            // Recargar la conversaciÃ³n
            viewConversation(currentConversationId);
            
            // Actualizar la tabla si la conversaciÃ³n fue marcada como resuelta
            if (markResolved) {
              setTimeout(() => {
                location.reload();
              }, 2000);
            }
          } else {
            showAlert('âŒ Error al enviar respuesta: ' + (data.error || 'Error desconocido'), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('âŒ Error de conexiÃ³n. Intenta de nuevo.', 'danger');
        })
        .finally(() => {
          // Restaurar el botÃ³n
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        });
      });

      // Actualizar estado de conversaciÃ³n desde el modal
      function updateConversationStatusInModal(newStatus) {
        if (!currentConversationId) {
          showAlert('âŒ Error: No hay conversaciÃ³n seleccionada', 'danger');
          return;
        }

        updateConversationStatus(currentConversationId, newStatus);
      }

      // Actualizar estado de conversaciÃ³n
      function updateConversationStatus(conversationId, newStatus) {
        const confirmMessage = `Â¿EstÃ¡s seguro de cambiar el estado de esta conversaciÃ³n a "${getConversationStatusText(newStatus)}"?`;
        
        if (!confirm(confirmMessage)) {
          return;
        }

        console.log('ðŸ”„ Actualizando estado de conversaciÃ³n:', conversationId, 'a', newStatus);

        fetch('/dashboard/admin/conversation/update-status/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conversation_id: conversationId,
            new_status: newStatus
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showAlert(`âœ… Estado actualizado a "${getConversationStatusText(newStatus)}" correctamente`, 'success');
            
            // Actualizar el badge en el modal si estÃ¡ abierto
            if (currentConversationId === conversationId) {
              const statusBadge = document.getElementById('conv-status-badge');
              statusBadge.className = `badge bg-${getConversationStatusColor(newStatus)}`;
              statusBadge.textContent = getConversationStatusText(newStatus);
            }
            
            // Actualizar la fila en la tabla
            updateConversationRowStatus(conversationId, newStatus);
            
            // Recargar estadÃ­sticas
            setTimeout(() => {
              location.reload();
            }, 2000);
          } else {
            showAlert('âŒ Error al actualizar estado: ' + (data.error || 'Error desconocido'), 'danger');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('âŒ Error de conexiÃ³n. Intenta de nuevo.', 'danger');
        });
      }

      // Actualizar fila de conversaciÃ³n en la tabla
      function updateConversationRowStatus(conversationId, newStatus) {
        const row = document.querySelector(`[data-conversation-id="${conversationId}"]`);
        if (row) {
          const statusBadge = row.querySelector('.badge');
          if (statusBadge) {
            statusBadge.className = `badge bg-${getConversationStatusColor(newStatus)}`;
            statusBadge.textContent = getConversationStatusText(newStatus);
          }
          
          // Actualizar el atributo data-status para los filtros
          row.setAttribute('data-status', newStatus);
        }
      }

      // Funciones auxiliares para conversaciones
      function getConversationStatusColor(status) {
        const colors = {
          'open': 'warning',
          'in_progress': 'info', 
          'resolved': 'success',
          'closed': 'secondary'
        };
        return colors[status] || 'secondary';
      }

      function getConversationStatusText(status) {
        const texts = {
          'open': 'Abierta',
          'in_progress': 'En Progreso',
          'resolved': 'Resuelta', 
          'closed': 'Cerrada'
        };
        return texts[status] || 'Desconocido';
      }

      // Filtros de conversaciones
      document.addEventListener('DOMContentLoaded', function() {
        const filterButtons = document.querySelectorAll('input[name="conversation-filter"]');
        filterButtons.forEach(button => {
          button.addEventListener('change', function() {
            const filterValue = this.id.replace('filter-', '');
            filterConversations(filterValue);
          });
        });
      });

      function filterConversations(filter) {
        const rows = document.querySelectorAll('.conversation-row');
        
        rows.forEach(row => {
          const status = row.getAttribute('data-status');
          let shouldShow = false;
          
          switch(filter) {
            case 'all':
              shouldShow = true;
              break;
            case 'pending':
              shouldShow = status === 'open';
              break;
            case 'active':
              shouldShow = status === 'in_progress';
              break;
            case 'closed':
              shouldShow = status === 'closed' || status === 'resolved';
              break;
          }
          
          row.style.display = shouldShow ? '' : 'none';
        });
      }

      // Actualizar mensajes automÃ¡ticamente
      document.getElementById('refreshMessages').addEventListener('click', function() {
        location.reload();
      });

      // Formatear fechas
      function formatDate(dateString) {
        console.log('ðŸ” formatDate llamado con:', dateString, 'tipo:', typeof dateString);
        try {
          if (!dateString) {
            console.log('âš ï¸ formatDate: dateString estÃ¡ vacÃ­o');
            return 'Fecha no disponible';
          }
          console.log('ðŸ” formatDate: Creando objeto Date...');
          const date = new Date(dateString);
          console.log('ðŸ” formatDate: Date creado:', date);
          if (isNaN(date.getTime())) {
            console.error('âŒ formatDate: Fecha invÃ¡lida:', dateString);
            return 'Fecha invÃ¡lida';
          }
          const result = date.toLocaleDateString('es-CO') + ' ' + date.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});
          console.log('âœ… formatDate: Resultado:', result);
          return result;
        } catch (error) {
          console.error('âŒ formatDate: Error al formatear fecha:', error, dateString);
          console.error('âŒ formatDate: Stack trace:', error.stack);
          return 'Error en fecha';
        }
      }

      function formatDateTime(dateString) {
        console.log('ðŸ” formatDateTime llamado con:', dateString, 'tipo:', typeof dateString);
        try {
          if (!dateString) {
            console.log('âš ï¸ formatDateTime: dateString estÃ¡ vacÃ­o');
            return 'Fecha no disponible';
          }
          console.log('ðŸ” formatDateTime: Creando objeto Date...');
          const date = new Date(dateString);
          console.log('ðŸ” formatDateTime: Date creado:', date);
          if (isNaN(date.getTime())) {
            console.error('âŒ formatDateTime: Fecha/hora invÃ¡lida:', dateString);
            return 'Fecha invÃ¡lida';
          }
          const now = new Date();
          const diffInMs = now - date;
          const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
          
          let result;
          if (diffInDays === 0) {
            result = 'Hoy ' + date.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});
          } else if (diffInDays === 1) {
            result = 'Ayer ' + date.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});
          } else {
            result = date.toLocaleDateString('es-CO') + ' ' + date.toLocaleTimeString('es-CO', {hour: '2-digit', minute: '2-digit'});
          }
          console.log('âœ… formatDateTime: Resultado:', result);
          return result;
        } catch (error) {
          console.error('âŒ formatDateTime: Error al formatear fecha/hora:', error, dateString);
          console.error('âŒ formatDateTime: Stack trace:', error.stack);
          return 'Error en fecha';
        }
      }

      // FUNCIONES PARA BONOS DE DESCUENTO
      function editarBono(bonoId) {
        // Por ahora, redirigir a la pÃ¡gina con parÃ¡metros para ediciÃ³n
        // En una implementaciÃ³n mÃ¡s avanzada, se podrÃ­a cargar via AJAX
        alert('Funcionalidad de ediciÃ³n en desarrollo. Por ahora puedes eliminar y crear nuevamente el bono.');
      }

      // ValidaciÃ³n de formularios de bonos
      document.addEventListener('DOMContentLoaded', function() {
        // Actualizar fecha mÃ­nima al cargar
        const now = new Date();
        const minDate = now.toISOString().slice(0, 16);
        
        const fechaInicioInput = document.getElementById('fecha_inicio');
        const fechaFinInput = document.getElementById('fecha_fin');
        
        if (fechaInicioInput) {
          fechaInicioInput.min = minDate;
          fechaInicioInput.value = minDate;
        }
        
        if (fechaFinInput) {
          fechaFinInput.min = minDate;
          // Establecer fecha fin como 1 semana despuÃ©s
          const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
          fechaFinInput.value = nextWeek.toISOString().slice(0, 16);
        }
      });
    </script>

  
    <!-- MÃ³dulos JS Especializados -->
    <script src="{% static 'js/dashboard-users.js' %}"></script>
    <script src="{% static 'js/dashboard-pedidos.js' %}"></script>
    <script src="{% static 'js/dashboard-autorefresh.js' %}"></script>
    
    <!-- Script de InicializaciÃ³n y Debug -->
    <script>
        console.log('ðŸ” DEBUG: Verificando elementos data-stat en la pÃ¡gina');
        document.addEventListener('DOMContentLoaded', function() {
            const ventasHoyElement = document.querySelector('[data-stat="ventas-hoy"]');
            if (ventasHoyElement) {
                console.log('âœ… Elemento ventas-hoy encontrado');
                console.log('   Valor inicial:', ventasHoyElement.textContent);
            } else {
                console.error('âŒ Elemento ventas-hoy NO encontrado');
            }
            
            // Listar todos los elementos con data-stat
            const allStats = document.querySelectorAll('[data-stat]');
            console.log(`ðŸ“Š Total elementos data-stat: ${allStats.length}`);
            allStats.forEach(el => {
                console.log(`   - ${el.getAttribute('data-stat')}: "${el.textContent.trim()}"`);
            });
            
            // Verificar funciones de pedidos
            console.log('ðŸ” Verificando funciones de pedidos...');
            if (typeof viewPedidoDetails === 'function') {
                console.log('âœ… viewPedidoDetails estÃ¡ disponible');
            } else {
                console.error('âŒ viewPedidoDetails NO estÃ¡ disponible');
            }
            
            if (typeof updateEstado === 'function') {
                console.log('âœ… updateEstado estÃ¡ disponible');
            } else {
                console.error('âŒ updateEstado NO estÃ¡ disponible');
            }
            
            if (typeof confirmarPago === 'function') {
                console.log('âœ… confirmarPago estÃ¡ disponible');
            } else {
                console.error('âŒ confirmarPago NO estÃ¡ disponible');
            }
            
            // Verificar si DashboardAutoRefresh estÃ¡ disponible
            setTimeout(() => {
                if (window.DashboardAutoRefresh) {
                    console.log('âœ… DashboardAutoRefresh disponible');
                    console.log('   MÃ©todos:', Object.keys(window.DashboardAutoRefresh));
                    
                    // Forzar actualizaciÃ³n manual para test
                    console.log('ðŸ”„ Forzando actualizaciÃ³n manual de stats...');
                    window.DashboardAutoRefresh.refreshStats();
                } else {
                    console.error('âŒ DashboardAutoRefresh NO disponible');
                }
            }, 1000);
            
            // Configurar event listeners para el modal de pedidos
            const pedidoModal = document.getElementById('pedidoModal');
            if (pedidoModal) {
                pedidoModal.addEventListener('show.bs.modal', function(event) {
                    console.log('ðŸ”“ Modal de pedido abierto');
                });
                
                pedidoModal.addEventListener('hidden.bs.modal', function(event) {
                    console.log('ðŸ”’ Modal de pedido cerrado');
                });
            }
        });
    </script>
    
</body>
<script>
(function() {
    var ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    var ws_path = ws_scheme + '://' + window.location.host + '/ws/dashboard/';
    var dashboardSocket = new WebSocket(ws_path);

    dashboardSocket.onopen = function(e) {
        console.log('[WebSocket] Dashboard conectado para notificaciones de visitas');
    };
    dashboardSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        if (data.message === 'new_visit') {
            // Modern alert: SweetAlert2 si estÃ¡ disponible, si no, toast, si no, alert
            if (window.Swal && typeof Swal.fire === 'function') {
                Swal.fire({
                    title: 'Â¡Nuevo visitante en tienda!',
                    text: 'Alguien acaba de ingresar a la tienda online.',
                    icon: 'info',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3500,
                    timerProgressBar: true,
                    background: '#f0f9ff',
                    color: '#222',
                    customClass: {
                        popup: 'swal2-modern-toast swal2-shadow'
                    }
                });
            } else if (window.showToast) {
                showToast('Nuevo visitante', 'Alguien acaba de ingresar a la tienda', 'info', 3500);
            } else {
                alert('Nuevo visitante en la tienda');
            }
            console.log('[WebSocket] Nuevo visitante:', data.timestamp);
            
            // Auto-refresh si estamos en la vista de visitas
            if (window.location.search.includes('view=visitas')) {
                refreshVisitas();
            }
        }
    };
    dashboardSocket.onclose = function(e) {
        console.log('[WebSocket] Dashboard desconectado');
    };
})();
</script>

<!-- Auto-refresh para visitas en tiempo real -->
<script>
(function() {
    'use strict';
    
    // Solo ejecutar en la vista de visitas
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view') !== 'visitas') {
        return;
    }
    
    console.log('ðŸ”„ Sistema de visitas cargado (auto-refresh desactivado para permitir scroll infinito)');
    
    // AUTO-REFRESH DESACTIVADO - Las visitas se muestran todas con scroll
    // let refreshInterval = null;
    // const REFRESH_INTERVAL = 10000; // 10 segundos
    
    // FunciÃ³n para actualizar visitas (solo refresh manual)
    window.refreshVisitas = function() {
        const filterForm = document.getElementById('visitas-filter-form');
        if (!filterForm) return;
        
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        
        console.log('ðŸ”„ Actualizando visitas...', params.toString());
        
        fetch(`/dashboard/api/visitas-live/?${params.toString()}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('âœ… Visitas actualizadas:', data.visitas.length);
                
                // Actualizar AMBAS versiones: desktop Y mobile
                updateVisitasTable(data.visitas);
                updateVisitasCards(data.visitas);
                updateVisitasStats(data.stats);
                
                // Animar indicador en vivo
                const liveIndicator = document.getElementById('live-indicator');
                if (liveIndicator) {
                    liveIndicator.style.animation = 'none';
                    setTimeout(() => {
                        liveIndicator.style.animation = '';
                    }, 10);
                }
            }
        })
        .catch(error => {
            console.error('âŒ Error al actualizar visitas:', error);
        });
    };
    
    // FunciÃ³n auxiliar para parsear timestamp del API
    function parseTimestamp(timestamp) {
        // Formato del API: "05/12/2025 14:30:45"
        const parts = timestamp.split(' ');
        const datePart = parts[0]; // "05/12/2025"
        const timePart = parts[1]; // "14:30:45"
        const timeShort = timePart.substring(0, 5); // "14:30"
        
        return {
            date: datePart,
            time: timeShort,
            full: timestamp
        };
    }
    
    // FunciÃ³n auxiliar para generar badge de tipo de visita
    function generateVisitTypeBadge(visita) {
        const types = {
            'home': { gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', icon: 'fa-home', label: 'Home' },
            'store': { gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', icon: 'fa-store', label: 'Tienda' },
            'product_detail': { gradient: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', icon: 'fa-box', label: visita.product_name || `Producto ${visita.product_id ? '#' + visita.product_id : ''}` },
            'cart': { gradient: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', icon: 'fa-shopping-basket', label: 'Carrito' },
            'checkout': { gradient: 'linear-gradient(135deg, #ffd89b 0%, #19547b 100%)', icon: 'fa-shopping-cart', label: 'Checkout' }
        };
        
        const type = types[visita.visit_type] || { gradient: '#6c757d', icon: 'fa-question', label: '-' };
        return `<span class="badge rounded-pill" style="background: ${type.gradient};"><i class="fas ${type.icon}"></i> ${type.label}</span>`;
    }
    
    // FunciÃ³n auxiliar para generar info de usuario
    function generateUserInfo(visita) {
        if (visita.is_authenticated) {
            const userName = visita.user_name || visita.user_email || 'Usuario';
            const initial = userName.charAt(0).toUpperCase();
            return {
                avatar: `<div class="user-avatar me-2" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${initial}</div>`,
                name: userName,
                status: 'âœ… Autenticado',
                simple: `<span class="badge bg-primary"><i class="fas fa-user"></i> ${userName}</span>`
            };
        } else {
            return {
                avatar: `<div class="user-avatar me-2" style="width: 32px; height: 32px; border-radius: 50%; background: #6c757d; display: flex; align-items: center; justify-content: center; color: white;"><i class="fas fa-user-secret"></i></div>`,
                name: 'AnÃ³nimo',
                status: 'ðŸ”’ No identificado',
                simple: '<span class="text-secondary small">AnÃ³nimo</span>'
            };
        }
    }
    
    // FunciÃ³n auxiliar para color del border segÃºn tipo
    function getBorderColor(visitType) {
        const colors = {
            'home': '#667eea',
            'store': '#4facfe',
            'product_detail': '#43e97b',
            'cart': '#fa709a',
            'checkout': '#ffd89b'
        };
        return colors[visitType] || '#6c757d';
    }
    
    // FunciÃ³n para actualizar tabla de visitas (DESKTOP)
    function updateVisitasTable(visitas) {
        const tbody = document.getElementById('visitas-tbody');
        if (!tbody) return;
        
        if (visitas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4"><i class="fas fa-eye-slash me-2"></i>Sin visitas recientes</td></tr>';
            return;
        }
        
        tbody.innerHTML = visitas.map(visita => {
            const timestamp = parseTimestamp(visita.timestamp);
            const userInfo = generateUserInfo(visita);
            const location = (visita.city || visita.country) 
                ? `<div class="d-flex align-items-center"><i class="fas fa-map-marker-alt text-danger me-2"></i><div><div class="fw-semibold">${visita.city || 'Desconocida'}</div>${visita.country ? `<small class="text-muted">${visita.country}</small>` : ''}</div></div>`
                : '<small class="text-muted"><i class="fas fa-question-circle"></i> No disponible</small>';
            
            return `
                <tr class="visita-row" style="transition: all 0.3s ease;">
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="visit-time-badge">
                                <div class="fw-bold">${timestamp.time}</div>
                                <small class="text-muted">${timestamp.date}</small>
                            </div>
                        </div>
                    </td>
                    <td>${generateVisitTypeBadge(visita)}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            ${userInfo.avatar}
                            <div>
                                <div class="fw-semibold">${userInfo.name}</div>
                                <small class="text-muted">${userInfo.status}</small>
                            </div>
                        </div>
                    </td>
                    <td>${location}</td>
                    <td><code class="small">${visita.ip_address || '-'}</code></td>
                </tr>
            `;
        }).join('');
    }
    
    // FunciÃ³n para actualizar cards mÃ³viles (MOBILE)
    function updateVisitasCards(visitas) {
        // Buscar el contenedor de cards mÃ³viles
        const mobileContainer = document.querySelector('.col-12.d-lg-none > div[style*="max-height"]');
        if (!mobileContainer) return;
        
        if (visitas.length === 0) {
            mobileContainer.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-eye-slash fa-3x mb-3 d-block"></i>
                    <p class="mb-0">No hay visitas con los filtros seleccionados</p>
                </div>
            `;
            return;
        }
        
        mobileContainer.innerHTML = visitas.map(visita => {
            const timestamp = parseTimestamp(visita.timestamp);
            const userInfo = generateUserInfo(visita);
            const borderColor = getBorderColor(visita.visit_type);
            const location = (visita.city || visita.country)
                ? `<small class="text-muted"><i class="fas fa-map-marker-alt text-danger"></i> ${visita.city || 'Desconocida'}${visita.country ? ', ' + visita.country : ''}</small>`
                : '<small class="text-muted"><i class="fas fa-question-circle"></i> No disponible</small>';
            
            return `
                <div class="card mb-3 shadow-sm border-0" style="border-left: 4px solid ${borderColor} !important;">
                    <div class="card-body p-3">
                        <!-- Header de la card -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>${generateVisitTypeBadge(visita)}</div>
                            <div class="text-end">
                                <div class="fw-bold">${timestamp.time}</div>
                                <small class="text-muted">${timestamp.date}</small>
                            </div>
                        </div>
                        
                        <!-- Usuario -->
                        <div class="mb-2">
                            <div class="d-flex align-items-center">
                                ${userInfo.avatar.replace('32px', '40px')}
                                <div>
                                    <div class="fw-semibold">${userInfo.name}</div>
                                    <small class="text-muted">${userInfo.status}</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer con ubicaciÃ³n e IP -->
                        <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                            <div>${location}</div>
                            <code class="small bg-light px-2 py-1 rounded">${visita.ip_address || '-'}</code>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // FunciÃ³n para actualizar estadÃ­sticas
    function updateVisitasStats(stats) {
        const statElements = {
            'visitas_count': stats.total_filtrado,
            'visitas_count_today': stats.total_hoy,
            'visitas_count_week': stats.total_semana,
            'visitas_count_month': stats.total_mes,
            'visitas_count_auth': stats.total_autenticados,
            'visitas_count_anon': stats.total_anonimos,
            'visitas_count_store': stats.total_tienda,
            'visitas_count_product': stats.total_productos
        };
        
        // Actualizar badges en el sidebar
        document.querySelectorAll('.badge').forEach(badge => {
            const text = badge.textContent.trim();
            // Reemplazar nÃºmeros en badges
            for (const [key, value] of Object.entries(stats)) {
                const currentBadge = badge.closest('.small, .mb-3');
                if (currentBadge) {
                    const parentText = currentBadge.textContent;
                    if (parentText.includes('Total filtrado') && key === 'total_filtrado') {
                        badge.textContent = value;
                    } else if (parentText.includes('Hoy') && key === 'total_hoy') {
                        badge.textContent = value;
                    } else if (parentText.includes('Esta semana') && key === 'total_semana') {
                        badge.textContent = value;
                    } else if (parentText.includes('Este mes') && key === 'total_mes') {
                        badge.textContent = value;
                    } else if (parentText.includes('Autenticados') && key === 'total_autenticados') {
                        badge.textContent = value;
                    } else if (parentText.includes('AnÃ³nimos') && key === 'total_anonimos') {
                        badge.textContent = value;
                    } else if (parentText.includes('Tienda') && key === 'total_tienda') {
                        badge.textContent = value;
                    } else if (parentText.includes('Productos') && key === 'total_productos') {
                        badge.textContent = value;
                    }
                }
            }
        });
    }
    
    // FunciÃ³n para actualizar productos mÃ¡s visitados
    function refreshProductosMasVisitados() {
        const periodoSelect = document.getElementById('periodo-productos');
        if (!periodoSelect) return;
        
        const periodo = periodoSelect.value;
        
        fetch(`/dashboard/api/productos-mas-visitados/?periodo=${periodo}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('âœ… Productos mÃ¡s visitados actualizados:', data.productos.length);
                updateProductosVisitados(data.productos);
            }
        })
        .catch(error => {
            console.error('âŒ Error al actualizar productos:', error);
        });
    }
    
    // FunciÃ³n para actualizar contenedor de productos
    function updateProductosVisitados(productos) {
        const container = document.getElementById('productos-visitados-container');
        if (!container) return;
        
        if (productos.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No hay datos de productos visitados en este perÃ­odo
                    </div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = productos.map(item => {
            const imageHtml = item.product_image ? 
                `<img src="${item.product_image}" alt="${item.product_name}" class="rounded" width="60" height="60" style="object-fit: cover;">` :
                `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                    <i class="fas fa-image text-muted"></i>
                </div>`;
            
            return `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    ${imageHtml}
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">${item.product_name}</h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-danger">
                                            <i class="fas fa-eye"></i> ${item.total_visitas} visita${item.total_visitas !== 1 ? 's' : ''}
                                        </span>
                                        <span class="text-muted small">
                                            $${parseFloat(item.product_price).toLocaleString()}
                                        </span>
                                    </div>
                                    <div class="mt-1">
                                        <span class="badge bg-secondary small">Stock: ${item.product_stock}</span>
                                        <span class="badge bg-info small">${item.product_category}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // BotÃ³n de refresh manual de visitas
        const refreshBtn = document.getElementById('refresh-visitas');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                console.log('ðŸ”„ Refresh manual de visitas solicitado');
                
                // Verificar si hay paginaciÃ³n de productos activa
                const urlParams = new URLSearchParams(window.location.search);
                const hasProductosPagination = urlParams.has('productos_page');
                
                if (hasProductosPagination) {
                    // Si hay paginaciÃ³n, recargar toda la pÃ¡gina para mantener el estado
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.add('fa-spin');
                    }
                    window.location.reload();
                } else {
                    // Si no hay paginaciÃ³n, usar AJAX normal
                    refreshVisitas();
                    
                    // Feedback visual
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.classList.add('fa-spin');
                        setTimeout(() => icon.classList.remove('fa-spin'), 1000);
                    }
                }
            });
        }
        
        // Selector de perÃ­odo de productos - Usar recarga de pÃ¡gina para mantener paginaciÃ³n
        const periodoSelect = document.getElementById('periodo-productos');
        if (periodoSelect) {
            periodoSelect.addEventListener('change', function() {
                console.log('ðŸ“Š Cambiando perÃ­odo de productos:', this.value);
                
                // Construir URL con parÃ¡metros actuales
                const url = new URL(window.location);
                url.searchParams.set('periodo_productos', this.value);
                url.searchParams.delete('productos_page'); // Reset a primera pÃ¡gina
                
                // Redirigir con nuevos parÃ¡metros
                window.location.href = url.toString();
            });
        }
        
        // BotÃ³n de refresh de productos
        const refreshProductosBtn = document.getElementById('refresh-productos');
        if (refreshProductosBtn) {
            refreshProductosBtn.addEventListener('click', function() {
                console.log('ðŸ”„ Refresh manual de productos');
                
                // Feedback visual
                const icon = this.querySelector('i');
                if (icon) {
                    icon.classList.add('fa-spin');
                }
                
                // Recargar pÃ¡gina actual
                window.location.reload();
            });
        }
        
        // Verificar si hay paginaciÃ³n activa en productos
        const urlParams = new URLSearchParams(window.location.search);
        const hasProductosPagination = urlParams.has('productos_page');
        
        // Solo iniciar auto-refresh si NO hay paginaciÃ³n de productos activa
        if (!hasProductosPagination) {
            // Iniciar auto-refresh solo para visitas (no productos)
            refreshInterval = setInterval(() => {
                refreshVisitas();
                // NO refrescar productos si hay paginaciÃ³n
            }, REFRESH_INTERVAL);
            
            console.log(`âœ… Auto-refresh iniciado solo para visitas (cada ${REFRESH_INTERVAL/1000}s)`);
            
            // Refresh inicial despuÃ©s de 2 segundos
            setTimeout(() => {
                refreshVisitas();
            }, 2000);
        } else {
            console.log('â¸ï¸ Auto-refresh deshabilitado - PaginaciÃ³n de productos activa');
            
            // Agregar mensaje informativo
            const infoMsg = document.createElement('div');
            infoMsg.className = 'alert alert-info alert-dismissible fade show mt-3';
            infoMsg.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>Auto-actualizaciÃ³n pausada:</strong> La actualizaciÃ³n automÃ¡tica estÃ¡ deshabilitada mientras navegas por las pÃ¡ginas. 
                Usa el botÃ³n <i class="fas fa-sync-alt"></i> para actualizar manualmente.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const productosSection = document.querySelector('.card.modern-card .card-body');
            if (productosSection && productosSection.querySelector('.row.g-3')) {
                productosSection.insertBefore(infoMsg, productosSection.firstChild);
            }
        }
    });
    
    // Limpiar interval al salir de la pÃ¡gina
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            console.log('ðŸ›‘ Auto-refresh detenido');
        }
    });
    
    // CSS para animaciÃ³n del indicador en vivo
    const style = document.createElement('style');
    style.textContent = `
        /* AnimaciÃ³n de pulso */
        @keyframes pulse-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-animation {
            animation: pulse-animation 2s ease-in-out infinite;
        }
        
        /* Scrollbar personalizado moderno */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        /* AnimaciÃ³n suave para filas de tabla */
        .visita-row:hover {
            background-color: #f8f9fa !important;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Estilo para tiempo de visita */
        .visit-time-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        /* AnimaciÃ³n de entrada para cards mÃ³viles */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card {
            animation: fadeInUp 0.3s ease-out;
        }
        
        /* Efecto hover mejorado para cards */
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            transition: all 0.3s ease;
        }
    `;
    document.head.appendChild(style);
    
})();
</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Script de GrÃ¡ficos de Ventas -->
<script>
(function() {
    'use strict';
    
    // Solo ejecutar en la vista de ventas
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view') !== 'ventas') {
        return;
    }
    
    console.log('ðŸ“Š Inicializando grÃ¡ficos de anÃ¡lisis de ventas');
    
    // Datos de ventas por categorÃ­a desde Django
    const ventasData = {
        categorias: [
            {% for categoria in ventas_por_categoria %}
                '{{ categoria.nombre }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        ingresos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.total_ingresos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        productos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.cantidad_productos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        pedidos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.cantidad_pedidos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    // Colores modernos para los grÃ¡ficos
    const colors = [
        'rgba(102, 126, 234, 0.8)',   // PÃºrpura
        'rgba(118, 75, 162, 0.8)',    // Morado oscuro
        'rgba(79, 172, 254, 0.8)',    // Azul claro
        'rgba(0, 242, 254, 0.8)',     // Cyan
        'rgba(67, 233, 123, 0.8)',    // Verde
        'rgba(245, 87, 108, 0.8)',    // Rosa
        'rgba(255, 159, 64, 0.8)',    // Naranja
        'rgba(255, 205, 86, 0.8)',    // Amarillo
        'rgba(153, 102, 255, 0.8)',   // Violeta
        'rgba(201, 203, 207, 0.8)'    // Gris
    ];
    
    const borderColors = colors.map(color => color.replace('0.8', '1'));
    
    // ConfiguraciÃ³n del grÃ¡fico
    const ctx = document.getElementById('ventasCategoriaChart');
    if (!ctx) {
        console.error('âŒ Canvas del grÃ¡fico no encontrado');
        return;
    }
    
    let currentChart = null;
    let currentChartType = 'bar';
    
    // FunciÃ³n para crear/actualizar el grÃ¡fico
    function createChart(type = 'bar') {
        if (currentChart) {
            currentChart.destroy();
        }
        
        const config = {
            type: type,
            data: {
                labels: ventasData.categorias,
                datasets: [{
                    label: 'Ingresos ($)',
                    data: ventasData.ingresos,
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: type === 'bar' ? 8 : 0,
                    hoverOffset: type === 'pie' || type === 'doughnut' ? 10 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: type !== 'bar',
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        return {
                                            text: label + ' ($' + value.toLocaleString() + ')',
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += '$' + context.parsed.y.toLocaleString();
                                return label;
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: type === 'bar' ? {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                } : {}
            }
        };
        
        currentChart = new Chart(ctx, config);
        currentChartType = type;
        
        console.log(`âœ… GrÃ¡fico ${type} creado exitosamente`);
    }
    
    // Crear grÃ¡fico inicial
    createChart('bar');
    
    // Event listeners para cambio de tipo de grÃ¡fico
    document.querySelectorAll('[data-chart-type]').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.getAttribute('data-chart-type');
            
            // Actualizar botones activos
            document.querySelectorAll('[data-chart-type]').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            // Crear nuevo grÃ¡fico
            createChart(type);
            
            console.log('ðŸ“Š Tipo de grÃ¡fico cambiado a:', type);
        });
    });
    
    // FunciÃ³n para cargar datos de ventas por perÃ­odo
    let currentPeriod = 'all';
    
    async function loadVentasPorPeriodo(periodo) {
        try {
            console.log(`ðŸ“Š Cargando ventas para perÃ­odo: ${periodo}`);
            
            // Mostrar indicador de carga
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                chartContainer.style.opacity = '0.5';
            }
            
            const response = await fetch(`/dashboard/api/ventas-por-periodo/?periodo=${periodo}`);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error('Error al cargar datos de ventas');
            }
            
            console.log('âœ… Datos cargados:', data);
            
            // Actualizar datos del grÃ¡fico
            ventasData.categorias = data.ventas_por_categoria.map(c => c.nombre);
            ventasData.ingresos = data.ventas_por_categoria.map(c => c.total_ingresos);
            ventasData.productos = data.ventas_por_categoria.map(c => c.cantidad_productos);
            ventasData.pedidos = data.ventas_por_categoria.map(c => c.cantidad_pedidos);
            
            // Recrear grÃ¡fico con nuevos datos
            createChart(currentChartType);
            
            // Actualizar KPIs
            updateKPIs(data.estadisticas, data.ventas_por_categoria);
            
            // Actualizar tabla
            updateTable(data.ventas_por_categoria);
            
            // Actualizar top 5
            updateTop5(data.ventas_por_categoria);
            
            currentPeriod = periodo;
            
            // Restaurar opacidad
            if (chartContainer) {
                chartContainer.style.opacity = '1';
            }
            
            console.log('âœ… Vista actualizada exitosamente');
            
        } catch (error) {
            console.error('âŒ Error cargando ventas:', error);
            alert('Error al cargar datos de ventas. Por favor intente nuevamente.');
        }
    }
    
    // FunciÃ³n para actualizar KPIs
    function updateKPIs(stats, categorias) {
        // Total ventas
        const totalVentasEl = document.querySelector('.modern-stat-card:nth-child(1) .stat-value');
        if (totalVentasEl) {
            totalVentasEl.textContent = '$' + stats.total_ventas.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }
        
        // Productos vendidos
        const totalProductosEl = document.querySelector('.modern-stat-card:nth-child(2) .stat-value');
        if (totalProductosEl) {
            totalProductosEl.textContent = stats.total_productos.toLocaleString();
        }
        
        // Promedio por pedido
        const promedioEl = document.querySelector('.modern-stat-card:nth-child(3) .stat-value');
        if (promedioEl) {
            promedioEl.textContent = '$' + stats.promedio_por_pedido.toLocaleString('es-CO', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }
        
        // Total pedidos
        const pedidosEl = document.querySelector('.modern-stat-card:nth-child(4) .stat-value');
        if (pedidosEl) {
            pedidosEl.textContent = stats.pedidos_totales.toLocaleString();
        }
        
        console.log('âœ… KPIs actualizados');
    }
    
    // FunciÃ³n para actualizar tabla
    function updateTable(categorias) {
        const tbody = document.querySelector('.table tbody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        categorias.forEach((categoria, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="fw-bold text-muted">${index + 1}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="category-color-indicator me-2" 
                             style="width: 8px; height: 8px; border-radius: 50%; background: ${colors[index % colors.length]};"></div>
                        <strong class="text-dark">${categoria.nombre}</strong>
                    </div>
                </td>
                <td class="text-end">
                    <span class="badge bg-success-subtle text-success px-3 py-2">
                        $${categoria.total_ingresos.toLocaleString('es-CO', {minimumFractionDigits: 0})}
                    </span>
                </td>
                <td class="text-center">
                    <span class="badge bg-info-subtle text-info">
                        ${categoria.cantidad_productos}
                    </span>
                </td>
                <td class="text-center">
                    <span class="badge bg-primary-subtle text-primary">
                        ${categoria.cantidad_pedidos}
                    </span>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        console.log('âœ… Tabla actualizada');
    }
    
    // FunciÃ³n para actualizar top 5
    function updateTop5(categorias) {
        const container = document.querySelector('.top-5-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        const top5 = categorias.slice(0, 5);
        const maxIngresos = top5[0]?.total_ingresos || 1;
        
        top5.forEach((categoria, index) => {
            const percentage = (categoria.total_ingresos / maxIngresos) * 100;
            const item = document.createElement('div');
            item.className = 'top-category-item';
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="fw-bold">${index + 1}. ${categoria.nombre}</span>
                        <small class="text-muted d-block">${categoria.cantidad_productos} productos</small>
                    </div>
                    <span class="badge bg-success">$${categoria.total_ingresos.toLocaleString('es-CO', {minimumFractionDigits: 0})}</span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: ${percentage}%; background: linear-gradient(90deg, ${colors[index % colors.length]}, ${colors[(index + 1) % colors.length]});"
                         aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            `;
            container.appendChild(item);
        });
        
        console.log('âœ… Top 5 actualizado');
    }
    
    // Event listeners para botones de perÃ­odo
    document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', function() {
            const periodo = this.getAttribute('data-period');
            
            // Actualizar botones activos
            document.querySelectorAll('[data-period]').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            // Cargar datos del perÃ­odo
            loadVentasPorPeriodo(periodo);
            
            console.log('ðŸ“… PerÃ­odo cambiado a:', periodo);
        });
    });
    
    // FunciÃ³n para exportar a Excel (simplificada)
    window.exportToExcel = function() {
        console.log('ðŸ“¥ Exportando datos a Excel...');
        
        // Crear datos CSV
        let csv = 'CategorÃ­a,Ingresos,Productos Vendidos,Pedidos\n';
        for (let i = 0; i < ventasData.categorias.length; i++) {
            csv += `${ventasData.categorias[i]},${ventasData.ingresos[i]},${ventasData.productos[i]},${ventasData.pedidos[i]}\n`;
        }
        
        // Descargar archivo
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'analisis_ventas_' + currentPeriod + '_' + new Date().toISOString().split('T')[0] + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('âœ… Datos exportados exitosamente');
    };
    
    console.log('âœ… Sistema de grÃ¡ficos inicializado correctamente');
    
})();
</script>

<!-- Script de GrÃ¡ficos del HOME -->
<script>
(function() {
    'use strict';
    
    // Solo ejecutar en la vista home (sin parÃ¡metro view)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view')) {
        return; // No es la vista home
    }
    
    console.log('ðŸ  Inicializando grÃ¡ficos del panel principal (HOME)');
    
    // Datos de ventas por categorÃ­a desde Django
    const homeVentasData = {
        categorias: [
            {% for categoria in ventas_por_categoria %}
                '{{ categoria.nombre }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        ingresos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.total_ingresos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        productos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.cantidad_productos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        pedidos: [
            {% for categoria in ventas_por_categoria %}
                {{ categoria.cantidad_pedidos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    // Colores modernos para los grÃ¡ficos
    const homeColors = [
        'rgba(102, 126, 234, 0.8)',
        'rgba(118, 75, 162, 0.8)',
        'rgba(79, 172, 254, 0.8)',
        'rgba(0, 242, 254, 0.8)',
        'rgba(67, 233, 123, 0.8)',
        'rgba(245, 87, 108, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(201, 203, 207, 0.8)'
    ];
    
    const homeBorderColors = homeColors.map(color => color.replace('0.8', '1'));
    
    // ConfiguraciÃ³n del grÃ¡fico
    const homeCtx = document.getElementById('homeVentasChart');
    if (!homeCtx) {
        console.warn('âš ï¸ Canvas del grÃ¡fico HOME no encontrado');
        return;
    }
    
    let homeCurrentChart = null;
    let homeCurrentChartType = 'bar';
    
    // FunciÃ³n para crear/actualizar el grÃ¡fico
    function createHomeChart(type = 'bar') {
        if (homeCurrentChart) {
            homeCurrentChart.destroy();
        }
        
        const config = {
            type: type,
            data: {
                labels: homeVentasData.categorias,
                datasets: [{
                    label: 'Ingresos ($)',
                    data: homeVentasData.ingresos,
                    backgroundColor: homeColors,
                    borderColor: homeBorderColors,
                    borderWidth: 2,
                    borderRadius: type === 'bar' ? 8 : 0,
                    hoverOffset: type === 'pie' || type === 'doughnut' ? 10 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: type !== 'bar',
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            font: {
                                size: 12
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        return {
                                            text: label + ' ($' + value.toLocaleString() + ')',
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (type === 'bar') {
                                    label += '$' + context.parsed.y.toLocaleString();
                                } else {
                                    label += '$' + context.parsed.toLocaleString();
                                }
                                return label;
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: type === 'bar' ? {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                } : {}
            }
        };
        
        homeCurrentChart = new Chart(homeCtx, config);
        homeCurrentChartType = type;
        
        console.log(`âœ… GrÃ¡fico HOME ${type} creado exitosamente`);
    }
    
    // Crear grÃ¡fico inicial
    createHomeChart('bar');
    
    // Event listeners para cambio de tipo de grÃ¡fico en HOME
    document.querySelectorAll('[data-chart-type]').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.getAttribute('data-chart-type');
            
            // Actualizar botones activos
            document.querySelectorAll('[data-chart-type]').forEach(b => {
                b.classList.remove('active');
            });
            this.classList.add('active');
            
            // Crear nuevo grÃ¡fico
            createHomeChart(type);
            
            console.log('ðŸ“Š Tipo de grÃ¡fico HOME cambiado a:', type);
        });
    });
    
    // FunciÃ³n para exportar a Excel del HOME
    window.exportToExcelHome = function() {
        console.log('ðŸ“¥ Exportando datos del HOME a Excel...');
        
        // Crear datos CSV
        let csv = 'CategorÃ­a,Ingresos,Productos Vendidos,Pedidos\n';
        for (let i = 0; i < homeVentasData.categorias.length; i++) {
            csv += `${homeVentasData.categorias[i]},${homeVentasData.ingresos[i]},${homeVentasData.productos[i]},${homeVentasData.pedidos[i]}\n`;
        }
        
        // Descargar archivo
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'resumen_ventas_' + new Date().toISOString().split('T')[0] + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('âœ… Datos del HOME exportados exitosamente');
    };
    
    console.log('âœ… Sistema de grÃ¡ficos HOME inicializado correctamente');
    
})();
</script>

<!-- Script de GrÃ¡ficos de Inventario -->
<script>
(function() {
    'use strict';
    
    // Solo ejecutar en la vista de inventario
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('view') !== 'inventario') {
        return;
    }
    
    console.log('ðŸ“¦ Inicializando sistema de inventario avanzado');
    
    // Datos de inventario por categorÃ­a desde Django
    const inventoryData = {
        categorias: [
            {% for cat in inventario_by_category %}
                '{{ cat.category_name }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        valorInvertido: [
            {% for cat in inventario_by_category %}
                {{ cat.valor_invertido|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        valorVenta: [
            {% for cat in inventario_by_category %}
                {{ cat.valor_productos|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        stock: [
            {% for cat in inventario_by_category %}
                {{ cat.cantidad_stock|default:0 }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        productos: [
            {% for cat in inventario_by_category %}
                {{ cat.items|length }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    // Verificar si hay datos
    const hasData = inventoryData.categorias.length > 0;
    const hasSingleCategory = inventoryData.categorias.length === 1;
    
    console.log('ðŸ“Š Datos de inventario:', {
        categorias: inventoryData.categorias.length,
        hasData: hasData,
        hasSingleCategory: hasSingleCategory
    });
    
    if (!hasData) {
        console.warn('âš ï¸ No hay datos de inventario para mostrar grÃ¡ficos');
    } else if (hasSingleCategory) {
        console.log('â„¹ï¸ Mostrando datos de una sola categorÃ­a:', inventoryData.categorias[0]);
    }
    
    // FunciÃ³n para mostrar placeholder
    function showPlaceholder(canvasId, icon = 'chart-bar') {
        const canvas = document.getElementById(canvasId);
        if (canvas) {
            const container = canvas.closest('.chart-container');
            if (container) {
                container.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <i class="fas fa-${icon} fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">No hay datos para mostrar</p>
                            <small class="text-muted">Selecciona una categorÃ­a con productos</small>
                        </div>
                    </div>
                `;
            }
        }
    }
    
    // Si no hay datos, mostrar placeholders y salir
    if (!hasData) {
        showPlaceholder('inventoryValueChart', 'chart-bar');
        showPlaceholder('inventoryStockChart', 'chart-pie');
        return;
    }
    
    // Colores para grÃ¡ficos
    const invColors = [
        'rgba(102, 126, 234, 0.8)',
        'rgba(118, 75, 162, 0.8)',
        'rgba(79, 172, 254, 0.8)',
        'rgba(0, 242, 254, 0.8)',
        'rgba(67, 233, 123, 0.8)',
        'rgba(245, 87, 108, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(201, 203, 207, 0.8)'
    ];
    
    const invBorderColors = invColors.map(color => color.replace('0.8', '1'));
    
    // GRÃFICO 1: ValoraciÃ³n por CategorÃ­a
    const valueChartCtx = document.getElementById('inventoryValueChart');
    let valueChart = null;
    let currentValueChartType = 'bar';
    
    if (valueChartCtx) {
        function createValueChart(type = 'bar') {
            if (valueChart) {
                valueChart.destroy();
            }
            
            // Para una sola categorÃ­a, forzar tipo bar para mejor visualizaciÃ³n
            const chartType = hasSingleCategory ? 'bar' : type;
            
            const config = {
                type: chartType,
                data: {
                    labels: inventoryData.categorias,
                    datasets: [{
                        label: 'Valor Invertido',
                        data: inventoryData.valorInvertido,
                        backgroundColor: chartType === 'bar' ? 'rgba(220, 53, 69, 0.7)' : invColors,
                        borderColor: chartType === 'bar' ? 'rgba(220, 53, 69, 1)' : invBorderColors,
                        borderWidth: 2,
                        borderRadius: chartType === 'bar' ? 6 : 0
                    }, {
                        label: 'Valor de Venta',
                        data: inventoryData.valorVenta,
                        backgroundColor: chartType === 'bar' ? 'rgba(25, 135, 84, 0.7)' : invColors,
                        borderColor: chartType === 'bar' ? 'rgba(25, 135, 84, 1)' : invBorderColors,
                        borderWidth: 2,
                        borderRadius: chartType === 'bar' ? 6 : 0,
                        hidden: chartType !== 'bar'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: type === 'bar' ? 'top' : 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = type === 'bar' ? context.parsed.y : context.parsed;
                                    label += '$' + value.toLocaleString();
                                    return label;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: chartType === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    } : {}
                }
            };
            
            valueChart = new Chart(valueChartCtx, config);
            currentValueChartType = chartType;
            console.log(`âœ… GrÃ¡fico de valoraciÃ³n (${chartType}) creado con ${inventoryData.categorias.length} categorÃ­a(s)`);
        }
        
        createValueChart('bar');
        
        // Event listeners para cambio de tipo (deshabilitar si solo hay una categorÃ­a)
        document.querySelectorAll('[data-inv-chart-type]').forEach(btn => {
            if (hasSingleCategory) {
                // Deshabilitar botones de doughnut cuando solo hay una categorÃ­a
                if (btn.getAttribute('data-inv-chart-type') === 'doughnut') {
                    btn.disabled = true;
                    btn.classList.add('disabled');
                    btn.title = 'Requiere mÃºltiples categorÃ­as';
                }
            }
            
            btn.addEventListener('click', function() {
                if (this.disabled) return;
                
                const type = this.getAttribute('data-inv-chart-type');
                document.querySelectorAll('[data-inv-chart-type]').forEach(b => {
                    b.classList.remove('active');
                });
                this.classList.add('active');
                createValueChart(type);
            });
        });
    }
    
    // GRÃFICO 2: Stock por CategorÃ­a (Doughnut o Bar para una sola categorÃ­a)
    const stockChartCtx = document.getElementById('inventoryStockChart');
    
    if (stockChartCtx) {
        // Si solo hay una categorÃ­a, usar grÃ¡fico de barras en lugar de doughnut
        const stockChartType = hasSingleCategory ? 'bar' : 'doughnut';
        
        const stockChart = new Chart(stockChartCtx, {
            type: stockChartType,
            data: {
                labels: inventoryData.categorias,
                datasets: [{
                    label: 'Unidades en Stock',
                    data: inventoryData.stock,
                    backgroundColor: hasSingleCategory ? 'rgba(79, 172, 254, 0.8)' : invColors,
                    borderColor: hasSingleCategory ? 'rgba(79, 172, 254, 1)' : invBorderColors,
                    borderWidth: 2,
                    borderRadius: hasSingleCategory ? 6 : 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: !hasSingleCategory,
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 10,
                            font: { size: 11 },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        return {
                                            text: label + ' (' + value + ')',
                                            fillStyle: data.datasets[0].backgroundColor[i] || data.datasets[0].backgroundColor,
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = hasSingleCategory ? context.parsed.y : context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value + ' unidades' + (hasSingleCategory ? '' : ' (' + percentage + '%)');
                            }
                        },
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: hasSingleCategory ? {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' unidades';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                } : {}
            }
        });
        
        console.log(`âœ… GrÃ¡fico de stock (${stockChartType}) creado con ${inventoryData.categorias.length} categorÃ­a(s)`);
    }
    
    // FunciÃ³n para exportar reportes
    window.exportInventoryReport = function(format) {
        console.log(`ðŸ“¥ Exportando reporte de inventario (${format})...`);
        
        if (!hasData) {
            showNotification('No hay datos para exportar', 'warning');
            return;
        }
        
        if (format === 'excel' || format === 'pdf') {
            // Extraer datos de las tablas del DOM
            let csv = 'CategorÃ­a,Producto,Stock,Precio Compra,Precio Venta,InversiÃ³n Total,Valor Total,Margen\n';
            
            // Recorrer todas las tablas de categorÃ­as
            const tables = document.querySelectorAll('.modern-card table tbody');
            tables.forEach(tbody => {
                const rows = tbody.querySelectorAll('tr:not(tfoot tr)');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 6) {
                        // Obtener categorÃ­a del header mÃ¡s cercano
                        const card = row.closest('.modern-card');
                        const categoryName = card ? card.querySelector('.card-header h5')?.textContent.trim().replace(/\\n/g, ' ').replace(/\\s+/g, ' ') : 'Sin CategorÃ­a';
                        
                        const productName = cells[0].querySelector('strong')?.textContent.trim() || '';
                        const stock = cells[1].textContent.trim().replace(/[^0-9]/g, '');
                        const priceBuy = cells[2].textContent.trim().replace(/[$,]/g, '');
                        const priceSell = cells[3].textContent.trim().replace(/[$,]/g, '');
                        const invTotal = cells[4].textContent.trim().replace(/[$,]/g, '');
                        const valTotal = cells[5].textContent.trim().replace(/[$,]/g, '');
                        const margin = (parseFloat(valTotal) - parseFloat(invTotal)).toFixed(2);
                        
                        csv += `"${categoryName}","${productName}",${stock},${priceBuy},${priceSell},${invTotal},${valTotal},${margin}\\n`;
                    }
                });
            });
            
            // Agregar resumen general
            csv += '\\n\\nRESUMEN GENERAL\\n';
            csv += 'Concepto,Valor\\n';
            csv += 'Total Productos,{{ resumen_inventario.cantidad_productos_stock }}\\n';
            csv += 'Capital Invertido,${{ resumen_inventario.valor_invertido|floatformat:2 }}\\n';
            csv += 'Valor de Venta,${{ resumen_inventario.valor_productos|floatformat:2 }}\\n';
            csv += 'Margen de Ganancia,${{ resumen_inventario.margen_ganancia|floatformat:2 }}\\n';
            
            // Agregar informaciÃ³n de categorÃ­as
            csv += '\\n\\nDETALLE POR CATEGORÃA\\n';
            csv += 'CategorÃ­a,Stock Total,InversiÃ³n,Valor Venta\\n';
            inventoryData.categorias.forEach((cat, i) => {
                csv += `"${cat}",${inventoryData.stock[i]},$${inventoryData.valorInvertido[i]},$${inventoryData.valorVenta[i]}\\n`;
            });
            
            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fecha = new Date().toISOString().split('T')[0];
            a.download = `inventario_completo_${fecha}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('âœ… Reporte exportado exitosamente');
            showNotification('Â¡Reporte generado exitosamente!', 'success');
        }
    };
    
    // FunciÃ³n auxiliar para mostrar notificaciones
    function showNotification(message, type = 'success') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alert.style.zIndex = '9999';
        alert.style.minWidth = '300px';
        
        const icon = type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle';
        alert.innerHTML = `
            <i class="fas fa-${icon} me-2"></i>
            <strong>${message}</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }, 4000);
    }
    
    // FunciÃ³n para imprimir inventario
    window.printInventory = function() {
        console.log('ðŸ–¨ï¸ Preparando impresiÃ³n...');
        
        if (!hasData) {
            showNotification('No hay datos para imprimir', 'warning');
            return;
        }
        
        // Agregar clase temporal para ocultar elementos innecesarios
        document.body.classList.add('printing-inventory');
        
        // Imprimir
        setTimeout(() => {
            window.print();
            // Remover clase despuÃ©s de imprimir
            setTimeout(() => {
                document.body.classList.remove('printing-inventory');
            }, 100);
        }, 100);
    };
    
    console.log('âœ… Sistema de inventario inicializado correctamente');
    
})();
</script>

<!-- Estilos adicionales para visitas y impresiÃ³n -->
<style>
/* Estilos para scroll de visitas - Desktop */
.visitas-table-scroll {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: hidden;
    scroll-behavior: smooth;
}

.visitas-table-scroll::-webkit-scrollbar {
    width: 10px;
}

.visitas-table-scroll::-webkit-scrollbar-track {
    background: #e9ecef;
    border-radius: 10px;
}

.visitas-table-scroll::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 10px;
    border: 2px solid #e9ecef;
}

.visitas-table-scroll::-webkit-scrollbar-thumb:hover {
    background: #495057;
}

/* Headers sticky para tabla de visitas */
.visitas-thead-sticky {
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: #f8f9fa !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.visitas-thead-sticky th {
    background-color: #f8f9fa !important;
}

/* Scroll suave para tarjetas mÃ³viles */
.visitas-mobile-scroll {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: hidden;
    scroll-behavior: smooth;
}

.visitas-mobile-scroll::-webkit-scrollbar {
    width: 8px;
}

.visitas-mobile-scroll::-webkit-scrollbar-track {
    background: #e9ecef;
    border-radius: 10px;
}

.visitas-mobile-scroll::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 10px;
    border: 2px solid #e9ecef;
}

.visitas-mobile-scroll::-webkit-scrollbar-thumb:hover {
    background: #495057;
}

@media print {
    /* Ocultar elementos innecesarios */
    .sidebar, 
    .mobile-header, 
    .btn, 
    .alert:not(.alert-danger):not(.alert-warning), 
    .form-select,
    .form-control,
    nav,
    .btn-group,
    .card-header .btn,
    .modern-stat-card .stat-trend {
        display: none !important;
    }
    
    /* Ajustar contenido principal */
    .main-content {
        margin: 0 !important;
        padding: 20px !important;
        width: 100% !important;
    }
    
    /* Evitar saltos de pÃ¡gina en cards */
    .card {
        break-inside: avoid;
        page-break-inside: avoid;
        margin-bottom: 20px !important;
        box-shadow: none !important;
        border: 1px solid #ddd !important;
    }
    
    /* Ocultar grÃ¡ficos en impresiÃ³n */
    .chart-container {
        display: none !important;
    }
    
    /* Mantener KPIs visibles */
    .modern-stat-card {
        break-inside: avoid;
        page-break-inside: avoid;
        border: 1px solid #ddd !important;
        box-shadow: none !important;
    }
    
    .modern-stat-card .stat-value {
        font-size: 1.5rem !important;
    }
    
    /* Mejorar visualizaciÃ³n de tablas */
    table {
        font-size: 0.85rem !important;
    }
    
    thead {
        background: #f8f9fa !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    /* Encabezado de reporte */
    .inventario-dashboard-modern::before {
        content: 'REPORTE DE INVENTARIO - CompuEasys';
        display: block;
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #333;
    }
    
    .inventario-dashboard-modern::after {
        content: 'Fecha: ' attr(data-print-date);
        display: block;
        text-align: right;
        font-size: 0.9rem;
        margin-top: 10px;
    }
}

/* Estilos adicionales para indicadores de stock */
.product-status-indicator {
    display: inline-block;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* AnimaciÃ³n para notificaciones */
@keyframes slideInDown {
    from {
        transform: translate(-50%, -100%);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

.alert.position-fixed {
    animation: slideInDown 0.3s ease-out;
}
</style>

<script>
// Autofocus en el campo nombre del producto al crear o editar
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si estamos en la vista de productos y en modo crear o editar
    const urlParams = new URLSearchParams(window.location.search);
    const isProductView = urlParams.get('view') === 'productos';
    const isCreating = urlParams.has('crear');
    const isEditing = urlParams.has('editar');
    
    if (isProductView && (isCreating || isEditing)) {
        const productNameInput = document.getElementById('producto_name');
        if (productNameInput) {
            // Hacer focus despuÃ©s de un pequeÃ±o delay para asegurar que el DOM estÃ© listo
            setTimeout(() => {
                productNameInput.focus();
                // Seleccionar todo el texto si estamos editando
                if (isEditing && productNameInput.value) {
                    productNameInput.select();
                }
            }, 100);
        }
    }
});

// Sistema de colapso de cards del dashboard
document.addEventListener('DOMContentLoaded', function() {
    // ConfiguraciÃ³n de cards colapsables
    const collapsibleCards = [
        {
            id: 'ventasCategorias',
            toggleBtn: 'toggleVentasCategorias',
            content: 'ventasCategoriasContent',
            icon: 'iconVentasCategorias',
            storageKey: 'ventasCategoriasCollapsed'
        },
        {
            id: 'graficoVentas',
            toggleBtn: 'toggleGraficoVentas',
            content: 'graficoVentasContent',
            icon: 'iconGraficoVentas',
            storageKey: 'graficoVentasCollapsed'
        },
        {
            id: 'topCategorias',
            toggleBtn: 'toggleTopCategorias',
            content: 'topCategoriasContent',
            icon: 'iconTopCategorias',
            storageKey: 'topCategoriasCollapsed'
        }
    ];

    // FunciÃ³n para colapsar/expandir un card
    function setupCollapsibleCard(config) {
        const toggleBtn = document.getElementById(config.toggleBtn);
        const content = document.getElementById(config.content);
        const icon = document.getElementById(config.icon);
        
        if (!toggleBtn || !content || !icon) return;

        // Restaurar estado desde localStorage
        const isCollapsed = localStorage.getItem(config.storageKey) === 'true';
        if (isCollapsed) {
            content.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }

        // Agregar transiciÃ³n suave
        content.style.transition = 'all 0.3s ease-in-out';
        icon.style.transition = 'transform 0.3s ease-in-out';

        // Manejar click en el botÃ³n
        toggleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const currentlyHidden = content.style.display === 'none';
            
            if (currentlyHidden) {
                // Expandir
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                localStorage.setItem(config.storageKey, 'false');
            } else {
                // Colapsar
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                localStorage.setItem(config.storageKey, 'true');
            }
        });
    }

    // Inicializar todos los cards colapsables
    collapsibleCards.forEach(config => setupCollapsibleCard(config));
});

// ========================================
// FUNCIONES PARA NOTIFICACIONES DE STOCK
// ========================================

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function markAsNotified(notificationId) {
    if (!confirm('Â¿Confirmas que deseas marcar esta notificaciÃ³n como enviada?')) {
        return;
    }

    const csrftoken = getCookie('csrftoken');
    
    fetch(`/dashboard/notification/${notificationId}/mark_sent/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar mensaje de Ã©xito con animaciÃ³n
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 animate-fade-in';
            alertDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>NotificaciÃ³n marcada como enviada';
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
                location.reload();
            }, 2000);
        } else {
            alert('Error: ' + (data.error || 'No se pudo marcar la notificaciÃ³n'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al procesar la solicitud');
    });
}

function viewNotificationDetails(notificationId) {
    // Crear modal con detalles
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-info-circle text-indigo-600"></i>
                    Detalles de NotificaciÃ³n
                </h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="notification-details-content" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
                <p class="text-gray-600 mt-4">Cargando detalles...</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Cargar detalles con fetch
    fetch(`/dashboard/notification/${notificationId}/details/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const notification = data.notification;
                document.getElementById('notification-details-content').innerHTML = `
                    <div class="space-y-6 text-left">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Usuario</label>
                                <p class="text-gray-800 mt-1">${notification.email}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Producto</label>
                                <p class="text-gray-800 mt-1">${notification.product_name}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Tipo</label>
                                <p class="text-gray-800 mt-1">${notification.notification_type_display}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Estado</label>
                                <p class="text-gray-800 mt-1">
                                    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold ${
                                        notification.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                        notification.status === 'sent' ? 'bg-green-100 text-green-700' :
                                        'bg-red-100 text-red-700'
                                    }">
                                        ${notification.status_display}
                                    </span>
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Fecha de Registro</label>
                                <p class="text-gray-800 mt-1">${notification.created_at}</p>
                            </div>
                            ${notification.sent_at ? `
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Fecha de EnvÃ­o</label>
                                <p class="text-gray-800 mt-1">${notification.sent_at}</p>
                            </div>
                            ` : ''}
                        </div>
                        ${notification.target_price ? `
                        <div>
                            <label class="text-sm font-semibold text-gray-600">Precio Objetivo</label>
                            <p class="text-gray-800 mt-1">$${notification.target_price}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else {
                document.getElementById('notification-details-content').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-600"></i>
                        <p class="text-gray-600 mt-4">Error al cargar los detalles</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('notification-details-content').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-600"></i>
                    <p class="text-gray-600 mt-4">Error de conexiÃ³n</p>
                </div>
            `;
        });
}
</script>
</html>