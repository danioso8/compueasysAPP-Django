<!-- filepath: d:\ESCRITORIO\CompueasysApp\dashboard\templates\dashboard\dashboard_home.html -->
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <title>Dashboard Tienda</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>
<body>
    <header>
       <div class="admin-container">
         <h1>Tienda CompuEasys</h1>
          <div class="logout-container">
            <form method="post" action="{% url 'logout_view' %}">
                {% csrf_token %}
                <button type="submit" class="btn ">Cerrar sesión</button>
            </form>
          </div>
       </div>
    </header>
    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <!-- Header del Sidebar con botón toggle -->
            <div class="sidebar-header">
                <div class="logo-area">
                    <i class="fas fa-desktop sidebar-logo-icon"></i>
                    <span class="sidebar-text logo-text">CompuEasys</span>
                </div>
                <button class="sidebar-toggle" id="sidebarToggle" title="Contraer/Expandir sidebar">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <!-- Navegación Principal -->
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li class="nav-item">
                        <a href="/dashboard/dashboard_home/" class="nav-link {% if not request.GET.view %}active{% endif %}" title="Panel Principal">
                            <i class="fas fa-chart-line nav-icon"></i>
                            <span class="sidebar-text">Home</span>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a href="?view=ventas" class="nav-link {% if request.GET.view == 'ventas' %}active{% endif %}" title="Análisis de Ventas">
                            <i class="fas fa-chart-bar nav-icon"></i>
                            <span class="sidebar-text">Análisis Ventas</span>
                        </a>
                    </li>
                    
                    <li class="nav-separator"></li>
                    
                    <li class="nav-item">
                        <a href="?view=pedidos" class="nav-link {% if request.GET.view == 'pedidos' %}active{% endif %}" title="Gestión de Pedidos">
                            <i class="fas fa-shopping-cart nav-icon"></i>
                            <span class="sidebar-text">Pedidos</span>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a href="?view=productos" class="nav-link {% if request.GET.view == 'productos' %}active{% endif %}" title="Gestión de Productos">
                            <i class="fas fa-boxes nav-icon"></i>
                            <span class="sidebar-text">Productos</span>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a href="?view=inventario" class="nav-link {% if request.GET.view == 'inventario' %}active{% endif %}" title="Control de Inventario">
                            <i class="fas fa-warehouse nav-icon"></i>
                            <span class="sidebar-text">Inventario</span>
                        </a>
                    </li>
                    
                    <li class="nav-separator"></li>
                    
                    <li class="nav-item">
                        <a href="?view=categoria" class="nav-link {% if request.GET.view == 'categoria' %}active{% endif %}" title="Gestión de Categorías">
                            <i class="fas fa-tags nav-icon"></i>
                            <span class="sidebar-text">Categorías</span>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a href="?view=tipos" class="nav-link {% if request.GET.view == 'tipos' %}active{% endif %}" title="Gestión de Tipos">
                            <i class="fas fa-list nav-icon"></i>
                            <span class="sidebar-text">Tipos</span>
                        </a>
                    </li>
                    
                    <li class="nav-item">
                        <a href="?view=proveedores" class="nav-link {% if request.GET.view == 'proveedores' %}active{% endif %}" title="Gestión de Proveedores">
                            <i class="fas fa-truck nav-icon"></i>
                            <span class="sidebar-text">Proveedores</span>
                        </a>
                    </li>
                    
                    <li class="nav-separator"></li>
                    
                    <li class="nav-item">
                        <a href="?view=usuarios" class="nav-link {% if request.GET.view == 'usuarios' %}active{% endif %}" title="Gestión de Usuarios">
                            <i class="fas fa-users nav-icon"></i>
                            <span class="sidebar-text">Usuarios</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- Footer del Sidebar -->
            <div class="sidebar-footer">
                <div class="user-info">
                    <i class="fas fa-user-shield nav-icon"></i>
                    <span class="sidebar-text">Admin</span>
                </div>
            </div>
        </aside>
        <main class="main-content">
            {% if request.GET.view == "usuarios" %}
                <h2>Usuarios</h2>

                 <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"> 
                <table>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Staff</th>
                        <th>Super</th>
                        <th>Activo</th>
                        <th>Admin</th>
                        <th>Acciones</th>
                    </tr>
                    {% for usuario in usuarios %}
                    <tr>
                        <td>{{ usuario.username }}</td>
                        <td>{{ usuario.email }}</td>
                        <td>
                            <select name="is_staff">
                                <option value="True">Sí</option>
                                <option value="False">No</option>
                            </select>
                        </td>
                        <td>
                            <select name="is_superuser">
                                <option value="True">Sí</option>
                                <option value="False">No</option>
                            </select>
                        </td>
                        <td>
                            <select name="is_active">
                                <option value="True">Sí</option>
                                <option value="False">No</option>
                            </select>
                        </td>
                        <td>
                            <select name="is_admin">
                                <option value="True">Sí</option>
                                <option value="False">No</option>
                            </select>
                        </td>                    
                            
                            <td>
                                <button class="btn btn-primary" onclick="openEditModal('{{ usuario.id }}', '{{ usuario.username }}', '{{ usuario.email }}')">Editar</button>
                                <button  class="btn btn-danger eliminar-usuario-btn" data-user-id="{{ usuario.id }}">x</button>
                                <button  class="btn btn-info" href="?view=usuarios&reset_password={{ usuario.id }}">Restablecer contraseña</button>
                           </td>
                            {% if usuario.is_staff %}
                                <span>Admin</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% for usuario in usuarios_super %}
                    <tr>
                        <td>{{ usuario.username }}</td>
                        <td>{{ usuario.email }}</td>
                        <td>
                            <select name="is_staff">
                                <option value="True">Sí</option>
                                <option value="False">No</option>
                            </select>
                        </td>
                        <td>
                            <select name="is_superuser">
                                <option value="True">Sí</option>
                                <option value="False">No</option>
                            </select>
                        </td>
                        <td>
                            <select name="is_active">
                                <option value="True">Sí</option>
                                <option value="False">No</option>
                            </select>
                        </td>
                        <td>
                            <select name="is_admin">
                                <option value="True">Sí</option>
                                <option value="False">No</option>
                            </select>
                        </td>
                        <td>
                            <td>
                                <button onclick="openEditModal('{{ usuario.id }}', '{{ usuario.username }}', '{{ usuario.email }}')">Editar</button>
                            <td>
                                <button class="btn btn-danger eliminar-usuario-btn" data-user-id="{{ usuario.id }}">Eliminar</button>
                            </td>
                            {% if usuario.is_staff %}
                                <span>Admin</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            {% elif request.GET.view == "productos" %}
                <div class="productos-dashboard">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-boxes me-2"></i>Gestión de Productos</h2>
                        <a href="?view=productos&crear=1" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Crear Producto
                        </a>
                    </div>

                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
                        </div>
                        <div class="card-body">
                            <form method="GET" class="row g-3">
                                <input type="hidden" name="view" value="productos">
                                
                                <div class="col-md-4">
                                    <label for="categoria_filter" class="form-label">Filtrar por Categoría:</label>
                                    <select name="categoria_filter" id="categoria_filter" class="form-select">
                                        <option value="">Todas las categorías</option>
                                        {% for categoria in categorias %}
                                            <option value="{{ categoria.id }}" {% if categoria_filter == categoria.id|stringformat:"s" %}selected{% endif %}>
                                                {{ categoria.nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="search" class="form-label">Buscar producto:</label>
                                    <input type="text" name="search" id="search" class="form-control" 
                                           value="{{ search_query }}" placeholder="Buscar por nombre o descripción">
                                </div>
                                
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary me-2">
                                        <i class="fas fa-search me-2"></i>Filtrar
                                    </button>
                                    <a href="?view=productos" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Limpiar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Información de resultados -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="results-info">
                            <span class="badge bg-info">
                                Total: {{ productos_page.paginator.count }} producto(s)
                            </span>
                            {% if categoria_filter %}
                                <span class="badge bg-success ms-2">
                                    Filtrado por categoría
                                </span>
                            {% endif %}
                            {% if search_query %}
                                <span class="badge bg-warning ms-2">
                                    Búsqueda: "{{ search_query }}"
                                </span>
                            {% endif %}
                        </div>
                        
                        <div class="pagination-info">
                            Página {{ productos_page.number }} de {{ productos_page.paginator.num_pages }}
                        </div>
                    </div>

                    <!-- Tabla de productos -->
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col" style="width: 80px;">Imagen</th>
                                            <th scope="col">Nombre</th>
                                            <th scope="col">Categoría</th>
                                            <th scope="col">Stock</th>
                                            <th scope="col">Precio Compra</th>
                                            <th scope="col">Precio Venta</th>
                                            <th scope="col">Proveedor</th>
                                            <th scope="col" style="width: 150px;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for producto in productos %}
                                        <tr data-producto-id="{{ producto.id }}">
                                            <td class="text-center">
                                                {% if producto.imagen %}
                                                    <img src="{{ producto.imagen.url }}" alt="{{ producto.name }}" 
                                                         class="product-thumbnail rounded" width="50" height="50" 
                                                         style="object-fit: cover;"/>
                                                {% else %}
                                                    <div class="no-image-placeholder">
                                                        <i class="fas fa-image text-muted"></i>
                                                    </div>
                                                {% endif %} 
                                            </td>
                                            <td class="align-middle">
                                                <div class="product-info">
                                                    <strong>{{ producto.name }}</strong>
                                                    {% if producto.description %}
                                                        <br><small class="text-muted">{{ producto.description|truncatechars:50 }}</small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td class="align-middle">
                                                {% if producto.category %}
                                                    <span class="badge bg-primary">{{ producto.category.nombre }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Sin categoría</span>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                {% if producto.stock > 10 %}
                                                    <span class="badge bg-success">{{ producto.stock }}</span>
                                                {% elif producto.stock > 0 %}
                                                    <span class="badge bg-warning">{{ producto.stock }}</span>
                                                {% else %}
                                                    <span class="badge bg-danger">{{ producto.stock }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                <span class="text-muted">${{ producto.price_buy|floatformat:0 }}</span>
                                            </td>
                                            <td class="align-middle">
                                                <strong class="text-success">${{ producto.price|floatformat:0 }}</strong>
                                            </td>
                                            <td class="align-middle">
                                                {% if producto.proveedor %}
                                                    <small>{{ producto.proveedor.nombre }}</small>
                                                {% else %}
                                                    <small class="text-muted">Sin proveedor</small>
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="?view=productos&editar={{ producto.id }}" 
                                                       class="btn btn-outline-primary" title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <button type="button" 
                                                            class="btn btn-outline-danger delete-product-btn" 
                                                            data-product-id="{{ producto.id }}" title="Eliminar">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center py-4">
                                                <div class="no-products">
                                                    <i class="fas fa-box-open text-muted" style="font-size: 3rem;"></i>
                                                    <h5 class="mt-3 text-muted">No hay productos</h5>
                                                    <p class="text-muted">
                                                        {% if categoria_filter or search_query %}
                                                            No se encontraron productos con los filtros aplicados.
                                                        {% else %}
                                                            Aún no has agregado productos a tu inventario.
                                                        {% endif %}
                                                    </p>
                                                    {% if not categoria_filter and not search_query %}
                                                        <a href="?view=productos&crear=1" class="btn btn-primary">
                                                            <i class="fas fa-plus me-2"></i>Crear primer producto
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Paginación -->
                    {% if productos_page.paginator.num_pages > 1 %}
                    <nav aria-label="Paginación de productos" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <!-- Primera página -->
                            {% if productos_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page=1">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <!-- Página anterior -->
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ productos_page.previous_page_number }}">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-left"></i></span>
                                </li>
                            {% endif %}

                            <!-- Páginas numeradas -->
                            {% for num in productos_page.paginator.page_range %}
                                {% if num == productos_page.number %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > productos_page.number|add:'-3' and num < productos_page.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ num }}">
                                            {{ num }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            <!-- Página siguiente -->
                            {% if productos_page.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ productos_page.next_page_number }}">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <!-- Última página -->
                                <li class="page-item">
                                    <a class="page-link" href="?view=productos{% if categoria_filter %}&categoria_filter={{ categoria_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&page={{ productos_page.paginator.num_pages }}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-right"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>

                    <!-- Información de la paginación -->
                    <div class="text-center text-muted">
                        <small>
                            Mostrando 
                            <strong>{{ productos_page.start_index }}</strong> - <strong>{{ productos_page.end_index }}</strong> 
                            de <strong>{{ productos_page.paginator.count }}</strong> productos
                        </small>
                    </div>
                    {% endif %}
                </div>
                </table>
               
            <!-- ...existing code... -->
            {% if show_create_product_form or show_edit_product_form %}
               <h2 id="form-title">Crear Producto</h2>
               <form id="form-crear-producto" method="post" enctype="multipart/form-data" class="form-crear-producto" action="{% url 'dashboard_home' %}?view=productos&crear=1" data-create-action="{% url 'dashboard_home' %}?view=productos&crear=1">
               {% csrf_token %}
              <input type="hidden" name="product_id" id="producto_id" value="" />

             <label>Nombre:</label>
             <input type="text" name="name" id="producto_name" required />

             <label>Descripción:</label>
            <textarea name="description" id="producto_description"></textarea>
 
            <div class="precios">
              <div>
                <label>Precio de compra:</label>
                <input type="number" name="price_buy" id="producto_price_buy" step="0.01" required />
             </div>
            <div>
                <label>Precio de venta:</label>
                <input type="number" name="price" id="producto_price" step="0.01" required />
            </div>
            <div>
                <label>Stock:</label>
                <input type="number" name="stock" id="producto_stock" required />
            </div>
            <div>
                <label>Descuento:</label>
                <input type="number" name="descuento" id="producto_descuento" step="0.01" />
            </div>
            <div>
                <label>IVA:</label>
                <input type="number" name="iva" id="producto_iva" step="0.01" />
            </div>
        </div>

        <div class="categorias-proveedor">
            <div>
                <label>Proveedor:</label>
                <select name="proveedor" id="producto_proveedor" class="form-select">
                    <option value="">Seleccione un proveedor</option>
                    {% for prov in proveedores %}
                        <option value="{{ prov.id }}">{{ prov.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Categorías:</label>
                <select name="categoria" id="producto_categoria" class="form-select">
                    <option value="">Seleccione una categoría</option>
                    {% for categoria in categorias %}
                        <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Tipo de producto:</label>
                <select name="type" id="producto_type" class="form-select">
                    <option value="">Seleccione un tipo</option>
                    {% for tipo in tipos %}
                        <option value="{{ tipo.id }}">{{ tipo.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <label>Imagen principal:</label>
        <input type="file" name="images" id="producto_images" />
        <div id="preview-main" style="margin-top:8px;">
            <img id="preview-main-img" src="" alt="Imagen principal" style="max-width:150px; display:none;" />
        </div>

        <label>Galería:</label>
<input type="file" name="galeria" id="producto_galeria" multiple />
<div id="preview-gallery" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
  {# imágenes existentes (solo si existe producto_to_edit) #}
  {% if producto_to_edit %}
    {% for img in producto_to_edit.galeria.all %}
      <div class="gallery-item position-relative" data-gallery-id="{{ img.id }}" style="position:relative;">
        {% if img.galeria and img.galeria.name %}
          <img src="{{ img.galeria.url }}" style="max-width:120px; max-height:120px; object-fit:cover; border-radius:6px;" />
        {% elif img.imagen and img.imagen.name %}
          <img src="{{ img.imagen.url }}" style="max-width:120px; max-height:120px; object-fit:cover; border-radius:6px;" />
        {% elif img.image and img.image.name %}
          <img src="{{ img.image.url }}" style="max-width:120px; max-height:120px; object-fit:cover; border-radius:6px;" />
        {% endif %}
        <button type="button" class="btn btn-sm btn-danger gallery-remove-btn" data-gallery-id="{{ img.id }}" style="position:absolute; top:4px; right:4px; border-radius:50%;">×</button>
      </div>
    {% endfor %}
  {% endif %}
  {# previews de archivos nuevos serán añadidos por JS aquí #}
</div>

{# input oculto para listar imágenes existentes (opcional, ayuda al servidor) #}
{% if producto_to_edit %}
  {% for img in producto_to_edit.galeria.all %}
    <input type="hidden" name="galeria_existing[]" value="{{ img.id }}">
  {% endfor %}
{% endif %}

<!-- Variantes -->
<label>Variantes:</label>
<div id="variantes-container">
  {# variantes existentes (editar) #}
  {% if producto_to_edit %}
    {% for v in producto_to_edit.variants.all %}
      <div class="variante-row d-flex gap-2 mb-2 align-items-center" data-variant-id="{{ v.id }}">
        <button type="button" class="btn btn-sm btn-danger variant-remove-btn" data-variant-id="{{ v.id }}" style="margin-right:6px;">×</button>
        <input type="text" name="variante_nombre[]" value="{{ v.nombre }}" placeholder="Nombre variante" class="form-control" />
        <input type="number" name="variante_precio[]" value="{{ v.precio }}" placeholder="Precio" step="0.01" class="form-control" />
        <input type="number" name="variante_stock[]" value="{{ v.stock }}" placeholder="Stock" class="form-control" />
        <input type="text" name="variante_color[]" value="{{ v.color }}" placeholder="Color" class="form-control" />
        <input type="text" name="variante_talla[]" value="{{ v.talla }}" placeholder="Talla" class="form-control" />
        <input type="file" name="variante_imagen[]" class="form-control" />
        {% if v.imagen and v.imagen.name %}
          <img src="{{ v.imagen.url }}" style="max-width:80px; margin-left:6px; object-fit:cover;" />
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    {# fila vacía por defecto para crear #}
    <div class="variante-row d-flex gap-2 mb-2 align-items-center">
      <button type="button" class="btn btn-sm btn-danger variant-remove-btn-new" style="display:none; margin-right:6px;">×</button>
      <input type="text" name="variante_nombre[]" placeholder="Nombre variante" class="form-control" />
      <input type="number" name="variante_precio[]" placeholder="Precio" step="0.01" class="form-control" />
      <input type="number" name="variante_stock[]" placeholder="Stock" class="form-control" />
      <input type="text" name="variante_color[]" placeholder="Color" class="form-control" />
      <input type="text" name="variante_talla[]" placeholder="Talla" class="form-control" />
      <input type="file" name="variante_imagen[]" class="form-control" />
    </div>
  {% endif %}
</div>
        <button type="button" onclick="agregarVariante()">Agregar otra variante</button>
        <button type="submit" id="form-submit-btn">Guardar</button>
        <button type="button" id="form-clear-btn">Nuevo</button>
    </form>
{% endif %}


<!-- ...existing code... -->
            {% elif request.GET.view == "pedidos" %}
                <h2>Pedidos</h2>
                <table>
                    <tr>
                       
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Total</th>
                        <th>Fecha</th>
                    </tr>
                    {% for pedido in pedidos %}
                    <tr>
                        <td>{{ pedido.nombre }}</td>
                        <td>{{ pedido.user }}</td>
                        <td>${{ pedido.total }}</td>
                        <td>{{ pedido.created_at }}</td>
                    </tr>
                    {% endfor %}
                </table>
             {% elif request.GET.view == "inventario" %}
      <div class="inventory-filters">
        <h2>Inventario</h2>
        <form id="inventario-filter-form" method="get" action="" class="inventory-filters mb-3 d-flex align-items-center gap-2">
          <input type="hidden" name="view" value="inventario">
          <select name="inventory_category" id="inventory_category_select" class="form-select" onchange="this.form.submit()" style="max-width:320px;">
            <option value="">Todos los productos</option>
            {% for categoria in categorias %}
              <option value="{{ categoria.id }}" {% if selected_category_id and selected_category_id == categoria.id %}selected{% endif %}>{{ categoria.nombre }}</option>
            {% endfor %}
          </select>
          <a href="?view=inventario" class="btn btn-sm btn-outline-secondary ms-2">Limpiar</a>
        </form>
      </div>

      <div class="inventory-overview mb-3">
        <strong>Productos en stock:</strong> {{ cantidad_productos_stock }} &nbsp; |
        <strong>Valor invertido:</strong> ${{ valor_invertido|floatformat:2 }} &nbsp; |
        <strong>Valor total (venta):</strong> ${{ valor_productos|floatformat:2 }} &nbsp; |
        <strong>Margen:</strong> ${{ margen_ganancia|floatformat:2 }}
      </div>

      {% if inventario_by_category %}
        {% for cat in inventario_by_category %}
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ cat.category_name }}</strong>
                <small class="text-muted ms-2">({{ cat.items|length }} productos)</small>
              </div>
              <div class="text-end">
                <small class="d-block">Stock: {{ cat.cantidad_stock }}</small>
                <small class="d-block">Valor compra: ${{ cat.valor_invertido|floatformat:2 }}</small>
                <small class="d-block">Valor venta: ${{ cat.valor_productos|floatformat:2 }}</small>
              </div>
            </div>
            <div class="card-body p-0">
              <table class="table table-sm mb-0">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th class="text-end">Stock</th>
                    <th class="text-end">Precio compra</th>
                    <th class="text-end">Precio venta</th>
                    <th class="text-end">Subtotal compra</th>
                    <th class="text-end">Subtotal venta</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in cat.items %}
                    <tr>
                      <td>{{ item.product_name }}</td>
                      <td class="text-end">{{ item.stock }}</td>
                      <td class="text-end">${{ item.price_buy|floatformat:2 }}</td>
                      <td class="text-end">${{ item.price|floatformat:2 }}</td>
                      <td class="text-end">${{ item.subtotal_buy|floatformat:2 }}</td>
                      <td class="text-end">${{ item.subtotal_sell|floatformat:2 }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p>No hay productos en inventario para la categoría seleccionada.</p>
      {% endif %}
    
            {% elif request.GET.view == "categoria" %}
                <h2>Categorías</h2>
                <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#modalNuevaCategoria">
                    <i class="fas fa-plus"></i> Nueva Categoría
                </button>
                 
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Slug</th>
                            <th scope="col">Productos</th>
                            <th scope="col">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="categorias-table-body">
                        {% for categoria in categorias %}
                        <tr data-category-id="{{ categoria.id }}">
                            <td>{{ categoria.id }}</td>
                            <td>{{ categoria.nombre }}</td>
                            <td>{{ categoria.slug }}</td>
                            <td>{{ categoria.products.count }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary edit-category-btn" 
                                        data-category-id="{{ categoria.id }}"
                                        data-category-nombre="{{ categoria.nombre }}"
                                        data-category-slug="{{ categoria.slug }}"
                                        data-bs-toggle="modal" data-bs-target="#modalEditarCategoria">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button type="button" class="btn btn-sm btn-danger delete-category-btn" 
                                        data-category-id="{{ categoria.id }}"
                                        data-category-nombre="{{ categoria.nombre }}">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="no-categories-row">
                            <td colspan="5" class="text-center">No hay categorías registradas.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table> 
            {% elif request.GET.view == "tipos" %}
                 <h2>Tipos</h2>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoTipo">
                     Nuevo Tipo
                    </button>

                <table class="table mt-3">
                     <thead>
                         <tr>
                            <th>Nombre</th>
                            <th>Acciones</th>
                         </tr>
                     </thead>
                <tbody>
               {% for tipo in tipos %}
                 <tr>
                   <td>{{ tipo.name }}</td>
                   <td>
                      <a href="{% url 'edit_tipo' tipo.id %}" class="btn btn-sm btn-primary">Editar</a>
                      <a href="{% url 'delete_tipo' tipo.id %}" class="btn btn-sm btn-danger">x</a>
                   </td>
                 </tr>
               {% empty %}
              <tr><td colspan="2">No hay tipos registrados.</td></tr>
            {% endfor %}
        </tbody>
    </table>

            {% elif request.GET.view == "ventas" %}
                <div class="ventas-dashboard">
                    <h2><i class="fas fa-chart-line me-2"></i>Análisis de Ventas por Categorías</h2>
                    
                    <!-- Resumen General -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${{ total_ventas_general|floatformat:0 }}</h4>
                                            <p class="mb-0">Ventas Totales</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-dollar-sign fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ estadisticas_ventas.pedidos_totales }}</h4>
                                            <p class="mb-0">Pedidos Totales</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-shopping-cart fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ estadisticas_ventas.productos_vendidos }}</h4>
                                            <p class="mb-0">Productos Vendidos</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-boxes fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${{ estadisticas_ventas.promedio_por_pedido|floatformat:0 }}</h4>
                                            <p class="mb-0">Promedio por Pedido</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-calculator fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Categorías Destacadas -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-crown me-2"></i>Categoría con Mayores Ingresos</h5>
                                </div>
                                <div class="card-body">
                                    {% if estadisticas_ventas.categoria_mayor_ingresos %}
                                        <h4 class="text-primary">{{ estadisticas_ventas.categoria_mayor_ingresos.nombre }}</h4>
                                        <p class="mb-1"><strong>Ingresos:</strong> ${{ estadisticas_ventas.categoria_mayor_ingresos.total_ingresos|floatformat:0 }}</p>
                                        <p class="mb-1"><strong>Productos vendidos:</strong> {{ estadisticas_ventas.categoria_mayor_ingresos.cantidad_productos }}</p>
                                        <p class="mb-0"><strong>Pedidos:</strong> {{ estadisticas_ventas.categoria_mayor_ingresos.cantidad_pedidos }}</p>
                                    {% else %}
                                        <p class="text-muted">No hay datos de ventas disponibles</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Categoría Más Vendida</h5>
                                </div>
                                <div class="card-body">
                                    {% if estadisticas_ventas.categoria_mas_vendida %}
                                        <h4 class="text-success">{{ estadisticas_ventas.categoria_mas_vendida.nombre }}</h4>
                                        <p class="mb-1"><strong>Productos vendidos:</strong> {{ estadisticas_ventas.categoria_mas_vendida.cantidad_productos }}</p>
                                        <p class="mb-1"><strong>Ingresos:</strong> ${{ estadisticas_ventas.categoria_mas_vendida.total_ingresos|floatformat:0 }}</p>
                                        <p class="mb-0"><strong>Pedidos:</strong> {{ estadisticas_ventas.categoria_mas_vendida.cantidad_pedidos }}</p>
                                    {% else %}
                                        <p class="text-muted">No hay datos de ventas disponibles</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Detallada de Ventas por Categoría -->
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0"><i class="fas fa-table me-2"></i>Ventas Detalladas por Categoría</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Categoría</th>
                                            <th scope="col">Ingresos Totales</th>
                                            <th scope="col">Productos Vendidos</th>
                                            <th scope="col">Pedidos</th>
                                            <th scope="col">Promedio por Pedido</th>
                                            <th scope="col">% del Total</th>
                                            <th scope="col">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for categoria in ventas_por_categoria %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>
                                                <strong class="text-primary">{{ categoria.nombre }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">${{ categoria.total_ingresos|floatformat:0 }}</span>
                                            </td>
                                            <td>{{ categoria.cantidad_productos }}</td>
                                            <td>{{ categoria.cantidad_pedidos }}</td>
                                            <td>
                                                {% widthratio categoria.total_ingresos categoria.cantidad_pedidos 1 as promedio %}
                                                ${{ promedio|floatformat:0 }}
                                            </td>
                                            <td>
                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                <div class="progress" style="width: 60px;">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ porcentaje }}%">
                                                        {{ porcentaje|floatformat:1 }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary ver-detalle-categoria" 
                                                        data-categoria="{{ categoria.nombre }}"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#modalDetalleCategoriaVentas">
                                                    <i class="fas fa-eye"></i> Ver Detalles
                                                </button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>No hay ventas registradas aún
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            {% elif request.GET.view == "ventas" %}
                <!-- Vista Completa de Análisis de Ventas -->
                <div class="ventas-dashboard">
                    <h2><i class="fas fa-chart-line me-2"></i>Análisis Completo de Ventas por Categorías</h2>
                    <p class="text-muted mb-4">Vista detallada de todas las métricas y estadísticas de ventas</p>
                    
                    <!-- Resumen General -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${{ total_ventas_general|floatformat:0 }}</h4>
                                            <p class="mb-0">Ventas Totales</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-dollar-sign fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ estadisticas_ventas.pedidos_totales }}</h4>
                                            <p class="mb-0">Pedidos Totales</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-shopping-cart fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ estadisticas_ventas.productos_vendidos }}</h4>
                                            <p class="mb-0">Productos Vendidos</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-boxes fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${{ estadisticas_ventas.promedio_por_pedido|floatformat:0 }}</h4>
                                            <p class="mb-0">Promedio por Pedido</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-calculator fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Categorías Destacadas -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-crown me-2"></i>Categoría con Mayores Ingresos</h5>
                                </div>
                                <div class="card-body">
                                    {% if estadisticas_ventas.categoria_mayor_ingresos %}
                                        <h4 class="text-primary">{{ estadisticas_ventas.categoria_mayor_ingresos.nombre }}</h4>
                                        <p class="mb-1"><strong>Ingresos:</strong> ${{ estadisticas_ventas.categoria_mayor_ingresos.total_ingresos|floatformat:0 }}</p>
                                        <p class="mb-1"><strong>Productos vendidos:</strong> {{ estadisticas_ventas.categoria_mayor_ingresos.cantidad_productos }}</p>
                                        <p class="mb-0"><strong>Pedidos:</strong> {{ estadisticas_ventas.categoria_mayor_ingresos.cantidad_pedidos }}</p>
                                    {% else %}
                                        <p class="text-muted">No hay datos de ventas disponibles</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Categoría Más Vendida</h5>
                                </div>
                                <div class="card-body">
                                    {% if estadisticas_ventas.categoria_mas_vendida %}
                                        <h4 class="text-success">{{ estadisticas_ventas.categoria_mas_vendida.nombre }}</h4>
                                        <p class="mb-1"><strong>Productos vendidos:</strong> {{ estadisticas_ventas.categoria_mas_vendida.cantidad_productos }}</p>
                                        <p class="mb-1"><strong>Ingresos:</strong> ${{ estadisticas_ventas.categoria_mas_vendida.total_ingresos|floatformat:0 }}</p>
                                        <p class="mb-0"><strong>Pedidos:</strong> {{ estadisticas_ventas.categoria_mas_vendida.cantidad_pedidos }}</p>
                                    {% else %}
                                        <p class="text-muted">No hay datos de ventas disponibles</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Completa de Ventas por Categoría -->
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Análisis Detallado por Categoría</h5>
                                <div>
                                    <a href="/dashboard/dashboard_home/" class="btn btn-sm btn-outline-light me-2">
                                        <i class="fas fa-home"></i> Volver al Home
                                    </a>
                                    <button class="btn btn-sm btn-outline-light" onclick="window.print()">
                                        <i class="fas fa-print"></i> Imprimir
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">#</th>
                                            <th scope="col">Categoría</th>
                                            <th scope="col">Ingresos Totales</th>
                                            <th scope="col">Productos Vendidos</th>
                                            <th scope="col">Pedidos</th>
                                            <th scope="col">Promedio por Pedido</th>
                                            <th scope="col">% del Total</th>
                                            <th scope="col">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for categoria in ventas_por_categoria %}
                                        <tr>
                                            <td>
                                                {% if forloop.counter <= 3 %}
                                                    <span class="badge bg-warning text-dark">
                                                        {% if forloop.counter == 1 %}🥇{% elif forloop.counter == 2 %}🥈{% else %}🥉{% endif %}
                                                        {{ forloop.counter }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ forloop.counter }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <strong class="text-primary">{{ categoria.nombre }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">${{ categoria.total_ingresos|floatformat:0 }}</span>
                                            </td>
                                            <td>{{ categoria.cantidad_productos }}</td>
                                            <td>{{ categoria.cantidad_pedidos }}</td>
                                            <td>
                                                {% widthratio categoria.total_ingresos categoria.cantidad_pedidos 1 as promedio %}
                                                ${{ promedio|floatformat:0 }}
                                            </td>
                                            <td>
                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                <div class="progress" style="width: 60px;">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ porcentaje }}%">
                                                        {{ porcentaje|floatformat:1 }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary ver-detalle-categoria" 
                                                        data-categoria="{{ categoria.nombre }}"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#modalDetalleCategoriaVentas">
                                                    <i class="fas fa-eye"></i> Ver Detalles
                                                </button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>No hay ventas registradas aún
                                                <br><small>Las estadísticas aparecerán cuando se registren los primeros pedidos</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            {% elif request.GET.view == "proveedores" %>
                <h2>Proveedores</h2>
                    <a href="{% url 'create_proveedor' %}" data-bs-toggle="modal" data-bs-target="#modalNuevoProveedor" class="btn btn-primary mb-3">Crear Proveedor</a>
                    <table>
                        <tr>
                              <th>Nombre</th>
                            <th>Cédula</th>                          
                            <th>Email</th>
                            <th>Teléfono</th>
                            <th>Dirección</th>
                            <th>Acciones</th>
                        </tr>
                    {% if proveedores %}
                        <tr>
                            {% for proveedor in proveedores %}
                                <td>{{ proveedor.nombre }}</td>
                                <td>{{ proveedor.cedulaOnita }}</td>
                                <td>{{ proveedor.email }}</td>
                                <td>{{ proveedor.telefono }}</td>
                                <td>{{ proveedor.direccion }}</td>
                                <td>
                                    <a href="{% url 'edit_proveedor' proveedor.id %}" class="btn btn-sm btn-warning">Editar</a>
                                    <a href="{% url 'delete_proveedor' proveedor.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                                </td>
                          
                        </tr>
                        {% endfor %}
                {% else %}
                    <p>No hay proveedores disponibles.</p>
                {% endif %}
            {% else %}
                <!-- Vista de Ventas por Categorías - Home del Dashboard -->
                <div class="ventas-dashboard">
                    <h2><i class="fas fa-chart-line me-2"></i>Panel de Ventas - CompuEasys</h2>
                    <p class="text-muted mb-4">Análisis completo de ventas por categorías y estadísticas generales</p>
                    
                    <!-- Resumen General -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${{ total_ventas_general|floatformat:0 }}</h4>
                                            <p class="mb-0">Ventas Totales</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-dollar-sign fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ estadisticas_ventas.pedidos_totales }}</h4>
                                            <p class="mb-0">Pedidos Totales</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-shopping-cart fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>{{ estadisticas_ventas.productos_vendidos }}</h4>
                                            <p class="mb-0">Productos Vendidos</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-boxes fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4>${{ estadisticas_ventas.promedio_por_pedido|floatformat:0 }}</h4>
                                            <p class="mb-0">Promedio por Pedido</p>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-calculator fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Categorías Destacadas -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-crown me-2"></i>Categoría con Mayores Ingresos</h5>
                                </div>
                                <div class="card-body">
                                    {% if estadisticas_ventas.categoria_mayor_ingresos %}
                                        <h4 class="text-primary">{{ estadisticas_ventas.categoria_mayor_ingresos.nombre }}</h4>
                                        <p class="mb-1"><strong>Ingresos:</strong> ${{ estadisticas_ventas.categoria_mayor_ingresos.total_ingresos|floatformat:0 }}</p>
                                        <p class="mb-1"><strong>Productos vendidos:</strong> {{ estadisticas_ventas.categoria_mayor_ingresos.cantidad_productos }}</p>
                                        <p class="mb-0"><strong>Pedidos:</strong> {{ estadisticas_ventas.categoria_mayor_ingresos.cantidad_pedidos }}</p>
                                    {% else %}
                                        <p class="text-muted">No hay datos de ventas disponibles</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Categoría Más Vendida</h5>
                                </div>
                                <div class="card-body">
                                    {% if estadisticas_ventas.categoria_mas_vendida %}
                                        <h4 class="text-success">{{ estadisticas_ventas.categoria_mas_vendida.nombre }}</h4>
                                        <p class="mb-1"><strong>Productos vendidos:</strong> {{ estadisticas_ventas.categoria_mas_vendida.cantidad_productos }}</p>
                                        <p class="mb-1"><strong>Ingresos:</strong> ${{ estadisticas_ventas.categoria_mas_vendida.total_ingresos|floatformat:0 }}</p>
                                        <p class="mb-0"><strong>Pedidos:</strong> {{ estadisticas_ventas.categoria_mas_vendida.cantidad_pedidos }}</p>
                                    {% else %}
                                        <p class="text-muted">No hay datos de ventas disponibles</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla Resumida de Top Categorías -->
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Top Categorías por Ventas</h5>
                                <a href="?view=ventas" class="btn btn-sm btn-outline-light">
                                    <i class="fas fa-expand"></i> Ver Análisis Completo
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th scope="col">Ranking</th>
                                            <th scope="col">Categoría</th>
                                            <th scope="col">Ingresos</th>
                                            <th scope="col">Productos Vendidos</th>
                                            <th scope="col">% del Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for categoria in ventas_por_categoria|slice:":5" %}
                                        <tr>
                                            <td>
                                                {% if forloop.counter <= 3 %}
                                                    <span class="badge bg-warning text-dark">
                                                        {% if forloop.counter == 1 %}🥇{% elif forloop.counter == 2 %}🥈{% else %}🥉{% endif %}
                                                        {{ forloop.counter }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ forloop.counter }}</span>
                                                {% endif %}
                                            </td>
                                            <td><strong class="text-primary">{{ categoria.nombre }}</strong></td>
                                            <td><span class="badge bg-success">${{ categoria.total_ingresos|floatformat:0 }}</span></td>
                                            <td>{{ categoria.cantidad_productos }}</td>
                                            <td>
                                                {% widthratio categoria.total_ingresos total_ventas_general 100 as porcentaje %}
                                                <div class="progress" style="width: 80px;">
                                                    <div class="progress-bar bg-primary" role="progressbar" style="width: {{ porcentaje }}%">
                                                        {{ porcentaje|floatformat:1 }}%
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle me-2"></i>No hay ventas registradas aún
                                                <br><small>Las estadísticas aparecerán cuando se registren los primeros pedidos</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </main>
    </div>
    

    <!--modal crear tipo-->
    <div class="modal fade" id="modalNuevoTipo" tabindex="-1" aria-labelledby="modalNuevoTipoLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'crear_tipo' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalNuevoTipoLabel">Crear nuevo tipo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <label for="nombre_tipo">Nombre del tipo:</label>
                        <input type="text" class="form-control" id="nombre_tipo" name="nombre" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para crear nuevas categorías -->
    <div class="modal fade" id="modalNuevaCategoria" tabindex="-1" aria-labelledby="modalNuevaCategoriaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="create-category-form">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalNuevaCategoriaLabel">Crear nueva categoría</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nombre_categoria" class="form-label">Nombre de la categoría:</label>
                            <input type="text" class="form-control" id="nombre_categoria" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="slug_categoria" class="form-label">Slug:</label>
                            <input type="text" class="form-control" id="slug_categoria" name="slug" required>
                            <div class="form-text">URL amigable para la categoría (ej: electronica, computadoras)</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar categorías -->
    <div class="modal fade" id="modalEditarCategoria" tabindex="-1" aria-labelledby="modalEditarCategoriaLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="edit-category-form">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarCategoriaLabel">Editar categoría</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit_categoria_id" name="categoria_id">
                        <div class="mb-3">
                            <label for="edit_nombre_categoria" class="form-label">Nombre de la categoría:</label>
                            <input type="text" class="form-control" id="edit_nombre_categoria" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_slug_categoria" class="form-label">Slug:</label>
                            <input type="text" class="form-control" id="edit_slug_categoria" name="slug" required>
                            <div class="form-text">URL amigable para la categoría (ej: electronica, computadoras)</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            Actualizar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar eliminación de categoría -->
    <div class="modal fade" id="modalEliminarCategoria" tabindex="-1" aria-labelledby="modalEliminarCategoriaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEliminarCategoriaLabel">Confirmar eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle text-warning me-3" style="font-size: 2rem;"></i>
                        <div>
                            <p class="mb-1">¿Estás seguro de que deseas eliminar la categoría?</p>
                            <strong id="delete-category-name" class="text-danger"></strong>
                            <p class="small text-muted mt-2 mb-0">Esta acción no se puede deshacer.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="confirm-delete-category" class="btn btn-danger">
                        <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para crear nuevos proveedores -->
    <div class="modal fade" id="modalNuevoProveedor" tabindex="-1" aria-labelledby="modalNuevoProveedorLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'create_proveedor' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalNuevoProveedorLabel">Crear nuevo proveedor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="nombre_proveedor">Nombre del proveedor:</label>
          <input type="text" class="form-control" id="nombre_proveedor" name="nombre" required>
            <label for="cedula_proveedor">Cédula:</label>
            <input type="text" class="form-control" id="cedula_proveedor" name="cedulaOnita" >
            <label for="email_proveedor">Email:</label>
            <input type="email" class="form-control" id="email_proveedor" name="email" >
            <label for="telefono_proveedor">Teléfono:</label>
            <input type="text" class="form-control" id="telefono_proveedor" name="telefono" >
            <label for="direccion_proveedor">Dirección:</label>
            <input type="text" class="form-control" id="direccion_proveedor" name="direccion" >

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>
    <!-- Modal para editar usuario -->
    <div id="editModal" class="modal1">
        <div class="modal-content1">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h3>Editar Usuario</h3>
            <form id="editForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="user_id" id="modal_user_id" />
                <label>Username:</label>
                <input type="text" name="username" id="modal_username" required />
                <label>Email:</label>
                <input type="email" name="email" id="modal_email" required />
                <label>Contraseña (dejar en blanco para no cambiar):</label>
                <input type="password" name="password" id="modal_password" />
                <label>Celular:</label>
                <input type="text" name="celular" id="modal_celular" />
                <label>Dirección:</label>
                <input type="text" name="direccion" id="modal_direccion" />
                <label>Ciudad:</label>
                <input type="text" name="ciudad" id="modal_ciudad" />
                <label>País:</label>
                <input type="text" name="pais" id="modal_pais" />
                <label>Código postal:</label>
                <input type="text" name="codigo_postal" id="modal_codigo_postal" />
                <label>Fecha de creación:</label>
                <input type="date" name="created_at" id="modal_created_at" />
                <label>Fecha de nacimiento:</label>
                <input type="date" name="fecha_nacimiento" id="modal_fecha_nacimiento" />
                <label>Género:</label>
                <input type="text" name="genero" id="modal_genero" />
                <button type="submit">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Modal para ver detalles de ventas por categoría -->
    <div class="modal fade" id="modalDetalleCategoriaVentas" tabindex="-1" aria-labelledby="modalDetalleCategoriaVentasLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDetalleCategoriaVentasLabel">
                        <i class="fas fa-chart-bar me-2"></i>Detalles de Ventas - <span id="modal-categoria-nombre"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card bg-success text-white text-center">
                                <div class="card-body">
                                    <h5 id="modal-categoria-ingresos">$0</h5>
                                    <small>Ingresos Totales</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white text-center">
                                <div class="card-body">
                                    <h5 id="modal-categoria-productos">0</h5>
                                    <small>Productos Vendidos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-white text-center">
                                <div class="card-body">
                                    <h5 id="modal-categoria-pedidos">0</h5>
                                    <small>Pedidos</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h6><i class="fas fa-list me-2"></i>Productos más vendidos en esta categoría:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="modal-productos-detalle">
                                <!-- Se llenará dinámicamente con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                    <a href="?view=ventas" class="btn btn-primary">
                        <i class="fas fa-chart-line"></i> Ver Análisis Completo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/dashboard.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>
  document.getElementById('inventory_category_select').addEventListener('change', function(){
    const val = this.value;
    const url = new URL(window.location.href);
    url.searchParams.set('view','inventario');
    if(val) url.searchParams.set('inventory_category', val);
    else url.searchParams.delete('inventory_category');
    window.location.href = url.toString();
  });
</script>
    
</body>
</html>